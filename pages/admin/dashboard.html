<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - A Lo Cubano Boulder Fest</title>
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/typography.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/navigation.css" />
    <link rel="stylesheet" href="/css/forms.css" />
    <link rel="stylesheet" href="/css/admin-overrides.css" />
    <link rel="stylesheet" href="/css/admin-test-mode.css" />
    <script type="module" src="/js/theme-manager.js"></script>
  </head>
  <body class="admin-container">
    <!-- Skip Links for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <a href="#testModeSection" class="skip-link">Skip to test mode section</a>
    <a href="#registrations" class="skip-link">Skip to registrations</a>

    <!-- Unified Admin Header -->
    <header class="admin-header">
      <div class="admin-header-content">
        <div>
          <h1 class="admin-header-title">Admin Dashboard</h1>
          <p class="admin-header-subtitle">A Lo Cubano Boulder Fest - Festival Management & Analytics</p>
        </div>
        <div class="admin-header-actions">
          <!-- Event Selector in Header -->
          <div id="header-event-selector-container"></div>
          <button class="admin-btn admin-btn-success" onclick="syncToSheets()">
            <span>Sync to Sheets</span>
          </button>
          <button class="admin-btn admin-btn-primary" onclick="logout()">
            <span>Logout</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Unified Admin Navigation -->
    <nav class="admin-navigation">
      <ul class="admin-nav-list">
        <li class="admin-nav-item">
          <a href="/admin" class="admin-nav-link">
            <span>Portal</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/dashboard" class="admin-nav-link active">
            <span>Dashboard</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/tickets" class="admin-nav-link">
            <span>Tickets</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/analytics" class="admin-nav-link">
            <span>Analytics</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/checkin" class="admin-nav-link">
            <span>Check-in Scanner</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/api-endpoints" class="admin-nav-link">
            <span>API Endpoints</span>
          </a>
        </li>
      </ul>
      
      <!-- Event Selector -->
      <div id="event-selector-container"></div>
    </nav>

    <!-- Test Mode Section -->
    <section class="admin-card admin-mb-xl" id="testModeSection" data-testid="test-mode-section" role="region" aria-labelledby="test-mode-heading">
      <div class="admin-card-header">
        <h2 class="admin-card-title" id="test-mode-heading">Test Mode Cart</h2>
        <div class="admin-card-actions">
          <div class="test-mode-indicator" id="testModeIndicator" role="status" aria-live="polite" aria-label="Test environment status">
            <span class="test-badge" aria-label="Test mode active">TEST</span>
            <span class="test-status-text" id="test-status-description">Test Environment Active</span>
          </div>
        </div>
      </div>
      <div class="admin-card-body">
        <div class="test-mode-grid">
          <!-- Quick Add Test Items -->
          <div class="test-section" role="group" aria-labelledby="quick-add-heading">
            <h3 class="test-section-title" id="quick-add-heading">Quick Add Test Items</h3>
            <p class="visually-hidden">Add test items to your cart for testing checkout functionality</p>
            <div class="test-buttons-grid" role="group" aria-label="Test item buttons">
              <button class="admin-btn admin-btn-outline test-add-btn"
                      data-item="vip-pass"
                      data-testid="add-vip-test"
                      aria-describedby="vip-pass-description"
                      aria-label="Add VIP Pass for $150 to test cart">
                <span>Add VIP Pass</span>
                <small>$150</small>
                <span class="visually-hidden" id="vip-pass-description">Full festival access with VIP perks</span>
              </button>
              <button class="admin-btn admin-btn-outline test-add-btn"
                      data-item="weekend-pass"
                      data-testid="add-weekend-test"
                      aria-describedby="weekend-pass-description"
                      aria-label="Add Weekend Pass for $75 to test cart">
                <span>Add Weekend Pass</span>
                <small>$75</small>
                <span class="visually-hidden" id="weekend-pass-description">Access to all weekend events</span>
              </button>
              <button class="admin-btn admin-btn-outline test-add-btn"
                      data-item="donation"
                      data-testid="add-donation-test"
                      aria-describedby="donation-description"
                      aria-label="Add $25 donation to test cart">
                <span>Add Donation</span>
                <small>$25</small>
                <span class="visually-hidden" id="donation-description">Support the festival</span>
              </button>
            </div>
          </div>

          <!-- Cart Actions -->
          <div class="test-section" role="group" aria-labelledby="cart-actions-heading">
            <h3 class="test-section-title" id="cart-actions-heading">Cart Actions</h3>
            <p class="visually-hidden">Actions to manage your test cart</p>
            <div class="test-buttons-grid" role="group" aria-label="Cart action buttons">
              <button class="admin-btn admin-btn-primary"
                      onclick="viewCartOnMainSite()"
                      data-testid="view-cart-main"
                      aria-label="Open main site with test cart items in new tab"
                      aria-describedby="view-cart-description">
                <span>View Cart on Main Site</span>
                <span class="visually-hidden" id="view-cart-description">Opens tickets page in new tab with test items added to cart</span>
              </button>
              <button class="admin-btn admin-btn-secondary"
                      onclick="clearTestCart()"
                      data-testid="clear-test-cart"
                      aria-label="Clear all items from test cart"
                      aria-describedby="clear-cart-description">
                <span>Clear Test Cart</span>
                <span class="visually-hidden" id="clear-cart-description">Removes all test items from cart, requires confirmation</span>
              </button>
            </div>
          </div>

          <!-- Test Data Management -->
          <div class="test-section" role="group" aria-labelledby="test-data-heading">
            <h3 class="test-section-title" id="test-data-heading">Test Data Management</h3>
            <p class="visually-hidden">View test cart statistics and manage test data</p>
            <div class="test-stats" id="testStats" role="region" aria-label="Test cart statistics" aria-live="polite">
              <div class="test-stat-item">
                <span class="test-stat-label" id="cart-count-label">Test Items in Cart:</span>
                <span class="test-stat-value" id="testCartCount" aria-labelledby="cart-count-label">0</span>
              </div>
              <div class="test-stat-item">
                <span class="test-stat-label" id="cart-value-label">Test Cart Value:</span>
                <span class="test-stat-value" id="testCartValue" aria-labelledby="cart-value-label">$0.00</span>
              </div>
            </div>
            <div class="test-buttons-grid" role="group" aria-label="Test data management buttons">
              <button class="admin-btn admin-btn-danger"
                      onclick="cleanupTestData()"
                      data-testid="cleanup-test-data"
                      aria-label="Remove all test data including cart items and session data"
                      aria-describedby="cleanup-description">
                <span>Cleanup All Test Data</span>
                <span class="visually-hidden" id="cleanup-description">Permanently removes all test cart items, session data, and preferences. Requires confirmation.</span>
              </button>
              <button class="admin-btn admin-btn-ghost"
                      onclick="generateTestData()"
                      data-testid="generate-test-data"
                      aria-label="Generate sample test data for testing purposes"
                      aria-describedby="generate-description">
                <span>Generate Test Data</span>
                <span class="visually-hidden" id="generate-description">Creates random test items in cart for development testing. Requires confirmation.</span>
              </button>
            </div>
          </div>

          <!-- Keyboard Shortcuts Help -->
          <div class="test-section" role="group" aria-labelledby="shortcuts-heading">
            <h3 class="test-section-title" id="shortcuts-heading">Keyboard Shortcuts</h3>
            <p class="visually-hidden">Available keyboard shortcuts for test mode functionality</p>
            <div class="keyboard-shortcuts-info">
              <div class="shortcut-grid">
                <div class="shortcut-item">
                  <kbd>Alt + T</kbd>
                  <span>Toggle test/production mode</span>
                </div>
                <div class="shortcut-item">
                  <kbd>Alt + V</kbd>
                  <span>Add VIP Pass</span>
                </div>
                <div class="shortcut-item">
                  <kbd>Alt + W</kbd>
                  <span>Add Weekend Pass</span>
                </div>
                <div class="shortcut-item">
                  <kbd>Alt + D</kbd>
                  <span>Add Donation</span>
                </div>
                <div class="shortcut-item">
                  <kbd>Alt + C</kbd>
                  <span>Clear test cart</span>
                </div>
                <div class="shortcut-item">
                  <kbd>Alt + H</kbd>
                  <span>Show help dialog</span>
                </div>
                <div class="shortcut-item">
                  <kbd>Esc</kbd>
                  <span>Cancel operations</span>
                </div>
                <div class="shortcut-item">
                  <kbd>Tab</kbd>
                  <span>Navigate elements</span>
                </div>
              </div>
              <button class="admin-btn admin-btn-outline admin-btn-sm"
                      onclick="window.testMode && window.testMode.showKeyboardShortcutsHelp && window.testMode.showKeyboardShortcutsHelp()"
                      aria-label="Show detailed keyboard shortcuts help">
                <span>Show Help Dialog</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Content -->
    <main id="main-content">
      <!-- Statistics Grid -->
      <section class="admin-grid auto-fit" id="statsGrid" data-testid="dashboard-stats" role="region" aria-labelledby="stats-heading">
        <h2 id="stats-heading" class="visually-hidden">Dashboard Statistics</h2>
        <div class="admin-loading">Loading statistics...</div>
      </section>
    </main>

    <!-- Registrations Section -->
    <div class="admin-card admin-mb-xl" id="registrations">
      <!-- Additional anchor for transactions (points to same section) -->
      <span id="transactions"></span>
      <div class="admin-card-header">
        <h2 class="admin-card-title">Registrations</h2>
        <div class="admin-card-actions">
          <button class="admin-btn admin-btn-sm" onclick="exportToCSV()">
            <span>Export CSV</span>
          </button>
        </div>
      </div>
      <div class="admin-card-body">

        <div class="admin-flex admin-flex-wrap admin-gap-md admin-mb-xl">
          <input
            type="text"
            id="searchInput"
            class="admin-form-input"
            placeholder="Search by name, email, or ticket ID..."
            onkeypress="if(event.key==='Enter') searchRegistrations()"
            data-testid="search-registrations"
            style="flex: 1; min-width: 250px"
          />
          <select
            id="statusFilter"
            class="admin-form-select"
            onchange="searchRegistrations()"
            data-testid="ticket-type-filter"
            style="min-width: 120px"
          >
            <option value="">All Status</option>
            <option value="valid">Valid</option>
            <option value="cancelled">Cancelled</option>
            <option value="transferred">Transferred</option>
          </select>
          <select 
            id="checkinFilter" 
            class="admin-form-select" 
            onchange="searchRegistrations()"
            style="min-width: 150px"
          >
            <option value="">All Tickets</option>
            <option value="false">Not Checked In</option>
            <option value="true">Checked In</option>
          </select>
          <button 
            class="admin-btn admin-btn-primary" 
            onclick="searchRegistrations()" 
            data-testid="search-button"
          >
            <span>Search</span>
          </button>
        </div>

        <div id="registrationsTable" data-testid="registrations-table">
          <div class="admin-loading">Loading registrations...</div>
        </div>

        <div class="pagination admin-flex admin-justify-center admin-gap-sm admin-mt-xl" id="pagination"></div>
      </div>
    </div>

    <script>
      // Security improvements:
      // 1. All user-provided data is escaped using escapeHtml() to prevent XSS attacks
      // 2. CSRF tokens are fetched and included in all state-changing requests
      // 3. Error messages are safely displayed using textContent or escapeHtml()

      let currentPage = 0;
      const pageSize = 50;
      let authToken = null;
      let csrfToken = null;

      // HTML escaping function to prevent XSS attacks
      // CRITICAL: Use this for ALL user-provided data displayed in innerHTML
      function escapeHtml(unsafe) {
        if (unsafe == null) return "";
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Fetch CSRF token
      async function fetchCSRFToken() {
        try {
          const response = await fetch("/api/admin/csrf-token", {
            credentials: "include" // Include cookies for production
          });
          if (response.ok) {
            const data = await response.json();
            csrfToken = data.csrfToken;
            // Refresh token before it expires (50 minutes)
            setTimeout(fetchCSRFToken, 50 * 60 * 1000);
          }
        } catch (error) {
          console.warn("Failed to fetch CSRF token:", error);
          // Continue without CSRF token for backward compatibility
        }
      }

      // ✅ PROPER AUTH CHECK - Use verify-session endpoint with credentials
      async function checkAuth() {
        try {
          const response = await fetch("/api/admin/verify-session", {
            credentials: "include", // CRITICAL: Include cookies for production
            headers: { "Cache-Control": "no-cache" },
            signal: AbortSignal.timeout(3000) // 3-second timeout, no retries
          });

          if (!response.ok) {
            // Immediate redirect on auth failure
            document.body.setAttribute("data-auth-status", "unauthenticated");
            window.location.replace("/admin/login");
            return false;
          }

          // Success - verify the session is valid
          const data = await response.json();
          if (!data.valid) {
            document.body.setAttribute("data-auth-status", "unauthenticated");
            window.location.replace("/admin/login");
            return false;
          }

          // Session is valid
          document.body.setAttribute("data-auth-status", "authenticated");
          console.log("Session verified successfully");
          return true;
        } catch (error) {
          // Immediate redirect on any error (timeout, network, etc.)
          console.error("Auth check failed:", error);
          document.body.setAttribute("data-auth-status", "error");
          window.location.replace("/admin/login");
          return false;
        }
      }

      // Load dashboard data
      async function loadDashboardData(eventId) {
        // Ensure auth status is set immediately
        if (!document.body.getAttribute("data-auth-status")) {
          document.body.setAttribute("data-auth-status", "checking");
        }

        try {
          // Perform authentication check first
          const isAuthenticated = await checkAuth();

          // If auth failed, checkAuth will redirect, so this won't execute
          if (!isAuthenticated) {
            return;
          }

          // Now fetch the actual dashboard data with credentials
          const url = new URL("/api/admin/dashboard", window.location.origin);
          if (eventId && eventId !== 'all') {
            url.searchParams.set('eventId', eventId);
          }

          // Add test mode parameter if in test mode view
          if (window.testModeView) {
            url.searchParams.set('testMode', 'true');
          }

          const response = await fetch(url.toString(), {
            credentials: "include" // CRITICAL: Include cookies for production
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to load dashboard');
          }

          const data = await response.json();

          // Fetch CSRF token after successful auth check
          await fetchCSRFToken();

          displayStats(data.stats);
          await loadRegistrations();
        } catch (error) {
          console.error("Failed to load dashboard:", error);
          document.getElementById("statsGrid").innerHTML = `
                    <div class="error">Failed to load dashboard: ${escapeHtml(error.message)}</div>
                `;
        }
      }

      // Make loadDashboardData available globally for event selector
      window.loadDashboardData = loadDashboardData;

      // Display statistics
      function displayStats(stats) {
        const statsGrid = document.getElementById("statsGrid");

        // Calculate percentage safely when division by zero might occur
        const checkinPercentage = stats.total_tickets > 0
          ? Math.round((stats.checked_in / stats.total_tickets) * 100)
          : 0;

        // Check if we're in test mode view
        const isTestMode = window.testModeView || false;
        const dataTypeLabel = isTestMode ? "Test" : "Production";
        const dataTypeClass = isTestMode ? "test-data" : "production-data";
        const modeIcon = isTestMode ? "🧪" : "🎯";

        // Add global test mode indicator to page
        updateGlobalTestModeIndicator(isTestMode);

        statsGrid.innerHTML = `
                <!-- Data Mode Toggle -->
                <div class="admin-stat-card data-mode-toggle" role="group" aria-labelledby="data-mode-heading">
                    <h3 class="stat-label" id="data-mode-heading">Data View Mode</h3>
                    <div class="data-mode-switcher" role="radiogroup" aria-labelledby="data-mode-heading" aria-describedby="data-mode-description">
                        <button class="mode-btn ${!isTestMode ? 'active' : ''}"
                                onclick="switchDataMode(false)"
                                data-testid="production-mode-btn"
                                role="radio"
                                aria-checked="${!isTestMode}"
                                aria-label="Production data view"
                                aria-describedby="production-mode-description">
                            <span>🎯 Production</span>
                            <span class="visually-hidden" id="production-mode-description">View live production data including real orders and tickets</span>
                        </button>
                        <button class="mode-btn test-mode-btn ${isTestMode ? 'active' : ''}"
                                onclick="switchDataMode(true)"
                                data-testid="test-mode-btn"
                                role="radio"
                                aria-checked="${isTestMode}"
                                aria-label="Test data view"
                                aria-describedby="test-mode-description">
                            <span>🧪 Test</span>
                            <span class="visually-hidden" id="test-mode-description">View test data including test orders and sample tickets</span>
                        </button>
                    </div>
                    <p class="visually-hidden" id="data-mode-description">Choose between viewing production data or test data. Production data shows real festival information while test data shows sample information for testing.</p>
                    ${isTestMode ? '<div class="test-mode-indicator" role="status" aria-live="polite"><span class="test-badge">TEST</span><span class="test-status-text">Test Data View Active</span></div>' : ''}
                </div>
                <div class="admin-stat-card ${dataTypeClass}">
                    <h3 class="stat-label">${modeIcon} ${dataTypeLabel} Total Tickets</h3>
                    <div class="stat-number">${stats.total_tickets || 0}</div>
                    ${isTestMode ? '<div class="test-badge">TEST</div>' : ''}
                </div>
                <div class="admin-stat-card ${dataTypeClass}">
                    <h3 class="stat-label">${modeIcon} ${dataTypeLabel} Checked In</h3>
                    <div class="stat-number">${stats.checked_in || 0}</div>
                    <div class="stat-label admin-mt-sm">${checkinPercentage}%</div>
                    ${isTestMode ? '<div class="test-badge">TEST</div>' : ''}
                </div>
                <div class="admin-stat-card ${dataTypeClass}">
                    <h3 class="stat-label">${modeIcon} ${dataTypeLabel} Revenue</h3>
                    <div class="stat-number">$${(stats.total_revenue || 0).toFixed(2)}</div>
                    ${isTestMode ? '<div class="test-badge">TEST</div>' : ''}
                </div>
                <div class="admin-stat-card ${dataTypeClass}">
                    <h3 class="stat-label">${modeIcon} ${dataTypeLabel} Orders</h3>
                    <div class="stat-number">${stats.total_orders || 0}</div>
                    ${isTestMode ? '<div class="test-badge">TEST</div>' : ''}
                </div>
                <div class="admin-stat-card ${dataTypeClass}">
                    <h3 class="stat-label">${modeIcon} ${dataTypeLabel} Workshop Tickets</h3>
                    <div class="stat-number">${stats.workshop_tickets || 0}</div>
                    ${isTestMode ? '<div class="test-badge">TEST</div>' : ''}
                </div>
                <div class="admin-stat-card ${dataTypeClass}">
                    <h3 class="stat-label">${modeIcon} ${dataTypeLabel} VIP Tickets</h3>
                    <div class="stat-number">${stats.vip_tickets || 0}</div>
                    ${isTestMode ? '<div class="test-badge">TEST</div>' : ''}
                </div>
                <!-- Wallet Statistics -->
                <div class="admin-stat-card ${dataTypeClass}">
                    <h3 class="stat-label">${modeIcon} ${dataTypeLabel} Apple Wallet</h3>
                    <div class="stat-number">${stats.apple_wallet_users || 0}</div>
                    <div class="stat-label admin-mt-sm">${stats.total_tickets ? Math.round((stats.apple_wallet_users / stats.total_tickets) * 100) : 0}% adoption</div>
                    ${isTestMode ? '<div class="test-badge">TEST</div>' : ''}
                </div>
                <div class="admin-stat-card ${dataTypeClass}">
                    <h3 class="stat-label">${modeIcon} ${dataTypeLabel} Google Wallet</h3>
                    <div class="stat-number">${stats.google_wallet_users || 0}</div>
                    <div class="stat-label admin-mt-sm">${stats.total_tickets ? Math.round((stats.google_wallet_users / stats.total_tickets) * 100) : 0}% adoption</div>
                    ${isTestMode ? '<div class="test-badge">TEST</div>' : ''}
                </div>
                <div class="admin-stat-card ${dataTypeClass}">
                    <h3 class="stat-label">${modeIcon} ${dataTypeLabel} QR Generated</h3>
                    <div class="stat-number">${stats.qr_generated || 0}</div>
                    <div class="stat-label admin-mt-sm">${stats.total_tickets ? Math.round((stats.qr_generated / stats.total_tickets) * 100) : 0}% ready</div>
                    ${isTestMode ? '<div class="test-badge">TEST</div>' : ''}
                </div>
            `;
      }

      // Switch between test and production data view
      function switchDataMode(isTestMode) {
        window.testModeView = isTestMode;

        // Update ARIA states for radio buttons
        const buttons = document.querySelectorAll('.mode-btn[role="radio"]');
        buttons.forEach(btn => {
          const isActive = (isTestMode && btn.classList.contains('test-mode-btn')) ||
                          (!isTestMode && !btn.classList.contains('test-mode-btn'));
          btn.setAttribute('aria-checked', isActive.toString());

          // Add loading state
          btn.classList.add('test-mode-loading');
          btn.setAttribute('aria-busy', 'true');
        });

        // Announce mode switch to screen readers
        const modeType = isTestMode ? 'test data' : 'production data';
        const announcer = document.getElementById('test-mode-announcer') || createScreenReaderAnnouncer();
        setTimeout(() => {
          announcer.textContent = `Switched to ${modeType} view. Loading dashboard statistics...`;
        }, 100);

        const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;
        loadDashboardData(selectedEventId);
      }

      // Helper function to create screen reader announcer
      function createScreenReaderAnnouncer() {
        const announcer = document.createElement('div');
        announcer.id = 'test-mode-announcer';
        announcer.setAttribute('aria-live', 'polite');
        announcer.setAttribute('aria-atomic', 'true');
        announcer.className = 'visually-hidden';
        document.body.appendChild(announcer);
        return announcer;
      }

      // Update global test mode indicator
      function updateGlobalTestModeIndicator(isTestMode) {
        const headerTitle = document.querySelector('.admin-header-title');
        const headerSubtitle = document.querySelector('.admin-header-subtitle');

        if (isTestMode) {
          // Add test mode indicator to header
          if (!headerTitle.querySelector('.global-test-indicator')) {
            const testIndicator = document.createElement('span');
            testIndicator.className = 'global-test-indicator';
            testIndicator.innerHTML = '<span class="test-badge">TEST MODE</span>';
            headerTitle.appendChild(testIndicator);
          }

          // Update subtitle to show test mode
          if (headerSubtitle) {
            headerSubtitle.innerHTML = 'A Lo Cubano Boulder Fest - <span style="color: var(--color-warning); font-weight: 700;">TEST DATA VIEW</span>';
          }

          // Add test mode class to body
          document.body.classList.add('admin-test-mode-active');
        } else {
          // Remove test mode indicator
          const testIndicator = headerTitle.querySelector('.global-test-indicator');
          if (testIndicator) {
            testIndicator.remove();
          }

          // Reset subtitle
          if (headerSubtitle) {
            headerSubtitle.textContent = 'A Lo Cubano Boulder Fest - Festival Management & Analytics';
          }

          // Remove test mode class from body
          document.body.classList.remove('admin-test-mode-active');
        }
      }

      // Load registrations
      async function loadRegistrations(page = 0) {
        currentPage = page;
        const offset = page * pageSize;

        const search = document.getElementById("searchInput").value;
        const status = document.getElementById("statusFilter").value;
        const checkedIn = document.getElementById("checkinFilter").value;

        // Get selected event ID from event selector
        const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;
        
        const params = new URLSearchParams({
          limit: pageSize,
          offset: offset,
          ...(search && { search }),
          ...(status && { status }),
          ...(checkedIn && { checkedIn }),
          ...(selectedEventId && { eventId: selectedEventId }),
          ...(window.testModeView && { testMode: 'true' }),
        });

        try {
          const response = await fetch(`/api/admin/registrations?${params}`, {
            credentials: "include" // Include cookies for production
          });


          // Response handled locally for security

          if (!response.ok) {
            throw new Error(data.error || data.message || `HTTP ${response.status}`);
          }

          displayRegistrations(data.registrations);
          displayPagination(data.total, page);
        } catch (error) {
          console.error("Failed to load registrations:", error);

          // Enhanced error display for debugging
          let errorDetails = error.message;

          // If it's an import failure, try to extract more details from the response
          if (error.message.includes("Import failure")) {
            try {
              // Try to extract the response data for more details
              if (window.lastDebugResponse && window.lastDebugResponse.service && window.lastDebugResponse.message) {
                errorDetails = `Import failed in ${window.lastDebugResponse.service}: ${window.lastDebugResponse.message}`;
                console.error("🔍 Full import error:", window.lastDebugResponse);
              }
            } catch (parseError) {
              console.error("Could not parse error details:", parseError);
            }
          }

          document.getElementById("registrationsTable").innerHTML = `
                    <div class="error">
                      <strong>Failed to load registrations:</strong><br>
                      ${escapeHtml(errorDetails)}<br>
                      <small>Check browser console and Network tab for more details</small>
                    </div>
                `;
        }
      }

      // Display registrations table
      function displayRegistrations(registrations) {
        if (registrations.length === 0) {
          document.getElementById("registrationsTable").innerHTML = `
                    <p class="admin-text-center admin-p-xl admin-text-muted">
                        No registrations found
                    </p>
                `;
          return;
        }

        const isTestModeView = window.testModeView || false;

        const tableHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Order</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${registrations
                          .map(
                            (reg) => {
                              const isTestTicket = reg.is_test === 1 || reg.ticket_id?.startsWith('TEST-');
                              const rowClass = isTestTicket ? 'test-ticket-row' : '';
                              const testBadge = isTestTicket ? '<span class="test-badge">TEST</span>' : '';

                              return `
                            <tr class="${rowClass}">
                                <td>
                                    <code class="admin-p-xs" style="background: var(--color-background-secondary); border-radius: var(--radius-sm);">${escapeHtml(reg.ticket_id)}</code>
                                    ${testBadge}
                                </td>
                                <td>${escapeHtml(reg.attendee_first_name)} ${escapeHtml(reg.attendee_last_name)}</td>
                                <td>${escapeHtml(reg.attendee_email)}</td>
                                <td>
                                    ${escapeHtml(formatTicketType(reg.ticket_type))}
                                    ${isTestTicket ? '<small class="test-indicator">🧪 Test</small>' : ''}
                                </td>
                                <td>
                                    <span class="status-badge ${reg.checked_in_at ? "success" : reg.status === "valid" ? "info" : "warning"}">
                                        ${reg.checked_in_at ? "Checked In" : escapeHtml(reg.status)}
                                    </span>
                                </td>
                                <td>${escapeHtml(reg.order_number)}</td>
                                <td>
                                    ${
                                      reg.checked_in_at
                                        ? `<button class="admin-btn admin-btn-sm admin-btn-secondary" data-action="undo" data-ticket-id="${escapeHtml(reg.ticket_id)}" data-testid="checkin-reg_${escapeHtml(reg.ticket_id)}"><span>Undo</span></button>`
                                        : `<button class="admin-btn admin-btn-sm admin-btn-success" data-action="checkin" data-ticket-id="${escapeHtml(reg.ticket_id)}" data-testid="checkin-reg_${escapeHtml(reg.ticket_id)}"><span>Check In</span></button>`
                                    }
                                </td>
                            </tr>
                        `;
                            }
                          )
                          .join("")}
                    </tbody>
                </table>
            `;

        document.getElementById("registrationsTable").innerHTML = tableHTML;
      }

      // Display pagination
      function displayPagination(total, currentPage) {
        const totalPages = Math.ceil(total / pageSize);
        const pagination = document.getElementById("pagination");

        if (totalPages <= 1) {
          pagination.innerHTML = "";
          return;
        }

        pagination.innerHTML = `
                <button class="admin-btn admin-btn-ghost" onclick="loadRegistrations(0)" ${currentPage === 0 ? "disabled" : ""}>
                    <span>First</span>
                </button>
                <button class="admin-btn admin-btn-ghost" onclick="loadRegistrations(${currentPage - 1})" ${currentPage === 0 ? "disabled" : ""}>
                    <span>Previous</span>
                </button>
                <span class="admin-p-md admin-text-secondary" style="font-family: var(--font-code); font-size: var(--font-size-sm);">
                    Page ${currentPage + 1} of ${totalPages}
                </span>
                <button class="admin-btn admin-btn-ghost" onclick="loadRegistrations(${currentPage + 1})" ${currentPage >= totalPages - 1 ? "disabled" : ""}>
                    <span>Next</span>
                </button>
                <button class="admin-btn admin-btn-ghost" onclick="loadRegistrations(${totalPages - 1})" ${currentPage >= totalPages - 1 ? "disabled" : ""}>
                    <span>Last</span>
                </button>
            `;
      }

      // Search registrations
      function searchRegistrations() {
        loadRegistrations(0);
      }

      // Check in ticket
      async function checkinTicket(ticketId) {
        if (!confirm(`Check in ticket ${ticketId}?`)) return;

        try {
          const headers = { "Content-Type": "application/json" };
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const response = await fetch(
            `/api/admin/registrations?ticketId=${encodeURIComponent(ticketId)}`,
            {
              method: "PUT",
              credentials: "same-origin", // CRITICAL: Include cookies for production
              headers: headers,
              body: JSON.stringify({ action: "checkin" }),
            },
          );

          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          await loadRegistrations(currentPage);
        } catch (error) {
          alert(`Failed to check in: ${escapeHtml(error.message)}`);
        }
      }

      // Undo check in
      async function undoCheckin(ticketId) {
        if (!confirm(`Undo check-in for ticket ${ticketId}?`)) return;

        try {
          const headers = { "Content-Type": "application/json" };
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const response = await fetch(
            `/api/admin/registrations?ticketId=${encodeURIComponent(ticketId)}`,
            {
              method: "PUT",
              credentials: "same-origin", // CRITICAL: Include cookies for production
              headers: headers,
              body: JSON.stringify({ action: "undo_checkin" }),
            },
          );

          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          await loadRegistrations(currentPage);
        } catch (error) {
          alert(`Failed to undo check-in: ${escapeHtml(error.message)}`);
        }
      }

      // Export to CSV
      async function exportToCSV() {
        const search = document.getElementById("searchInput").value;
        const status = document.getElementById("statusFilter").value;
        const checkedIn = document.getElementById("checkinFilter").value;

        // Get selected event ID from event selector
        const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;
        
        const params = new URLSearchParams({
          limit: 10000, // Export all
          offset: 0,
          ...(search && { search }),
          ...(status && { status }),
          ...(checkedIn && { checkedIn }),
          ...(selectedEventId && { eventId: selectedEventId }),
          ...(window.testModeView && { testMode: 'true' }),
        });

        try {
          const response = await fetch(`/api/admin/registrations?${params}`, {
            credentials: "include" // Include cookies for production
          });
          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          // Convert to CSV
          const csv = convertToCSV(data.registrations);

          // Download with test mode prefix
          const blob = new Blob([csv], { type: "text/csv" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          const modePrefix = window.testModeView ? 'test-data-' : 'production-data-';
          const timestamp = new Date().toISOString().split("T")[0];
          a.download = `${modePrefix}registrations-${timestamp}.csv`;
          a.click();
        } catch (error) {
          alert(`Export failed: ${escapeHtml(error.message)}`);
        }
      }

      // Convert to CSV
      function convertToCSV(data) {
        if (data.length === 0) return "";

        const headers = [
          "Ticket ID",
          "First Name",
          "Last Name",
          "Email",
          "Ticket Type",
          "Status",
          "Checked In",
          "Order Number",
        ];

        // Note: No HTML escaping needed for CSV export data
        // CSV format handles special characters differently
        const rows = data.map((row) => [
          row.ticket_id,
          row.attendee_first_name,
          row.attendee_last_name,
          row.attendee_email,
          row.ticket_type,
          row.status,
          row.checked_in_at ? "Yes" : "No",
          row.order_number,
        ]);

        return [
          headers.join(","),
          ...rows.map((row) =>
            row
              .map((cell) => `"${String(cell || "").replace(/"/g, '""')}"`)
              .join(","),
          ),
        ].join("\n");
      }

      // Format ticket type
      function formatTicketType(type) {
        const typeMap = {
          "vip-pass": "VIP Pass",
          "weekend-pass": "Weekend Pass",
          "friday-pass": "Friday",
          "saturday-pass": "Saturday",
          "sunday-pass": "Sunday",
          workshop: "Workshop",
          "general-admission": "General",
        };
        return typeMap[type] || type;
      }

      // Logout
      async function logout() {
        try {
          const headers = {};
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          await fetch("/api/admin/login", {
            credentials: "same-origin", // Include cookies for production
            method: "DELETE",
            headers: headers,
          });
        } finally {
          // Clear client storage
          localStorage.removeItem('adminToken');
          sessionStorage.clear();
          // Redirect
          window.location.href = '/admin/login';
        }
      }

      // Sync to Google Sheets
      async function syncToSheets() {
        const btn = event.target;
        const originalText = btn.textContent;

        btn.disabled = true;
        btn.textContent = "Syncing...";

        try {
          const response = await fetch("/api/sheets/sync", {
            credentials: "same-origin", // Include cookies for production
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": window.csrfToken,
            },
          });

          const data = await response.json();

          if (response.ok) {
            if (data.sheetUrl) {
              alert(
                `✅ Sync completed!\n\nView your data at:\n${data.sheetUrl}`,
              );
            } else {
              alert(`✅ Sync completed at ${data.timestamp}`);
            }
          } else {
            alert(`❌ Sync failed: ${data.message || data.error}`);
          }
        } catch (error) {
          alert(`❌ Sync failed: ${error.message}`);
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }

      // Add event delegation for check-in buttons
      document
        .getElementById("registrationsTable")
        .addEventListener("click", function (event) {
          if (event.target.matches(".admin-btn[data-action]") || 
              (event.target.parentElement && event.target.parentElement.matches(".admin-btn[data-action]"))) {
            const button = event.target.matches(".admin-btn[data-action]") 
              ? event.target 
              : event.target.parentElement;
            const action = button.getAttribute("data-action");
            const ticketId = button.getAttribute("data-ticket-id");

            if (action === "checkin") {
              checkinTicket(ticketId);
            } else if (action === "undo") {
              undoCheckin(ticketId);
            }
          }
        });

      // Initialize dashboard immediately
      document.body.setAttribute('data-auth-status', 'checking');
      
      // Initialize event selector and load dashboard data
      document.addEventListener('DOMContentLoaded', async () => {
        if (window.eventSelector) {
          await window.eventSelector.init();
          
          // Render event selector in both navigation and header
          window.eventSelector.render('event-selector-container');
          window.eventSelector.render('header-event-selector-container');
          
          // Load dashboard with selected event
          const selectedEventId = window.eventSelector.getSelectedEventId();
          loadDashboardData(selectedEventId);
        } else {
          // Fallback if event selector not available
          loadDashboardData(null);
        }
      });

      // Refresh data every 30 seconds
      setInterval(() => {
        const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;
        loadDashboardData(selectedEventId);
      }, 30000);
    </script>

    <script src="/js/admin-event-selector.js"></script>
    <script src="/js/admin-test-mode.js"></script>
  </body>
</html>
