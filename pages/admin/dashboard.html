<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <!-- Inline theme detection to prevent FOUC -->
    <script>
      (function() {
        // Detect admin pages
        const path = window.location.pathname.toLowerCase();
        const isAdmin = path.includes('/admin') || path.includes('pages/admin');

        if (isAdmin) {
          // Admin pages always use dark theme
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          // Main site: check user preference
          let stored = null;
          try {
            stored = localStorage.getItem('theme-preference');
          } catch {
            // localStorage might be disabled
          }

          const preference = stored || 'system';
          let theme = preference;

          if (preference === 'system') {
            // Detect system preference
            theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
              ? 'dark'
              : 'light';
          }

          document.documentElement.setAttribute('data-theme', theme);
        }
      })();
    </script>

    <!-- Pre-render auth check to prevent content flash -->
    <script>
      // Hide content immediately to prevent flash
      document.documentElement.style.visibility = 'hidden';
      document.documentElement.style.opacity = '0';
      document.documentElement.style.transition = 'opacity 0.2s ease-in';

      // Quick token validation to prevent flash with invalid tokens
      (async function() {
        if (!window.location.pathname.includes('/admin/login')) {
          const token = localStorage.getItem('adminToken');
          if (!token) {
            // No token - redirect immediately
            window.location.replace('/admin/login');
            return;
          }

          // Quick validation - check if token is expired client-side
          try {
            // Parse JWT to check expiration (basic check)
            const payload = JSON.parse(atob(token.split('.')[1]));
            if (payload.exp && payload.exp * 1000 < Date.now()) {
              // Token expired - clear and redirect
              localStorage.removeItem('adminToken');
              window.location.replace('/admin/login');
              return;
            }
          } catch (e) {
            // Invalid token format - clear and redirect
            localStorage.removeItem('adminToken');
            window.location.replace('/admin/login');
            return;
          }
          // Valid token format - wait for server verification
        }
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - A Lo Cubano Boulder Fest</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/typography.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/navigation.css" />
    <link rel="stylesheet" href="/css/forms.css" />
    <link rel="stylesheet" href="/css/admin-overrides.css" />
    <script type="module" src="/js/theme-manager.js"></script>
    <script type="module" src="/js/time-manager.js"></script>

    <style>
      /* Auth loading overlay */
      .auth-loading {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--color-background-dark, #1a1a1a);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .auth-loading-content {
        text-align: center;
        color: var(--color-text-primary);
      }

      .auth-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top-color: var(--color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body class="admin-container" style="visibility: hidden;">
    <!-- Auth Loading State (hidden by default, shown only during auth check) -->
    <div id="auth-loading" class="auth-loading" style="display: none;">
      <div class="auth-loading-content">
        <div class="auth-spinner"></div>
        <h2>Verifying Authentication...</h2>
      </div>
    </div>

    <!-- Skip Links for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <a href="#registrations" class="skip-link">Skip to registrations</a>

    <!-- Unified Admin Header -->
    <header class="admin-header">
      <div class="admin-header-content">
        <div>
          <h1 class="admin-header-title">Admin Dashboard</h1>
          <p class="admin-header-subtitle">A Lo Cubano Boulder Fest - Festival Management & Analytics</p>
        </div>
        <div class="admin-header-actions">
          <button class="admin-btn admin-btn-success" onclick="syncToSheets()">
            <span>Sync to Sheets</span>
          </button>
          <button class="admin-btn admin-btn-primary" onclick="logout()">
            <span>Logout</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Unified Admin Navigation -->
    <nav class="admin-navigation">
      <ul class="admin-nav-list">
        <li class="admin-nav-item">
          <a href="/admin" class="admin-nav-link">
            <span>Portal</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/dashboard" class="admin-nav-link active">
            <span>Dashboard</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/tickets" class="admin-nav-link">
            <span>Tickets</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/analytics" class="admin-nav-link">
            <span>Analytics</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/donations" class="admin-nav-link">
            <span>Donations</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/checkin" class="admin-nav-link">
            <span>Check-in Scanner</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/test" class="admin-nav-link">
            <span>Test</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/api-endpoints" class="admin-nav-link">
            <span>API Endpoints</span>
          </a>
        </li>
      </ul>
      
      <!-- Event Selector -->
      <div id="event-selector-container"></div>
    </nav>

    <!-- Main Content -->
    <main id="main-content">
      <!-- Statistics Grid -->
      <section class="admin-grid auto-fit" id="statsGrid" data-testid="dashboard-stats" role="region" aria-labelledby="stats-heading">
        <h2 id="stats-heading" class="visually-hidden">Dashboard Statistics</h2>
        <div class="admin-loading">Loading statistics...</div>
      </section>

      <!-- Flagged Tickets Section (Security Alert) -->
      <div class="admin-card admin-mb-xl" id="flagged-tickets-section" style="display: none;">
        <div class="admin-card-header" style="background: var(--color-danger-bg, #fee); border-left: 4px solid var(--color-danger, #e11d48);">
          <h2 class="admin-card-title" style="color: var(--color-danger, #e11d48);">
            <span style="font-size: 1.2em; margin-right: 8px;">‚ö†Ô∏è</span>
            Flagged Tickets - Security Review Required
          </h2>
          <div class="admin-card-actions">
            <span id="flagged-tickets-count" class="admin-badge admin-badge-danger">0 flagged</span>
          </div>
        </div>
        <div class="admin-card-body">
          <div style="background: var(--color-warning-bg, #fff3cd); padding: 12px; border-radius: 4px; margin-bottom: 16px;">
            <p style="margin: 0; color: var(--color-text-primary);">
              <strong>Security Notice:</strong> These tickets were flagged due to suspicious webhook metadata (price tampering, invalid ticket types, etc.).
              Review validation errors and take action.
            </p>
          </div>
          <div id="flaggedTicketsTable">
            <div class="admin-loading">Loading flagged tickets...</div>
          </div>
        </div>
      </div>

      <!-- Events Section -->
      <div class="admin-card admin-mb-xl" id="events-section">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Events</h2>
          <div class="admin-card-actions">
            <span id="events-count" class="admin-badge">0 events</span>
          </div>
        </div>
        <div class="admin-card-body">
          <div id="eventsTable">
            <div class="admin-loading">Loading events...</div>
          </div>
        </div>
      </div>

      <!-- Ticket Types Section -->
      <div class="admin-card admin-mb-xl" id="ticket-types-section">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Ticket Types & Availability</h2>
          <div class="admin-card-actions">
            <span id="ticket-types-count" class="admin-badge">0 types</span>
          </div>
        </div>
        <div class="admin-card-body">
          <div id="ticketTypesTable">
            <div class="admin-loading">Loading ticket types...</div>
          </div>
        </div>
      </div>
    </main>

    <!-- Registrations Section -->
    <div class="admin-card admin-mb-xl" id="registrations">
      <!-- Additional anchor for transactions (points to same section) -->
      <span id="transactions"></span>
      <div class="admin-card-header">
        <h2 class="admin-card-title">Registrations</h2>
        <div class="admin-card-actions">
          <button class="admin-btn admin-btn-sm" onclick="exportToCSV()">
            <span>Export CSV</span>
          </button>
        </div>
      </div>
      <div class="admin-card-body">

        <div class="admin-flex admin-flex-wrap admin-gap-md admin-mb-xl">
          <input
            type="text"
            id="searchInput"
            class="admin-form-input"
            placeholder="Search by name, email, or ticket ID..."
            onkeypress="if(event.key==='Enter') searchRegistrations()"
            data-testid="search-registrations"
            style="flex: 1; min-width: 250px"
          />
          <select
            id="statusFilter"
            class="admin-form-select"
            onchange="searchRegistrations()"
            data-testid="ticket-type-filter"
            style="min-width: 120px"
          >
            <option value="">All Status</option>
            <option value="valid">Valid</option>
            <option value="cancelled">Cancelled</option>
            <option value="transferred">Transferred</option>
          </select>
          <select
            id="paymentMethodFilter"
            class="admin-form-select"
            onchange="searchRegistrations()"
            style="min-width: 150px"
          >
            <option value="">All Payment Methods</option>
            <option value="stripe">Stripe</option>
            <option value="paypal">PayPal</option>
          </select>
          <select 
            id="checkinFilter" 
            class="admin-form-select" 
            onchange="searchRegistrations()"
            style="min-width: 150px"
          >
            <option value="">All Tickets</option>
            <option value="false">Not Checked In</option>
            <option value="true">Checked In</option>
          </select>
          <button 
            class="admin-btn admin-btn-primary" 
            onclick="searchRegistrations()" 
            data-testid="search-button"
          >
            <span>Search</span>
          </button>
        </div>

        <div id="registrationsTable" data-testid="registrations-table">
          <div class="admin-loading">Loading registrations...</div>
        </div>

        <div class="pagination admin-flex admin-justify-center admin-gap-sm admin-mt-xl" id="pagination"></div>
      </div>
    </div>

    <script>
      // Security improvements:
      // 1. All user-provided data is escaped using escapeHtml() to prevent XSS attacks
      // 2. CSRF tokens are fetched and included in all state-changing requests
      // 3. Error messages are safely displayed using textContent or escapeHtml()

      let currentPage = 0;
      const pageSize = 50;
      let authToken = null;
      let csrfToken = null;
      let timeManager = null;

      // Import timeManager
      import('/js/time-manager.js').then(module => {
        timeManager = module.default;
      });

      // HTML escaping function to prevent XSS attacks
      // CRITICAL: Use this for ALL user-provided data displayed in innerHTML
      function escapeHtml(unsafe) {
        if (unsafe == null) return "";
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Fetch CSRF token
      async function fetchCSRFToken() {
        try {
          const response = await fetch("/api/admin/csrf-token", {
            headers: {
              "Authorization": `Bearer ${localStorage.getItem('adminToken')}`
            }
          });
          if (response.ok) {
            const data = await response.json();
            csrfToken = data.csrfToken;
            // Refresh token before it expires (50 minutes)
            setTimeout(fetchCSRFToken, 50 * 60 * 1000);
          }
        } catch (error) {
          console.warn("Failed to fetch CSRF token:", error);
          // Continue without CSRF token for backward compatibility
        }
      }

      // ‚úÖ PROPER AUTH CHECK - Use verify-session endpoint with credentials
      async function checkAuth() {
        try {
          // Get token from localStorage
          const token = localStorage.getItem('adminToken');
          if (!token) {
            window.location.replace("/admin/login");
            return false;
          }

          const response = await fetch("/api/admin/verify-session", {
            headers: {
              "Authorization": `Bearer ${token}`,
              "Cache-Control": "no-cache"
            }
          });

          if (!response.ok) {
            // Clear invalid token and redirect
            localStorage.removeItem('adminToken');
            window.location.replace("/admin/login");
            return false;
          }

          // Success - verify the session is valid
          const data = await response.json();
          if (!data.valid) {
            localStorage.removeItem('adminToken');
            window.location.replace("/admin/login");
            return false;
          }

          // Session is valid - show the content with smooth transition
          document.documentElement.style.visibility = 'visible';
          document.documentElement.style.opacity = '1';
          document.body.style.visibility = 'visible';
          document.body.setAttribute("data-auth-status", "authenticated");

          // Hide loading overlay if it exists
          const loadingOverlay = document.getElementById('auth-loading');
          if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
          }

          return true;
        } catch (error) {
          console.error("Auth check failed:", error);
          document.body.setAttribute("data-auth-status", "error");
          window.location.replace("/admin/login");
          return false;
        }
      }

      // Load dashboard data
      async function loadDashboardData(eventId) {
        // Ensure auth status is set immediately
        if (!document.body.getAttribute("data-auth-status")) {
          document.body.setAttribute("data-auth-status", "checking");
        }

        try {
          // Auth check already done in DOMContentLoaded, proceed with dashboard data
          // Now fetch the actual dashboard data with credentials
          const url = new URL("/api/admin/dashboard", window.location.origin);
          if (eventId && eventId !== 'all') {
            url.searchParams.set('eventId', eventId);
          }

          const token = localStorage.getItem('adminToken');
          if (!token) {
            throw new Error('No authentication token found');
          }

          const response = await fetch(url.toString(), {
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            }
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to load dashboard');
          }

          const data = await response.json();

          // Fetch CSRF token after successful auth check
          await fetchCSRFToken();

          displayStats(data.stats);
          displayEvents(data.events || []);
          displayTicketTypes(data.ticketTypes || []);

          await loadFlaggedTickets();
          await loadRegistrations();
        } catch (error) {
          console.error("Failed to load dashboard:", error);
          document.getElementById("statsGrid").innerHTML = `
                    <div class="error">Failed to load dashboard: ${escapeHtml(error.message)}</div>
                `;
        }
      }

      // Load flagged tickets
      async function loadFlaggedTickets() {
        try {
          const token = localStorage.getItem('adminToken');
          if (!token) {
            throw new Error('No authentication token found');
          }

          const response = await fetch('/api/admin/flagged-tickets?limit=50&offset=0', {
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            }
          });

          if (!response.ok) {
            throw new Error('Failed to load flagged tickets');
          }

          const data = await response.json();
          displayFlaggedTickets(data.flaggedTickets || [], data.total || 0);

        } catch (error) {
          console.error('Failed to load flagged tickets:', error);
          document.getElementById('flaggedTicketsTable').innerHTML = `
            <div class="error">Failed to load flagged tickets: ${escapeHtml(error.message)}</div>
          `;
        }
      }

      // Display flagged tickets
      function displayFlaggedTickets(tickets, total) {
        const section = document.getElementById('flagged-tickets-section');
        const table = document.getElementById('flaggedTicketsTable');
        const countBadge = document.getElementById('flagged-tickets-count');

        // Update count badge
        countBadge.textContent = `${total} flagged`;

        // Show/hide section based on whether there are flagged tickets
        if (total === 0) {
          section.style.display = 'none';
          return;
        }

        section.style.display = 'block';

        if (tickets.length === 0) {
          table.innerHTML = '<p class="admin-text-center admin-p-xl">No flagged tickets to review</p>';
          return;
        }

        // Build table
        const rows = tickets.map(ticket => {
          const severityClass = {
            'critical': 'admin-badge-danger',
            'high': 'admin-badge-warning',
            'medium': 'admin-badge-info',
            'low': 'admin-badge-secondary'
          }[ticket.severity] || 'admin-badge-secondary';

          const severityIcon = {
            'critical': 'üî¥',
            'high': 'üü†',
            'medium': 'üü°',
            'low': '‚ö™'
          }[ticket.severity] || '‚ö™';

          const errorsList = ticket.validation_errors && ticket.validation_errors.length > 0
            ? ticket.validation_errors.map(err => `<li>${escapeHtml(err)}</li>`).join('')
            : '<li>No validation errors recorded</li>';

          return `
            <tr>
              <td>
                <code style="background: var(--color-background-secondary); padding: 4px 8px; border-radius: 4px;">
                  ${escapeHtml(ticket.ticket_id)}
                </code>
              </td>
              <td>${escapeHtml(ticket.order_id || 'N/A')}</td>
              <td>
                <strong>${escapeHtml(ticket.customer_name || 'Unknown')}</strong><br>
                <small>${escapeHtml(ticket.customer_email || 'N/A')}</small>
              </td>
              <td>
                <span class="admin-badge ${severityClass}">
                  ${severityIcon} ${escapeHtml(ticket.severity.toUpperCase())}
                </span>
              </td>
              <td>
                <button
                  class="admin-btn admin-btn-sm admin-btn-ghost"
                  onclick="showValidationDetails('${escapeHtml(ticket.ticket_id)}')"
                  title="View validation errors"
                >
                  <span>View Details</span>
                </button>
                <div id="validation-details-${escapeHtml(ticket.ticket_id)}" style="display: none;">
                  <ul style="margin: 8px 0; padding-left: 20px; font-size: 0.9em;">
                    ${errorsList}
                  </ul>
                </div>
              </td>
              <td>${escapeHtml(ticket.created_at_display || ticket.created_at || 'N/A')}</td>
              <td>
                <button
                  class="admin-btn admin-btn-sm admin-btn-success"
                  onclick="handleFlaggedTicketAction('${escapeHtml(ticket.ticket_id)}', 'mark_safe')"
                  title="Mark ticket as safe"
                >
                  <span>Mark Safe</span>
                </button>
                <button
                  class="admin-btn admin-btn-sm admin-btn-danger"
                  onclick="handleFlaggedTicketAction('${escapeHtml(ticket.ticket_id)}', 'cancel_ticket')"
                  title="Cancel this ticket"
                >
                  <span>Cancel</span>
                </button>
              </td>
            </tr>
          `;
        }).join('');

        table.innerHTML = `
          <div class="admin-table-responsive">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Ticket ID</th>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Severity</th>
                  <th>Validation Errors</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        `;
      }

      // Show validation details for a flagged ticket
      function showValidationDetails(ticketId) {
        const detailsDiv = document.getElementById(`validation-details-${ticketId}`);
        if (detailsDiv) {
          if (detailsDiv.style.display === 'none') {
            detailsDiv.style.display = 'block';
          } else {
            detailsDiv.style.display = 'none';
          }
        }
      }

      // Handle actions on flagged tickets
      async function handleFlaggedTicketAction(ticketId, action) {
        const actionText = action === 'mark_safe' ? 'mark this ticket as safe' : 'cancel this ticket';
        const confirmMessage = `Are you sure you want to ${actionText}?\n\nTicket ID: ${ticketId}`;

        if (!confirm(confirmMessage)) {
          return;
        }

        try {
          const token = localStorage.getItem('adminToken');
          if (!token) {
            throw new Error('No authentication token found');
          }

          const headers = {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          };

          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const response = await fetch(`/api/admin/flagged-tickets?ticketId=${encodeURIComponent(ticketId)}`, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify({ action })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Action failed');
          }

          const result = await response.json();
          alert(result.message || 'Action completed successfully');

          // Reload flagged tickets
          await loadFlaggedTickets();

        } catch (error) {
          console.error('Failed to perform action on flagged ticket:', error);
          alert(`Failed to ${actionText}: ${error.message}`);
        }
      }

      // Make functions globally available
      window.showValidationDetails = showValidationDetails;
      window.handleFlaggedTicketAction = handleFlaggedTicketAction;

      // Make loadDashboardData available globally for event selector
      window.loadDashboardData = loadDashboardData;

      // Display statistics
      function displayStats(stats) {
        const statsGrid = document.getElementById("statsGrid");

        // Calculate percentage safely when division by zero might occur
        const checkinPercentage = stats.total_tickets > 0
          ? Math.round((stats.checked_in / stats.total_tickets) * 100)
          : 0;

        statsGrid.innerHTML = `
                <div class="admin-stat-card">
                    <h3 class="stat-label">Total Tickets</h3>
                    <div class="stat-number">${stats.total_tickets || 0}</div>
                </div>
                <div class="admin-stat-card">
                    <h3 class="stat-label">Checked In</h3>
                    <div class="stat-number">${stats.checked_in || 0}</div>
                    <div class="stat-label admin-mt-sm">${checkinPercentage}%</div>
                </div>
                <div class="admin-stat-card">
                    <h3 class="stat-label">Revenue</h3>
                    <div class="stat-number">$${(stats.total_revenue || 0).toFixed(2)}</div>
                </div>
                <div class="admin-stat-card">
                    <h3 class="stat-label">Orders</h3>
                    <div class="stat-number">${stats.total_orders || 0}</div>
                </div>
                <div class="admin-stat-card">
                    <h3 class="stat-label">Workshop Tickets</h3>
                    <div class="stat-number">${stats.workshop_tickets || 0}</div>
                </div>
                <div class="admin-stat-card">
                    <h3 class="stat-label">VIP Tickets</h3>
                    <div class="stat-number">${stats.vip_tickets || 0}</div>
                </div>
                <!-- Wallet Statistics -->
                <div class="admin-stat-card">
                    <h3 class="stat-label">Apple Wallet</h3>
                    <div class="stat-number">${stats.apple_wallet_users || 0}</div>
                    <div class="stat-label admin-mt-sm">${stats.total_tickets ? Math.round((stats.apple_wallet_users / stats.total_tickets) * 100) : 0}% adoption</div>
                </div>
                <div class="admin-stat-card">
                    <h3 class="stat-label">Google Wallet</h3>
                    <div class="stat-number">${stats.google_wallet_users || 0}</div>
                    <div class="stat-label admin-mt-sm">${stats.total_tickets ? Math.round((stats.google_wallet_users / stats.total_tickets) * 100) : 0}% adoption</div>
                </div>
                <div class="admin-stat-card">
                    <h3 class="stat-label">QR Generated</h3>
                    <div class="stat-number">${stats.qr_generated || 0}</div>
                    <div class="stat-label admin-mt-sm">${stats.total_tickets ? Math.round((stats.qr_generated / stats.total_tickets) * 100) : 0}% ready</div>
                </div>
            `;
      }

      // Display events list
      function displayEvents(events) {
        const eventsTable = document.getElementById('eventsTable');
        const eventsCount = document.getElementById('events-count');

        if (!events || events.length === 0) {
          eventsTable.innerHTML = '<div class="admin-empty-state">No events found</div>';
          eventsCount.textContent = '0 events';
          return;
        }

        eventsCount.textContent = `${events.length} event${events.length !== 1 ? 's' : ''}`;

        // Status badge colors
        const statusColors = {
          'active': 'success',
          'upcoming': 'info',
          'completed': 'secondary',
          'draft': 'warning',
          'cancelled': 'danger',
          'test': 'purple'
        };

        const rows = events.map(event => {
          const statusColor = statusColors[event.status] || 'secondary';
          const startDate = event.start_date ? (timeManager ? timeManager.formatDate(event.start_date) : new Date(event.start_date).toLocaleDateString()) : 'TBA';
          const endDate = event.end_date ? (timeManager ? timeManager.formatDate(event.end_date) : new Date(event.end_date).toLocaleDateString()) : 'TBA';

          return `
            <tr>
              <td><strong>${escapeHtml(event.name)}</strong></td>
              <td>${escapeHtml(event.slug || 'N/A')}</td>
              <td><span class="admin-badge admin-badge-${statusColor}">${escapeHtml(event.status)}</span></td>
              <td>${escapeHtml(event.type || 'N/A')}</td>
              <td>${startDate} - ${endDate}</td>
              <td>${escapeHtml(event.venue_name || 'TBA')}</td>
              <td>${event.max_capacity || 'N/A'}</td>
            </tr>
          `;
        }).join('');

        eventsTable.innerHTML = `
          <div class="admin-table-responsive">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Slug</th>
                  <th>Status</th>
                  <th>Type</th>
                  <th>Dates</th>
                  <th>Venue</th>
                  <th>Capacity</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        `;
      }

      // Display ticket types with availability
      function displayTicketTypes(ticketTypes) {
        const ticketTypesTable = document.getElementById('ticketTypesTable');
        const ticketTypesCount = document.getElementById('ticket-types-count');

        if (!ticketTypes || ticketTypes.length === 0) {
          ticketTypesTable.innerHTML = '<div class="admin-empty-state">No ticket types found</div>';
          ticketTypesCount.textContent = '0 types';
          return;
        }

        ticketTypesCount.textContent = `${ticketTypes.length} type${ticketTypes.length !== 1 ? 's' : ''}`;

        // Group by event
        const byEvent = {};
        ticketTypes.forEach(tt => {
          const eventKey = tt.event_name || 'Unknown Event';
          if (!byEvent[eventKey]) {
            byEvent[eventKey] = [];
          }
          byEvent[eventKey].push(tt);
        });

        const sections = Object.entries(byEvent).map(([eventName, tickets]) => {
          const rows = tickets.map(tt => {
            const soldCount = tt.sold_count || 0;
            const maxQuantity = tt.max_quantity || 0;
            const remaining = tt.remaining_quantity || 0;
            const percentage = tt.availability_percentage || 0;
            const revenue = (tt.total_revenue_cents || 0) / 100;

            // Determine availability color: green (>50%), yellow (25-50%), red (<25%)
            let availabilityColor = 'success';
            let availabilityText = 'Available';
            if (tt.status === 'sold-out') {
              availabilityColor = 'danger';
              availabilityText = 'Sold Out';
            } else if (tt.status === 'coming-soon') {
              availabilityColor = 'info';
              availabilityText = 'Coming Soon';
            } else if (tt.status === 'closed') {
              availabilityColor = 'secondary';
              availabilityText = 'Closed';
            } else if (tt.status === 'test') {
              availabilityColor = 'purple';
              availabilityText = 'Test';
            } else if (maxQuantity > 0) {
              if (percentage >= 75) {
                availabilityColor = 'danger';
                availabilityText = 'Low Stock';
              } else if (percentage >= 50) {
                availabilityColor = 'warning';
                availabilityText = 'Medium Stock';
              }
            }

            const priceDisplay = tt.price_cents ? `$${(tt.price_cents / 100).toFixed(2)}` : 'TBA';

            return `
              <tr>
                <td><strong>${escapeHtml(tt.name)}</strong></td>
                <td>${priceDisplay}</td>
                <td><span class="admin-badge admin-badge-${availabilityColor}">${availabilityText}</span></td>
                <td>${soldCount} / ${maxQuantity > 0 ? maxQuantity : '‚àû'}</td>
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="flex: 1; background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                      <div style="width: ${percentage}%; background: ${percentage >= 75 ? '#ef4444' : percentage >= 50 ? '#f59e0b' : '#10b981'}; height: 100%;"></div>
                    </div>
                    <span style="min-width: 50px; text-align: right;">${percentage.toFixed(1)}%</span>
                  </div>
                </td>
                <td>${maxQuantity > 0 ? remaining : 'N/A'}</td>
                <td>$${revenue.toFixed(2)}</td>
              </tr>
            `;
          }).join('');

          return `
            <div style="margin-bottom: 24px;">
              <h3 style="margin: 16px 0 8px 0; padding: 8px 12px; background: var(--color-background-secondary); border-radius: 4px;">
                ${escapeHtml(eventName)}
              </h3>
              <div class="admin-table-responsive">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>Ticket Type</th>
                      <th>Price</th>
                      <th>Status</th>
                      <th>Sold / Capacity</th>
                      <th>Availability</th>
                      <th>Remaining</th>
                      <th>Revenue</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${rows}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }).join('');

        ticketTypesTable.innerHTML = sections;
      }


      // Load registrations
      async function loadRegistrations(page = 0) {
        currentPage = page;
        const offset = page * pageSize;

        const search = document.getElementById("searchInput").value;
        const status = document.getElementById("statusFilter").value;
        const checkedIn = document.getElementById("checkinFilter").value;
        const paymentMethod = document.getElementById("paymentMethodFilter").value;

        // Get selected event ID from event selector
        const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;

        const params = new URLSearchParams({
          limit: pageSize,
          offset: offset,
          ...(search && { search }),
          ...(status && { status }),
          ...(checkedIn && { checkedIn }),
          ...(paymentMethod && { paymentMethod }),
          ...(selectedEventId && { eventId: selectedEventId }),
        });

        try {
          const token = localStorage.getItem('adminToken');
          if (!token) {
            throw new Error('No authentication token found');
          }
          const response = await fetch(`/api/admin/registrations?${params}`, {
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            }
          });

          const data = await response.json();

          // Response handled locally for security

          if (!response.ok) {
            throw new Error(data.error || data.message || `HTTP ${response.status}`);
          }

          displayRegistrations(data.registrations);
          displayPagination(data.total, page);
        } catch (error) {
          console.error("Failed to load registrations:", error);

          // Enhanced error display for debugging
          let errorDetails = error.message;

          // If it's an import failure, try to extract more details from the response
          if (error.message.includes("Import failure")) {
            try {
              // Try to extract the response data for more details
              if (window.lastDebugResponse && window.lastDebugResponse.service && window.lastDebugResponse.message) {
                errorDetails = `Import failed in ${window.lastDebugResponse.service}: ${window.lastDebugResponse.message}`;
                console.error("üîç Full import error:", window.lastDebugResponse);
              }
            } catch (parseError) {
              console.error("Could not parse error details:", parseError);
            }
          }

          document.getElementById("registrationsTable").innerHTML = `
                    <div class="error">
                      <strong>Failed to load registrations:</strong><br>
                      ${escapeHtml(errorDetails)}<br>
                      <small>Check browser console and Network tab for more details</small>
                    </div>
                `;
        }
      }

      // Display registrations table
      function displayRegistrations(registrations) {
        if (registrations.length === 0) {
          document.getElementById("registrationsTable").innerHTML = `
                    <p class="admin-text-center admin-p-xl admin-text-muted">
                        No registrations found
                    </p>
                `;
          return;
        }

        const tableHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Order</th>
                            <th>Payment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${registrations
                          .map(
                            (reg) => {
                              const isTestTicket = reg.is_test === 1 || reg.ticket_id?.startsWith('TEST-');
                              const rowClass = isTestTicket ? 'test-ticket-row' : '';
                              const testBadge = isTestTicket ? '<span class="test-badge">TEST</span>' : '';

                              // Format payment processor information
                              const paymentProcessor = reg.payment_processor || 'stripe';
                              const processorIcon = paymentProcessor === 'paypal' ? 'üÖøÔ∏è' : 'üí≥';
                              const processorBadge = paymentProcessor === 'paypal' ? 'paypal-badge' : 'stripe-badge';
                              const transactionId = reg.paypal_order_id || reg.stripe_session_id || reg.transaction_id;

                              return `
                            <tr class="${rowClass}">
                                <td>
                                    <a href="/admin/ticket-detail?ticketId=${escapeHtml(reg.ticket_id)}"
                                       target="_blank"
                                       rel="noopener noreferrer"
                                       class="detail-link"
                                       title="View admin ticket details"
                                       style="text-decoration: none;">
                                      <code class="admin-p-xs" style="background: var(--color-background-secondary); border-radius: var(--radius-sm); cursor: pointer;">${escapeHtml(reg.ticket_id)}</code>
                                    </a>
                                    ${testBadge}
                                </td>
                                <td>
                                    ${escapeHtml(formatTicketType(reg.ticket_type))}
                                    ${isTestTicket ? '<small class="test-indicator">üß™ Test</small>' : ''}
                                </td>
                                <td>
                                    <span class="status-badge ${reg.checked_in_at ? "success" : reg.status === "valid" ? "info" : "warning"}">
                                        ${reg.checked_in_at ? "Checked In" : escapeHtml(reg.status)}
                                    </span>
                                </td>
                                <td>${escapeHtml(reg.transaction_id)}</td>
                                <td>
                                    <div class="payment-info">
                                        <span class="processor-badge ${processorBadge}" title="${paymentProcessor.toUpperCase()}">
                                            ${processorIcon} ${paymentProcessor.toUpperCase()}
                                        </span>
                                        <small class="transaction-ref" title="Transaction ID">${escapeHtml(transactionId)}</small>
                                    </div>
                                </td>
                                <td>
                                    ${
                                      reg.checked_in_at
                                        ? `<button class="admin-btn admin-btn-sm admin-btn-secondary" data-action="undo" data-ticket-id="${escapeHtml(reg.ticket_id)}" data-testid="checkin-reg_${escapeHtml(reg.ticket_id)}"><span>Undo</span></button>`
                                        : `<button class="admin-btn admin-btn-sm admin-btn-success" data-action="checkin" data-ticket-id="${escapeHtml(reg.ticket_id)}" data-testid="checkin-reg_${escapeHtml(reg.ticket_id)}"><span>Check In</span></button>`
                                    }
                                </td>
                            </tr>
                        `;
                            }
                          )
                          .join("")}
                    </tbody>
                </table>
            `;

        document.getElementById("registrationsTable").innerHTML = tableHTML;
      }

      // Display pagination
      function displayPagination(total, currentPage) {
        const totalPages = Math.ceil(total / pageSize);
        const pagination = document.getElementById("pagination");

        if (totalPages <= 1) {
          pagination.innerHTML = "";
          return;
        }

        pagination.innerHTML = `
                <button class="admin-btn admin-btn-ghost" onclick="loadRegistrations(0)" ${currentPage === 0 ? "disabled" : ""}>
                    <span>First</span>
                </button>
                <button class="admin-btn admin-btn-ghost" onclick="loadRegistrations(${currentPage - 1})" ${currentPage === 0 ? "disabled" : ""}>
                    <span>Previous</span>
                </button>
                <span class="admin-p-md admin-text-secondary" style="font-family: var(--font-code); font-size: var(--font-size-sm);">
                    Page ${currentPage + 1} of ${totalPages}
                </span>
                <button class="admin-btn admin-btn-ghost" onclick="loadRegistrations(${currentPage + 1})" ${currentPage >= totalPages - 1 ? "disabled" : ""}>
                    <span>Next</span>
                </button>
                <button class="admin-btn admin-btn-ghost" onclick="loadRegistrations(${totalPages - 1})" ${currentPage >= totalPages - 1 ? "disabled" : ""}>
                    <span>Last</span>
                </button>
            `;
      }

      // Search registrations
      function searchRegistrations() {
        loadRegistrations(0);
      }

      // Check in ticket
      async function checkinTicket(ticketId) {
        if (!confirm(`Check in ticket ${ticketId}?`)) return;

        try {
          const headers = { "Content-Type": "application/json" };
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const token = localStorage.getItem('adminToken');
          if (!token) {
            throw new Error('No authentication token found');
          }
          headers["Authorization"] = `Bearer ${token}`;

          const response = await fetch(
            `/api/admin/registrations?ticketId=${encodeURIComponent(ticketId)}`,
            {
              method: "PUT",
              headers: headers,
              body: JSON.stringify({ action: "checkin" }),
            },
          );

          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          await loadRegistrations(currentPage);
        } catch (error) {
          alert(`Failed to check in: ${escapeHtml(error.message)}`);
        }
      }

      // Undo check in
      async function undoCheckin(ticketId) {
        if (!confirm(`Undo check-in for ticket ${ticketId}?`)) return;

        try {
          const headers = { "Content-Type": "application/json" };
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const token = localStorage.getItem('adminToken');
          if (!token) {
            throw new Error('No authentication token found');
          }
          headers["Authorization"] = `Bearer ${token}`;

          const response = await fetch(
            `/api/admin/registrations?ticketId=${encodeURIComponent(ticketId)}`,
            {
              method: "PUT",
              headers: headers,
              body: JSON.stringify({ action: "undo_checkin" }),
            },
          );

          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          await loadRegistrations(currentPage);
        } catch (error) {
          alert(`Failed to undo check-in: ${escapeHtml(error.message)}`);
        }
      }

      // Export to CSV
      async function exportToCSV() {
        const search = document.getElementById("searchInput").value;
        const status = document.getElementById("statusFilter").value;
        const checkedIn = document.getElementById("checkinFilter").value;
        const paymentMethod = document.getElementById("paymentMethodFilter").value;

        // Get selected event ID from event selector
        const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;

        const params = new URLSearchParams({
          limit: 10000, // Export all
          offset: 0,
          ...(search && { search }),
          ...(status && { status }),
          ...(checkedIn && { checkedIn }),
          ...(paymentMethod && { paymentMethod }),
          ...(selectedEventId && { eventId: selectedEventId }),
        });

        try {
          const token = localStorage.getItem('adminToken');
          if (!token) {
            throw new Error('No authentication token found');
          }
          const response = await fetch(`/api/admin/registrations?${params}`, {
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            }
          });
          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          // Convert to CSV
          const csv = convertToCSV(data.registrations);

          // Download CSV
          const blob = new Blob([csv], { type: "text/csv" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          const timestamp = timeManager ? timeManager.formatDate(new Date()).replace(/\s/g, '-') : new Date().toISOString().split("T")[0];
          a.download = `registrations-${timestamp}.csv`;
          a.click();
        } catch (error) {
          alert(`Export failed: ${escapeHtml(error.message)}`);
        }
      }

      // Convert to CSV
      function convertToCSV(data) {
        if (data.length === 0) return "";

        const headers = [
          "Ticket ID",
          "First Name",
          "Last Name",
          "Email",
          "Ticket Type",
          "Status",
          "Checked In",
          "Order Number",
          "Payment Method",
          "Transaction ID",
        ];

        // Note: No HTML escaping needed for CSV export data
        // CSV format handles special characters differently
        const rows = data.map((row) => [
          row.ticket_id,
          row.attendee_first_name,
          row.attendee_last_name,
          row.attendee_email,
          row.ticket_type,
          row.status,
          row.checked_in_at ? "Yes" : "No",
          row.transaction_id,
          row.payment_processor || 'stripe',
          row.paypal_order_id || row.stripe_session_id || row.transaction_id,
        ]);

        return [
          headers.join(","),
          ...rows.map((row) =>
            row
              .map((cell) => `"${String(cell || "").replace(/"/g, '""')}"`)
              .join(","),
          ),
        ].join("\n");
      }

      // Format ticket type
      function formatTicketType(type) {
        const typeMap = {
          "vip-pass": "VIP Pass",
          "weekend-pass": "Weekend Pass",
          "friday-pass": "Friday",
          "saturday-pass": "Saturday",
          "sunday-pass": "Sunday",
          workshop: "Workshop",
          "general-admission": "General",
        };
        return typeMap[type] || type;
      }

      // Logout
      async function logout() {
        try {
          const headers = {};
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const token = localStorage.getItem('adminToken');
          if (token) {
            headers["Authorization"] = `Bearer ${token}`;
          }
          await fetch("/api/admin/login", {
            method: "DELETE",
            headers: headers,
          });
        } finally {
          // Clear client storage
          localStorage.removeItem('adminToken');
          sessionStorage.clear();
          // Redirect
          window.location.href = '/admin/login';
        }
      }

      // Sync to Google Sheets
      async function syncToSheets() {
        const btn = event.target;
        const originalText = btn.textContent;

        btn.disabled = true;
        btn.textContent = "Syncing...";

        try {
          const token = localStorage.getItem('adminToken');
          const response = await fetch("/api/sheets/sync", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": csrfToken,
              "Authorization": `Bearer ${token}`
            },
          });

          const data = await response.json();

          if (response.ok) {
            if (data.sheetUrl) {
              alert(
                `‚úÖ Sync completed!\n\nView your data at:\n${data.sheetUrl}`,
              );
            } else {
              alert(`‚úÖ Sync completed at ${data.timestamp}`);
            }
          } else {
            alert(`‚ùå Sync failed: ${data.message || data.error}`);
          }
        } catch (error) {
          alert(`‚ùå Sync failed: ${error.message}`);
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }

      // Add event delegation for check-in buttons
      document
        .getElementById("registrationsTable")
        .addEventListener("click", function (event) {
          if (event.target.matches(".admin-btn[data-action]") || 
              (event.target.parentElement && event.target.parentElement.matches(".admin-btn[data-action]"))) {
            const button = event.target.matches(".admin-btn[data-action]") 
              ? event.target 
              : event.target.parentElement;
            const action = button.getAttribute("data-action");
            const ticketId = button.getAttribute("data-ticket-id");

            if (action === "checkin") {
              checkinTicket(ticketId);
            } else if (action === "undo") {
              undoCheckin(ticketId);
            }
          }
        });


      // Global auth promise to prevent race conditions
      let authPromise = null;

      // Initialize dashboard with single auth check
      document.body.setAttribute('data-auth-status', 'checking');

      // Initialize event selector and load dashboard data
      document.addEventListener('DOMContentLoaded', async () => {
        // CRITICAL: Use single auth check to prevent race conditions
        if (!authPromise) {
          authPromise = checkAuth();
        }
        const isAuthenticated = await authPromise;

        // If auth failed, checkAuth will redirect, so stop here
        if (!isAuthenticated) {
          return;
        }

        // Only proceed with initialization if authenticated
        if (window.eventSelector) {
          await window.eventSelector.init();

          // Render event selector in navigation
          window.eventSelector.render('event-selector-container');

          // Load dashboard with selected event
          const selectedEventId = window.eventSelector.getSelectedEventId();
          loadDashboardData(selectedEventId);
        } else {
          // Fallback if event selector not available
          loadDashboardData(null);
        }
      });

      // Refresh data every 30 seconds
      setInterval(() => {
        const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;
        loadDashboardData(selectedEventId);
      }, 30000);
    </script>

    <script src="/js/admin-event-selector.js"></script>
  </body>
</html>
