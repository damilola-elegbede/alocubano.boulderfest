<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - A Lo Cubano Boulder Fest</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          sans-serif;
        background: #f5f7fa;
        color: #333;
      }

      .admin-header {
        background: #2c3e50;
        color: white;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .admin-header h1 {
        font-size: 24px;
        font-weight: 500;
      }

      .logout-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .logout-btn:hover {
        background: #c0392b;
      }

      .portal-btn {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
      }

      .portal-btn:hover {
        background: #138496;
      }

      .analytics-btn {
        background: #9c27b0;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
      }

      .analytics-btn:hover {
        background: #7b1fa2;
      }

      .sync-btn {
        background: #0f9d58;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
      }

      .sync-btn:hover {
        background: #0b7938;
      }

      .sync-btn:disabled {
        background: #95a5a6;
        cursor: not-allowed;
      }

      .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .stat-card h3 {
        color: #7f8c8d;
        font-size: 14px;
        font-weight: 500;
        text-transform: uppercase;
        margin-bottom: 10px;
      }

      .stat-number {
        font-size: 32px;
        font-weight: bold;
        color: #2c3e50;
      }

      .stat-label {
        color: #95a5a6;
        font-size: 12px;
        margin-top: 5px;
      }

      .section {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #ecf0f1;
      }

      .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #2c3e50;
      }

      .search-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .search-bar input {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .search-bar select {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        background: white;
      }

      .search-bar button {
        padding: 10px 25px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .search-bar button:hover {
        background: #2980b9;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #7f8c8d;
        font-size: 12px;
        text-transform: uppercase;
        border-bottom: 2px solid #e9ecef;
      }

      .data-table td {
        padding: 12px;
        border-bottom: 1px solid #e9ecef;
        font-size: 14px;
      }

      .data-table tr:hover {
        background: #f8f9fa;
      }

      .ticket-id {
        font-family: monospace;
        font-size: 12px;
        background: #ecf0f1;
        padding: 2px 6px;
        border-radius: 3px;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-valid {
        background: #d4edda;
        color: #155724;
      }
      .status-checked-in {
        background: #cce5ff;
        color: #004085;
      }
      .status-cancelled {
        background: #f8d7da;
        color: #721c24;
      }

      .checkin-btn {
        padding: 6px 12px;
        background: #27ae60;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }

      .checkin-btn:hover {
        background: #229954;
      }

      .checkin-btn:disabled {
        background: #95a5a6;
        cursor: not-allowed;
      }

      .pagination {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
      }

      .pagination button {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .pagination button:hover:not(:disabled) {
        background: #f8f9fa;
      }

      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .pagination .page-info {
        padding: 8px 12px;
        color: #7f8c8d;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }

      @media (max-width: 768px) {
        .dashboard-container {
          padding: 15px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .data-table {
          font-size: 12px;
        }

        .data-table th,
        .data-table td {
          padding: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-header">
      <h1>Admin Dashboard</h1>
      <div class="header-actions">
        <button
          class="portal-btn"
          onclick="location.href='/pages/admin/index.html'"
        >
          🎯 Portal
        </button>
        <button
          class="analytics-btn"
          onclick="location.href='/pages/admin/analytics.html'"
        >
          📈 Analytics
        </button>
        <button class="sync-btn" onclick="syncToSheets()">
          📊 Sync to Sheets
        </button>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="dashboard-container">
      <!-- Statistics -->
      <div class="stats-grid" id="statsGrid">
        <div class="loading">Loading statistics...</div>
      </div>

      <!-- Registrations Section (also handles transactions) -->
      <div class="section" id="registrations">
        <!-- Additional anchor for transactions (points to same section) -->
        <span id="transactions"></span>
        <div class="section-header">
          <h2 class="section-title">Registrations</h2>
        </div>

        <div class="search-bar">
          <input
            type="text"
            id="searchInput"
            placeholder="Search by name, email, or ticket ID..."
            onkeypress="if(event.key==='Enter') searchRegistrations()"
          />
          <select id="statusFilter" onchange="searchRegistrations()">
            <option value="">All Status</option>
            <option value="valid">Valid</option>
            <option value="cancelled">Cancelled</option>
            <option value="transferred">Transferred</option>
          </select>
          <select id="checkinFilter" onchange="searchRegistrations()">
            <option value="">All Tickets</option>
            <option value="false">Not Checked In</option>
            <option value="true">Checked In</option>
          </select>
          <button onclick="searchRegistrations()">Search</button>
          <button onclick="exportToCSV()">Export CSV</button>
        </div>

        <div id="registrationsTable">
          <div class="loading">Loading registrations...</div>
        </div>

        <div class="pagination" id="pagination"></div>
      </div>
    </div>

    <script>
      // Security improvements:
      // 1. All user-provided data is escaped using escapeHtml() to prevent XSS attacks
      // 2. CSRF tokens are fetched and included in all state-changing requests
      // 3. Error messages are safely displayed using textContent or escapeHtml()

      let currentPage = 0;
      const pageSize = 50;
      let authToken = null;
      let csrfToken = null;

      // HTML escaping function to prevent XSS attacks
      // CRITICAL: Use this for ALL user-provided data displayed in innerHTML
      function escapeHtml(unsafe) {
        if (unsafe == null) return "";
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Fetch CSRF token
      async function fetchCSRFToken() {
        try {
          const response = await fetch("/api/admin/csrf-token");
          if (response.ok) {
            const data = await response.json();
            csrfToken = data.csrfToken;
            // Refresh token before it expires (50 minutes)
            setTimeout(fetchCSRFToken, 50 * 60 * 1000);
          }
        } catch (error) {
          console.warn("Failed to fetch CSRF token:", error);
          // Continue without CSRF token for backward compatibility
        }
      }

      // Check authentication on load
      async function checkAuth() {
        try {
          // Try to use existing session
          const response = await fetch("/api/admin/dashboard");

          if (!response.ok) {
            // Not authenticated, redirect to login
            window.location.href = "/pages/admin/login.html";
            return false;
          }

          // Fetch CSRF token after successful auth check
          await fetchCSRFToken();

          return true;
        } catch (error) {
          console.error("Auth check failed:", error);
          window.location.href = "/pages/admin/login.html";
          return false;
        }
      }

      // Load dashboard data
      async function loadDashboard() {
        if (!(await checkAuth())) return;

        try {
          const response = await fetch("/api/admin/dashboard");
          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          displayStats(data.stats);
          await loadRegistrations();
        } catch (error) {
          console.error("Failed to load dashboard:", error);
          document.getElementById("statsGrid").innerHTML = `
                    <div class="error">Failed to load dashboard: ${escapeHtml(error.message)}</div>
                `;
        }
      }

      // Display statistics
      function displayStats(stats) {
        const statsGrid = document.getElementById("statsGrid");

        statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Total Tickets</h3>
                    <div class="stat-number">${stats.total_tickets || 0}</div>
                </div>
                <div class="stat-card">
                    <h3>Checked In</h3>
                    <div class="stat-number">${stats.checked_in || 0}</div>
                    <div class="stat-label">${Math.round((stats.checked_in / stats.total_tickets) * 100) || 0}%</div>
                </div>
                <div class="stat-card">
                    <h3>Total Revenue</h3>
                    <div class="stat-number">$${(stats.total_revenue || 0).toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Orders</h3>
                    <div class="stat-number">${stats.total_orders || 0}</div>
                </div>
                <div class="stat-card">
                    <h3>Workshop Tickets</h3>
                    <div class="stat-number">${stats.workshop_tickets || 0}</div>
                </div>
                <div class="stat-card">
                    <h3>VIP Tickets</h3>
                    <div class="stat-number">${stats.vip_tickets || 0}</div>
                </div>
                <!-- Wallet Statistics -->
                <div class="stat-card" style="border-left: 3px solid #000;">
                    <h3>Apple Wallet</h3>
                    <div class="stat-number">${stats.apple_wallet_users || 0}</div>
                    <div class="stat-label">${stats.total_tickets ? Math.round((stats.apple_wallet_users / stats.total_tickets) * 100) : 0}% adoption</div>
                </div>
                <div class="stat-card" style="border-left: 3px solid #4285f4;">
                    <h3>Google Wallet</h3>
                    <div class="stat-number">${stats.google_wallet_users || 0}</div>
                    <div class="stat-label">${stats.total_tickets ? Math.round((stats.google_wallet_users / stats.total_tickets) * 100) : 0}% adoption</div>
                </div>
                <div class="stat-card">
                    <h3>QR Generated</h3>
                    <div class="stat-number">${stats.qr_generated || 0}</div>
                    <div class="stat-label">${stats.total_tickets ? Math.round((stats.qr_generated / stats.total_tickets) * 100) : 0}% ready</div>
                </div>
            `;
      }

      // Load registrations
      async function loadRegistrations(page = 0) {
        currentPage = page;
        const offset = page * pageSize;

        const search = document.getElementById("searchInput").value;
        const status = document.getElementById("statusFilter").value;
        const checkedIn = document.getElementById("checkinFilter").value;

        const params = new URLSearchParams({
          limit: pageSize,
          offset: offset,
          ...(search && { search }),
          ...(status && { status }),
          ...(checkedIn && { checkedIn }),
        });

        try {
          const response = await fetch(`/api/admin/registrations?${params}`);
          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          displayRegistrations(data.registrations);
          displayPagination(data.total, page);
        } catch (error) {
          console.error("Failed to load registrations:", error);
          document.getElementById("registrationsTable").innerHTML = `
                    <div class="error">Failed to load registrations: ${escapeHtml(error.message)}</div>
                `;
        }
      }

      // Display registrations table
      function displayRegistrations(registrations) {
        if (registrations.length === 0) {
          document.getElementById("registrationsTable").innerHTML = `
                    <p style="text-align: center; padding: 20px; color: #7f8c8d;">
                        No registrations found
                    </p>
                `;
          return;
        }

        const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Order</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${registrations
                          .map(
                            (reg) => `
                            <tr>
                                <td><span class="ticket-id">${escapeHtml(reg.ticket_id)}</span></td>
                                <td>${escapeHtml(reg.attendee_first_name)} ${escapeHtml(reg.attendee_last_name)}</td>
                                <td>${escapeHtml(reg.attendee_email)}</td>
                                <td>${escapeHtml(formatTicketType(reg.ticket_type))}</td>
                                <td>
                                    <span class="status-badge status-${reg.checked_in_at ? "checked-in" : escapeHtml(reg.status)}">
                                        ${reg.checked_in_at ? "Checked In" : escapeHtml(reg.status)}
                                    </span>
                                </td>
                                <td>${escapeHtml(reg.order_number)}</td>
                                <td>
                                    ${
                                      reg.checked_in_at
                                        ? `<button class="checkin-btn" data-action="undo" data-ticket-id="${escapeHtml(reg.ticket_id)}">Undo</button>`
                                        : `<button class="checkin-btn" data-action="checkin" data-ticket-id="${escapeHtml(reg.ticket_id)}">Check In</button>`
                                    }
                                </td>
                            </tr>
                        `,
                          )
                          .join("")}
                    </tbody>
                </table>
            `;

        document.getElementById("registrationsTable").innerHTML = tableHTML;
      }

      // Display pagination
      function displayPagination(total, currentPage) {
        const totalPages = Math.ceil(total / pageSize);
        const pagination = document.getElementById("pagination");

        if (totalPages <= 1) {
          pagination.innerHTML = "";
          return;
        }

        pagination.innerHTML = `
                <button onclick="loadRegistrations(0)" ${currentPage === 0 ? "disabled" : ""}>
                    First
                </button>
                <button onclick="loadRegistrations(${currentPage - 1})" ${currentPage === 0 ? "disabled" : ""}>
                    Previous
                </button>
                <span class="page-info">
                    Page ${currentPage + 1} of ${totalPages}
                </span>
                <button onclick="loadRegistrations(${currentPage + 1})" ${currentPage >= totalPages - 1 ? "disabled" : ""}>
                    Next
                </button>
                <button onclick="loadRegistrations(${totalPages - 1})" ${currentPage >= totalPages - 1 ? "disabled" : ""}>
                    Last
                </button>
            `;
      }

      // Search registrations
      function searchRegistrations() {
        loadRegistrations(0);
      }

      // Check in ticket
      async function checkinTicket(ticketId) {
        if (!confirm(`Check in ticket ${ticketId}?`)) return;

        try {
          const headers = { "Content-Type": "application/json" };
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const response = await fetch(
            `/api/admin/registrations?ticketId=${encodeURIComponent(ticketId)}`,
            {
              method: "PUT",
              headers: headers,
              body: JSON.stringify({ action: "checkin" }),
            },
          );

          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          await loadRegistrations(currentPage);
        } catch (error) {
          alert(`Failed to check in: ${escapeHtml(error.message)}`);
        }
      }

      // Undo check in
      async function undoCheckin(ticketId) {
        if (!confirm(`Undo check-in for ticket ${ticketId}?`)) return;

        try {
          const headers = { "Content-Type": "application/json" };
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const response = await fetch(
            `/api/admin/registrations?ticketId=${encodeURIComponent(ticketId)}`,
            {
              method: "PUT",
              headers: headers,
              body: JSON.stringify({ action: "undo_checkin" }),
            },
          );

          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          await loadRegistrations(currentPage);
        } catch (error) {
          alert(`Failed to undo check-in: ${escapeHtml(error.message)}`);
        }
      }

      // Export to CSV
      async function exportToCSV() {
        const search = document.getElementById("searchInput").value;
        const status = document.getElementById("statusFilter").value;
        const checkedIn = document.getElementById("checkinFilter").value;

        const params = new URLSearchParams({
          limit: 10000, // Export all
          offset: 0,
          ...(search && { search }),
          ...(status && { status }),
          ...(checkedIn && { checkedIn }),
        });

        try {
          const response = await fetch(`/api/admin/registrations?${params}`);
          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          // Convert to CSV
          const csv = convertToCSV(data.registrations);

          // Download
          const blob = new Blob([csv], { type: "text/csv" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `registrations-${new Date().toISOString().split("T")[0]}.csv`;
          a.click();
        } catch (error) {
          alert(`Export failed: ${escapeHtml(error.message)}`);
        }
      }

      // Convert to CSV
      function convertToCSV(data) {
        if (data.length === 0) return "";

        const headers = [
          "Ticket ID",
          "First Name",
          "Last Name",
          "Email",
          "Ticket Type",
          "Status",
          "Checked In",
          "Order Number",
        ];

        // Note: No HTML escaping needed for CSV export data
        // CSV format handles special characters differently
        const rows = data.map((row) => [
          row.ticket_id,
          row.attendee_first_name,
          row.attendee_last_name,
          row.attendee_email,
          row.ticket_type,
          row.status,
          row.checked_in_at ? "Yes" : "No",
          row.order_number,
        ]);

        return [
          headers.join(","),
          ...rows.map((row) =>
            row
              .map((cell) => `"${String(cell || "").replace(/"/g, '""')}"`)
              .join(","),
          ),
        ].join("\n");
      }

      // Format ticket type
      function formatTicketType(type) {
        const typeMap = {
          "vip-pass": "VIP Pass",
          "weekend-pass": "Weekend Pass",
          "friday-pass": "Friday",
          "saturday-pass": "Saturday",
          "sunday-pass": "Sunday",
          workshop: "Workshop",
          "general-admission": "General",
        };
        return typeMap[type] || type;
      }

      // Logout
      async function logout() {
        try {
          const headers = {};
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          await fetch("/api/admin/login", {
            method: "DELETE",
            headers: headers,
          });
          window.location.href = "/pages/admin/login.html";
        } catch (error) {
          console.error("Logout failed:", error);
          window.location.href = "/pages/admin/login.html";
        }
      }

      // Sync to Google Sheets
      async function syncToSheets() {
        const btn = event.target;
        const originalText = btn.textContent;

        btn.disabled = true;
        btn.textContent = "Syncing...";

        try {
          const response = await fetch("/api/sheets/sync", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (response.ok) {
            if (data.sheetUrl) {
              alert(
                `✅ Sync completed!\n\nView your data at:\n${data.sheetUrl}`,
              );
            } else {
              alert(`✅ Sync completed at ${data.timestamp}`);
            }
          } else {
            alert(`❌ Sync failed: ${data.message || data.error}`);
          }
        } catch (error) {
          alert(`❌ Sync failed: ${error.message}`);
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }

      // Add event delegation for check-in buttons
      document
        .getElementById("registrationsTable")
        .addEventListener("click", function (event) {
          if (event.target.matches(".checkin-btn[data-action]")) {
            const action = event.target.getAttribute("data-action");
            const ticketId = event.target.getAttribute("data-ticket-id");

            if (action === "checkin") {
              checkinTicket(ticketId);
            } else if (action === "undo") {
              undoCheckin(ticketId);
            }
          }
        });

      // Initialize dashboard
      loadDashboard();

      // Refresh data every 30 seconds
      setInterval(() => {
        loadDashboard();
      }, 30000);
    </script>
  </body>
</html>
