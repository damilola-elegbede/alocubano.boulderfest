<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MFA Security Settings - A Lo Cubano Boulder Fest</title>
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/typography.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/forms.css" />
    <link rel="stylesheet" href="/css/admin-overrides.css" />
    <script type="module" src="/js/theme-manager.js"></script>
    <style>
      /* MFA-specific custom styles that work with the main CSS system */
      .admin-header {
        background: linear-gradient(
          135deg,
          var(--color-blue),
          var(--color-red)
        );
        color: var(--color-white);
        padding: var(--space-lg) var(--space-xl);
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow-lg);
      }

      .admin-header h1 {
        font-family: var(--font-display);
        font-size: var(--font-size-2xl);
        font-weight: 700;
        margin: 0;
      }

      .header-actions {
        display: flex;
        gap: var(--space-md);
        align-items: center;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: var(--space-2xl);
        display: grid;
        gap: var(--space-xl);
      }

      .step-header {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
      }

      .step-number {
        background: var(--color-primary);
        color: var(--color-white);
        width: 40px;
        height: 40px;
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: var(--font-size-lg);
        font-family: var(--font-display);
      }

      .qr-container {
        text-align: center;
        margin: var(--space-xl) 0;
      }

      .qr-code {
        max-width: 200px;
        border: 2px solid var(--color-border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
      }

      .manual-entry {
        background: var(--color-background-secondary);
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        margin: var(--space-lg) 0;
        font-family: var(--font-code);
        font-size: var(--font-size-sm);
        word-break: break-all;
        border: 1px solid var(--color-border);
      }

      .verification-input {
        display: flex;
        gap: var(--space-md);
        margin: var(--space-xl) 0;
        align-items: center;
      }

      .verification-input input {
        padding: var(--space-lg);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-md);
        font-size: var(--font-size-xl);
        font-family: var(--font-code);
        width: 140px;
        text-align: center;
        letter-spacing: 0.2em;
        transition: border-color var(--transition-base);
      }

      .verification-input input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px var(--color-info-light);
      }

      .backup-codes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: var(--space-md);
        margin: var(--space-xl) 0;
      }

      .backup-code {
        background: var(--color-background-secondary);
        padding: var(--space-lg);
        text-align: center;
        border-radius: var(--radius-md);
        font-family: var(--font-code);
        font-size: var(--font-size-sm);
        border: 1px solid var(--color-border);
        font-weight: 600;
      }

      .mfa-actions {
        display: flex;
        gap: var(--space-md);
        flex-wrap: wrap;
        margin-top: var(--space-xl);
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-md);
        padding: var(--space-xl);
        color: var(--color-text-secondary);
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .container {
          padding: var(--space-lg);
        }

        .admin-header {
          padding: var(--space-lg);
          flex-direction: column;
          gap: var(--space-md);
          text-align: center;
        }

        .verification-input {
          flex-direction: column;
          align-items: stretch;
        }

        .verification-input input {
          width: 100%;
        }

        .mfa-actions {
          flex-direction: column;
        }

        .step-header {
          flex-direction: column;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-header">
      <h1>üîê MFA Security Settings</h1>
      <div class="header-actions">
        <a href="/admin/dashboard" class="form-button-type">‚Üê Dashboard</a>
      </div>
    </div>

    <div class="container">
      <!-- MFA Status Section -->
      <div class="ticket-card">
        <h2>Multi-Factor Authentication Status</h2>
        <div id="mfaStatusContainer">
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Loading MFA status...</span>
          </div>
        </div>
      </div>

      <!-- MFA Setup Section -->
      <div class="ticket-card">
        <h2>Setup Multi-Factor Authentication</h2>
        <div id="setupContainer">
          <!-- Content will be dynamically loaded -->
        </div>
      </div>

      <!-- Recovery Options Section -->
      <div class="ticket-card">
        <h2>Recovery Options</h2>
        <div id="recoveryContainer">
          <div class="admin-alert warning">
            <strong>Important:</strong> Store your backup codes in a safe place.
            They are your only way to recover access if you lose your
            authenticator device.
          </div>
          <!-- Content will be dynamically loaded -->
        </div>
      </div>
    </div>

    <script>
      let mfaStatus = null;
      let setupData = null;

      // Initialize page
      async function init() {
        await checkAuth();
        await loadMfaStatus();
      }

      // Check authentication
      async function checkAuth() {
        try {
          const response = await fetch("/api/admin/dashboard");
          if (!response.ok) {
            window.location.href = "/admin/login";
            return false;
          }
          return true;
        } catch (error) {
          console.error("Auth check failed:", error);
          window.location.href = "/admin/login";
          return false;
        }
      }

      // Load MFA status
      async function loadMfaStatus() {
        try {
          const response = await fetch("/api/admin/mfa-setup");
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          mfaStatus = await response.json();
          displayMfaStatus();
          displaySetupOptions();
          displayRecoveryOptions();
        } catch (error) {
          console.error("Failed to load MFA status:", error);
          displayError(
            "mfaStatusContainer",
            `Failed to load MFA status: ${error.message}`,
          );
        }
      }

      // Display MFA status
      function displayMfaStatus() {
        const container = document.getElementById("mfaStatusContainer");
        const isEnabled = mfaStatus.isEnabled;
        const statusClass = isEnabled ? "success" : "error";
        const statusIcon = isEnabled ? "‚úÖ" : "‚ùå";
        const statusTitle = isEnabled ? "MFA is Enabled" : "MFA is Disabled";
        const statusDesc = isEnabled
          ? `Enabled on ${new Date(mfaStatus.enabledAt).toLocaleDateString()}`
          : "Your account is not protected by multi-factor authentication";

        container.innerHTML = `
          <div class="status-badge ${statusClass}">
            <div class="status-icon">${statusIcon}</div>
            <div class="status-text">
              <div class="status-title">${statusTitle}</div>
              <div class="status-description">${statusDesc}</div>
            </div>
          </div>
          ${
            isEnabled
              ? `
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-value">${mfaStatus.backupCodesCount}</div>
                <div class="stat-label">Backup Codes Available</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${mfaStatus.recentAttempts.successful}</div>
                <div class="stat-label">Successful Attempts (24h)</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${mfaStatus.recentAttempts.total}</div>
                <div class="stat-label">Total Attempts (24h)</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${mfaStatus.deviceName || "Unknown"}</div>
                <div class="stat-label">Authenticator Device</div>
              </div>
            </div>
          `
              : ""
          }
        `;
      }

      // Display setup options
      function displaySetupOptions() {
        const container = document.getElementById("setupContainer");

        if (mfaStatus.isEnabled) {
          container.innerHTML = `
            <div class="admin-alert success">
              <strong>‚úÖ MFA is already enabled</strong><br>
              Your account is protected with multi-factor authentication.
            </div>
            <div class="mfa-actions">
              <button class="form-button-type" onclick="generateBackupCodes()">Generate New Backup Codes</button>
              <button class="form-button-type" onclick="confirmDisableMfa()" style="background: var(--color-error);">Disable MFA</button>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="admin-alert warning">
              <strong>‚ö†Ô∏è Your account is not protected</strong><br>
              Enable multi-factor authentication to secure your admin account.
            </div>
            <div class="mfa-actions">
              <button class="form-button-type" onclick="startMfaSetup()" style="background: var(--color-success);">Enable MFA</button>
            </div>
          `;
        }
      }

      // Display recovery options
      function displayRecoveryOptions() {
        const container = document.getElementById("recoveryContainer");

        if (!mfaStatus.isEnabled) {
          container.innerHTML = `
            <div class="admin-alert warning">
              MFA must be enabled before recovery options are available.
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value">${mfaStatus.backupCodesCount}</div>
              <div class="stat-label">Backup Codes Available</div>
            </div>
          </div>
          <div class="mfa-actions">
            <button class="form-button-type" onclick="generateBackupCodes()">Generate New Backup Codes</button>
            <button class="form-button-type" onclick="showRecoveryOptions()" style="background: var(--color-error);">Recovery Options</button>
          </div>
        `;
      }

      // Start MFA setup process
      async function startMfaSetup() {
        const container = document.getElementById("setupContainer");
        container.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Generating TOTP secret...</span>
          </div>
        `;

        try {
          const response = await fetch(
            "/api/admin/mfa-setup?action=generate-secret",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ deviceName: "Admin Authenticator" }),
            },
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          setupData = await response.json();
          displaySetupFlow();
        } catch (error) {
          console.error("Failed to generate MFA secret:", error);
          displayError(
            "setupContainer",
            `Failed to generate MFA secret: ${error.message}`,
          );
        }
      }

      // Display setup flow
      function displaySetupFlow() {
        const container = document.getElementById("setupContainer");
        container.innerHTML = `
          <div class="setup-flow active">
            <div class="ticket-card">
              <div class="step-header">
                <div class="step-number">1</div>
                <h3>Install Authenticator App</h3>
              </div>
              <p>Install an authenticator app on your phone:</p>
              <ul style="margin: 10px 0 0 20px;">
                <li><strong>Google Authenticator</strong> (iOS/Android)</li>
                <li><strong>Authy</strong> (iOS/Android/Desktop)</li>
                <li><strong>Microsoft Authenticator</strong> (iOS/Android)</li>
                <li><strong>1Password</strong> (Premium feature)</li>
              </ul>
            </div>

            <div class="ticket-card">
              <div class="step-header">
                <div class="step-number">2</div>
                <h3>Scan QR Code</h3>
              </div>
              <p>Open your authenticator app and scan this QR code:</p>
              <div class="qr-container">
                <img src="${setupData.qrCodeUrl}" alt="MFA QR Code" class="qr-code">
              </div>
              <p><strong>Can't scan?</strong> Enter this key manually:</p>
              <div class="manual-entry">${setupData.manualEntryKey}</div>
            </div>

            <div class="ticket-card">
              <div class="step-header">
                <div class="step-number">3</div>
                <h3>Verify Setup</h3>
              </div>
              <p>Enter the 6-digit code from your authenticator app:</p>
              <div class="verification-input">
                <input type="text" 
                       id="verificationCode" 
                       placeholder="000000" 
                       maxlength="6" 
                       pattern="[0-9]{6}"
                       class="form-input-type"
                       autocomplete="off">
                <button class="form-button-type" onclick="verifyMfaSetup()" style="background: var(--color-success);">Verify & Enable</button>
              </div>
              <div id="verificationResult"></div>
            </div>
          </div>
        `;

        // Auto-focus on verification input
        setTimeout(() => {
          document.getElementById("verificationCode").focus();
        }, 100);
      }

      // Verify MFA setup
      async function verifyMfaSetup() {
        const codeInput = document.getElementById("verificationCode");
        const code = codeInput.value.trim();
        const resultDiv = document.getElementById("verificationResult");

        if (!/^\d{6}$/.test(code)) {
          resultDiv.innerHTML = `
            <div class="admin-alert error">
              Please enter a valid 6-digit code from your authenticator app.
            </div>
          `;
          return;
        }

        resultDiv.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Verifying code...</span>
          </div>
        `;

        try {
          const response = await fetch(
            "/api/admin/mfa-setup?action=verify-setup",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                token: code,
                deviceName: "Admin Authenticator",
              }),
            },
          );

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error);
          }

          // Success! Show backup codes
          displayBackupCodes(result.backupCodes);

          // Reload status after successful setup
          setTimeout(() => {
            loadMfaStatus();
          }, 2000);
        } catch (error) {
          console.error("MFA verification failed:", error);
          resultDiv.innerHTML = `
            <div class="admin-alert error">
              <strong>Verification failed:</strong> ${error.message}
            </div>
          `;
        }
      }

      // Display backup codes
      function displayBackupCodes(codes) {
        const container = document.getElementById("setupContainer");
        container.innerHTML = `
          <div class="admin-alert success">
            <strong>‚úÖ MFA Successfully Enabled!</strong><br>
            Your account is now protected with multi-factor authentication.
          </div>
          
          <div class="ticket-card">
            <div class="step-header">
              <div class="step-number">4</div>
              <h3>Save Your Backup Codes</h3>
            </div>
            <div class="admin-alert warning">
              <strong>Important:</strong> Save these backup codes in a safe place. 
              They are the only way to recover access if you lose your authenticator device.
              Each code can only be used once.
            </div>
            <div class="backup-codes">
              ${codes.map((code) => `<div class="backup-code">${code}</div>`).join("")}
            </div>
            <div class="mfa-actions">
              <button class="form-button-type" onclick="downloadBackupCodes(${JSON.stringify(codes).replace(/"/g, "&quot;")})">Download Codes</button>
              <button class="form-button-type" onclick="loadMfaStatus()" style="background: var(--color-success);">Continue</button>
            </div>
          </div>
        `;
      }

      // Generate new backup codes
      async function generateBackupCodes() {
        if (
          !confirm("This will invalidate all existing backup codes. Continue?")
        ) {
          return;
        }

        try {
          const response = await fetch(
            "/api/admin/mfa-setup?action=generate-backup-codes",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            },
          );

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error);
          }

          displayBackupCodes(result.backupCodes);
        } catch (error) {
          console.error("Failed to generate backup codes:", error);
          alert(`Failed to generate backup codes: ${error.message}`);
        }
      }

      // Confirm disable MFA
      function confirmDisableMfa() {
        const code = prompt(
          "Enter your current TOTP code or backup code to disable MFA:",
        );
        if (!code) return;

        disableMfa(code);
      }

      // Disable MFA
      async function disableMfa(confirmationCode) {
        try {
          const response = await fetch("/api/admin/mfa-setup?action=disable", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ confirmationCode }),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error);
          }

          alert("MFA has been disabled successfully.");
          loadMfaStatus();
        } catch (error) {
          console.error("Failed to disable MFA:", error);
          alert(`Failed to disable MFA: ${error.message}`);
        }
      }

      // Download backup codes
      function downloadBackupCodes(codes) {
        const content = `A Lo Cubano Boulder Fest - Admin MFA Backup Codes
Generated: ${new Date().toLocaleString()}

IMPORTANT: Store these codes safely. Each can only be used once.

${codes.map((code, i) => `${i + 1}. ${code}`).join("\n")}

Instructions:
- Use these codes if you lose access to your authenticator app
- Enter any unused code when prompted for MFA
- Generate new codes after using several of them
`;

        const blob = new Blob([content], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `mfa-backup-codes-${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Show recovery options
      function showRecoveryOptions() {
        if (
          confirm(
            "Open recovery options? This should only be used if you have lost access to your authenticator device.",
          )
        ) {
          window.open("/admin/mfa-recovery", "_blank", "noopener,noreferrer");
        }
      }

      // Display error
      function displayError(containerId, message) {
        const container = document.getElementById(containerId);
        container.innerHTML = `
          <div class="admin-alert error">
            <strong>Error:</strong> ${escapeHtml(message)}
          </div>
        `;
      }

      // HTML escaping function
      function escapeHtml(unsafe) {
        if (unsafe == null) return "";
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
