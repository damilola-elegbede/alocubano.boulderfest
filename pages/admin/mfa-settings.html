<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <!-- Inline theme detection to prevent FOUC -->
    <script>
      (function() {
        // Detect admin pages
        const path = window.location.pathname.toLowerCase();
        const isAdmin = path.includes('/admin') || path.includes('pages/admin');

        if (isAdmin) {
          // Admin pages always use dark theme
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          // Main site: check user preference
          let stored = null;
          try {
            stored = localStorage.getItem('theme-preference');
          } catch {
            // localStorage might be disabled
          }

          const preference = stored || 'system';
          let theme = preference;

          if (preference === 'system') {
            // Detect system preference
            theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
              ? 'dark'
              : 'light';
          }

          document.documentElement.setAttribute('data-theme', theme);
        }
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MFA Security Settings - A Lo Cubano Boulder Fest</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/typography.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/forms.css" />
    <link rel="stylesheet" href="/css/admin-overrides.css" />
    <script type="module" src="/js/theme-manager.js"></script>
    <style>
      /* MFA-specific styles that extend the unified design system */
      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: var(--space-2xl);
        display: grid;
        gap: var(--space-xl);
      }

      .step-header {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
      }

      .step-number {
        background: var(--color-blue);
        color: var(--color-text-inverse);
        width: 40px;
        height: 40px;
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: var(--font-size-lg);
        font-family: var(--font-display);
      }

      .qr-container {
        text-align: center;
        margin: var(--space-xl) 0;
      }

      .qr-code {
        max-width: 200px;
        border: 2px solid var(--color-border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
      }

      .manual-entry {
        background: var(--color-background-secondary);
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        margin: var(--space-lg) 0;
        font-family: var(--font-code);
        font-size: var(--font-size-sm);
        word-break: break-all;
        border: 1px solid var(--color-border);
      }

      .verification-input {
        display: flex;
        gap: var(--space-md);
        margin: var(--space-xl) 0;
        align-items: center;
      }

      .verification-code-input {
        padding: var(--space-lg);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-md);
        font-size: var(--font-size-xl);
        font-family: var(--font-code);
        width: 140px;
        text-align: center;
        letter-spacing: 0.2em;
        transition: border-color var(--transition-base);
        background: var(--color-surface);
        color: var(--color-text-primary);
      }

      .verification-code-input:focus {
        outline: none;
        border-color: var(--color-blue);
        box-shadow: 0 0 0 3px rgba(91, 107, 181, 0.1);
      }

      .backup-codes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: var(--space-md);
        margin: var(--space-xl) 0;
      }

      .backup-code {
        background: var(--color-background-secondary);
        padding: var(--space-lg);
        text-align: center;
        border-radius: var(--radius-md);
        font-family: var(--font-code);
        font-size: var(--font-size-sm);
        border: 1px solid var(--color-border);
        font-weight: 600;
      }

      .mfa-actions {
        display: flex;
        gap: var(--space-md);
        flex-wrap: wrap;
        margin-top: var(--space-xl);
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-md);
        padding: var(--space-xl);
        color: var(--color-text-secondary);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-lg);
        margin: var(--space-xl) 0;
      }

      .stat-item {
        text-align: center;
        padding: var(--space-lg);
        background: var(--color-background-secondary);
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
      }

      .stat-value {
        font-family: var(--font-display);
        font-size: var(--font-size-2xl);
        font-weight: 700;
        color: var(--color-blue);
        margin-bottom: var(--space-sm);
      }

      .stat-label {
        font-family: var(--font-sans);
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
      }

      .status-badge {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        border: 2px solid;
        margin: var(--space-lg) 0;
      }

      .status-badge.success {
        background: rgba(91, 107, 181, 0.1);
        color: var(--color-blue);
        border-color: var(--color-blue);
      }

      .status-badge.error {
        background: rgba(204, 41, 54, 0.1);
        color: var(--color-red);
        border-color: var(--color-red);
      }

      .status-icon {
        font-size: var(--font-size-lg);
      }

      .status-text {
        flex: 1;
      }

      .status-title {
        font-family: var(--font-display);
        font-size: var(--font-size-lg);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
        margin-bottom: var(--space-xs);
      }

      .status-description {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .container {
          padding: var(--space-lg);
        }

        .verification-input {
          flex-direction: column;
          align-items: stretch;
        }

        .verification-code-input {
          width: 100%;
        }

        .mfa-actions {
          flex-direction: column;
        }

        .step-header {
          flex-direction: column;
          text-align: center;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Mobile Hamburger Menu Toggle -->
    <button class="admin-menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false">
      <div class="admin-menu-icon">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </button>

    <div class="admin-header">
      <div class="admin-header-content">
        <div>
          <h1 class="admin-header-title">MFA Security Settings</h1>
          <p class="admin-header-subtitle">Multi-Factor Authentication Configuration</p>
        </div>
        <div class="admin-header-actions">
          <a href="/admin/dashboard" class="admin-btn admin-btn-ghost">Dashboard</a>
          <button onclick="logout()" class="admin-btn admin-btn-secondary admin-btn-sm">Logout</button>
        </div>
      </div>
    </div>

    <!-- Unified Admin Navigation -->
    <nav class="admin-navigation">
      <ul class="admin-nav-list">
        <!-- Core Tools Group -->
        <li role="presentation" class="admin-nav-group-header">Core Tools</li>
        <li class="admin-nav-item">
          <a href="/admin" class="admin-nav-link">
            <span class="nav-icon">üè†</span>
            <span>Portal</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/dashboard" class="admin-nav-link">
            <span class="nav-icon">üìä</span>
            <span>Dashboard</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/checkin" class="admin-nav-link">
            <span class="nav-icon">üì±</span>
            <span>Check-in Scanner</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/manual-entry" class="admin-nav-link">
            <span class="nav-icon">‚úèÔ∏è</span>
            <span>Manual Entry</span>
          </a>
        </li>

        <!-- Data & Analytics Group -->
        <li role="presentation" aria-hidden="true" class="admin-nav-separator"></li>
        <li role="presentation" class="admin-nav-group-header">Data & Analytics</li>
        <li class="admin-nav-item">
          <a href="/admin/tickets" class="admin-nav-link">
            <span class="nav-icon">üé´</span>
            <span>Tickets</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/analytics" class="admin-nav-link">
            <span class="nav-icon">üìà</span>
            <span>Analytics</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/donations" class="admin-nav-link">
            <span class="nav-icon">üíù</span>
            <span>Donations</span>
          </a>
        </li>

        <!-- Utilities Group -->
        <li role="presentation" aria-hidden="true" class="admin-nav-separator"></li>
        <li role="presentation" class="admin-nav-group-header">Utilities</li>
        <li class="admin-nav-item">
          <a href="/admin/test" class="admin-nav-link">
            <span class="nav-icon">üß™</span>
            <span>Test</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/api-endpoints" class="admin-nav-link">
            <span class="nav-icon">üîå</span>
            <span>API Endpoints</span>
          </a>
        </li>
      </ul>
    </nav>

    <div class="container">
      <!-- MFA Status Section -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Multi-Factor Authentication Status</h2>
        </div>
        <div class="admin-card-body">
          <div id="mfaStatusContainer">
            <div class="loading">
              <div class="admin-loading"></div>
              <span>Loading MFA status...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- MFA Setup Section -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Setup Multi-Factor Authentication</h2>
        </div>
        <div class="admin-card-body">
          <div id="setupContainer">
            <!-- Content will be dynamically loaded -->
          </div>
        </div>
      </div>

      <!-- Recovery Options Section -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Recovery Options</h2>
        </div>
        <div class="admin-card-body">
          <div id="recoveryContainer">
            <div class="admin-alert warning">
              <strong>Important:</strong> Store your backup codes in a safe place.
              They are your only way to recover access if you lose your
              authenticator device.
            </div>
            <!-- Content will be dynamically loaded -->
          </div>
        </div>
      </div>
    </div>

    <script>
      let mfaStatus = null;
      let setupData = null;
      let csrfToken = null;

      // Fetch CSRF token
      async function fetchCSRFToken() {
        try {
          const response = await fetch("/api/admin/csrf-token", {
            credentials: "include"
          });
          if (response.ok) {
            const data = await response.json();
            csrfToken = data.csrfToken || data.token;
            // Refresh token before it expires (50 minutes)
            setTimeout(fetchCSRFToken, 50 * 60 * 1000);
          }
        } catch (error) {
          console.error("Failed to fetch CSRF token:", error);
        }
      }

      // Initialize page
      async function init() {
        await checkAuth();
        await fetchCSRFToken();
        await loadMfaStatus();
      }

      // SECURITY: Enhanced authentication check with proper timeout and session validation
      async function checkAuth() {
        try {
          const response = await fetch("/api/admin/verify-session", {
            credentials: "include" // CRITICAL: Include cookies for production
          });
          if (!response.ok) {
            window.location.href = "/admin/login";
            return false;
          }
          const data = await response.json();
          if (!data.valid) {
            window.location.href = "/admin/login";
            return false;
          }
          return true;
        } catch (error) {
          console.error("Auth check failed:", error);
          window.location.href = "/admin/login";
          return false;
        }
      }
      
      // SECURITY: Proper session cleanup helper
      function cleanupSession() {
        // Clear all session-related storage
        localStorage.removeItem("adminToken");
        sessionStorage.clear();
        
        // Clear admin session cookie with proper path and domain
        document.cookie = "admin_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Strict";
        
        // Clear any other potential admin cookies
        document.cookie = "admin_auth=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Strict";
      }

      // Load MFA status
      async function loadMfaStatus() {
        try {
          const response = await fetch("/api/admin/mfa-setup", {
            credentials: "include"
          });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          mfaStatus = await response.json();
          displayMfaStatus();
          displaySetupOptions();
          displayRecoveryOptions();
        } catch (error) {
          console.error("Failed to load MFA status:", error);
          displayError(
            "mfaStatusContainer",
            `Failed to load MFA status: ${error.message}`,
          );
        }
      }

      // Display MFA status
      function displayMfaStatus() {
        const container = document.getElementById("mfaStatusContainer");
        const isEnabled = mfaStatus.isEnabled;
        const statusClass = isEnabled ? "success" : "error";
        const statusIcon = isEnabled ? "‚úÖ" : "‚ùå";
        const statusTitle = isEnabled ? "MFA is Enabled" : "MFA is Disabled";
        const statusDesc = isEnabled
          ? `Enabled on ${window.timeManager ? window.timeManager.formatDate(mfaStatus.enabledAt) : new Date(mfaStatus.enabledAt).toLocaleDateString('en-US', { timeZone: 'America/Denver' })}`
          : "Your account is not protected by multi-factor authentication";

        container.innerHTML = `
          <div class="status-badge ${statusClass}">
            <div class="status-icon">${statusIcon}</div>
            <div class="status-text">
              <div class="status-title">${statusTitle}</div>
              <div class="status-description">${statusDesc}</div>
            </div>
          </div>
          ${
            isEnabled
              ? `
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-value">${mfaStatus.backupCodesCount}</div>
                <div class="stat-label">Backup Codes Available</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${mfaStatus.recentAttempts.successful}</div>
                <div class="stat-label">Successful Attempts (24h)</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${mfaStatus.recentAttempts.total}</div>
                <div class="stat-label">Total Attempts (24h)</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${mfaStatus.deviceName || "Unknown"}</div>
                <div class="stat-label">Authenticator Device</div>
              </div>
            </div>
          `
              : ""
          }
        `;
      }

      // Display setup options
      function displaySetupOptions() {
        const container = document.getElementById("setupContainer");

        if (mfaStatus.isEnabled) {
          container.innerHTML = `
            <div class="admin-alert success">
              <strong>MFA is already enabled</strong><br>
              Your account is protected with multi-factor authentication.
            </div>
            <div class="mfa-actions">
              <button class="admin-btn admin-btn-primary" onclick="generateBackupCodes()">Generate New Backup Codes</button>
              <button class="admin-btn admin-btn-danger" onclick="confirmDisableMfa()">Disable MFA</button>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="admin-alert warning">
              <strong>Your account is not protected</strong><br>
              Enable multi-factor authentication to secure your admin account.
            </div>
            <div class="mfa-actions">
              <button class="admin-btn admin-btn-success" onclick="startMfaSetup()">Enable MFA</button>
            </div>
          `;
        }
      }

      // Display recovery options
      function displayRecoveryOptions() {
        const container = document.getElementById("recoveryContainer");

        if (!mfaStatus.isEnabled) {
          container.innerHTML = `
            <div class="admin-alert warning">
              MFA must be enabled before recovery options are available.
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value">${mfaStatus.backupCodesCount}</div>
              <div class="stat-label">Backup Codes Available</div>
            </div>
          </div>
          <div class="mfa-actions">
            <button class="admin-btn admin-btn-primary" onclick="generateBackupCodes()">Generate New Backup Codes</button>
            <button class="admin-btn admin-btn-danger" onclick="showRecoveryOptions()">Recovery Options</button>
          </div>
        `;
      }

      // Start MFA setup process
      async function startMfaSetup() {
        const container = document.getElementById("setupContainer");
        container.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Generating TOTP secret...</span>
          </div>
        `;

        try {
          const headers = { "Content-Type": "application/json" };
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const response = await fetch(
            "/api/admin/mfa-setup?action=generate-secret",
            {
              method: "POST",
              headers: headers,
              body: JSON.stringify({ deviceName: "Admin Authenticator" }),
              credentials: "same-origin"
            },
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          setupData = await response.json();
          displaySetupFlow();
        } catch (error) {
          console.error("Failed to generate MFA secret:", error);
          displayError(
            "setupContainer",
            `Failed to generate MFA secret: ${error.message}`,
          );
        }
      }

      // Display setup flow
      function displaySetupFlow() {
        const container = document.getElementById("setupContainer");
        container.innerHTML = `
          <div class="setup-flow active">
            <div class="admin-card">
              <div class="admin-card-header">
                <div class="step-header">
                  <div class="step-number">1</div>
                  <h3 class="admin-card-title">Install Authenticator App</h3>
                </div>
              </div>
              <div class="admin-card-body">
                <p>Install an authenticator app on your phone:</p>
                <ul style="margin: 10px 0 0 20px;">
                  <li><strong>Google Authenticator</strong> (iOS/Android)</li>
                  <li><strong>Authy</strong> (iOS/Android/Desktop)</li>
                  <li><strong>Microsoft Authenticator</strong> (iOS/Android)</li>
                  <li><strong>1Password</strong> (Premium feature)</li>
                </ul>
              </div>
            </div>

            <div class="admin-card">
              <div class="admin-card-header">
                <div class="step-header">
                  <div class="step-number">2</div>
                  <h3 class="admin-card-title">Scan QR Code</h3>
                </div>
              </div>
              <div class="admin-card-body">
                <p>Open your authenticator app and scan this QR code:</p>
                <div class="qr-container">
                  <img src="${setupData.qrCodeUrl}" alt="MFA QR Code" class="qr-code">
                </div>
                <p><strong>Can't scan?</strong> Enter this key manually:</p>
                <div class="manual-entry">${setupData.manualEntryKey}</div>
              </div>
            </div>

            <div class="admin-card">
              <div class="admin-card-header">
                <div class="step-header">
                  <div class="step-number">3</div>
                  <h3 class="admin-card-title">Verify Setup</h3>
                </div>
              </div>
              <div class="admin-card-body">
                <p>Enter the 6-digit code from your authenticator app:</p>
                <div class="verification-input">
                  <input type="text" 
                         id="verificationCode" 
                         placeholder="000000" 
                         maxlength="6" 
                         pattern="[0-9]{6}"
                         class="verification-code-input"
                         autocomplete="off">
                  <button class="admin-btn admin-btn-success" onclick="verifyMfaSetup()">Verify & Enable</button>
                </div>
                <div id="verificationResult"></div>
              </div>
            </div>
          </div>
        `;

        // Auto-focus on verification input
        setTimeout(() => {
          document.getElementById("verificationCode").focus();
        }, 100);
      }

      // Verify MFA setup
      async function verifyMfaSetup() {
        const codeInput = document.getElementById("verificationCode");
        const code = codeInput.value.trim();
        const resultDiv = document.getElementById("verificationResult");

        if (!/^\d{6}$/.test(code)) {
          resultDiv.innerHTML = `
            <div class="admin-alert error">
              Please enter a valid 6-digit code from your authenticator app.
            </div>
          `;
          return;
        }

        resultDiv.innerHTML = `
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Verifying code...</span>
          </div>
        `;

        try {
          const headers = { "Content-Type": "application/json" };
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const response = await fetch(
            "/api/admin/mfa-setup?action=verify-setup",
            {
              method: "POST",
              headers: headers,
              body: JSON.stringify({
                token: code,
                deviceName: "Admin Authenticator",
              }),
              credentials: "same-origin"
            },
          );

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error);
          }

          // Success! Show backup codes
          displayBackupCodes(result.backupCodes);

          // Reload status after successful setup
          setTimeout(() => {
            loadMfaStatus();
          }, 2000);
        } catch (error) {
          console.error("MFA verification failed:", error);
          resultDiv.innerHTML = `
            <div class="admin-alert error">
              <strong>Verification failed:</strong> ${error.message}
            </div>
          `;
        }
      }

      // Display backup codes
      function displayBackupCodes(codes) {
        const container = document.getElementById("setupContainer");
        container.innerHTML = `
          <div class="admin-alert success">
            <strong>MFA Successfully Enabled!</strong><br>
            Your account is now protected with multi-factor authentication.
          </div>
          
          <div class="admin-card">
            <div class="admin-card-header">
              <div class="step-header">
                <div class="step-number">4</div>
                <h3 class="admin-card-title">Save Your Backup Codes</h3>
              </div>
            </div>
            <div class="admin-card-body">
              <div class="admin-alert warning">
                <strong>Important:</strong> Save these backup codes in a safe place. 
                They are the only way to recover access if you lose your authenticator device.
                Each code can only be used once.
              </div>
              <div class="backup-codes">
                ${codes.map((code) => `<div class="backup-code">${code}</div>`).join("")}
              </div>
              <div class="mfa-actions">
                <button class="admin-btn admin-btn-primary" onclick="downloadBackupCodes(${JSON.stringify(codes).replace(/"/g, "&quot;")})">Download Codes</button>
                <button class="admin-btn admin-btn-success" onclick="loadMfaStatus()">Continue</button>
              </div>
            </div>
          </div>
        `;
      }

      // Generate new backup codes
      async function generateBackupCodes() {
        if (
          !confirm("This will invalidate all existing backup codes. Continue?")
        ) {
          return;
        }

        try {
          const headers = { "Content-Type": "application/json" };
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const response = await fetch(
            "/api/admin/mfa-setup?action=generate-backup-codes",
            {
              method: "POST",
              headers: headers,
              credentials: "same-origin"
            },
          );

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error);
          }

          displayBackupCodes(result.backupCodes);
        } catch (error) {
          console.error("Failed to generate backup codes:", error);
          alert(`Failed to generate backup codes: ${error.message}`);
        }
      }

      // Confirm disable MFA
      function confirmDisableMfa() {
        const code = prompt(
          "Enter your current TOTP code or backup code to disable MFA:",
        );
        if (!code) return;

        disableMfa(code);
      }

      // Disable MFA
      async function disableMfa(confirmationCode) {
        try {
          const headers = { "Content-Type": "application/json" };
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const response = await fetch("/api/admin/mfa-setup?action=disable", {
            method: "POST",
            headers: headers,
            body: JSON.stringify({ confirmationCode }),
            credentials: "include"
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error);
          }

          alert("MFA has been disabled successfully.");
          loadMfaStatus();
        } catch (error) {
          console.error("Failed to disable MFA:", error);
          alert(`Failed to disable MFA: ${error.message}`);
        }
      }

      // Download backup codes
      function downloadBackupCodes(codes) {
        const content = `A Lo Cubano Boulder Fest - Admin MFA Backup Codes
Generated: ${window.timeManager ? window.timeManager.formatDateTime(new Date()) : new Date().toLocaleString()} (Mountain Time)

IMPORTANT: Store these codes safely. Each can only be used once.

${codes.map((code, i) => `${i + 1}. ${code}`).join("\n")}

Instructions:
- Use these codes if you lose access to your authenticator app
- Enter any unused code when prompted for MFA
- Generate new codes after using several of them
`;

        const blob = new Blob([content], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `mfa-backup-codes-${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Show recovery options
      function showRecoveryOptions() {
        if (
          confirm(
            "Open recovery options? This should only be used if you have lost access to your authenticator device.",
          )
        ) {
          // SECURITY: Use proper noopener noreferrer for external window
          const recoveryWindow = window.open("/admin/mfa-recovery", "_blank", "noopener,noreferrer");
          if (!recoveryWindow) {
            alert("Please allow pop-ups for this site to access MFA recovery options.");
          }
        }
      }

      // Display error
      function displayError(containerId, message) {
        const container = document.getElementById(containerId);
        container.innerHTML = `
          <div class="admin-alert error">
            <strong>Error:</strong> ${escapeHtml(message)}
          </div>
        `;
      }

      // HTML escaping function
      function escapeHtml(unsafe) {
        if (unsafe == null) return "";
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // SECURITY: Enhanced logout function with proper session cleanup
      async function logout() {
        if (!confirm("Are you sure you want to logout?")) return;

        try {
          const headers = {};
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          await fetch("/api/admin/login", {
            method: "DELETE",
            headers: headers,
            credentials: "same-origin"
          });
        } finally {
          // Clear client storage
          localStorage.removeItem('adminToken');
          sessionStorage.clear();
          // Redirect
          window.location.href = '/admin/login';
        }
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", init);
    </script>

    <!-- Mobile Navigation Controller -->
    <script src="/js/admin-mobile-nav.js"></script>
  </body>
</html>
