<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MFA Security Settings - A Lo Cubano Boulder Fest</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          sans-serif;
        background: #f5f7fa;
        color: #333;
        line-height: 1.6;
      }

      .admin-header {
        background: #2c3e50;
        color: white;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .admin-header h1 {
        font-size: 24px;
        font-weight: 500;
      }

      .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .btn {
        border: none;
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-primary {
        background: #3498db;
        color: white;
      }

      .btn-primary:hover {
        background: #2980b9;
      }

      .btn-success {
        background: #27ae60;
        color: white;
      }

      .btn-success:hover {
        background: #229954;
      }

      .btn-danger {
        background: #e74c3c;
        color: white;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      .btn-warning {
        background: #f39c12;
        color: white;
      }

      .btn-warning:hover {
        background: #e67e22;
      }

      .btn:disabled {
        background: #95a5a6;
        cursor: not-allowed;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 30px;
      }

      .mfa-section {
        background: white;
        border-radius: 8px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .mfa-section h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #ecf0f1;
      }

      .mfa-status {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 25px;
        padding: 20px;
        border-radius: 6px;
        border-left: 4px solid #3498db;
      }

      .mfa-status.enabled {
        background: #d5f4e6;
        border-color: #27ae60;
      }

      .mfa-status.disabled {
        background: #fdeaea;
        border-color: #e74c3c;
      }

      .status-icon {
        font-size: 24px;
      }

      .status-text {
        flex: 1;
      }

      .status-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 5px;
      }

      .status-description {
        color: #7f8c8d;
        font-size: 14px;
      }

      .setup-flow {
        display: none;
      }

      .setup-flow.active {
        display: block;
      }

      .setup-step {
        margin-bottom: 30px;
        padding: 25px;
        border: 1px solid #ecf0f1;
        border-radius: 6px;
      }

      .step-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .step-number {
        background: #3498db;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
      }

      .qr-container {
        text-align: center;
        margin: 20px 0;
      }

      .qr-code {
        max-width: 200px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }

      .manual-entry {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
        font-family: monospace;
        font-size: 14px;
        word-break: break-all;
      }

      .verification-input {
        display: flex;
        gap: 10px;
        margin: 20px 0;
        align-items: center;
      }

      .verification-input input {
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 18px;
        font-family: monospace;
        width: 120px;
        text-align: center;
        letter-spacing: 2px;
      }

      .backup-codes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin: 20px 0;
      }

      .backup-code {
        background: #f8f9fa;
        padding: 12px;
        text-align: center;
        border-radius: 4px;
        font-family: monospace;
        font-size: 14px;
        border: 1px solid #dee2e6;
      }

      .warning-box {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-left: 4px solid #f39c12;
        padding: 15px;
        border-radius: 4px;
        margin: 20px 0;
      }

      .error-box {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-left: 4px solid #dc3545;
        padding: 15px;
        border-radius: 4px;
        margin: 20px 0;
      }

      .success-box {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-left: 4px solid #28a745;
        padding: 15px;
        border-radius: 4px;
        margin: 20px 0;
      }

      .mfa-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .recovery-section {
        margin-top: 30px;
        padding-top: 30px;
        border-top: 1px solid #ecf0f1;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 20px;
        color: #7f8c8d;
      }

      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #ecf0f1;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
      }

      .stat-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
      }

      .stat-label {
        color: #7f8c8d;
        font-size: 12px;
        margin-top: 5px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        .mfa-section {
          padding: 20px;
        }

        .verification-input {
          flex-direction: column;
          align-items: stretch;
        }

        .verification-input input {
          width: 100%;
        }

        .mfa-actions {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-header">
      <h1>üîê MFA Security Settings</h1>
      <div class="header-actions">
        <a href="/pages/admin/dashboard.html" class="btn btn-primary">‚Üê Dashboard</a>
      </div>
    </div>

    <div class="container">
      <!-- MFA Status Section -->
      <div class="mfa-section">
        <h2>Multi-Factor Authentication Status</h2>
        <div id="mfaStatusContainer">
          <div class="loading">
            <div class="spinner"></div>
            <span>Loading MFA status...</span>
          </div>
        </div>
      </div>

      <!-- MFA Setup Section -->
      <div class="mfa-section">
        <h2>Setup Multi-Factor Authentication</h2>
        <div id="setupContainer">
          <!-- Content will be dynamically loaded -->
        </div>
      </div>

      <!-- Recovery Options Section -->
      <div class="mfa-section">
        <h2>Recovery Options</h2>
        <div id="recoveryContainer">
          <div class="warning-box">
            <strong>Important:</strong> Store your backup codes in a safe place. They are your only way to recover access if you lose your authenticator device.
          </div>
          <!-- Content will be dynamically loaded -->
        </div>
      </div>
    </div>

    <script>
      let mfaStatus = null;
      let setupData = null;

      // Initialize page
      async function init() {
        await checkAuth();
        await loadMfaStatus();
      }

      // Check authentication
      async function checkAuth() {
        try {
          const response = await fetch('/api/admin/dashboard');
          if (!response.ok) {
            window.location.href = '/pages/admin/login.html';
            return false;
          }
          return true;
        } catch (error) {
          console.error('Auth check failed:', error);
          window.location.href = '/pages/admin/login.html';
          return false;
        }
      }

      // Load MFA status
      async function loadMfaStatus() {
        try {
          const response = await fetch('/api/admin/mfa-setup');
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          mfaStatus = await response.json();
          displayMfaStatus();
          displaySetupOptions();
          displayRecoveryOptions();
        } catch (error) {
          console.error('Failed to load MFA status:', error);
          displayError('mfaStatusContainer', `Failed to load MFA status: ${error.message}`);
        }
      }

      // Display MFA status
      function displayMfaStatus() {
        const container = document.getElementById('mfaStatusContainer');
        const isEnabled = mfaStatus.isEnabled;
        const statusClass = isEnabled ? 'enabled' : 'disabled';
        const statusIcon = isEnabled ? '‚úÖ' : '‚ùå';
        const statusTitle = isEnabled ? 'MFA is Enabled' : 'MFA is Disabled';
        const statusDesc = isEnabled ? 
          `Enabled on ${new Date(mfaStatus.enabledAt).toLocaleDateString()}` :
          'Your account is not protected by multi-factor authentication';

        container.innerHTML = `
          <div class="mfa-status ${statusClass}">
            <div class="status-icon">${statusIcon}</div>
            <div class="status-text">
              <div class="status-title">${statusTitle}</div>
              <div class="status-description">${statusDesc}</div>
            </div>
          </div>
          ${isEnabled ? `
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-value">${mfaStatus.backupCodesCount}</div>
                <div class="stat-label">Backup Codes Available</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${mfaStatus.recentAttempts.successful}</div>
                <div class="stat-label">Successful Attempts (24h)</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${mfaStatus.recentAttempts.total}</div>
                <div class="stat-label">Total Attempts (24h)</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${mfaStatus.deviceName || 'Unknown'}</div>
                <div class="stat-label">Authenticator Device</div>
              </div>
            </div>
          ` : ''}
        `;
      }

      // Display setup options
      function displaySetupOptions() {
        const container = document.getElementById('setupContainer');
        
        if (mfaStatus.isEnabled) {
          container.innerHTML = `
            <div class="success-box">
              <strong>‚úÖ MFA is already enabled</strong><br>
              Your account is protected with multi-factor authentication.
            </div>
            <div class="mfa-actions">
              <button class="btn btn-warning" onclick="generateBackupCodes()">Generate New Backup Codes</button>
              <button class="btn btn-danger" onclick="confirmDisableMfa()">Disable MFA</button>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="warning-box">
              <strong>‚ö†Ô∏è Your account is not protected</strong><br>
              Enable multi-factor authentication to secure your admin account.
            </div>
            <div class="mfa-actions">
              <button class="btn btn-success" onclick="startMfaSetup()">Enable MFA</button>
            </div>
          `;
        }
      }

      // Display recovery options
      function displayRecoveryOptions() {
        const container = document.getElementById('recoveryContainer');
        
        if (!mfaStatus.isEnabled) {
          container.innerHTML = `
            <div class="warning-box">
              MFA must be enabled before recovery options are available.
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value">${mfaStatus.backupCodesCount}</div>
              <div class="stat-label">Backup Codes Available</div>
            </div>
          </div>
          <div class="mfa-actions">
            <button class="btn btn-warning" onclick="generateBackupCodes()">Generate New Backup Codes</button>
            <button class="btn btn-danger" onclick="showRecoveryOptions()">Recovery Options</button>
          </div>
        `;
      }

      // Start MFA setup process
      async function startMfaSetup() {
        const container = document.getElementById('setupContainer');
        container.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <span>Generating TOTP secret...</span>
          </div>
        `;

        try {
          const response = await fetch('/api/admin/mfa-setup?action=generate-secret', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ deviceName: 'Admin Authenticator' })
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          setupData = await response.json();
          displaySetupFlow();
        } catch (error) {
          console.error('Failed to generate MFA secret:', error);
          displayError('setupContainer', `Failed to generate MFA secret: ${error.message}`);
        }
      }

      // Display setup flow
      function displaySetupFlow() {
        const container = document.getElementById('setupContainer');
        container.innerHTML = `
          <div class="setup-flow active">
            <div class="setup-step">
              <div class="step-header">
                <div class="step-number">1</div>
                <h3>Install Authenticator App</h3>
              </div>
              <p>Install an authenticator app on your phone:</p>
              <ul style="margin: 10px 0 0 20px;">
                <li><strong>Google Authenticator</strong> (iOS/Android)</li>
                <li><strong>Authy</strong> (iOS/Android/Desktop)</li>
                <li><strong>Microsoft Authenticator</strong> (iOS/Android)</li>
                <li><strong>1Password</strong> (Premium feature)</li>
              </ul>
            </div>

            <div class="setup-step">
              <div class="step-header">
                <div class="step-number">2</div>
                <h3>Scan QR Code</h3>
              </div>
              <p>Open your authenticator app and scan this QR code:</p>
              <div class="qr-container">
                <img src="${setupData.qrCodeUrl}" alt="MFA QR Code" class="qr-code">
              </div>
              <p><strong>Can't scan?</strong> Enter this key manually:</p>
              <div class="manual-entry">${setupData.manualEntryKey}</div>
            </div>

            <div class="setup-step">
              <div class="step-header">
                <div class="step-number">3</div>
                <h3>Verify Setup</h3>
              </div>
              <p>Enter the 6-digit code from your authenticator app:</p>
              <div class="verification-input">
                <input type="text" 
                       id="verificationCode" 
                       placeholder="000000" 
                       maxlength="6" 
                       pattern="[0-9]{6}"
                       autocomplete="off">
                <button class="btn btn-success" onclick="verifyMfaSetup()">Verify & Enable</button>
              </div>
              <div id="verificationResult"></div>
            </div>
          </div>
        `;

        // Auto-focus on verification input
        setTimeout(() => {
          document.getElementById('verificationCode').focus();
        }, 100);
      }

      // Verify MFA setup
      async function verifyMfaSetup() {
        const codeInput = document.getElementById('verificationCode');
        const code = codeInput.value.trim();
        const resultDiv = document.getElementById('verificationResult');

        if (!/^\d{6}$/.test(code)) {
          resultDiv.innerHTML = `
            <div class="error-box">
              Please enter a valid 6-digit code from your authenticator app.
            </div>
          `;
          return;
        }

        resultDiv.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <span>Verifying code...</span>
          </div>
        `;

        try {
          const response = await fetch('/api/admin/mfa-setup?action=verify-setup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              token: code,
              deviceName: 'Admin Authenticator'
            })
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error);
          }

          // Success! Show backup codes
          displayBackupCodes(result.backupCodes);
          
          // Reload status after successful setup
          setTimeout(() => {
            loadMfaStatus();
          }, 2000);

        } catch (error) {
          console.error('MFA verification failed:', error);
          resultDiv.innerHTML = `
            <div class="error-box">
              <strong>Verification failed:</strong> ${error.message}
            </div>
          `;
        }
      }

      // Display backup codes
      function displayBackupCodes(codes) {
        const container = document.getElementById('setupContainer');
        container.innerHTML = `
          <div class="success-box">
            <strong>‚úÖ MFA Successfully Enabled!</strong><br>
            Your account is now protected with multi-factor authentication.
          </div>
          
          <div class="setup-step">
            <div class="step-header">
              <div class="step-number">4</div>
              <h3>Save Your Backup Codes</h3>
            </div>
            <div class="warning-box">
              <strong>Important:</strong> Save these backup codes in a safe place. 
              They are the only way to recover access if you lose your authenticator device.
              Each code can only be used once.
            </div>
            <div class="backup-codes">
              ${codes.map(code => `<div class="backup-code">${code}</div>`).join('')}
            </div>
            <div class="mfa-actions">
              <button class="btn btn-primary" onclick="downloadBackupCodes(${JSON.stringify(codes).replace(/"/g, '&quot;')})">Download Codes</button>
              <button class="btn btn-success" onclick="loadMfaStatus()">Continue</button>
            </div>
          </div>
        `;
      }

      // Generate new backup codes
      async function generateBackupCodes() {
        if (!confirm('This will invalidate all existing backup codes. Continue?')) {
          return;
        }

        try {
          const response = await fetch('/api/admin/mfa-setup?action=generate-backup-codes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error);
          }

          displayBackupCodes(result.backupCodes);
        } catch (error) {
          console.error('Failed to generate backup codes:', error);
          alert(`Failed to generate backup codes: ${error.message}`);
        }
      }

      // Confirm disable MFA
      function confirmDisableMfa() {
        const code = prompt('Enter your current TOTP code or backup code to disable MFA:');
        if (!code) return;

        disableMfa(code);
      }

      // Disable MFA
      async function disableMfa(confirmationCode) {
        try {
          const response = await fetch('/api/admin/mfa-setup?action=disable', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ confirmationCode })
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error);
          }

          alert('MFA has been disabled successfully.');
          loadMfaStatus();
        } catch (error) {
          console.error('Failed to disable MFA:', error);
          alert(`Failed to disable MFA: ${error.message}`);
        }
      }

      // Download backup codes
      function downloadBackupCodes(codes) {
        const content = `A Lo Cubano Boulder Fest - Admin MFA Backup Codes
Generated: ${new Date().toLocaleString()}

IMPORTANT: Store these codes safely. Each can only be used once.

${codes.map((code, i) => `${i + 1}. ${code}`).join('\n')}

Instructions:
- Use these codes if you lose access to your authenticator app
- Enter any unused code when prompted for MFA
- Generate new codes after using several of them
`;

        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mfa-backup-codes-${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Show recovery options
      function showRecoveryOptions() {
        if (confirm('Open recovery options? This should only be used if you have lost access to your authenticator device.')) {
          window.open('/pages/admin/mfa-recovery.html', '_blank');
        }
      }

      // Display error
      function displayError(containerId, message) {
        const container = document.getElementById(containerId);
        container.innerHTML = `
          <div class="error-box">
            <strong>Error:</strong> ${escapeHtml(message)}
          </div>
        `;
      }

      // HTML escaping function
      function escapeHtml(unsafe) {
        if (unsafe == null) return '';
        return String(unsafe)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>