<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Portal - A Lo Cubano Boulder Fest</title>

    <!-- Main Site CSS System -->
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/typography.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/navigation.css" />
    <link rel="stylesheet" href="/css/admin-overrides.css" />

    <style>
      /* Admin Portal Specific Styles */
      body {
        background: linear-gradient(
          135deg,
          var(--color-blue) 0%,
          var(--color-red) 100%
        );
        min-height: 100vh;
        padding: var(--space-lg);
      }

      /* Endpoints Grid Styling */
      .endpoints-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: var(--space-lg);
      }

      .endpoint-item {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        padding: var(--space-md);
        background: var(--color-background-secondary);
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        font-size: var(--font-size-sm);
        transition: all var(--transition-base);
      }

      .endpoint-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        border-color: var(--color-blue);
      }

      .endpoint-item .method {
        background: var(--color-success);
        color: var(--color-text-inverse);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        font-family: var(--font-code);
        font-size: var(--font-size-xs);
        font-weight: 700;
        min-width: 50px;
        text-align: center;
        text-transform: uppercase;
      }

      .endpoint-item .method.post {
        background: var(--color-blue);
      }

      .endpoint-item code {
        color: var(--color-red);
        font-family: var(--font-code);
        font-size: var(--font-size-xs);
      }

      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        body {
          padding: var(--space-md);
        }

        .endpoints-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>

    <!-- Theme Manager -->
    <script type="module" src="/js/theme-manager.js"></script>
  </head>
  <body class="admin-container">
    <!-- Unified Admin Header -->
    <header class="admin-header">
      <div class="admin-header-content">
        <div>
          <h1 class="admin-header-title">Admin Portal</h1>
          <p class="admin-header-subtitle">A Lo Cubano Boulder Fest - Central Administration Hub</p>
        </div>
        <div class="admin-header-actions">
          <div class="admin-status-indicator">
            <span class="admin-status-dot"></span>
            <span id="status">All Systems Operational</span>
          </div>
          <button class="admin-btn admin-btn-primary" onclick="logout()">
            <span>Logout</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Unified Admin Navigation -->
    <nav class="admin-navigation">
      <ul class="admin-nav-list">
        <li class="admin-nav-item">
          <a href="/admin" class="admin-nav-link active">
            <span>Portal</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/dashboard" class="admin-nav-link">
            <span>Dashboard</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/tickets" class="admin-nav-link">
            <span>Tickets</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/analytics" class="admin-nav-link">
            <span>Analytics</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/checkin" class="admin-nav-link">
            <span>Check-in Scanner</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- Quick Actions Section -->
    <div class="admin-card">
      <div class="admin-card-header">
        <h2 class="admin-card-title">Quick Actions</h2>
      </div>
      <div class="admin-card-body">
        <div class="admin-grid auto-fit">
          <button onclick="syncToSheets()" class="admin-btn admin-btn-primary">
            <span>Sync Sheets</span>
          </button>
          <button onclick="generateReport()" class="admin-btn admin-btn-secondary">
            <span>Export</span>
          </button>
          <button onclick="testDatabase()" class="admin-btn admin-btn-ghost">
            <span>DB Health</span>
          </button>
          <button onclick="clearCache()" class="admin-btn admin-btn-ghost">
            <span>Clear Cache</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Admin Sections -->
    <div class="admin-grid auto-fit">
      <!-- Dashboards & Analytics -->
      <div class="admin-card admin-action-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">
            <span class="card-icon">D</span>
            <span>Dashboards & Analytics</span>
          </h2>
        </div>
        <div class="admin-card-body">
          <p>Registration management, transactions, and comprehensive analytics with charts and insights. Use the navigation above to access the specific dashboard or analytics views.</p>
        </div>
      </div>

      <!-- Authentication & Security -->
      <div class="admin-card admin-action-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">
            <span class="card-icon">S</span>
            <span>Authentication & Security</span>
          </h2>
        </div>
        <div class="admin-card-body">
          <p>Secure admin authentication, mobile auth testing, and CSRF token management</p>
          <div style="margin-top: var(--space-lg); display: flex; gap: var(--space-sm); flex-wrap: wrap;">
            <a href="/admin/login" class="admin-btn admin-btn-sm">
              <span>Login</span>
            </a>
            <button class="admin-btn admin-btn-sm admin-btn-ghost" onclick="testMobileAuth()">
              <span>Test Auth</span>
            </button>
            <button class="admin-btn admin-btn-sm admin-btn-ghost" onclick="viewCSRFToken()">
              <span>CSRF Status</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Data Management -->
      <div class="admin-card admin-action-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">
            <span class="card-icon">M</span>
            <span>Data Management</span>
          </h2>
        </div>
        <div class="admin-card-body">
          <p>Registration data, transaction history, and Google Sheets integration for comprehensive data access. Access detailed data views through the Dashboard above.</p>
          <div style="margin-top: var(--space-lg); display: flex; gap: var(--space-sm); flex-wrap: wrap;">
            <button class="admin-btn admin-btn-sm admin-btn-ghost" onclick="openGoogleSheets()">
              <span>Open Sheets</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Tools & Utilities -->
      <div class="admin-card admin-action-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">
            <span class="card-icon">T</span>
            <span>Tools & Utilities</span>
          </h2>
        </div>
        <div class="admin-card-body">
          <p>Database health checks, cache management, system utilities, and comprehensive documentation. Common utilities are available in Quick Actions above.</p>
          <div style="margin-top: var(--space-lg); display: flex; gap: var(--space-sm); flex-wrap: wrap;">
            <a href="/docs/ADMIN_GUIDE.md" target="_blank" rel="noopener noreferrer" class="admin-btn admin-btn-sm">
              <span>Documentation</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- API Endpoints Section -->
    <div class="admin-card">
      <div class="admin-card-header">
        <h2 class="admin-card-title">Available API Endpoints</h2>
      </div>
      <div class="admin-card-body">
        <div class="endpoints-grid">
          <div class="endpoint-item">
            <span class="method">GET</span>
            <code>/api/admin/dashboard</code>
          </div>
          <div class="endpoint-item">
            <span class="method post">POST</span>
            <code>/api/admin/login</code>
          </div>
          <div class="endpoint-item">
            <span class="method post">POST</span>
            <code>/api/admin/mobile-login</code>
          </div>
          <div class="endpoint-item">
            <span class="method">GET</span>
            <code>/api/admin/registrations</code>
          </div>
          <div class="endpoint-item">
            <span class="method">GET</span>
            <code>/api/admin/transactions</code>
          </div>
          <div class="endpoint-item">
            <span class="method">GET</span>
            <code>/api/admin/analytics</code>
          </div>
          <div class="endpoint-item">
            <span class="method">GET</span>
            <code>/api/admin/events</code>
          </div>
          <div class="endpoint-item">
            <span class="method">GET</span>
            <code>/api/admin/generate-report</code>
          </div>
          <div class="endpoint-item">
            <span class="method">GET</span>
            <code>/api/admin/csrf-token</code>
          </div>
          <div class="endpoint-item">
            <span class="method post">POST</span>
            <code>/api/sheets/sync</code>
          </div>
          <div class="endpoint-item">
            <span class="method">GET</span>
            <code>/api/sheets/scheduled-sync</code>
          </div>
          <div class="endpoint-item">
            <span class="method post">POST</span>
            <code>/api/tickets/validate</code>
          </div>
          <div class="endpoint-item">
            <span class="method">GET</span>
            <code>/api/test-db</code>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="admin-card" style="text-align: center; margin-top: var(--space-4xl);">
      <div class="admin-card-body">
        <p style="color: var(--color-text-secondary); font-family: var(--font-sans); font-size: var(--font-size-sm); margin-bottom: var(--space-sm);">
          <strong style="color: var(--color-text-primary); font-family: var(--font-display);">A Lo Cubano Boulder Fest</strong> Admin Portal v1.0
        </p>
        <p style="color: var(--color-text-tertiary); font-size: var(--font-size-xs); margin-bottom: var(--space-sm);">
          Festival Dates: May 15-17, 2026 | Avalon Ballroom, Boulder, CO
        </p>
        <div style="display: flex; gap: var(--space-lg); justify-content: center; flex-wrap: wrap;">
          <a href="mailto:alocubanoboulderfest@gmail.com" style="color: var(--color-blue); text-decoration: none; font-size: var(--font-size-sm);">Support</a>
          <a href="https://github.com/damilola-elegbede/alocubano.boulderfest" target="_blank" rel="noopener noreferrer" style="color: var(--color-blue); text-decoration: none; font-size: var(--font-size-sm);">GitHub</a>
          <a href="/docs" target="_blank" rel="noopener noreferrer" style="color: var(--color-blue); text-decoration: none; font-size: var(--font-size-sm);">Documentation</a>
        </div>
      </div>
    </div>

    <script>
      // Check authentication on load
      async function checkAuth() {
        try {
          const response = await fetch("/api/admin/verify-session");
          if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
              // Only redirect to login for authentication failures
              window.location.href = "/admin/login";
              return false;
            } else {
              // For other errors (500, 503), show error but stay on page
              console.error("Session check failed with status:", response.status);
              alert("Error verifying session. Please refresh the page.");
              return false;
            }
          }
          return true;
        } catch (error) {
          console.error("Auth check failed:", error);
          alert("Network error. Please check your connection and refresh.");
          return false;
        }
      }

      // Sync to Google Sheets
      async function syncToSheets() {
        if (!confirm("Sync all data to Google Sheets?")) return;

        try {
          // Get CSRF token for state-changing operation
          const headers = { "Content-Type": "application/json" };
          try {
            const csrfResponse = await fetch("/api/admin/csrf-token");
            if (csrfResponse.ok) {
              const csrfData = await csrfResponse.json();
              headers["X-CSRF-Token"] = csrfData.token;
            }
          } catch (error) {
            console.warn("Could not fetch CSRF token:", error);
          }

          const response = await fetch("/api/sheets/sync", {
            method: "POST",
            headers: headers,
          });

          if (response.ok) {
            alert("Successfully synced to Google Sheets!");
          } else {
            alert("Sync failed. Please try again.");
          }
        } catch (error) {
          console.error("Sync error:", error);
          alert("Sync failed. Please check the connection.");
        }
      }

      // Generate report
      async function generateReport() {
        const format = confirm("Download as CSV? (Cancel for JSON)")
          ? "csv"
          : "json";
        window.open(
          `/api/admin/generate-report?format=${format}`,
          "_blank",
          "noopener,noreferrer",
        );
      }

      // Test database
      async function testDatabase() {
        try {
          const response = await fetch("/api/test-db");
          const data = await response.json();

          if (data.status === "healthy") {
            const tableCount = data.tests.tables.data ? Object.keys(data.tests.tables.data).length : 0;
            alert(
              `Database Healthy!\n\nStatus: ${data.status}\nDuration: ${data.duration}\nTables: ${tableCount}\nTests Passed: ${data.summary.passed}/${data.summary.totalTests}`,
            );
          } else if (data.status === "degraded") {
            alert(
              `Database Partially Healthy\n\nStatus: ${data.status}\nTests Passed: ${data.summary.passed}/${data.summary.totalTests}\n\nCheck console for details.`,
            );
            console.error("Database test results:", data);
          } else {
            alert("Database issues detected. Check console for details.");
            console.error("Database test:", data);
          }
        } catch (error) {
          alert("Database test failed");
          console.error(error);
        }
      }

      // Test mobile auth
      async function testMobileAuth() {
        const password = prompt("Enter staff password to test mobile auth:");
        if (!password) return;

        try {
          // Get CSRF token for state-changing operation
          const headers = { "Content-Type": "application/json" };
          let csrfToken = null;
          try {
            const csrfResponse = await fetch("/api/admin/csrf-token");
            if (csrfResponse.ok) {
              const csrfData = await csrfResponse.json();
              headers["X-CSRF-Token"] = csrfData.token;
              csrfToken = csrfData.token;
            }
          } catch (error) {
            console.warn("Could not fetch CSRF token:", error);
          }

          const response = await fetch("/api/admin/mobile-login", {
            method: "POST",
            headers: headers,
            body: JSON.stringify({
              password,
              csrfToken: csrfToken,
            }),
          });

          const data = await response.json();
          if (response.ok) {
            alert(
              `Mobile auth successful!\n\nToken: ${data.token.substring(0, 20)}...`,
            );
          } else {
            alert(`Mobile auth failed: ${data.error}`);
          }
        } catch (error) {
          alert("Mobile auth test failed");
          console.error(error);
        }
      }

      // View CSRF token
      async function viewCSRFToken() {
        try {
          const response = await fetch("/api/admin/csrf-token");
          const data = await response.json();
          alert(
            `CSRF Token Info:\n\nToken: ${data.csrfToken.substring(0, 20)}...\nExpires: ${new Date(Date.now() + 3600000).toLocaleString()}`,
          );
        } catch (error) {
          alert("Failed to fetch CSRF token");
          console.error(error);
        }
      }

      // Clear cache
      function clearCache() {
        if (!confirm("Clear all cached data?")) return;

        localStorage.clear();
        sessionStorage.clear();

        if ("caches" in window) {
          caches.keys().then((names) => {
            names.forEach((name) => caches.delete(name));
          });
        }

        alert("Cache cleared successfully!");
        window.location.reload();
      }

      // Open Google Sheets
      function openGoogleSheets() {
        alert(
          "Google Sheets integration requires proper setup.\nPlease refer to the documentation for sheet ID configuration.",
        );
        // In production, this would open the actual Google Sheets URL
        // window.open('https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID', '_blank', 'noopener,noreferrer');
      }

      // Logout
      async function logout() {
        if (!confirm("Are you sure you want to logout?")) return;

        try {
          await fetch("/api/admin/login", {
            method: "DELETE",
          });
        } finally {
          // Clear client storage
          localStorage.removeItem('adminToken');
          sessionStorage.clear();
          // Redirect
          window.location.href = '/admin/login';
        }
      }

      // Initialize
      checkAuth();
    </script>
  </body>
</html>
