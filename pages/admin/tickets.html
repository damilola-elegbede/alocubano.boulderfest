<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <!-- Inline theme detection to prevent FOUC -->
    <script>
      (function() {
        // Detect admin pages
        const path = window.location.pathname.toLowerCase();
        const isAdmin = path.includes('/admin') || path.includes('pages/admin');

        if (isAdmin) {
          // Admin pages always use dark theme
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          // Main site: check user preference
          let stored = null;
          try {
            stored = localStorage.getItem('theme-preference');
          } catch {
            // localStorage might be disabled
          }

          const preference = stored || 'system';
          let theme = preference;

          if (preference === 'system') {
            // Detect system preference
            theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
              ? 'dark'
              : 'light';
          }

          document.documentElement.setAttribute('data-theme', theme);
        }
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Tickets - A Lo Cubano Boulder Fest</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    
    <!-- Preconnect to Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Preload critical fonts -->
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Playfair+Display:ital,wght@0,400;0,900;1,400;1,900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Playfair+Display:ital,wght@0,400;0,900;1,400;1,900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" media="print" onload="this.media='all'">
    <noscript>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Playfair+Display:ital,wght@0,400;0,900;1,400;1,900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap">
    </noscript>
    <!-- Critical CSS (render-blocking) -->
    <link rel="stylesheet" href="/css/bundle-critical.css" />

    <!-- Admin CSS -->
    <link rel="stylesheet" href="/css/bundle-admin.css" />

    <!-- Deferred CSS (lazy-loaded) -->
    <link rel="stylesheet" href="/css/bundle-deferred.css" media="print" onload="this.media='all'">
    <noscript>
      <link rel="stylesheet" href="/css/bundle-deferred.css">
    </noscript>
  <script src="/js/admin-auth-guard.js"></script>
    <script type="module" src="/js/theme-manager.js"></script>
    <script type="module" src="/js/time-manager.js"></script>
    <style>
      /* Transfer Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--space-xl);
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-lg);
        padding-bottom: var(--space-md);
        border-bottom: 2px solid var(--color-border);
      }

      .modal-title {
        font-size: var(--font-size-xl);
        font-weight: 700;
        color: var(--color-text-primary);
      }

      .modal-close {
        background: transparent !important;
        border: none !important;
        color: var(--color-text-secondary) !important;
        font-size: var(--font-size-xl);
        cursor: pointer;
        min-width: auto !important;
        min-height: auto !important;
        padding: var(--space-xs) !important;
      }

      .modal-close:hover {
        color: var(--color-text-primary) !important;
      }

      .alert {
        padding: var(--space-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-md);
        font-size: var(--font-size-sm);
      }

      .alert-error {
        background: rgba(204, 41, 54, 0.1);
        border: 1px solid rgba(204, 41, 54, 0.3);
        color: var(--color-error);
      }

      .alert-success {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: var(--color-success);
      }

      .alert-info {
        background: rgba(91, 107, 181, 0.1);
        border: 1px solid rgba(91, 107, 181, 0.3);
        color: var(--color-blue);
      }

      .transfer-summary {
        background: var(--color-background-secondary);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        margin: var(--space-md) 0;
      }

      .transfer-summary-row {
        display: flex;
        justify-content: space-between;
        padding: var(--space-sm) 0;
      }

      .transfer-summary-label {
        font-weight: 600;
        color: var(--color-text-secondary);
      }

      .transfer-summary-value {
        color: var(--color-text-primary);
        font-family: var(--font-mono);
      }
    </style>
  </head>
  <body class="admin-container">
    <!-- Auth Loading State -->
    <div id="auth-loading" class="auth-loading" style="display: none;">
      <div class="auth-loading-content">
        <div class="auth-spinner"></div>
        <h2>Verifying Authentication...</h2>
      </div>
    </div>

    <!-- Mobile Hamburger Menu Toggle -->
    <button class="admin-menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false">
      <div class="admin-menu-icon">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </button>

    <!-- Unified Admin Header -->
    <header class="admin-header">
      <div class="admin-header-content">
        <div>
          <h1 class="admin-header-title">Tickets Management</h1>
          <p class="admin-header-subtitle">A Lo Cubano Boulder Fest - Ticket Administration</p>
        </div>
        <div class="admin-header-actions">
          <!-- Event Selector -->
          <div id="event-selector-container"></div>
          <button class="admin-btn admin-btn-primary" onclick="logout()">
            <span>Logout</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Unified Admin Navigation -->
    <nav class="admin-navigation">
      <ul class="admin-nav-list">
        <!-- Core Tools Group -->
        <li role="presentation" class="admin-nav-group-header">Core Tools</li>
        <li class="admin-nav-item">
          <a href="/admin" class="admin-nav-link">
            <span class="nav-icon">üè†</span>
            <span>Portal</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/dashboard" class="admin-nav-link">
            <span class="nav-icon">üìä</span>
            <span>Dashboard</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/checkin" class="admin-nav-link">
            <span class="nav-icon">üì±</span>
            <span>Check-in Scanner</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/manual-entry" class="admin-nav-link">
            <span class="nav-icon">‚úèÔ∏è</span>
            <span>Manual Entry</span>
          </a>
        </li>

        <!-- Data & Analytics Group -->
        <li role="presentation" aria-hidden="true" class="admin-nav-separator"></li>
        <li role="presentation" class="admin-nav-group-header">Data & Analytics</li>
        <li class="admin-nav-item">
          <a href="/admin/tickets" class="admin-nav-link active">
            <span class="nav-icon">üé´</span>
            <span>Tickets</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/analytics" class="admin-nav-link">
            <span class="nav-icon">üìà</span>
            <span>Analytics</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/donations" class="admin-nav-link">
            <span class="nav-icon">üíù</span>
            <span>Donations</span>
          </a>
        </li>

        <!-- Utilities Group -->
        <li role="presentation" aria-hidden="true" class="admin-nav-separator"></li>
        <li role="presentation" class="admin-nav-group-header">Utilities</li>
        <li class="admin-nav-item">
          <a href="/admin/test" class="admin-nav-link">
            <span class="nav-icon">üß™</span>
            <span>Test</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/api-endpoints" class="admin-nav-link">
            <span class="nav-icon">üîå</span>
            <span>API Endpoints</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/audit-logs" class="admin-nav-link">
            <span class="nav-icon">üìã</span>
            <span>Audit Logs</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- Tickets Section -->
    <div class="admin-card admin-mb-xl" id="tickets">
      <div class="admin-card-header">
        <h2 class="admin-card-title">Tickets</h2>
        <div class="admin-card-actions">
          <button class="admin-btn admin-btn-sm" onclick="exportToCSV()">
            <span>Export CSV</span>
          </button>
        </div>
      </div>
      <div class="admin-card-body">

        <div class="admin-flex admin-flex-wrap admin-gap-md admin-mb-xl">
          <input
            type="text"
            id="searchInput"
            class="admin-form-input"
            placeholder="Search by name, email, or ticket ID..."
            onkeypress="if(event.key==='Enter') searchTickets()"
            oninput="handleSearchInput()"
            data-testid="search-tickets"
            style="flex: 1; min-width: 250px;"
          />
          <select
            id="statusFilter"
            class="admin-form-select"
            onchange="searchTickets()"
            data-testid="ticket-status-filter"
            style="min-width: 120px;"
          >
            <option value="">All Status</option>
            <option value="valid">Valid</option>
            <option value="cancelled">Cancelled</option>
            <option value="transferred">Transferred</option>
          </select>
          <select 
            id="checkinFilter" 
            class="admin-form-select" 
            onchange="searchTickets()"
            style="min-width: 150px;"
          >
            <option value="">All Tickets</option>
            <option value="false">Not Checked In</option>
            <option value="true">Checked In</option>
          </select>
          <select 
            id="typeFilter" 
            class="admin-form-select" 
            onchange="searchTickets()"
            style="min-width: 150px;"
          >
            <option value="">All Types</option>
            <option value="vip-pass">VIP Pass</option>
            <option value="weekend-pass">Weekend Pass</option>
            <option value="friday-pass">Friday</option>
            <option value="saturday-pass">Saturday</option>
            <option value="sunday-pass">Sunday</option>
            <option value="workshop">Workshop</option>
            <option value="general-admission">General</option>
          </select>
          <button 
            class="admin-btn admin-btn-primary" 
            onclick="searchTickets()" 
            data-testid="search-button"
          >
            <span>Search</span>
          </button>
        </div>

        <div id="ticketsTable" data-testid="tickets-table">
          <div class="admin-loading">Loading tickets...</div>
        </div>

        <div class="pagination admin-flex admin-justify-center admin-gap-sm admin-mt-xl" id="pagination"></div>
      </div>
    </div>

    <script>
      // Security improvements:
      // 1. All user-provided data is escaped using escapeHtml() to prevent XSS attacks
      // 2. CSRF tokens are fetched and included in all state-changing requests
      // 3. Error messages are safely displayed using textContent or escapeHtml()

      let currentPage = 0;
      const pageSize = 50;
      let authToken = null;
      let csrfToken = null;
      let timeManager = null;

      // Import timeManager
      import('/js/time-manager.js').then(module => {
        timeManager = module.default;
      });
      
      // AbortController for canceling stale fetches during rapid searches
      let searchAbortController = null;
      
      // Debounced search timer
      let searchTimeout = null;

      // HTML escaping function to prevent XSS attacks
      // CRITICAL: Use this for ALL user-provided data displayed in innerHTML
      function escapeHtml(unsafe) {
        if (unsafe == null) return "";
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Fetch CSRF token
      async function fetchCSRFToken() {
        try {
          const response = await fetch("/api/admin/csrf-token", {
            credentials: "include"
          });
          if (response.ok) {
            const data = await response.json();
            csrfToken = data.csrfToken;
            // Refresh token before it expires (50 minutes)
            setTimeout(fetchCSRFToken, 50 * 60 * 1000);
          }
        } catch (error) {
          console.warn("Failed to fetch CSRF token:", error);
          // Continue without CSRF token for backward compatibility
        }
      }

      // Check authentication on load
      async function checkAuth() {
        if (window.AdminAuthGuard) {
          return await window.AdminAuthGuard.verifyAndShow();
        } else {
          console.error("AdminAuthGuard not available");
          window.location.href = "/admin/login";
          return false;
        }
      }

      // Load tickets data - accepts eventId parameter for event filtering
      async function loadTickets(eventId = null, page = 0, abortSignal = null) {
        currentPage = page;
        const offset = page * pageSize;

        const search = document.getElementById("searchInput").value;
        const status = document.getElementById("statusFilter").value;
        const checkedIn = document.getElementById("checkinFilter").value;
        const ticketType = document.getElementById("typeFilter").value;

        const params = new URLSearchParams({
          limit: pageSize,
          offset: offset,
          ...(search && { search }),
          ...(status && { status }),
          ...(checkedIn && { checkedIn }),
          ...(ticketType && { ticketType }),
          ...(eventId && eventId !== 'all' && { eventId }),
        });

        try {
          const fetchOptions = {
            credentials: 'include'
          };
          if (abortSignal) {
            fetchOptions.signal = abortSignal;
          }

          const response = await fetch(`/api/admin/registrations?${params}`, fetchOptions);
          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          displayTickets(data.registrations);
          displayPagination(data.total, page);
        } catch (error) {
          // Handle AbortError gracefully - don't show error for cancelled requests
          if (error.name === 'AbortError') {
            console.log('Search request cancelled');
            return;
          }
          
          console.error("Failed to load tickets:", error);
          document.getElementById("ticketsTable").innerHTML = `
                    <div class="error">Failed to load tickets: ${escapeHtml(error.message)}</div>
                `;
        }
      }

      // Make loadTickets globally accessible
      window.loadTickets = loadTickets;

      // Display tickets table
      function displayTickets(tickets) {
        if (tickets.length === 0) {
          document.getElementById("ticketsTable").innerHTML = `
                    <p class="admin-text-center admin-p-xl admin-text-muted">
                        No tickets found
                    </p>
                `;
          return;
        }

        const tableHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Order</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tickets
                          .map(
                            (ticket) => `
                            <tr>
                                <td>
                                    <a href="/admin/ticket-detail?ticketId=${encodeURIComponent(ticket.ticket_id)}"
                                       target="_blank"
                                       rel="noopener noreferrer"
                                       class="detail-link"
                                       title="View admin ticket details"
                                       style="text-decoration: none;">
                                      <code class="admin-p-xs" style="background: var(--color-background-secondary); border-radius: var(--radius-sm); cursor: pointer;">${escapeHtml(ticket.ticket_id)}</code>
                                    </a>
                                </td>
                                <td>${escapeHtml(formatTicketType(ticket.ticket_type))}</td>
                                <td>
                                    <span class="status-badge ${ticket.checked_in_at ? "success" : ticket.status === "valid" ? "info" : "warning"}">
                                        ${ticket.checked_in_at ? "Checked In" : escapeHtml(ticket.status)}
                                    </span>
                                </td>
                                <td>${escapeHtml(ticket.order_number)}</td>
                                <td style="white-space: nowrap;">
                                    ${
                                      ticket.checked_in_at
                                        ? `<button class="admin-btn admin-btn-sm admin-btn-secondary" data-action="undo" data-ticket-id="${escapeHtml(ticket.ticket_id)}" data-testid="checkin-ticket_${escapeHtml(ticket.ticket_id)}"><span>Undo</span></button>`
                                        : `<button class="admin-btn admin-btn-sm admin-btn-success" data-action="checkin" data-ticket-id="${escapeHtml(ticket.ticket_id)}" data-testid="checkin-ticket_${escapeHtml(ticket.ticket_id)}"><span>Check In</span></button>`
                                    }
                                    <button class="admin-btn admin-btn-sm admin-btn-primary" data-action="transfer" data-ticket-id="${escapeHtml(ticket.ticket_id)}" data-ticket-email="${escapeHtml(ticket.attendee_email || '')}" data-ticket-firstname="${escapeHtml(ticket.attendee_first_name || '')}" data-ticket-lastname="${escapeHtml(ticket.attendee_last_name || '')}" style="margin-left: var(--space-xs);"><span>Transfer</span></button>
                                </td>
                            </tr>
                        `,
                          )
                          .join("")}
                    </tbody>
                </table>
            `;

        document.getElementById("ticketsTable").innerHTML = tableHTML;
      }

      // Display pagination
      function displayPagination(total, currentPage) {
        const totalPages = Math.ceil(total / pageSize);
        const pagination = document.getElementById("pagination");

        if (totalPages <= 1) {
          pagination.innerHTML = "";
          return;
        }

        pagination.innerHTML = `
                <button class="admin-btn admin-btn-ghost" onclick="loadTickets(window.eventSelector ? window.eventSelector.getSelectedEventId() : null, 0)" ${currentPage === 0 ? "disabled" : ""}>
                    <span>First</span>
                </button>
                <button class="admin-btn admin-btn-ghost" onclick="loadTickets(window.eventSelector ? window.eventSelector.getSelectedEventId() : null, ${currentPage - 1})" ${currentPage === 0 ? "disabled" : ""}>
                    <span>Previous</span>
                </button>
                <span class="admin-p-md admin-text-secondary" style="font-family: var(--font-code); font-size: var(--font-size-sm);">
                    Page ${currentPage + 1} of ${totalPages}
                </span>
                <button class="admin-btn admin-btn-ghost" onclick="loadTickets(window.eventSelector ? window.eventSelector.getSelectedEventId() : null, ${currentPage + 1})" ${currentPage >= totalPages - 1 ? "disabled" : ""}>
                    <span>Next</span>
                </button>
                <button class="admin-btn admin-btn-ghost" onclick="loadTickets(window.eventSelector ? window.eventSelector.getSelectedEventId() : null, ${totalPages - 1})" ${currentPage >= totalPages - 1 ? "disabled" : ""}>
                    <span>Last</span>
                </button>
            `;
      }

      // Search tickets
      function searchTickets() {
        // Cancel any pending search request
        if (searchAbortController) {
          searchAbortController.abort();
        }
        
        // Create new AbortController for this search
        searchAbortController = new AbortController();
        
        const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;
        loadTickets(selectedEventId, 0, searchAbortController.signal);
      }
      
      // Handle search input with debouncing and abort controller
      function handleSearchInput() {
        // Clear existing timeout
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }
        
        // Cancel any pending search request
        if (searchAbortController) {
          searchAbortController.abort();
        }
        
        // Set new timeout for debounced search (300ms delay)
        searchTimeout = setTimeout(() => {
          searchTickets();
        }, 300);
      }

      // Check in ticket
      async function checkinTicket(ticketId) {
        if (!confirm(`Check in ticket ${ticketId}?`)) return;

        try {
          const headers = { "Content-Type": "application/json" };
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const response = await fetch(
            `/api/admin/registrations?ticketId=${encodeURIComponent(ticketId)}`,
            {
              method: "PUT",
              headers: headers,
              body: JSON.stringify({ action: "checkin" }),
              credentials: 'include'
            },
          );

          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;
          await loadTickets(selectedEventId, currentPage);
        } catch (error) {
          alert(`Failed to check in: ${escapeHtml(error.message)}`);
        }
      }

      // Undo check in
      async function undoCheckin(ticketId) {
        if (!confirm(`Undo check-in for ticket ${ticketId}?`)) return;

        try {
          const headers = { "Content-Type": "application/json" };
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const response = await fetch(
            `/api/admin/registrations?ticketId=${encodeURIComponent(ticketId)}`,
            {
              method: "PUT",
              headers: headers,
              body: JSON.stringify({ action: "undo_checkin" }),
              credentials: 'include'
            },
          );

          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;
          await loadTickets(selectedEventId, currentPage);
        } catch (error) {
          alert(`Failed to undo check-in: ${escapeHtml(error.message)}`);
        }
      }

      // Export to CSV
      async function exportToCSV() {
        const search = document.getElementById("searchInput").value;
        const status = document.getElementById("statusFilter").value;
        const checkedIn = document.getElementById("checkinFilter").value;
        const ticketType = document.getElementById("typeFilter").value;
        const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;

        const params = new URLSearchParams({
          limit: 10000, // Export all
          offset: 0,
          ...(search && { search }),
          ...(status && { status }),
          ...(checkedIn && { checkedIn }),
          ...(ticketType && { ticketType }),
          ...(selectedEventId && selectedEventId !== 'all' && { eventId: selectedEventId }),
        });

        try {
          const response = await fetch(`/api/admin/registrations?${params}`, {
            credentials: 'include'
          });
          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          // Convert to CSV
          const csv = convertToCSV(data.registrations);

          // Download
          const blob = new Blob([csv], { type: "text/csv" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          const timestamp = timeManager ? timeManager.formatDate(new Date()).replace(/\s/g, '-') : new Date().toISOString().split("T")[0];
          a.download = `tickets-${timestamp}.csv`;
          a.click();
        } catch (error) {
          alert(`Export failed: ${escapeHtml(error.message)}`);
        }
      }

      // Convert to CSV
      function convertToCSV(data) {
        if (data.length === 0) return "";

        const headers = [
          "Ticket ID",
          "First Name",
          "Last Name",
          "Email",
          "Ticket Type",
          "Status",
          "Checked In",
          "Order Number",
        ];

        // Note: No HTML escaping needed for CSV export data
        // CSV format handles special characters differently
        const rows = data.map((row) => [
          row.ticket_id,
          row.attendee_first_name,
          row.attendee_last_name,
          row.attendee_email,
          row.ticket_type,
          row.status,
          row.checked_in_at ? "Yes" : "No",
          row.order_number,
        ]);

        return [
          headers.join(","),
          ...rows.map((row) =>
            row
              .map((cell) => `"${String(cell || "").replace(/"/g, '""')}"`)
              .join(","),
          ),
        ].join("\n");
      }

      // Format ticket type
      function formatTicketType(type) {
        const typeMap = {
          "vip-pass": "VIP Pass",
          "weekend-pass": "Weekend Pass",
          "friday-pass": "Friday",
          "saturday-pass": "Saturday",
          "sunday-pass": "Sunday",
          workshop: "Workshop",
          "general-admission": "General",
        };
        return typeMap[type] || type;
      }

      // Logout
      async function logout() {
        try {
          const headers = {};
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          await fetch("/api/admin/login", {
            method: "DELETE",
            headers: headers,
            credentials: "same-origin"
          });
        } finally {
          // Cookie cleared by server
          sessionStorage.clear();
          // Redirect
          window.location.href = '/admin/login';
        }
      }

      // Add event delegation for check-in and transfer buttons
      document
        .getElementById("ticketsTable")
        .addEventListener("click", function (event) {
          if (event.target.matches(".admin-btn[data-action]") ||
              (event.target.parentElement && event.target.parentElement.matches(".admin-btn[data-action]"))) {
            const button = event.target.matches(".admin-btn[data-action]")
              ? event.target
              : event.target.parentElement;
            const action = button.getAttribute("data-action");
            const ticketId = button.getAttribute("data-ticket-id");

            if (action === "checkin") {
              checkinTicket(ticketId);
            } else if (action === "undo") {
              undoCheckin(ticketId);
            } else if (action === "transfer") {
              const ticketEmail = button.getAttribute("data-ticket-email");
              const ticketFirstName = button.getAttribute("data-ticket-firstname");
              const ticketLastName = button.getAttribute("data-ticket-lastname");
              openTransferModal(ticketId, ticketEmail, ticketFirstName, ticketLastName);
            }
          }
        });

      // Initialize page
      async function initializePage() {
        // Check authentication first
        if (!(await checkAuth())) return;

        // Initialize and render event selector
        if (window.eventSelector) {
          await window.eventSelector.init();
          window.eventSelector.render('event-selector-container');
          
          // Set up event selector change listener
          window.eventSelector.onChange((eventId) => {
            loadTickets(eventId, 0);
          });
        }

        // Load initial tickets data
        const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;
        await loadTickets(selectedEventId);
      }

      // Transfer Modal Functions
      let currentTransferTicket = null;

      function openTransferModal(ticketId, currentEmail, currentFirstName, currentLastName) {
        const modal = document.getElementById('transfer-modal');
        const currentOwnerInfo = document.getElementById('current-owner-info');
        const transferTicketId = document.getElementById('transfer-ticket-id');
        const transferFromEmail = document.getElementById('transfer-from-email');

        // Update current owner info
        const ownerName = currentFirstName && currentLastName ? `${currentFirstName} ${currentLastName}` : (currentFirstName || 'Not registered');
        currentOwnerInfo.textContent = `${ownerName} (${currentEmail || 'No email'})`;

        // Update transfer summary
        transferTicketId.textContent = ticketId;
        transferFromEmail.textContent = currentEmail || 'Not set';

        // Store current ticket data
        currentTransferTicket = {
          ticketId: ticketId,
          currentEmail: currentEmail
        };

        // Clear form
        document.getElementById('transfer-form').reset();
        document.getElementById('transfer-to-email').textContent = '-';

        // Clear any previous alerts
        document.getElementById('transfer-alert-container').innerHTML = '';

        // Show modal
        modal.classList.add('show');
      }

      function closeTransferModal() {
        const modal = document.getElementById('transfer-modal');
        modal.classList.remove('show');
      }


      // Defer modal listeners until DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        // Update transfer summary as user types
        const newEmailInput = document.getElementById('new-email');
        if (newEmailInput) {
          newEmailInput.addEventListener('input', (e) => {
            document.getElementById('transfer-to-email').textContent = e.target.value || '-';
          });
        }

        // Close modal when clicking outside
        const transferModal = document.getElementById('transfer-modal');
        if (transferModal) {
          transferModal.addEventListener('click', (e) => {
            if (e.target.id === 'transfer-modal') {
              closeTransferModal();
            }
          });
        }
      });

      async function handleTransferSubmit(event) {
        event.preventDefault();

        const submitBtn = document.getElementById('transfer-submit-btn');
        const alertContainer = document.getElementById('transfer-alert-container');

        // Clear previous alerts
        alertContainer.innerHTML = '';

        // Get form data
        const formData = new FormData(event.target);
        const newFirstName = formData.get('newFirstName');
        const newLastName = formData.get('newLastName');
        const newEmail = formData.get('newEmail');
        const newPhone = formData.get('newPhone');
        const transferReason = formData.get('transferReason');

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span>Transferring...</span>';

        try {
          // Import CSRF service
          const csrfModule = await import('/js/csrf-service.js');
          const csrfService = csrfModule.default;
          const csrfToken = await csrfService.getCSRFToken();

          // Submit transfer request
          const response = await fetch('/api/admin/transfer-ticket', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': csrfToken
            },
            credentials: 'include',
            body: JSON.stringify({
              ticketId: currentTransferTicket.ticketId,
              newEmail: newEmail.trim(),
              newFirstName: newFirstName.trim(),
              newLastName: newLastName ? newLastName.trim() : '',
              newPhone: newPhone ? newPhone.trim() : null,
              transferReason: transferReason ? transferReason.trim() : null
            })
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || 'Failed to transfer ticket');
          }

          // Show success message
          alertContainer.innerHTML = `
            <div class="alert alert-success">
              <strong>Success!</strong> Ticket transferred successfully.<br>
              From: ${escapeHtml(result.transfer.from.email)}<br>
              To: ${escapeHtml(result.transfer.to.email)}
            </div>
          `;

          // Reload tickets list after 2 seconds
          setTimeout(() => {
            closeTransferModal();
            // Reload current page
            const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;
            loadTickets(selectedEventId, currentPage);
          }, 2000);

        } catch (error) {
          console.error('Transfer error:', error);

          // Show error message
          alertContainer.innerHTML = `
            <div class="alert alert-error">
              <strong>Error:</strong> ${escapeHtml(error.message || 'Failed to transfer ticket')}
            </div>
          `;

          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<span>Confirm Transfer</span>';
        }
      }

      // Initialize page immediately
      initializePage();
    </script>

    <!-- Transfer Modal -->
    <div id="transfer-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Transfer Ticket</h2>
          <button class="modal-close" onclick="closeTransferModal()">&times;</button>
        </div>

        <!-- Alert Container -->
        <div id="transfer-alert-container"></div>

        <!-- Current Owner Info -->
        <div class="alert alert-info">
          <strong>Current Owner:</strong><br>
          <span id="current-owner-info">Loading...</span>
        </div>

        <!-- Transfer Form -->
        <form id="transfer-form" onsubmit="handleTransferSubmit(event)">
          <div class="admin-form-group">
            <label for="new-first-name" class="admin-form-label">
              New First Name <span style="color: var(--color-error);">*</span>
            </label>
            <input
              type="text"
              id="new-first-name"
              name="newFirstName"
              class="admin-form-input"
              required
              maxlength="100"
              placeholder="John"
            />
          </div>

          <div class="admin-form-group">
            <label for="new-last-name" class="admin-form-label">
              New Last Name
            </label>
            <input
              type="text"
              id="new-last-name"
              name="newLastName"
              class="admin-form-input"
              maxlength="100"
              placeholder="Doe"
            />
          </div>

          <div class="admin-form-group">
            <label for="new-email" class="admin-form-label">
              New Email <span style="color: var(--color-error);">*</span>
            </label>
            <input
              type="email"
              id="new-email"
              name="newEmail"
              class="admin-form-input"
              required
              maxlength="255"
              placeholder="john@example.com"
            />
          </div>

          <div class="admin-form-group">
            <label for="new-phone" class="admin-form-label">
              New Phone (Optional)
            </label>
            <input
              type="tel"
              id="new-phone"
              name="newPhone"
              class="admin-form-input"
              maxlength="50"
              placeholder="+1 (303) 555-0123"
            />
          </div>

          <div class="admin-form-group">
            <label for="transfer-reason" class="admin-form-label">
              Transfer Reason (Optional)
            </label>
            <textarea
              id="transfer-reason"
              name="transferReason"
              class="admin-form-input"
              maxlength="500"
              rows="3"
              placeholder="Reason for transfer (optional)"
            ></textarea>
          </div>

          <!-- Transfer Summary -->
          <div class="transfer-summary">
            <h3 style="margin-bottom: var(--space-md); color: var(--color-text-primary);">Transfer Summary</h3>
            <div class="transfer-summary-row">
              <span class="transfer-summary-label">Ticket ID:</span>
              <span class="transfer-summary-value" id="transfer-ticket-id">-</span>
            </div>
            <div class="transfer-summary-row">
              <span class="transfer-summary-label">From:</span>
              <span class="transfer-summary-value" id="transfer-from-email">-</span>
            </div>
            <div class="transfer-summary-row">
              <span class="transfer-summary-label">To:</span>
              <span class="transfer-summary-value" id="transfer-to-email">-</span>
            </div>
          </div>

          <!-- Submit Buttons -->
          <div style="display: flex; gap: var(--space-md); margin-top: var(--space-lg);">
            <button type="submit" class="admin-btn admin-btn-primary" style="flex: 1;" id="transfer-submit-btn">
              <span>Confirm Transfer</span>
            </button>
            <button type="button" class="admin-btn admin-btn-secondary" style="flex: 1;" onclick="closeTransferModal()">
              <span>Cancel</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Event Selector Script -->
    <script src="/js/admin-event-selector.js"></script>

    <!-- Mobile Navigation Controller -->
    <script src="/js/admin-mobile-nav.js"></script>
  </body>
</html>