<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <!-- Inline theme detection to prevent FOUC -->
    <script>
      (function() {
        // Detect admin pages
        const path = window.location.pathname.toLowerCase();
        const isAdmin = path.includes('/admin') || path.includes('pages/admin');

        if (isAdmin) {
          // Admin pages always use dark theme
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          // Main site: check user preference
          let stored = null;
          try {
            stored = localStorage.getItem('theme-preference');
          } catch {
            // localStorage might be disabled
          }

          const preference = stored || 'system';
          let theme = preference;

          if (preference === 'system') {
            // Detect system preference
            theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
              ? 'dark'
              : 'light';
          }

          document.documentElement.setAttribute('data-theme', theme);
        }
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registrations - A Lo Cubano Boulder Fest</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/typography.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/navigation.css" />
    <link rel="stylesheet" href="/css/forms.css" />
    <link rel="stylesheet" href="/css/admin-overrides.css" />
    <script type="module" src="/js/theme-manager.js"></script>
    <script type="module" src="/js/time-manager.js"></script>
  </head>
  <body class="admin-container" style="visibility: hidden;">
    <!-- Auth Loading State -->
    <div id="auth-loading" class="auth-loading" style="display: none;">
      <div class="auth-loading-content">
        <div class="auth-spinner"></div>
        <h2>Verifying Authentication...</h2>
      </div>
    </div>

    <!-- Unified Admin Header -->
    <header class="admin-header">
      <div class="admin-header-content">
        <div>
          <h1 class="admin-header-title">Registrations</h1>
          <div id="event-selector-container"></div>
          <p class="admin-header-subtitle">A Lo Cubano Boulder Fest - Registration Management</p>
        </div>
        <div class="admin-header-actions">
          <button class="admin-btn admin-btn-primary" onclick="logout()">
            <span>Logout</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Unified Admin Navigation -->
    <nav class="admin-navigation">
      <ul class="admin-nav-list">
        <li class="admin-nav-item">
          <a href="/admin" class="admin-nav-link">
            <span>Portal</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/dashboard" class="admin-nav-link">
            <span>Dashboard</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/registrations" class="admin-nav-link active">
            <span>Registrations</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/analytics" class="admin-nav-link">
            <span>Analytics</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/checkin" class="admin-nav-link">
            <span>Check-in Scanner</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/test" class="admin-nav-link">
            <span>ðŸ§ª Test</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/api-endpoints" class="admin-nav-link">
            <span>API Endpoints</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- Registrations Section -->
    <div class="admin-card admin-mb-xl" id="registrations">
      <div class="admin-card-header">
        <h2 class="admin-card-title">Registrations</h2>
        <div class="admin-card-actions">
          <button class="admin-btn admin-btn-sm" onclick="exportToCSV()">
            <span>Export CSV</span>
          </button>
        </div>
      </div>
      <div class="admin-card-body">

        <div class="admin-flex admin-flex-wrap admin-gap-md admin-mb-xl">
          <input
            type="text"
            id="searchInput"
            class="admin-form-input"
            placeholder="Search by name, email, or ticket ID..."
            onkeypress="if(event.key==='Enter') searchRegistrations()"
            data-testid="search-registrations"
            style="flex: 1; min-width: 250px;"
          />
          <select
            id="statusFilter"
            class="admin-form-select"
            onchange="searchRegistrations()"
            data-testid="ticket-type-filter"
            style="min-width: 120px;"
          >
            <option value="">All Status</option>
            <option value="valid">Valid</option>
            <option value="cancelled">Cancelled</option>
            <option value="transferred">Transferred</option>
          </select>
          <select 
            id="checkinFilter" 
            class="admin-form-select" 
            onchange="searchRegistrations()"
            style="min-width: 150px;"
          >
            <option value="">All Tickets</option>
            <option value="false">Not Checked In</option>
            <option value="true">Checked In</option>
          </select>
          <button 
            class="admin-btn admin-btn-primary" 
            onclick="searchRegistrations()" 
            data-testid="search-button"
          >
            <span>Search</span>
          </button>
        </div>

        <div id="registrationsTable" data-testid="registrations-table">
          <div class="admin-loading">Loading registrations...</div>
        </div>

        <div class="pagination admin-flex admin-justify-center admin-gap-sm admin-mt-xl" id="pagination"></div>
      </div>
    </div>

    <script>
      // Security improvements:
      // 1. All user-provided data is escaped using escapeHtml() to prevent XSS attacks
      // 2. CSRF tokens are fetched and included in all state-changing requests
      // 3. Error messages are safely displayed using textContent or escapeHtml()

      let currentPage = 0;
      const pageSize = 50;
      let authToken = null;
      let csrfToken = null;
      let timeManager = null;

      // Import timeManager
      import('/js/time-manager.js').then(module => {
        timeManager = module.default;
      });

      // HTML escaping function to prevent XSS attacks
      // CRITICAL: Use this for ALL user-provided data displayed in innerHTML
      function escapeHtml(unsafe) {
        if (unsafe == null) return "";
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Fetch CSRF token
      async function fetchCSRFToken() {
        try {
          const response = await fetch("/api/admin/csrf-token", {
            credentials: "include"
          });
          if (response.ok) {
            const data = await response.json();
            csrfToken = data.token || data.csrfToken;
          }
        } catch (error) {
          console.warn("Failed to fetch CSRF token:", error);
        }
      }

      // Check authentication
      async function checkAuth() {
        try {
          const token = localStorage.getItem('adminToken');
          if (!token) {
            window.location.href = "/admin/login";
            return false;
          }

          const response = await fetch("/api/admin/verify-session", {
            credentials: "include",
            headers: {
              'Authorization': `Bearer ${token}`,
              'Cache-Control': 'no-cache'
            }
          });

          if (!response.ok) {
            localStorage.removeItem('adminToken');
            window.location.href = "/admin/login";
            return false;
          }

          const data = await response.json();
          if (!data.valid) {
            localStorage.removeItem('adminToken');
            window.location.href = "/admin/login";
            return false;
          }

          // Auth successful - show the content
          document.body.style.visibility = 'visible';
          return true;
        } catch (error) {
          console.error("Auth check failed:", error);
          localStorage.removeItem('adminToken');
          window.location.href = "/admin/login";
          return false;
        }
      }

      // Load registrations with optional event ID parameter
      async function loadRegistrations(eventId = null, page = 0) {
        // If eventId is a number (page), handle backward compatibility
        if (typeof eventId === 'number' && page === 0) {
          page = eventId;
          eventId = null;
        }
        
        currentPage = page;
        const offset = page * pageSize;

        const search = document.getElementById("searchInput").value;
        const status = document.getElementById("statusFilter").value;
        const checkedIn = document.getElementById("checkinFilter").value;

        const params = new URLSearchParams({
          limit: pageSize,
          offset: offset,
          ...(search && { search }),
          ...(status && { status }),
          ...(checkedIn && { checkedIn }),
          ...(eventId && eventId !== 'all' && { eventId }),
        });

        try {
          const response = await fetch(`/api/admin/registrations?${params}`, {
            credentials: "include"
          });

          if (!response.ok) {
            throw new Error(`Failed to load registrations: ${response.status}`);
          }

          const data = await response.json();
          displayRegistrations(data.registrations || []);
          updatePagination(data.totalCount || 0);
        } catch (error) {
          console.error("Error loading registrations:", error);
          document.getElementById("registrationsTable").innerHTML =
            '<tr><td colspan="8" class="text-center">Failed to load registrations</td></tr>';
        }
      }

      function displayRegistrations(registrations) {
        const tableBody = document.getElementById("registrationsTable");

        if (registrations.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No registrations found</td></tr>';
          return;
        }

        tableBody.innerHTML = registrations
          .map(reg => `
            <tr>
              <td>${escapeHtml(reg.ticketId)}</td>
              <td>${escapeHtml(reg.attendeeName || 'Not registered')}</td>
              <td>${escapeHtml(reg.email || '')}</td>
              <td>${escapeHtml(reg.ticketType || '')}</td>
              <td>${escapeHtml(reg.registrationStatus || '')}</td>
              <td>${reg.registeredAt ? (timeManager ? timeManager.formatDateTime(reg.registeredAt) : new Date(reg.registeredAt).toLocaleDateString()) : 'N/A'}</td>
              <td>${reg.checkedIn ? 'Yes' : 'No'}</td>
              <td>${reg.purchaserEmail || ''}</td>
            </tr>
          `)
          .join("");
      }

      function updatePagination(totalCount) {
        const totalPages = Math.ceil(totalCount / pageSize);
        document.getElementById("pageInfo").textContent =
          `Page ${currentPage + 1} of ${totalPages || 1}`;

        document.getElementById("prevPage").disabled = currentPage === 0;
        document.getElementById("nextPage").disabled = currentPage >= totalPages - 1;
      }

      // Logout function
      async function logout() {
        try {
          const headers = {};
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }
          await fetch("/api/admin/login", {
            method: "DELETE",
            headers: headers,
            credentials: "include"
          });
        } finally {
          localStorage.removeItem('adminToken');
          sessionStorage.clear();
          window.location.href = '/admin/login';
        }
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', async () => {
        // Check auth first
        const isAuthenticated = await checkAuth();
        if (!isAuthenticated) {
          return;
        }

        // Fetch CSRF token
        await fetchCSRFToken();

        // Initialize event selector if available
        if (window.eventSelector) {
          await window.eventSelector.init();
          window.eventSelector.render('event-selector-container');

          const selectedEventId = window.eventSelector.getSelectedEventId();
          loadRegistrations(selectedEventId);
        } else {
          loadRegistrations(null);
        }

        // Setup event listeners
        document.getElementById("searchInput").addEventListener("input", () => loadRegistrations());
        document.getElementById("statusFilter").addEventListener("change", () => loadRegistrations());
        document.getElementById("checkinFilter").addEventListener("change", () => loadRegistrations());
        document.getElementById("prevPage").addEventListener("click", () => loadRegistrations(null, currentPage - 1));
        document.getElementById("nextPage").addEventListener("click", () => loadRegistrations(null, currentPage + 1));
      });
    </script>
  </body>
</html>
