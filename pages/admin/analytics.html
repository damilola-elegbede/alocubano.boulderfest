<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <!-- Inline theme detection to prevent FOUC -->
    <script>
      (function() {
        // Detect admin pages
        const path = window.location.pathname.toLowerCase();
        const isAdmin = path.includes('/admin') || path.includes('pages/admin');

        if (isAdmin) {
          // Admin pages always use dark theme
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          // Main site: check user preference
          let stored = null;
          try {
            stored = localStorage.getItem('theme-preference');
          } catch {
            // localStorage might be disabled
          }

          const preference = stored || 'system';
          let theme = preference;

          if (preference === 'system') {
            // Detect system preference
            theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
              ? 'dark'
              : 'light';
          }

          document.documentElement.setAttribute('data-theme', theme);
        }
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics Dashboard - A Lo Cubano Boulder Fest Admin</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />

    <!-- Main Site CSS System -->
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/typography.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/navigation.css">
    <link rel="stylesheet" href="/css/admin-overrides.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Admin Auth Guard -->
    <script src="/js/admin-auth-guard.js"></script>

    <!-- Theme Manager -->
    <script type="module" src="/js/theme-manager.js"></script>
    <script type="module" src="/js/time-manager.js"></script>

    <style>
      /* Analytics Page Specific Styles */
      body {
        background: linear-gradient(135deg, var(--color-blue) 0%, var(--color-red) 100%);
        min-height: 100vh;
        padding: var(--space-lg);
      }

      .charts-section {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-xl);
        margin-bottom: var(--space-xl);
      }

      .two-column-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: var(--space-xl);
      }

      .chart-wrapper {
        position: relative;
        height: 300px;
      }

      /* Button States for Time Range */
      .time-range-btn.active {
        background: var(--color-blue) !important;
        color: var(--color-text-inverse) !important;
        border-color: var(--color-blue) !important;
      }

      /* Recommendation Items */
      .recommendation-item {
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-md);
        display: flex;
        align-items: flex-start;
        gap: var(--space-md);
      }

      .recommendation-item.success {
        background: var(--color-success-light);
        border-left: 4px solid var(--color-success);
      }

      .recommendation-item.warning {
        background: var(--color-warning-light);
        border-left: 4px solid var(--color-warning);
      }

      .recommendation-item.info {
        background: var(--color-info-light);
        border-left: 4px solid var(--color-info);
      }

      .recommendation-content {
        flex: 1;
      }

      .recommendation-title {
        font-family: var(--font-display);
        font-weight: 700;
        color: var(--color-text-primary);
        margin-bottom: var(--space-xs);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
      }

      .recommendation-text {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        line-height: var(--line-height-relaxed);
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: var(--space-4xl);
        color: var(--color-text-tertiary);
      }

      .spinner {
        border: 3px solid var(--color-border);
        border-top: 3px solid var(--color-blue);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-right: var(--space-sm);
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Responsive */
      @media (max-width: 768px) {
        body {
          padding: var(--space-md);
        }

        .two-column-charts {
          grid-template-columns: 1fr;
        }

        .admin-flex.admin-justify-between {
          flex-direction: column;
          align-items: stretch;
        }

        .admin-flex.admin-gap-sm {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body class="admin-container">
    <!-- Auth Loading State -->
    <div id="auth-loading" class="auth-loading" style="display: none;">
      <div class="auth-loading-content">
        <div class="auth-spinner"></div>
        <h2>Verifying Authentication...</h2>
      </div>
    </div>

    <!-- Unified Admin Header -->
    <header class="admin-header">
      <div class="admin-header-content">
        <div>
          <h1 class="admin-header-title">Analytics Dashboard</h1>
          <p class="admin-header-subtitle">A Lo Cubano Boulder Fest - Comprehensive Data Analytics</p>
        </div>
        <div class="admin-header-actions">
          <div class="admin-status-indicator">
            <span>Last updated: <span id="update-time">--</span></span>
          </div>
          <button class="admin-btn admin-btn-ghost" onclick="location.href='/admin'">
            <span>Portal</span>
          </button>
          <button class="admin-btn admin-btn-ghost" onclick="location.href='/admin/dashboard'">
            <span>Dashboard</span>
          </button>
          <button class="admin-btn admin-btn-primary" onclick="logout()">
            <span>Logout</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Unified Admin Navigation -->
    <nav class="admin-navigation">
      <ul class="admin-nav-list">
        <li class="admin-nav-item">
          <a href="/admin" class="admin-nav-link">
            <span>Portal</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/dashboard" class="admin-nav-link">
            <span>Dashboard</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/tickets" class="admin-nav-link">
            <span>Tickets</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/analytics" class="admin-nav-link active">
            <span>Analytics</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/donations" class="admin-nav-link">
            <span>Donations</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/checkin" class="admin-nav-link">
            <span>Check-in Scanner</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/test" class="admin-nav-link">
            <span>Test</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/api-endpoints" class="admin-nav-link">
            <span>API Endpoints</span>
          </a>
        </li>
      </ul>
      
      <!-- Event Selector -->
      <div id="event-selector-container"></div>
    </nav>

    <!-- Controls Bar -->
    <div class="admin-card">
      <div class="admin-card-body">
        <div class="admin-flex admin-justify-between admin-items-center admin-flex-wrap admin-gap-lg">
          <div class="admin-flex admin-gap-sm">
            <button class="admin-btn admin-btn-sm time-range-btn" data-days="7">
              <span>7 Days</span>
            </button>
            <button class="admin-btn admin-btn-sm time-range-btn active" data-days="30">
              <span>30 Days</span>
            </button>
            <button class="admin-btn admin-btn-sm time-range-btn" data-days="90">
              <span>90 Days</span>
            </button>
            <button class="admin-btn admin-btn-sm time-range-btn" data-days="all">
              <span>All Time</span>
            </button>
          </div>
          <div class="admin-flex admin-gap-sm">
            <button class="admin-btn admin-btn-sm admin-btn-success" onclick="exportJSON()">
              <span>Export JSON</span>
            </button>
            <button class="admin-btn admin-btn-sm admin-btn-success" onclick="exportCSV()">
              <span>Export CSV</span>
            </button>
          </div>
        </div>
      </div>
    </div>

      <!-- Metrics Grid -->
      <div class="admin-card admin-mb-xl">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Key Metrics</h2>
        </div>
        <div class="admin-card-body">
          <div class="admin-grid auto-fit" id="metrics-grid">
            <div class="admin-stat-card">
              <div class="stat-label">Total Tickets Sold</div>
              <div class="stat-number" id="total-tickets">--</div>
              <div class="stat-change positive" id="tickets-change">--</div>
            </div>
        <div class="admin-stat-card">
          <div class="stat-label">Gross Revenue</div>
          <div class="stat-number" id="gross-revenue">--</div>
          <div class="stat-change positive" id="revenue-change">--</div>
        </div>
        <div class="admin-stat-card">
          <div class="stat-label">Unique Customers</div>
          <div class="stat-number" id="unique-customers">--</div>
          <div class="stat-change positive" id="customers-change">--</div>
        </div>
        <div class="admin-stat-card">
          <div class="stat-label">Check-in Rate</div>
          <div class="stat-number" id="checkin-rate">--</div>
          <div class="stat-change" id="checkin-change">--</div>
        </div>
        <div class="admin-stat-card">
          <div class="stat-label">Conversion Rate</div>
          <div class="stat-number" id="conversion-rate">--</div>
          <div class="stat-change" id="conversion-change">--</div>
        </div>
        <div class="admin-stat-card">
          <div class="stat-label">Top Ticket Type</div>
          <div
            class="stat-number"
            id="top-ticket"
            style="font-size: var(--font-size-lg)"
          >
            --
          </div>
          <div class="stat-change" id="top-ticket-count">--</div>
        </div>
        <div class="admin-stat-card">
          <div class="stat-label">Wallet Adoption</div>
          <div class="stat-number" id="wallet-adoption">--</div>
          <div class="stat-change positive" id="wallet-change">--</div>
        </div>
        <div class="admin-stat-card">
          <div class="stat-label">Digital Revenue Share</div>
          <div class="stat-number" id="digital-share">--</div>
          <div class="stat-change" id="digital-change">--</div>
        </div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="admin-card admin-mb-xl">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Analytics Charts</h2>
        </div>
        <div class="admin-card-body">
          <div class="charts-section">
        <!-- Sales Trend Chart -->
        <div class="chart-container">
          <h3>Sales Trend</h3>
          <div class="chart-wrapper">
            <canvas id="sales-trend-chart"></canvas>
          </div>
        </div>

        <!-- Two Column Charts -->
        <div class="two-column-charts">
          <!-- Revenue Breakdown -->
          <div class="chart-container">
            <h3>Revenue by Ticket Type</h3>
            <div class="chart-wrapper">
              <canvas id="revenue-breakdown-chart"></canvas>
            </div>
          </div>

          <!-- Hourly Sales Pattern -->
          <div class="chart-container">
            <h3>Sales by Hour of Day</h3>
            <div class="chart-wrapper">
              <canvas id="hourly-sales-chart"></canvas>
            </div>
          </div>
        </div>

        <!-- Check-in and Wallet Charts -->
        <div class="two-column-charts">
          <!-- Check-in Rate by Type -->
          <div class="chart-container">
            <h3>Check-in Rate by Ticket Type</h3>
            <div class="chart-wrapper">
              <canvas id="checkin-by-type-chart"></canvas>
            </div>
          </div>

          <!-- Wallet Adoption Trend -->
          <div class="chart-container">
            <h3>Wallet Adoption Trend</h3>
            <div class="chart-wrapper">
              <canvas id="wallet-trend-chart"></canvas>
            </div>
          </div>
        </div>
          </div>
        </div>
      </div>

      <!-- Top Customers Table -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Top Customers</h2>
        </div>
        <div class="admin-card-body">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Customer</th>
                <th>Email</th>
                <th>Tickets</th>
                <th>Total Spent</th>
                <th>Last Purchase (MT)</th>
              </tr>
            </thead>
            <tbody id="top-customers-tbody">
              <tr>
                <td colspan="5" class="loading">
                  <div class="spinner"></div>
                  Loading customer data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Recommendations -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Insights & Recommendations</h2>
        </div>
        <div class="admin-card-body">
          <div id="recommendations-list">
            <div class="loading">
              <div class="spinner"></div>
              Analyzing data...
            </div>
          </div>
        </div>
      </div>

    <script>
      // Global variables
      let analyticsData = null;
      let currentTimeRange = 30;
      let charts = {};
      let refreshInterval = null;
      let timeManager = null;

      // Import timeManager
      import('/js/time-manager.js').then(module => {
        timeManager = module.default;
      });

      // Theme-aware color management
      function getThemeColor(cssVar) {
        return getComputedStyle(document.documentElement)
          .getPropertyValue(cssVar)
          .trim();
      }

      function getThemeColors() {
        return {
          primary: getThemeColor("--color-primary"),
          secondary: getThemeColor("--boulder-fest-secondary"),
          success: getThemeColor("--color-success"),
          warning: getThemeColor("--color-warning"),
          error: getThemeColor("--color-error"),
          info: getThemeColor("--color-info"),
          // Chart color palette with good contrast
          chartColors: [
            getThemeColor("--color-primary"),
            getThemeColor("--boulder-fest-secondary"),
            getThemeColor("--color-success"),
            getThemeColor("--color-warning"),
            getThemeColor("--color-info"),
            getThemeColor("--color-error"),
          ],
        };
      }

      function getThemeColorWithAlpha(cssVar, alpha = "0.1") {
        const color = getThemeColor(cssVar);
        // Convert hex to rgba if needed
        if (color.startsWith("#")) {
          const r = parseInt(color.slice(1, 3), 16);
          const g = parseInt(color.slice(3, 5), 16);
          const b = parseInt(color.slice(5, 7), 16);
          return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        return `${color}${alpha}`; // For CSS custom properties that might already be rgba
      }

      function updateChartColors() {
        // Re-read colors and update all chart instances
        const colors = getThemeColors();

        if (charts.salesTrend) {
          charts.salesTrend.data.datasets[0].borderColor = colors.primary;
          charts.salesTrend.data.datasets[0].backgroundColor =
            getThemeColorWithAlpha("--color-primary", "0.1");
          charts.salesTrend.data.datasets[1].borderColor = colors.secondary;
          charts.salesTrend.data.datasets[1].backgroundColor =
            getThemeColorWithAlpha("--boulder-fest-secondary", "0.1");
          charts.salesTrend.update();
        }

        if (charts.revenueBreakdown) {
          charts.revenueBreakdown.data.datasets[0].backgroundColor =
            colors.chartColors;
          charts.revenueBreakdown.update();
        }

        if (charts.hourlySales) {
          charts.hourlySales.data.datasets[0].backgroundColor = colors.primary;
          charts.hourlySales.update();
        }

        if (charts.checkinByType) {
          charts.checkinByType.data.datasets[0].backgroundColor =
            colors.secondary;
          charts.checkinByType.update();
        }

        if (charts.walletTrend) {
          charts.walletTrend.data.datasets[0].borderColor = colors.success;
          charts.walletTrend.data.datasets[0].backgroundColor =
            getThemeColorWithAlpha("--color-success", "0.1");
          charts.walletTrend.update();
        }
      }

      // SECURITY: Enhanced authentication check with timeout and proper error handling
      async function checkAuth() {
        if (window.AdminAuthGuard) {
          return await window.AdminAuthGuard.verifyAndShow();
        } else {
          console.error("AdminAuthGuard not available");
          window.location.href = "/admin/login";
          return false;
        }
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", async () => {
        // Check authentication first
        const isAuthenticated = await checkAuth();
        if (!isAuthenticated) return;
        
        initializeTimeRangeButtons();
        
        // Initialize event selector first
        if (window.eventSelector) {
          await window.eventSelector.init();
          window.eventSelector.render('event-selector-container');
          
          // Set up event selector change listener
          window.eventSelector.onChange(() => {
            loadAnalytics();
          });
        }
        
        loadAnalytics();
        // Auto-refresh every 5 minutes
        refreshInterval = setInterval(loadAnalytics, 5 * 60 * 1000);

        // Listen for theme changes
        const themeObserver = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (
              mutation.type === "attributes" &&
              mutation.attributeName === "data-theme"
            ) {
              // Theme changed, update chart colors
              updateChartColors();
            }
          });
        });

        themeObserver.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ["data-theme"],
        });
      });

      // Clean up on page unload
      window.addEventListener("beforeunload", () => {
        // Clear interval to prevent memory leaks
        if (refreshInterval) {
          clearInterval(refreshInterval);
          refreshInterval = null;
        }

        // Destroy all charts
        Object.values(charts).forEach((chart) => {
          if (chart && typeof chart.destroy === "function") {
            chart.destroy();
          }
        });
        charts = {};
      });

      // Initialize time range buttons
      function initializeTimeRangeButtons() {
        const buttons = document.querySelectorAll(".time-range-btn");
        buttons.forEach((btn) => {
          btn.addEventListener("click", () => {
            // Update active state
            buttons.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");

            // Update time range and reload
            const days = btn.dataset.days;
            currentTimeRange = days === "all" ? "all" : parseInt(days);

            console.log(`[Analytics] Time range changed to: ${currentTimeRange}`);
            loadAnalytics();
          });
        });
      }

      // Load analytics data
      async function loadAnalytics() {
        try {
          console.log('[Analytics] Loading with timeRange:', currentTimeRange);

          const params = new URLSearchParams();

          // Get selected event ID
          const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;
          console.log('[Analytics] Selected event:', selectedEventId);

          if (selectedEventId && selectedEventId !== 'all') {
            params.set('eventId', selectedEventId);
          }

          // Use new dashboard type instead of summary
          params.set('type', 'dashboard');

          // Include time range
          if (currentTimeRange !== "all") {
            params.set('days', currentTimeRange);
          }

          const url = `/api/admin/analytics?${params.toString()}`;

          const response = await fetch(url, {
            credentials: "include"
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: `HTTP ${response.status}` }));
            throw new Error(errorData.error || `HTTP ${response.status}`);
          }

          analyticsData = await response.json();
          console.log('[Analytics] Response received:', analyticsData);

          // Clear any existing error banner after successful fetch
          const activeBanner = document.querySelector('.analytics-error-banner');
          if (activeBanner) activeBanner.remove();

          // Update all components
          updateMetrics();
          updateCharts();
          updateTopCustomers();
          updateRecommendations();
          updateLastUpdated();
        } catch (error) {
          console.error("Failed to load analytics:", error);
          showErrorBanner(error.message);
        }
      }

      // Show error banner
      function showErrorBanner(message) {
        // Remove existing error banner
        const existing = document.querySelector('.analytics-error-banner');
        if (existing) existing.remove();

        const errorDiv = document.createElement('div');
        errorDiv.className = 'analytics-error-banner admin-card';
        errorDiv.style.cssText = 'background: var(--color-error-bg, #fee); color: var(--color-error-text, #c00); padding: 1rem; margin: 1rem 0; border-radius: 8px; border-left: 4px solid var(--color-error, #e11d48);';
        errorDiv.innerHTML = `
          <strong>⚠️ Failed to load analytics data</strong><br>
          <small>${escapeHtml(message)}</small>
        `;

        const container = document.querySelector('.charts-section');
        if (container) {
          container.insertBefore(errorDiv, container.firstChild);
        }
      }

      // Update metrics cards
      function updateMetrics() {
        if (!analyticsData) return;

        const { metrics, comparison } = analyticsData;

        // Total Tickets - use textContent for safe display
        document.getElementById("total-tickets").textContent =
          metrics.totalTickets.toLocaleString();
        updateChange("tickets-change", comparison.tickets);

        // Gross Revenue - use textContent for safe display
        document.getElementById("gross-revenue").textContent =
          `$${metrics.grossRevenue.toLocaleString()}`;
        updateChange("revenue-change", comparison.revenue);

        // Unique Customers - use textContent for safe display
        document.getElementById("unique-customers").textContent =
          metrics.uniqueCustomers.toLocaleString();
        updateChange("customers-change", comparison.customers);

        // Check-in Rate - use textContent for safe display
        document.getElementById("checkin-rate").textContent =
          `${metrics.checkinRate.toFixed(1)}%`;
        updateChange("checkin-change", comparison.checkinRate);

        // Conversion Rate - use textContent for safe display
        document.getElementById("conversion-rate").textContent =
          `${metrics.conversionRate.toFixed(1)}%`;
        updateChange("conversion-change", comparison.conversionRate);

        // Top Ticket Type - use textContent for safe display
        if (metrics.topTicketType) {
          document.getElementById("top-ticket").textContent =
            metrics.topTicketType.name;
          document.getElementById("top-ticket-count").textContent =
            `${metrics.topTicketType.count} sold`;
        }

        // Wallet Adoption - use textContent for safe display
        document.getElementById("wallet-adoption").textContent =
          `${metrics.walletAdoption.toFixed(1)}%`;
        updateChange("wallet-change", comparison.walletAdoption);

        // Digital Revenue Share - use textContent for safe display
        document.getElementById("digital-share").textContent =
          `${metrics.digitalShare.toFixed(1)}%`;
        updateChange("digital-change", comparison.digitalShare);
      }

      // Update change indicator
      function updateChange(elementId, change) {
        const element = document.getElementById(elementId);
        if (!element || change === undefined) return;

        const isPositive = change >= 0;
        // Remove old positive/negative classes before adding new one
        element.classList.remove("positive", "negative");
        element.classList.add(isPositive ? "positive" : "negative");
        // Use textContent for safe display
        element.textContent = `${isPositive ? "↑" : "↓"} ${Math.abs(change).toFixed(1)}%`;
      }

      // Show chart placeholder when data is missing
      function showChartPlaceholder(canvas, message) {
        if (!canvas) return;

        const container = canvas.parentElement;
        if (!container) return;

        // Remove existing placeholder
        const existingPlaceholder = container.querySelector('.chart-placeholder');
        if (existingPlaceholder) existingPlaceholder.remove();

        const placeholder = document.createElement('div');
        placeholder.className = 'chart-placeholder';
        placeholder.style.cssText = 'display: flex; align-items: center; justify-content: center; height: 300px; color: var(--color-text-tertiary); font-style: italic;';
        placeholder.textContent = message;

        // Hide canvas, show placeholder
        canvas.style.display = 'none';
        container.appendChild(placeholder);
      }

      // Update charts
      function updateCharts() {
        if (!analyticsData) return;

        // Sales Trend Chart
        updateSalesTrendChart();

        // Revenue Breakdown Chart
        updateRevenueBreakdownChart();

        // Hourly Sales Chart
        updateHourlySalesChart();

        // Check-in by Type Chart
        updateCheckinByTypeChart();

        // Wallet Trend Chart
        updateWalletTrendChart();
      }

      // Sales Trend Chart
      function updateSalesTrendChart() {
        const canvas = document.getElementById("sales-trend-chart");
        if (!canvas) return;

        // Validate data exists
        if (!analyticsData || !analyticsData.salesTrend) {
          console.warn('Sales trend data not available');
          showChartPlaceholder(canvas, 'Sales trend data is loading...');
          return;
        }

        const ctx = canvas.getContext("2d");
        const { salesTrend } = analyticsData;

        // Validate data structure
        if (!salesTrend.dates || !salesTrend.daily || !salesTrend.cumulative) {
          console.error('Invalid sales trend data structure', salesTrend);
          showChartPlaceholder(canvas, 'Invalid data format');
          return;
        }

        // Show canvas if it was hidden
        canvas.style.display = 'block';

        // Destroy existing chart if it exists
        if (charts.salesTrend) {
          charts.salesTrend.destroy();
          charts.salesTrend = null;
        }

        const colors = getThemeColors();

        charts.salesTrend = new Chart(ctx, {
          type: "line",
          data: {
            labels: salesTrend.dates,
            datasets: [
              {
                label: "Daily Sales",
                data: salesTrend.daily,
                borderColor: colors.primary,
                backgroundColor: getThemeColorWithAlpha(
                  "--color-primary",
                  "0.1",
                ),
                tension: 0.4,
              },
              {
                label: "Cumulative",
                data: salesTrend.cumulative,
                borderColor: colors.secondary,
                backgroundColor: getThemeColorWithAlpha(
                  "--boulder-fest-secondary",
                  "0.1",
                ),
                tension: 0.4,
                yAxisID: "y1",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            scales: {
              y: {
                type: "linear",
                display: true,
                position: "left",
                title: {
                  display: true,
                  text: "Daily Sales",
                },
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",
                title: {
                  display: true,
                  text: "Cumulative Sales",
                },
                grid: {
                  drawOnChartArea: false,
                },
              },
            },
          },
        });
      }

      // Revenue Breakdown Chart
      function updateRevenueBreakdownChart() {
        const canvas = document.getElementById("revenue-breakdown-chart");
        if (!canvas) return;

        // Validate data exists
        if (!analyticsData || !analyticsData.revenueByType) {
          console.warn('Revenue breakdown data not available');
          showChartPlaceholder(canvas, 'Revenue data is loading...');
          return;
        }

        const ctx = canvas.getContext("2d");
        const { revenueByType } = analyticsData;

        // Validate data structure
        if (!revenueByType.labels || !revenueByType.values) {
          console.error('Invalid revenue breakdown data structure', revenueByType);
          showChartPlaceholder(canvas, 'Invalid data format');
          return;
        }

        // Show canvas if it was hidden
        canvas.style.display = 'block';

        if (charts.revenueBreakdown) {
          charts.revenueBreakdown.destroy();
          charts.revenueBreakdown = null;
        }

        const colors = getThemeColors();

        charts.revenueBreakdown = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: revenueByType.labels,
            datasets: [
              {
                data: revenueByType.values,
                backgroundColor: colors.chartColors,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const value = context.parsed;
                    const total = context.dataset.data.reduce(
                      (a, b) => a + b,
                      0,
                    );
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${context.label}: $${value.toLocaleString()} (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
      }

      // Hourly Sales Chart
      function updateHourlySalesChart() {
        const canvas = document.getElementById("hourly-sales-chart");
        if (!canvas) return;

        // Validate data exists
        if (!analyticsData || !analyticsData.hourlySales) {
          console.warn('Hourly sales data not available');
          showChartPlaceholder(canvas, 'Hourly sales data is loading...');
          return;
        }

        const ctx = canvas.getContext("2d");
        const { hourlySales } = analyticsData;

        // Validate data structure
        if (!hourlySales.hours || !hourlySales.sales) {
          console.error('Invalid hourly sales data structure', hourlySales);
          showChartPlaceholder(canvas, 'Invalid data format');
          return;
        }

        // Show canvas if it was hidden
        canvas.style.display = 'block';

        if (charts.hourlySales) {
          charts.hourlySales.destroy();
          charts.hourlySales = null;
        }

        const colors = getThemeColors();

        charts.hourlySales = new Chart(ctx, {
          type: "bar",
          data: {
            labels: hourlySales.hours,
            datasets: [
              {
                label: "Sales",
                data: hourlySales.sales,
                backgroundColor: colors.primary,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Number of Sales",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "Hour of Day",
                },
              },
            },
          },
        });
      }

      // Check-in by Type Chart
      function updateCheckinByTypeChart() {
        const canvas = document.getElementById("checkin-by-type-chart");
        if (!canvas) return;

        // Validate data exists
        if (!analyticsData || !analyticsData.checkinByType) {
          console.warn('Check-in data not available');
          showChartPlaceholder(canvas, 'Check-in data is loading...');
          return;
        }

        const ctx = canvas.getContext("2d");
        const { checkinByType } = analyticsData;

        // Validate data structure
        if (!checkinByType.types || !checkinByType.rates) {
          console.error('Invalid check-in data structure', checkinByType);
          showChartPlaceholder(canvas, 'Invalid data format');
          return;
        }

        // Show canvas if it was hidden
        canvas.style.display = 'block';

        if (charts.checkinByType) {
          charts.checkinByType.destroy();
          charts.checkinByType = null;
        }

        const colors = getThemeColors();

        charts.checkinByType = new Chart(ctx, {
          type: "bar",
          data: {
            labels: checkinByType.types,
            datasets: [
              {
                label: "Check-in Rate (%)",
                data: checkinByType.rates,
                backgroundColor: colors.secondary,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: "Check-in Rate (%)",
                },
              },
            },
          },
        });
      }

      // Wallet Trend Chart
      function updateWalletTrendChart() {
        const canvas = document.getElementById("wallet-trend-chart");
        if (!canvas) return;

        // Validate data exists
        if (!analyticsData || !analyticsData.walletTrend) {
          console.warn('Wallet trend data not available');
          showChartPlaceholder(canvas, 'Wallet adoption data is loading...');
          return;
        }

        const ctx = canvas.getContext("2d");
        const { walletTrend } = analyticsData;

        // Validate data structure
        if (!walletTrend.dates || !walletTrend.adoption) {
          console.error('Invalid wallet trend data structure', walletTrend);
          showChartPlaceholder(canvas, 'Invalid data format');
          return;
        }

        // Show canvas if it was hidden
        canvas.style.display = 'block';

        if (charts.walletTrend) {
          charts.walletTrend.destroy();
          charts.walletTrend = null;
        }

        const colors = getThemeColors();

        charts.walletTrend = new Chart(ctx, {
          type: "line",
          data: {
            labels: walletTrend.dates,
            datasets: [
              {
                label: "Wallet Adoption (%)",
                data: walletTrend.adoption,
                borderColor: colors.success,
                backgroundColor: getThemeColorWithAlpha(
                  "--color-success",
                  "0.1",
                ),
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: "Adoption Rate (%)",
                },
              },
            },
          },
        });
      }

      // Update top customers table
      function updateTopCustomers() {
        if (!analyticsData || !analyticsData.topCustomers) return;

        const tbody = document.getElementById("top-customers-tbody");
        const customers = analyticsData.topCustomers;

        if (customers.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--color-text-tertiary);">
                            No customer data available
                        </td>
                    </tr>
                `;
          return;
        }

        tbody.innerHTML = customers
          .map(
            (customer) => `
                <tr>
                    <td>${escapeHtml(customer.name)}</td>
                    <td>${escapeHtml(customer.email)}</td>
                    <td>${escapeHtml(String(customer.ticketCount))}</td>
                    <td>${escapeHtml("$" + customer.totalSpent.toLocaleString())}</td>
                    <td>${escapeHtml(formatDate(customer.lastPurchase))}</td>
                </tr>
            `,
          )
          .join("");
      }

      // Update recommendations
      function updateRecommendations() {
        if (!analyticsData || !analyticsData.recommendations) return;

        const container = document.getElementById("recommendations-list");
        const recommendations = analyticsData.recommendations;

        if (recommendations.length === 0) {
          container.innerHTML = `
                    <div class="recommendation-item info">
                        <div class="recommendation-content">
                            <div class="recommendation-title">No Recommendations</div>
                            <div class="recommendation-text">
                                All metrics are performing well. Keep up the great work!
                            </div>
                        </div>
                    </div>
                `;
          return;
        }

        container.innerHTML = recommendations
          .map((rec) => {
            const typeClass =
              rec.type === "success"
                ? "success"
                : rec.type === "warning"
                  ? "warning"
                  : "info";

            return `
                    <div class="recommendation-item ${typeClass}">
                        <div class="recommendation-content">
                            <div class="recommendation-title">${escapeHtml(rec.title || rec.message.split('.')[0])}</div>
                            <div class="recommendation-text">${escapeHtml(rec.message)}</div>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // Export functions
      async function exportJSON() {
        if (!analyticsData) {
          alert("No data to export. Please wait for analytics to load.");
          return;
        }

        // Check if data is valid
        if (!analyticsData.metrics || !analyticsData.salesTrend) {
          alert("Analytics data is incomplete. Please refresh the page.");
          return;
        }

        const dataStr = JSON.stringify(analyticsData, null, 2);
        const dataUri =
          "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);

        const exportFileDefaultName = `analytics_${getDateString()}.json`;

        const linkElement = document.createElement("a");
        linkElement.setAttribute("href", dataUri);
        linkElement.setAttribute("download", exportFileDefaultName);
        linkElement.click();
      }

      async function exportCSV() {
        if (!analyticsData) {
          alert("No data to export. Please wait for analytics to load.");
          return;
        }

        // Validate topCustomers exists
        if (!analyticsData.topCustomers || analyticsData.topCustomers.length === 0) {
          alert("No customer data available to export.");
          return;
        }

        // Create CSV content
        const csv = [];

        // Add metrics
        csv.push("Metrics Report");
        csv.push("Metric,Value");
        csv.push(`Total Tickets,${analyticsData.metrics.totalTickets}`);
        csv.push(`Gross Revenue,$${analyticsData.metrics.grossRevenue}`);
        csv.push(`Unique Customers,${analyticsData.metrics.uniqueCustomers}`);
        csv.push(`Check-in Rate,${analyticsData.metrics.checkinRate}%`);
        csv.push(`Conversion Rate,${analyticsData.metrics.conversionRate}%`);
        csv.push(`Wallet Adoption,${analyticsData.metrics.walletAdoption}%`);
        csv.push(
          `Digital Revenue Share,${analyticsData.metrics.digitalShare}%`,
        );
        csv.push("");

        // Add top customers
        csv.push("Top Customers");
        csv.push("Name,Email,Tickets,Total Spent,Last Purchase");
        analyticsData.topCustomers.forEach((customer) => {
          csv.push(
            `"${customer.name}","${customer.email}",${customer.ticketCount},$${customer.totalSpent},"${customer.lastPurchase}"`,
          );
        });

        const csvContent = csv.join("\n");
        const dataUri =
          "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);

        const exportFileDefaultName = `analytics_${getDateString()}.csv`;

        const linkElement = document.createElement("a");
        linkElement.setAttribute("href", dataUri);
        linkElement.setAttribute("download", exportFileDefaultName);
        linkElement.click();
      }

      // Utility functions
      function escapeHtml(unsafe) {
        // Handle null, undefined, or non-string values
        if (unsafe === null || unsafe === undefined) {
          return '';
        }
        // Convert to string if not already
        const str = String(unsafe);
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function formatDate(dateString) {
        if (timeManager) {
          return timeManager.formatDate(dateString);
        }
        // Fallback for when timeManager is not loaded yet
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      }

      function getDateString() {
        const now = new Date();
        return now.toISOString().split("T")[0];
      }

      function updateLastUpdated() {
        const now = new Date();
        if (timeManager) {
          document.getElementById("update-time").textContent = timeManager.formatEventTime(now, {
            includeTime: true,
            includeTimezone: true,
            longFormat: false,
            shortTime: true
          });
        } else {
          document.getElementById("update-time").textContent =
            now.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
            });
        }
      }

      function showError(message) {
        console.error(message);
        // You could show a toast notification here
      }

      // Logout function
      async function logout() {
        if (!confirm("Are you sure you want to logout?")) return;

        try {
          const headers = {};

          // Add CSRF token if available
          try {
            const csrfResponse = await fetch('/api/admin/csrf-token', {
              credentials: 'same-origin'
            });
            if (csrfResponse.ok) {
              const csrfData = await csrfResponse.json();
              headers['X-CSRF-Token'] = csrfData.token || csrfData.csrfToken;
            }
          } catch (csrfError) {
            // Log CSRF fetch error but continue with logout
            console.warn("Failed to fetch CSRF token:", csrfError);
          }

          await fetch("/api/admin/login", {
            method: "DELETE",
            headers: headers,
            credentials: "same-origin"
          });
        } catch (error) {
          console.error("Logout request failed:", error);
        } finally {
          // Always clear client storage and redirect regardless of logout API result
          localStorage.removeItem('adminToken');
          sessionStorage.clear();
          window.location.href = '/admin/login';
        }
      }
    </script>
    
    <!-- Event Selector Script -->
    <script src="/js/admin-event-selector.js"></script>
  </body>
</html>