<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Mode - Admin Dashboard</title>
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="/css/admin-dashboard.css">
  <meta name="description" content="Admin test mode for cart and checkout functionality">
  <meta name="robots" content="noindex, nofollow">

  <!-- Security headers -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:;">
  <meta name="referrer" content="strict-origin-when-cross-origin">

  <!-- Admin specific meta -->
  <meta name="admin-area" content="true">
  <link rel="icon" href="/favicon.ico">
</head>
<body class="admin-body">
  <div class="admin-container">
    <!-- Header -->
    <header class="admin-header">
      <div class="admin-header-content">
        <div>
          <h1 class="admin-header-title">Test Mode</h1>
          <p class="admin-header-subtitle">A Lo Cubano Boulder Fest - Test Cart Management</p>
        </div>
        <div class="admin-header-actions">
          <button class="admin-btn admin-btn-primary" onclick="logout()">
            <span>Logout</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Unified Admin Navigation -->
    <nav class="admin-navigation">
      <ul class="admin-nav-list">
        <li class="admin-nav-item">
          <a href="/admin" class="admin-nav-link">
            <span>Portal</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/dashboard" class="admin-nav-link">
            <span>Dashboard</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/tickets" class="admin-nav-link">
            <span>Tickets</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/test-mode" class="admin-nav-link active">
            <span>Test Mode</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/analytics" class="admin-nav-link">
            <span>Analytics</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/checkin" class="admin-nav-link">
            <span>Check-in Scanner</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/api-endpoints" class="admin-nav-link">
            <span>API Endpoints</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- Test Mode Section -->
    <section class="admin-card admin-mb-xl" id="testModeSection" data-testid="test-mode-section" role="region" aria-labelledby="test-mode-heading">
      <div class="admin-card-header">
        <h2 class="admin-card-title" id="test-mode-heading">Test Mode Cart</h2>
        <div class="admin-card-actions">
          <div class="test-mode-indicator" id="testModeIndicator" role="status" aria-live="polite" aria-label="Test environment status">
            <span class="test-badge" aria-label="Test mode active">TEST</span>
            <span class="test-status-text" id="test-status-description">Test Environment Active</span>
          </div>
        </div>
      </div>
      <div class="admin-card-body">
        <div class="test-mode-grid">
          <!-- Quick Add Test Items -->
          <div class="test-section" role="group" aria-labelledby="quick-add-heading">
            <h3 class="test-section-title" id="quick-add-heading">Quick Add Test Items</h3>
            <p class="visually-hidden">Add test items to your cart for testing checkout functionality</p>
            <div class="test-buttons-grid" role="group" aria-label="Test item buttons">
              <button class="admin-btn admin-btn-outline test-add-btn"
                      data-item="vip-pass"
                      data-testid="add-vip-test"
                      aria-describedby="vip-pass-description"
                      aria-label="Add VIP Pass for $150 to test cart">
                <span>Add VIP Pass</span>
                <small>$150</small>
                <span class="visually-hidden" id="vip-pass-description">Full festival access with VIP perks</span>
              </button>
              <button class="admin-btn admin-btn-outline test-add-btn"
                      data-item="weekend-pass"
                      data-testid="add-weekend-test"
                      aria-describedby="weekend-pass-description"
                      aria-label="Add Weekend Pass for $75 to test cart">
                <span>Add Weekend Pass</span>
                <small>$75</small>
                <span class="visually-hidden" id="weekend-pass-description">Access to all weekend events</span>
              </button>
              <button class="admin-btn admin-btn-outline test-add-btn"
                      data-item="donation"
                      data-testid="add-donation-test"
                      aria-describedby="donation-description"
                      aria-label="Add $25 donation to test cart">
                <span>Add Donation</span>
                <small>$25</small>
                <span class="visually-hidden" id="donation-description">Support the festival</span>
              </button>
            </div>
          </div>

          <!-- Cart Actions -->
          <div class="test-section" role="group" aria-labelledby="cart-actions-heading">
            <h3 class="test-section-title" id="cart-actions-heading">Cart Actions</h3>
            <p class="visually-hidden">Actions to manage your test cart</p>
            <div class="test-buttons-grid" role="group" aria-label="Cart action buttons">
              <button class="admin-btn admin-btn-primary"
                      onclick="viewCartOnMainSite()"
                      data-testid="view-cart-main"
                      aria-label="Open main site with test cart items in new tab"
                      aria-describedby="view-cart-description">
                <span>View Cart on Main Site</span>
                <span class="visually-hidden" id="view-cart-description">Opens tickets page in new tab with test items added to cart</span>
              </button>
              <button class="admin-btn admin-btn-secondary"
                      onclick="clearTestCart()"
                      data-testid="clear-test-cart"
                      aria-label="Clear all items from test cart"
                      aria-describedby="clear-cart-description">
                <span>Clear Test Cart</span>
                <span class="visually-hidden" id="clear-cart-description">Removes all test items from cart, requires confirmation</span>
              </button>
            </div>
          </div>

          <!-- Test Data Management -->
          <div class="test-section" role="group" aria-labelledby="test-data-heading">
            <h3 class="test-section-title" id="test-data-heading">Test Data Management</h3>
            <p class="visually-hidden">View test cart statistics and manage test data</p>
            <div class="test-stats" id="testStats" role="region" aria-label="Test cart statistics" aria-live="polite">
              <div class="test-stat-item">
                <span class="test-stat-label" id="cart-count-label">Test Items in Cart:</span>
                <span class="test-stat-value" id="testCartCount" aria-labelledby="cart-count-label">0</span>
              </div>
              <div class="test-stat-item">
                <span class="test-stat-label" id="cart-value-label">Test Cart Value:</span>
                <span class="test-stat-value" id="testCartValue" aria-labelledby="cart-value-label">$0.00</span>
              </div>
            </div>
            <div class="test-buttons-grid" role="group" aria-label="Test data management buttons">
              <button class="admin-btn admin-btn-danger"
                      onclick="cleanupTestData()"
                      data-testid="cleanup-test-data"
                      aria-label="Remove all test data including cart items and session data"
                      aria-describedby="cleanup-description">
                <span>Cleanup All Test Data</span>
                <span class="visually-hidden" id="cleanup-description">Permanently removes all test cart items, session data, and preferences. Requires confirmation.</span>
              </button>
              <button class="admin-btn admin-btn-ghost"
                      onclick="generateTestData()"
                      data-testid="generate-test-data"
                      aria-label="Generate sample test data for testing purposes"
                      aria-describedby="generate-description">
                <span>Generate Test Data</span>
                <span class="visually-hidden" id="generate-description">Creates random test items in cart for development testing. Requires confirmation.</span>
              </button>
            </div>
          </div>

          <!-- Keyboard Shortcuts Help -->
          <div class="test-section" role="group" aria-labelledby="shortcuts-heading">
            <h3 class="test-section-title" id="shortcuts-heading">Keyboard Shortcuts</h3>
            <p class="visually-hidden">Available keyboard shortcuts for test mode functionality</p>
            <div class="keyboard-shortcuts-info">
              <div class="shortcut-grid">
                <div class="shortcut-item">
                  <kbd>Alt + T</kbd>
                  <span>Toggle test/production mode</span>
                </div>
                <div class="shortcut-item">
                  <kbd>Alt + V</kbd>
                  <span>Add VIP Pass</span>
                </div>
                <div class="shortcut-item">
                  <kbd>Alt + W</kbd>
                  <span>Add Weekend Pass</span>
                </div>
                <div class="shortcut-item">
                  <kbd>Alt + D</kbd>
                  <span>Add Donation</span>
                </div>
                <div class="shortcut-item">
                  <kbd>Alt + C</kbd>
                  <span>Clear test cart</span>
                </div>
                <div class="shortcut-item">
                  <kbd>Alt + H</kbd>
                  <span>Show help dialog</span>
                </div>
                <div class="shortcut-item">
                  <kbd>Esc</kbd>
                  <span>Cancel operations</span>
                </div>
                <div class="shortcut-item">
                  <kbd>Tab</kbd>
                  <span>Navigate elements</span>
                </div>
              </div>
              <button class="admin-btn admin-btn-outline admin-btn-sm"
                      onclick="window.testMode && window.testMode.showKeyboardShortcutsHelp && window.testMode.showKeyboardShortcutsHelp()"
                      aria-label="Show detailed keyboard shortcuts help">
                <span>Show Help Dialog</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Scripts -->
  <script src="/js/admin-auth.js"></script>
  <script>
    // Logout function
    function logout() {
      localStorage.removeItem('adminToken');
      window.location.href = '/pages/admin/login.html';
    }

    // Test Mode Cart Functions (non-module pattern to avoid import errors)
    const TEST_ITEMS = {
      'vip-pass': {
        id: 'test-vip-' + Date.now(),
        name: 'VIP Pass (Test)',
        price: 150,
        quantity: 1,
        type: 'ticket'
      },
      'weekend-pass': {
        id: 'test-weekend-' + Date.now(),
        name: 'Weekend Pass (Test)',
        price: 75,
        quantity: 1,
        type: 'ticket'
      },
      'donation': {
        id: 'test-donation-' + Date.now(),
        name: 'Festival Donation (Test)',
        price: 25,
        quantity: 1,
        type: 'donation'
      }
    };

    // Initialize Test Mode on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Test Mode] Page initialized');

      // Update cart stats
      updateTestCartStats();

      // Add event listeners to test item buttons
      document.querySelectorAll('.test-add-btn').forEach(button => {
        button.addEventListener('click', function() {
          const itemType = this.dataset.item;
          addTestItemToCart(itemType);
        });
      });

      // Set up keyboard shortcuts
      setupKeyboardShortcuts();
    });

    function addTestItemToCart(itemType) {
      const item = TEST_ITEMS[itemType];
      if (!item) {
        console.error('[Test Mode] Unknown item type:', itemType);
        return;
      }

      // Get current cart from localStorage
      let cart = [];
      try {
        cart = JSON.parse(localStorage.getItem('cart') || '[]');
      } catch (e) {
        console.error('[Test Mode] Error parsing cart:', e);
        cart = [];
      }

      // Create a new test item with unique ID
      const testItem = {
        ...item,
        id: itemType + '-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
        isTestItem: true
      };

      // Add to cart
      cart.push(testItem);
      localStorage.setItem('cart', JSON.stringify(cart));

      console.log('[Test Mode] Added item to cart:', testItem);

      // Update stats
      updateTestCartStats();

      // Show success message
      showNotification(`Added ${item.name} to cart`, 'success');
    }

    function viewCartOnMainSite() {
      // Open tickets page in new tab
      const ticketsUrl = '/pages/tickets.html';
      window.open(ticketsUrl, '_blank');
      console.log('[Test Mode] Opening main site with test cart');
    }

    function clearTestCart() {
      if (confirm('Are you sure you want to clear all test items from the cart?')) {
        let cart = [];
        try {
          cart = JSON.parse(localStorage.getItem('cart') || '[]');
          // Remove only test items
          cart = cart.filter(item => !item.isTestItem);
          localStorage.setItem('cart', JSON.stringify(cart));
        } catch (e) {
          console.error('[Test Mode] Error clearing cart:', e);
        }

        updateTestCartStats();
        showNotification('Test cart cleared', 'success');
      }
    }

    function cleanupTestData() {
      if (confirm('This will remove ALL test data including cart items and preferences. Continue?')) {
        // Clear test items from cart
        let cart = [];
        try {
          cart = JSON.parse(localStorage.getItem('cart') || '[]');
          cart = cart.filter(item => !item.isTestItem);
          localStorage.setItem('cart', JSON.stringify(cart));
        } catch (e) {
          console.error('[Test Mode] Error cleaning up:', e);
        }

        // Clear other test data
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && (key.startsWith('test-') || key.includes('-test-'))) {
            keysToRemove.push(key);
          }
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));

        updateTestCartStats();
        showNotification('All test data cleaned up', 'success');
      }
    }

    function generateTestData() {
      if (confirm('Generate random test items in cart?')) {
        const itemTypes = Object.keys(TEST_ITEMS);
        const numItems = Math.floor(Math.random() * 3) + 1;

        for (let i = 0; i < numItems; i++) {
          const randomType = itemTypes[Math.floor(Math.random() * itemTypes.length)];
          addTestItemToCart(randomType);
        }

        showNotification(`Generated ${numItems} test items`, 'success');
      }
    }

    function updateTestCartStats() {
      let cart = [];
      try {
        cart = JSON.parse(localStorage.getItem('cart') || '[]');
      } catch (e) {
        console.error('[Test Mode] Error reading cart:', e);
        cart = [];
      }

      // Filter for test items only
      const testItems = cart.filter(item => item.isTestItem);
      const itemCount = testItems.length;
      const totalValue = testItems.reduce((sum, item) => sum + (item.price || 0), 0);

      // Update UI
      const countElement = document.getElementById('testCartCount');
      const valueElement = document.getElementById('testCartValue');

      if (countElement) countElement.textContent = itemCount;
      if (valueElement) valueElement.textContent = `$${totalValue.toFixed(2)}`;
    }

    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function(e) {
        if (e.altKey) {
          switch(e.key.toLowerCase()) {
            case 'v':
              e.preventDefault();
              addTestItemToCart('vip-pass');
              break;
            case 'w':
              e.preventDefault();
              addTestItemToCart('weekend-pass');
              break;
            case 'd':
              e.preventDefault();
              addTestItemToCart('donation');
              break;
            case 'c':
              e.preventDefault();
              clearTestCart();
              break;
            case 'h':
              e.preventDefault();
              alert('Keyboard Shortcuts:\n\n' +
                    'Alt+V - Add VIP Pass\n' +
                    'Alt+W - Add Weekend Pass\n' +
                    'Alt+D - Add Donation\n' +
                    'Alt+C - Clear Test Cart\n' +
                    'Alt+H - Show this help');
              break;
          }
        }
      });
    }

    function showNotification(message, type = 'info') {
      // Simple notification (could be enhanced with better UI)
      const notification = document.createElement('div');
      notification.className = `admin-notification admin-notification-${type}`;
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'success' ? '#10b981' : '#3b82f6'};
        color: white;
        border-radius: 6px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Add slide-in animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>