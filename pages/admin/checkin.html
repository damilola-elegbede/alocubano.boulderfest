<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#5b6bb5" />
    <title>Check-in Scanner - A Lo Cubano</title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/images/icons/icon-192x192.png" />

    <!-- CSS System -->
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/typography.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/forms.css" />
    <link rel="stylesheet" href="/css/mobile-overrides.css" />
    <link rel="stylesheet" href="/css/admin-overrides.css" />
    <!-- Scanner-specific styles -->
    <style>
      /* QR Scanner specific overrides */
      body {
        height: 100vh;
        overflow: hidden;
        background: var(--color-background);
        color: var(--color-text-primary);
      }

      .scanner-app {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .app-header {
        background: linear-gradient(
          135deg,
          var(--color-blue) 0%,
          var(--color-red) 100%
        );
        padding: var(--space-lg) var(--space-xl);
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: var(--shadow-lg);
        position: relative;
        z-index: 100;
        min-height: 80px;
      }

      .logout-btn {
        position: absolute;
        top: var(--space-lg);
        right: var(--space-lg);
        background: rgba(255, 255, 255, 0.2) !important;
        border: 2px solid rgba(255, 255, 255, 0.3) !important;
        color: var(--color-white) !important;
        font-size: var(--font-size-sm);
        font-weight: 600;
        min-height: 36px;
        z-index: 110;
      }

      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3) !important;
        color: var(--color-white) !important;
      }

      .back-btn {
        position: absolute;
        top: var(--space-lg);
        left: var(--space-lg);
        background: rgba(255, 255, 255, 0.2) !important;
        border: 2px solid rgba(255, 255, 255, 0.3) !important;
        color: var(--color-white) !important;
        font-size: var(--font-size-sm);
        font-weight: 600;
        min-height: 36px;
        padding: var(--space-xs) var(--space-sm);
        z-index: 110;
      }

      .back-btn:hover {
        background: rgba(255, 255, 255, 0.3) !important;
        color: var(--color-white) !important;
        transform: translateX(-2px);
      }

      .app-title {
        font-family: var(--font-display);
        font-size: var(--font-size-xl);
        font-weight: 700;
        color: var(--color-white);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wider);
        margin: 0 120px;
        text-align: center;
        flex: 1;
        max-width: calc(100% - 240px);
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      .menu-btn {
        background: rgba(255, 255, 255, 0.2) !important;
        border: 2px solid rgba(255, 255, 255, 0.3) !important;
        width: 44px;
        height: 44px;
        min-height: 44px !important;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-white) !important;
        font-size: var(--font-size-xl);
        padding: 0 !important;
      }

      .menu-btn:hover {
        background: rgba(255, 255, 255, 0.3) !important;
        color: var(--color-white) !important;
      }

      .menu-btn:active {
        transform: scale(0.95);
      }

      .scanner-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .stats-bar {
        background: var(--color-surface-elevated);
        border-bottom: 1px solid var(--color-border);
        padding: var(--space-xs) var(--space-sm);
        display: flex;
        gap: var(--space-xs);
        font-size: var(--font-size-xs);
        min-height: 45px;
      }

      .stats-bar .admin-stat-card {
        padding: var(--space-xs) !important;
        margin: 0 !important;
        min-width: auto !important;
        flex: 1;
        cursor: default;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .stats-bar .stat-number {
        font-size: var(--font-size-lg);
        font-weight: 700;
        line-height: 1;
        margin-bottom: 2px;
      }

      .stats-bar .stat-label {
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.8;
      }

      .stats-bar .admin-stat-card:hover {
        transform: none;
        box-shadow: var(--shadow-md);
      }

      .scanner-viewport {
        flex: 1;
        position: relative;
        background: var(--color-black);
        overflow: hidden;
        min-height: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #reader {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
      }

      .scanner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .scan-region {
        width: 280px;
        height: 280px;
        border: 3px solid var(--color-blue);
        border-radius: var(--radius-xl);
        position: relative;
        animation: scannerPulse 2s infinite;
        box-shadow: 0 0 40px rgba(102, 126, 234, 0.3);
      }

      @keyframes scannerPulse {
        0% {
          border-color: var(--color-blue);
        }
        50% {
          border-color: var(--color-red);
        }
        100% {
          border-color: var(--color-blue);
        }
      }

      .scan-corners {
        position: absolute;
        width: 30px;
        height: 30px;
        border: 4px solid var(--color-white);
      }

      .scan-corners.tl {
        top: -2px;
        left: -2px;
        border-right: none;
        border-bottom: none;
        border-top-left-radius: var(--radius-md);
      }

      .scan-corners.tr {
        top: -2px;
        right: -2px;
        border-left: none;
        border-bottom: none;
        border-top-right-radius: var(--radius-md);
      }

      .scan-corners.bl {
        bottom: -2px;
        left: -2px;
        border-right: none;
        border-top: none;
        border-bottom-left-radius: var(--radius-md);
      }

      .scan-corners.br {
        bottom: -2px;
        right: -2px;
        border-left: none;
        border-top: none;
        border-bottom-right-radius: var(--radius-md);
      }

      .controls {
        background: var(--color-surface-elevated);
        border-top: 1px solid var(--color-border);
        padding: var(--space-lg) var(--space-xl);
        display: flex;
        justify-content: center;
        align-items: center;
        gap: var(--space-xl);
        box-shadow: var(--shadow-lg);
      }

      .control-btn {
        width: 60px !important;
        height: 60px !important;
        min-height: 60px !important;
        border-radius: 50% !important;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        padding: 0 !important;
        box-shadow: var(--shadow-md);
      }

      .control-btn:active {
        transform: scale(0.95);
      }


      .control-btn.manual {
        background: var(--color-red) !important;
        border-color: var(--color-red) !important;
        color: var(--color-white) !important;
      }

      .control-btn.manual:hover {
        background: var(--color-secondary-hover) !important;
        border-color: var(--color-secondary-hover) !important;
      }

      .result-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: var(--z-modal);
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .result-modal.show {
        display: flex;
      }

      .result-content {
        background: var(--color-white);
        border-radius: var(--radius-xl);
        padding: var(--space-3xl);
        max-width: 90%;
        width: 350px;
        text-align: center;
        animation: slideUp 0.3s ease-out;
        box-shadow: var(--shadow-2xl);
      }

      @keyframes slideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .result-content.success {
        background: var(--color-success);
        color: var(--color-white);
      }

      .result-content.error {
        background: var(--color-error);
        color: var(--color-white);
      }

      .result-icon {
        font-size: 60px;
        margin-bottom: var(--space-xl);
      }

      .result-title {
        font-family: var(--font-display);
        font-size: var(--font-size-2xl);
        font-weight: 700;
        margin-bottom: var(--space-md);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
      }

      .result-details {
        font-family: var(--font-sans);
        font-size: var(--font-size-base);
        opacity: 0.9;
        margin-bottom: var(--space-xl);
        white-space: pre-line;
        line-height: var(--line-height-relaxed);
      }

      .result-btn {
        background: rgba(255, 255, 255, 0.2) !important;
        color: currentColor !important;
        border: 2px solid rgba(255, 255, 255, 0.3) !important;
        padding: var(--space-md) var(--space-xl);
        border-radius: var(--radius-lg);
        font-family: var(--font-display);
        font-size: var(--font-size-base);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
        min-height: 44px;
      }

      .result-content.success .result-btn {
        background: rgba(255, 255, 255, 0.2) !important;
        color: var(--color-white) !important;
        border-color: rgba(255, 255, 255, 0.3) !important;
      }

      .result-content.success .result-btn:hover {
        background: rgba(255, 255, 255, 0.3) !important;
        color: var(--color-white) !important;
      }

      .result-content.error .result-btn {
        background: rgba(255, 255, 255, 0.2) !important;
        color: var(--color-white) !important;
        border-color: rgba(255, 255, 255, 0.3) !important;
      }

      .result-content.error .result-btn:hover {
        background: rgba(255, 255, 255, 0.3) !important;
        color: var(--color-white) !important;
      }

      .manual-input-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: calc(var(--z-modal) - 1);
      }

      .manual-input-backdrop.show {
        display: block;
      }

      .manual-input {
        position: fixed;
        bottom: -100%;
        left: 0;
        right: 0;
        background: var(--color-surface);
        color: var(--color-text-primary);
        padding: var(--space-xl);
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        transition: bottom 0.3s ease-out;
        z-index: var(--z-modal);
        box-shadow: var(--shadow-2xl);
      }

      .manual-input.show {
        bottom: 0;
      }

      .manual-input h3 {
        font-family: var(--font-display);
        font-size: var(--font-size-xl);
        font-weight: 700;
        margin-bottom: var(--space-lg);
        color: var(--color-text-primary);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
      }

      .manual-input-buttons {
        display: flex;
        gap: var(--space-md);
        margin-top: var(--space-lg);
      }

      /* Hide HTML5 QR Code default UI elements */
      #reader__dashboard_section_csr,
      #reader__dashboard_section_fsr {
        display: none !important;
      }

      #reader__scan_region {
        border: none !important;
      }

      #reader video {
        object-fit: cover !important;
      }

      .offline-indicator {
        position: absolute;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        z-index: var(--z-modal);
        margin: 0;
        width: auto;
        max-width: 90%;
        display: none;
      }

      /* Dark mode specific adjustments for scanner */
      [data-theme="dark"] .result-content:not(.success):not(.error) {
        background: var(--color-surface);
        color: var(--color-text-primary);
      }

      [data-theme="dark"] .manual-input {
        background: var(--color-surface-elevated);
        border-top: 1px solid var(--color-border);
      }

      /* Tablet responsiveness */
      @media (max-width: 768px) and (min-width: 481px) {
        .app-title {
          font-size: var(--font-size-lg);
          margin: 0 100px;
          max-width: calc(100% - 200px);
        }

        .back-btn,
        .logout-btn {
          font-size: var(--font-size-xs);
          padding: var(--space-xs);
          min-width: 70px;
        }
      }

      /* Mobile responsiveness */
      @media (max-width: 480px) {
        .app-header {
          flex-direction: column;
          align-items: center;
          text-align: center;
          padding: var(--space-md);
          min-height: auto;
        }

        .logout-btn,
        .back-btn {
          position: static;
          margin: var(--space-xs);
          min-width: 80px;
          z-index: auto;
        }

        .app-title {
          margin: var(--space-sm) 0;
          max-width: 100%;
          order: 1;
        }

        .back-btn {
          order: 0;
        }

        .logout-btn {
          order: 2;
        }
      }

        .stats-bar {
          padding: var(--space-xs);
          gap: var(--space-xs);
          flex-wrap: wrap;
        }

        .stats-bar .admin-stat-card {
          min-width: calc(50% - var(--space-xs) / 2);
          flex: 0 0 calc(50% - var(--space-xs) / 2);
        }
        .scan-region {
          width: 240px;
          height: 240px;
        }

        .controls {
          padding: var(--space-lg);
        }

        .control-btn {
          width: 50px !important;
          height: 50px !important;
          min-height: 50px !important;
          font-size: 20px;
        }

        .result-content {
          width: 90%;
          padding: var(--space-xl);
        }

        .offline-indicator {
          top: 110px; /* Adjusted to account for event selector */
          font-size: var(--font-size-sm);
        }
      }

      /* Event Selector Styles */
      .event-selector-wrapper {
        background: var(--color-surface-elevated);
        border-bottom: 1px solid var(--color-border);
        padding: var(--space-md) var(--space-xl);
        display: flex;
        align-items: center;
        gap: var(--space-md);
        font-size: var(--font-size-sm);
      }

      .event-selector-label {
        color: var(--color-text-secondary);
        font-weight: 600;
        white-space: nowrap;
        font-family: var(--font-display);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
      }

      .event-selector {
        flex: 1;
        max-width: 400px;
        background: var(--color-surface) !important;
        border: 1px solid var(--color-border) !important;
        color: var(--color-text-primary) !important;
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
        font-family: var(--font-sans);
      }

      .event-selector:focus {
        outline: none;
        border-color: var(--color-blue) !important;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
      }

      /* Wide screen optimizations */
      @media (min-width: 1200px) {
        .app-title {
          font-size: var(--font-size-2xl);
          margin: 0 160px;
          max-width: min(calc(100% - 320px), 600px);
        }

        .back-btn,
        .logout-btn {
          min-height: 40px;
          padding: var(--space-sm) var(--space-lg);
          font-size: var(--font-size-base);
        }
      }

      /* Ultra-wide screen constraints */
      @media (min-width: 1600px) {
        .app-header {
          max-width: 1400px;
          margin: 0 auto;
        }
      }

      /* Reduced motion support */
      @media (prefers-reduced-motion: reduce) {
        .scan-region {
          animation: none;
        }

        .result-modal,
        .result-content {
          animation: none;
        }

        .control-btn:active,
        .menu-btn:active {
          transform: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="scanner-app">
      <div class="app-header">
        <button 
          class="back-btn admin-btn admin-btn-ghost admin-btn-sm" 
          onclick="backToPortal()"
          aria-label="Go back to admin portal"
          title="Return to admin portal"
        >
          ← Portal
        </button>
        <h1 class="app-title" data-testid="scanner-title">
          Check-in Scanner
        </h1>
        <button 
          class="logout-btn admin-btn admin-btn-ghost admin-btn-sm" 
          onclick="logout()"
          aria-label="Logout from admin session"
          title="Logout from admin session"
        >
          Logout
        </button>
      </div>

      <!-- Event Selector -->
      <div id="event-selector-container"></div>

      <div class="admin-alert error offline-indicator" id="offlineIndicator">
        <div class="alert-title">📵 Offline Mode</div>
        <div class="alert-content">Check-ins will sync when connected</div>
      </div>

      <div class="scanner-container" data-testid="scanner-container">
        <div class="stats-bar">
          <div class="admin-stat-card">
            <div class="stat-number" id="todayCount">0</div>
            <div class="stat-label">Today</div>
          </div>
          <div class="admin-stat-card">
            <div
              class="stat-number"
              id="sessionCount"
              data-testid="checkin-counter"
            >
              0
            </div>
            <div class="stat-label">Session</div>
          </div>
          <div class="admin-stat-card">
            <div class="stat-number" id="queueCount">0</div>
            <div class="stat-label">Queued</div>
          </div>
          <div class="admin-stat-card">
            <div class="stat-number" id="walletCount">0</div>
            <div class="stat-label">Wallet</div>
          </div>
          <div class="admin-stat-card">
            <div class="stat-number" id="totalCount">0</div>
            <div class="stat-label">Total</div>
          </div>
        </div>

        <div class="scanner-viewport">
          <div id="reader" data-testid="camera-scanner"></div>
          <div class="scanner-overlay">
            <div class="scan-region">
              <div class="scan-corners tl"></div>
              <div class="scan-corners tr"></div>
              <div class="scan-corners bl"></div>
              <div class="scan-corners br"></div>
            </div>
          </div>
        </div>

        <div class="controls">
          <button
            class="control-btn manual admin-btn"
            onclick="showManualInput()"
            data-testid="manual-input-toggle"
            title="Manual Entry"
          >
            ⌨️
          </button>
          <button class="control-btn admin-btn" onclick="location.reload()" title="Refresh Scanner">
            🔄
          </button>
        </div>
      </div>
    </div>

    <div class="result-modal" id="resultModal">
      <div class="result-content" id="resultContent">
        <div class="result-icon" id="resultIcon"></div>
        <div
          class="result-title"
          id="resultTitle"
          data-testid="validation-result"
        ></div>
        <div
          class="result-details"
          id="resultDetails"
          data-testid="ticket-info"
        ></div>
        <button class="result-btn admin-btn admin-btn-primary" onclick="closeResult()">
          Continue Scanning
        </button>
      </div>
    </div>

    <div class="manual-input-backdrop" id="manualBackdrop" onclick="hideManualInput()"></div>
    <div class="manual-input" id="manualInput">
      <h3>Manual Ticket Entry</h3>
      <input
        type="text"
        id="manualTicketId"
        class="admin-form-input"
        placeholder="Enter ticket ID..."
        autocomplete="off"
        data-testid="qr-manual-input"
      />
      <div class="manual-input-buttons">
        <button
          class="admin-btn admin-btn-primary"
          onclick="submitManualTicket()"
          data-testid="validate-ticket"
        >
          Check In
        </button>
      </div>
    </div>

    <!-- Theme Manager -->
    <script type="module" src="/js/theme-manager.js"></script>
    <!-- Event Selector Component -->
    <script src="/js/admin-event-selector.js"></script>
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
      let scanner = null;
      let sessionCount = 0;
      let isScanning = false;

      // Statistics
      const stats = {
        today: 0,
        session: 0,
        queued: 0,
        wallet: 0,
        total: 0,
      };

      // Initialize scanner
      async function initScanner() {
        try {
          scanner = new Html5Qrcode("reader");

          const config = {
            fps: 10,
            qrbox: { width: 280, height: 280 },
            aspectRatio: 1.0,
            experimentalFeatures: {
              useBarCodeDetectorIfSupported: true,
            },
            videoConstraints: {
              facingMode: "environment",
              width: { ideal: 1920 },
              height: { ideal: 1080 }
            }
          };

          await scanner.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanError,
          );

          isScanning = true;
        } catch (error) {
          console.error("Failed to start scanner:", error);
          alert("Camera access denied or not available");
        }
      }

      // Handle successful scan
      async function onScanSuccess(decodedText) {
        if (!isScanning) return;

        // Prevent multiple scans
        isScanning = false;

        // Haptic feedback
        if (navigator.vibrate) {
          navigator.vibrate(200);
        }

        // Validate QR code
        await validateTicket(decodedText);

        // Resume scanning after delay
        setTimeout(() => {
          isScanning = true;
        }, 2000);
      }

      // Handle scan errors (ignore)
      function onScanError(error) {
        // Ignore scan errors
      }

      // Validate ticket (QR code or JWT wallet token)
      async function validateTicket(token) {
        try {
          // Detect wallet tokens (JWT format)
          const isWalletToken = token.includes(".") && token.length > 100;

          // Get selected event ID from event selector
          const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;

          // Get CSRF token for admin operations (only if admin authenticated)
          let headers = { "Content-Type": "application/json" };
          try {
            const csrfResponse = await fetch("/api/admin/csrf-token", {
              credentials: "include"
            });
            if (csrfResponse.ok) {
              const csrfData = await csrfResponse.json();
              headers["X-CSRF-Token"] = csrfData.token;
            }
          } catch (error) {
            // Not admin authenticated, continue without CSRF token
            console.log("Not admin authenticated, continuing without CSRF token");
          }

          const response = await fetch("/api/tickets/validate", {
            method: "POST",
            headers: headers,
            body: JSON.stringify({
              token: token,
              validatedBy: "admin-scanner",
              location: "entrance",
              wallet_source: isWalletToken ? "jwt" : null,
              qr_access_method: isWalletToken ? "wallet" : "qr_code",
              event_id: selectedEventId,
            }),
            credentials: "include"
          });

          const data = await response.json();

          if (data.offline) {
            // Offline check-in
            stats.queued++;
            updateStats();
            showResult(
              "queued",
              "Queued for Sync",
              `Check-in saved offline (${stats.queued} in queue)`,
            );
          } else if (data.valid) {
            // Success
            stats.session++;
            stats.today++;
            if (data.ticket && data.ticket.wallet_source) stats.wallet++;
            updateStats();

            // Show wallet badge if from wallet
            const walletBadge =
              data.ticket && data.ticket.wallet_source ? "📱 " : "🎫 ";
            const accessMethod =
              data.ticket && data.ticket.qr_access_method === "wallet"
                ? " (Wallet)"
                : "";

            if (data.ticket) {
              showResult(
                "success",
                `${walletBadge}Valid Ticket!`,
                `${data.ticket.attendeeName}\n${data.ticket.type}${accessMethod}\nScan ${data.ticket.scanCount}/${data.ticket.maxScans}`,
              );
            } else {
              showResult("success", "Valid Ticket!", "Check-in successful");
            }
          } else {
            // Error
            showResult(
              "error",
              "Invalid Ticket",
              data.error || "This ticket cannot be validated",
            );
          }
        } catch (error) {
          console.error("Validation error:", error);

          // Queue for offline sync
          stats.queued++;
          updateStats();
          showResult(
            "queued",
            "Queued for Sync",
            "No connection - check-in saved",
          );
        }
      }

      // Show result modal
      function showResult(type, title, details) {
        const modal = document.getElementById("resultModal");
        const content = document.getElementById("resultContent");
        const icon = document.getElementById("resultIcon");
        const titleEl = document.getElementById("resultTitle");
        const detailsEl = document.getElementById("resultDetails");

        // Set content
        if (type === "success") {
          content.className = "result-content success";
          icon.textContent = "✅";
          content.setAttribute("data-testid", "checkin-success");
        } else if (type === "error") {
          content.className = "result-content error";
          icon.textContent = "❌";
          content.setAttribute("data-testid", "validation-error");
        } else if (type === "queued") {
          content.className = "result-content";
          icon.textContent = "📥";
          content.setAttribute("data-testid", "network-error");
        }

        titleEl.textContent = title;
        detailsEl.textContent = details;

        // Show modal
        modal.classList.add("show");

        // Auto-close after 3 seconds
        setTimeout(() => {
          closeResult();
        }, 3000);
      }

      // Close result modal
      function closeResult() {
        document.getElementById("resultModal").classList.remove("show");
      }


      // Show manual input with backdrop
      function showManualInput() {
        document.getElementById("manualBackdrop").classList.add("show");
        document.getElementById("manualInput").classList.add("show");
        document.getElementById("manualTicketId").focus();
      }

      // Hide manual input and backdrop
      function hideManualInput() {
        document.getElementById("manualBackdrop").classList.remove("show");
        document.getElementById("manualInput").classList.remove("show");
        document.getElementById("manualTicketId").value = "";
      }

      // Handle escape key to close manual input
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && document.getElementById("manualInput").classList.contains("show")) {
          hideManualInput();
        }
      });

      // Submit manual ticket
      async function submitManualTicket() {
        const ticketId = document.getElementById("manualTicketId").value.trim();

        if (!ticketId) {
          alert("Please enter a ticket ID");
          return;
        }

        hideManualInput();

        // For manual entry, we need to look up the ticket first
        try {
          // Get selected event ID from event selector
          const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;
          const eventParam = selectedEventId ? `&event_id=${selectedEventId}` : '';

          const response = await fetch(
            `/api/tickets?ticket_id=${encodeURIComponent(ticketId)}${eventParam}`,
            {
              credentials: "include"
            }
          );
          const data = await response.json();

          if (data.ticket && data.ticket.qr_token) {
            await validateTicket(data.ticket.qr_token);
          } else {
            showResult("error", "Not Found", "Ticket ID not found");
          }
        } catch (error) {
          showResult("error", "Error", "Failed to lookup ticket");
        }
      }

      // Update statistics display
      function updateStats() {
        document.getElementById("todayCount").textContent = stats.today;
        document.getElementById("sessionCount").textContent = stats.session;
        document.getElementById("queueCount").textContent = stats.queued;
        document.getElementById("walletCount").textContent = stats.wallet;
        document.getElementById("totalCount").textContent = stats.total;
      }

      // Load statistics
      async function loadStats() {
        try {
          // Get selected event ID from event selector
          const selectedEventId = window.eventSelector ? window.eventSelector.getSelectedEventId() : null;
          const eventParam = selectedEventId ? `?eventId=${selectedEventId}` : '';

          const response = await fetch(`/api/admin/dashboard${eventParam}`, {
            credentials: "include"
          });
          const data = await response.json();

          if (data.stats) {
            // Get today's check-ins from the daily_checkins array if available
            const today = new Date().toISOString().split('T')[0];
            const todayCheckins = data.stats.daily_checkins?.find(d => d.date === today);

            stats.today = todayCheckins?.count || data.stats.today_checkins || 0;
            stats.total = data.stats.checked_in || 0;
            stats.wallet = data.stats.wallet_checkins || 0;

            // Update session count (preserve existing session count)
            // Total can be shown as all-time check-ins
            updateStats();
          }
        } catch (error) {
          console.error("Failed to load stats:", error);
        }
      }

      // Check online status
      function updateOnlineStatus() {
        const indicator = document.getElementById("offlineIndicator");

        if (navigator.onLine) {
          indicator.style.display = "none";

          // Trigger sync if we have queued items
          if (stats.queued > 0 && "serviceWorker" in navigator) {
            navigator.serviceWorker.ready.then((registration) => {
              return registration.sync.register("sync-checkins");
            });
          }
        } else {
          indicator.style.display = "block";
        }
      }

      // Show menu (placeholder)
      function showMenu() {
        if (confirm("Return to dashboard?")) {
          window.location.href = "/admin/dashboard";
        }
      }

      // Check authentication (mobile sessions last 72 hours)
      async function checkAuth() {
        try {
          const response = await fetch("/api/admin/verify-session", {
            credentials: "include" // CRITICAL: Include cookies for production
          });
          if (!response.ok) {
            showMobileLogin();
            return false;
          }
          const data = await response.json();
          if (!data.valid) {
            showMobileLogin();
            return false;
          }
          return true;
        } catch (error) {
          console.error("Auth check failed:", error);
          showMobileLogin();
          return false;
        }
      }

      // Show mobile login UI
      function showMobileLogin() {
        document.body.innerHTML = `
                <div style="
                    height: 100vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: linear-gradient(135deg, var(--color-blue) 0%, var(--color-red) 100%);
                ">
                    <div style="
                        background: var(--color-surface);
                        padding: 40px;
                        border-radius: 20px;
                        box-shadow: var(--shadow-xl);
                        max-width: 90%;
                        width: 350px;
                    ">
                        <h2 style="color: var(--color-text-primary); margin-bottom: 10px; text-align: center;">
                            🎫 Check-in Staff Login
                        </h2>
                        <p style="color: var(--color-text-secondary); text-align: center; margin-bottom: 30px; font-size: 14px;">
                            Session lasts 72 hours
                        </p>
                        <form id="mobileLoginForm" onsubmit="handleMobileLogin(event)">
                            <input 
                                type="password" 
                                id="staffPassword"
                                placeholder="Enter staff password"
                                required
                                style="
                                    width: 100%;
                                    padding: 15px;
                                    border: 1px solid var(--color-border);
                                    border-radius: 10px;
                                    font-size: 16px;
                                    margin-bottom: 20px;
                                    background: var(--color-background-secondary);
                                    color: var(--color-text-primary);
                                "
                            >
                            <button type="submit" style="
                                width: 100%;
                                padding: 15px;
                                background: var(--color-primary);
                                color: var(--color-text-inverse);
                                border: none;
                                border-radius: 10px;
                                font-size: 18px;
                                font-weight: 600;
                                cursor: pointer;
                            ">
                                Login to Scanner
                            </button>
                            <div id="loginError" style="
                                color: var(--color-error);
                                text-align: center;
                                margin-top: 15px;
                                display: none;
                            "></div>
                        </form>
                    </div>
                </div>
            `;

        // Focus password field
        setTimeout(() => {
          document.getElementById("staffPassword").focus();
        }, 100);
      }

      // Handle mobile login
      async function handleMobileLogin(event) {
        event.preventDefault();

        const password = document.getElementById("staffPassword").value;
        const errorDiv = document.getElementById("loginError");

        try {
          // Get CSRF token first
          const csrfResponse = await fetch("/api/admin/csrf-token", {
            credentials: "include"
          });
          const csrfData = await csrfResponse.json();

          // Attempt login with mobile endpoint
          const response = await fetch("/api/admin/mobile-login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": csrfData.token,
            },
            body: JSON.stringify({
              password: password,
              csrfToken: csrfData.token,
            }),
            credentials: "include"
          });

          const data = await response.json();

          if (response.ok) {
            // Login successful, reload page
            location.reload();
          } else {
            errorDiv.textContent = data.error || "Invalid password";
            errorDiv.style.display = "block";
            document.getElementById("staffPassword").value = "";
            document.getElementById("staffPassword").focus();
          }
        } catch (error) {
          errorDiv.textContent = "Connection error. Please try again.";
          errorDiv.style.display = "block";
        }
      }

      // Initialize app
      async function init() {
        // Check authentication
        if (!(await checkAuth())) return;

        // Wait for event selector to be available
        const waitForEventSelector = async () => {
          let attempts = 0;
          while (!window.eventSelector && attempts < 20) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
          }
          return window.eventSelector;
        };

        // Initialize event selector
        const eventSelector = await waitForEventSelector();
        if (eventSelector) {
          await eventSelector.init();
          eventSelector.render('event-selector-container');

          // Set up event change listener to reload stats
          eventSelector.onChange(() => {
            // Clear session stats when event changes
            stats.session = 0;
            updateStats();
            loadStats();
          });
        }

        // Register service worker
        if ("serviceWorker" in navigator) {
          try {
            await navigator.serviceWorker.register("/js/sw.js");
            console.log("Service worker registered");
          } catch (error) {
            console.error("Service worker registration failed:", error);
          }
        }

        // Initialize scanner
        await initScanner();

        // Load statistics
        await loadStats();

        // Monitor online status
        updateOnlineStatus();
        window.addEventListener("online", updateOnlineStatus);
        window.addEventListener("offline", updateOnlineStatus);

        // Refresh stats periodically
        setInterval(loadStats, 30000);
      }

      // Back to Portal function
      function backToPortal() {
        window.location.href = "/admin";
      }

      // Logout function
      async function logout() {
        if (!confirm("Are you sure you want to logout?")) return;

        try {
          const headers = {};

          // Add CSRF token for secure logout
          try {
            const csrfResponse = await fetch("/api/admin/csrf-token", {
              credentials: "same-origin"
            });
            if (csrfResponse.ok) {
              const csrfData = await csrfResponse.json();
              headers["X-CSRF-Token"] = csrfData.token || csrfData.csrfToken;
            }
          } catch (error) {
            console.warn("Could not fetch CSRF token for logout:", error);
          }

          await fetch("/api/admin/login", {
            method: "DELETE",
            headers: headers,
            credentials: "same-origin"
          });
        } finally {
          // Clear client storage
          localStorage.removeItem('adminToken');
          sessionStorage.clear();
          // Redirect
          window.location.href = '/admin/login';
        }
      }

      // Start app
      init();
    </script>
  </body>
</html>
