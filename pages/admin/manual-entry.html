<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <!-- Inline theme detection to prevent FOUC -->
    <script>
      (function() {
        // Admin pages always use dark theme
        document.documentElement.setAttribute('data-theme', 'dark');
      })();
    </script>

    <!-- Pre-render auth check to prevent content flash -->
    <script>
      // Hide content immediately to prevent flash
      document.documentElement.style.visibility = 'hidden';
      document.documentElement.style.opacity = '0';
      document.documentElement.style.transition = 'opacity 0.2s ease-in';

      // Quick token validation to prevent flash with invalid tokens
      (async function() {
        if (!window.location.pathname.includes('/admin/login')) {
          const token = localStorage.getItem('adminToken');
          if (!token) {
            // No token - redirect immediately
            window.location.replace('/admin/login');
            return;
          }

          // Quick validation - check if token is expired client-side
          try {
            // Parse JWT to check expiration (basic check)
            const payload = JSON.parse(atob(token.split('.')[1]));
            if (payload.exp && payload.exp * 1000 < Date.now()) {
              // Token expired - clear and redirect
              localStorage.removeItem('adminToken');
              window.location.replace('/admin/login');
              return;
            }
          } catch (e) {
            // Invalid token format - clear and redirect
            localStorage.removeItem('adminToken');
            window.location.replace('/admin/login');
            return;
          }
          // Valid token format - wait for server verification
        }
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manual Ticket Entry - A Lo Cubano Boulder Fest</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />

    <!-- Main Site CSS System -->
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/typography.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/forms.css" />
    <link rel="stylesheet" href="/css/navigation.css" />
    <link rel="stylesheet" href="/css/admin-overrides.css" />

    <style>
      /* Manual Entry Specific Styles */
      body {
        background: linear-gradient(
          135deg,
          var(--color-blue) 0%,
          var(--color-red) 100%
        );
        min-height: 100vh;
        padding: var(--space-lg);
      }

      .manual-entry-container {
        max-width: 800px;
        margin: 0 auto;
      }

      .ticket-items-container {
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
      }

      .ticket-item {
        background: var(--color-background-secondary);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        position: relative;
      }

      .ticket-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-sm);
      }

      .ticket-item-number {
        font-weight: 600;
        color: var(--color-text-secondary);
      }

      .remove-ticket-btn {
        background: transparent !important;
        border: none !important;
        color: var(--color-error) !important;
        padding: var(--space-xs) !important;
        font-size: var(--font-size-lg);
        cursor: pointer;
        min-width: auto !important;
        min-height: auto !important;
      }

      .remove-ticket-btn:hover {
        color: var(--color-error-hover) !important;
        background: rgba(204, 41, 54, 0.1) !important;
      }

      .form-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--space-md);
      }

      .add-ticket-btn {
        width: 100%;
        background: var(--color-surface) !important;
        border: 2px dashed var(--color-border) !important;
        color: var(--color-text-secondary) !important;
      }

      .add-ticket-btn:hover {
        border-color: var(--color-blue) !important;
        color: var(--color-blue) !important;
      }

      .summary-section {
        background: var(--color-surface-elevated);
        border: 2px solid var(--color-blue);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        margin-top: var(--space-lg);
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        padding: var(--space-sm) 0;
        border-bottom: 1px solid var(--color-border);
      }

      .summary-row:last-child {
        border-bottom: none;
        font-size: var(--font-size-lg);
        font-weight: 700;
        padding-top: var(--space-md);
      }

      .form-section {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        margin-bottom: var(--space-lg);
      }

      .section-title {
        font-size: var(--font-size-lg);
        font-weight: 600;
        margin-bottom: var(--space-md);
        color: var(--color-text-primary);
      }

      .cash-shift-info {
        background: rgba(91, 107, 181, 0.1);
        border: 1px solid rgba(91, 107, 181, 0.3);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        margin-top: var(--space-sm);
        font-size: var(--font-size-sm);
      }

      .alert {
        padding: var(--space-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-md);
        font-size: var(--font-size-sm);
      }

      .alert-error {
        background: rgba(204, 41, 54, 0.1);
        border: 1px solid rgba(204, 41, 54, 0.3);
        color: var(--color-error);
      }

      .alert-success {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: var(--color-success);
      }

      .alert-warning {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        color: var(--color-warning, #f59e0b);
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .loading-content {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--space-xl);
        text-align: center;
        min-width: 300px;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--color-border);
        border-top-color: var(--color-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto var(--space-md);
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        body {
          padding: var(--space-md);
        }

        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>

    <!-- Theme Manager -->
    <script type="module" src="/js/theme-manager.js"></script>
  </head>
  <body class="admin-container">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
      <div class="loading-content">
        <div class="spinner"></div>
        <p>Processing ticket entry...</p>
      </div>
    </div>

    <!-- Mobile Hamburger Menu Toggle -->
    <button class="admin-menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false">
      <div class="admin-menu-icon">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </button>

    <!-- Unified Admin Header -->
    <header class="admin-header">
      <div class="admin-header-content">
        <div>
          <h1 class="admin-header-title">Manual Ticket Entry</h1>
          <p class="admin-header-subtitle">At-Door Purchase Entry System</p>
        </div>
        <div class="admin-header-actions">
          <button class="admin-btn admin-btn-secondary" onclick="window.location.href='/admin'">
            <span>‚Üê Back</span>
          </button>
          <button class="admin-btn admin-btn-primary" onclick="logout()">
            <span>Logout</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Unified Admin Navigation -->
    <nav class="admin-navigation">
      <ul class="admin-nav-list">
        <!-- Core Tools Group -->
        <li role="presentation" class="admin-nav-group-header">Core Tools</li>
        <li class="admin-nav-item">
          <a href="/admin" class="admin-nav-link">
            <span class="nav-icon">üè†</span>
            <span>Portal</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/dashboard" class="admin-nav-link">
            <span class="nav-icon">üìä</span>
            <span>Dashboard</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/checkin" class="admin-nav-link">
            <span class="nav-icon">üì±</span>
            <span>Check-in Scanner</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/manual-entry" class="admin-nav-link active">
            <span class="nav-icon">‚úèÔ∏è</span>
            <span>Manual Entry</span>
          </a>
        </li>

        <!-- Data & Analytics Group -->
        <li role="presentation" aria-hidden="true" class="admin-nav-separator"></li>
        <li role="presentation" class="admin-nav-group-header">Data & Analytics</li>
        <li class="admin-nav-item">
          <a href="/admin/tickets" class="admin-nav-link">
            <span class="nav-icon">üé´</span>
            <span>Tickets</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/analytics" class="admin-nav-link">
            <span class="nav-icon">üìà</span>
            <span>Analytics</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/donations" class="admin-nav-link">
            <span class="nav-icon">üíù</span>
            <span>Donations</span>
          </a>
        </li>

        <!-- Utilities Group -->
        <li role="presentation" aria-hidden="true" class="admin-nav-separator"></li>
        <li role="presentation" class="admin-nav-group-header">Utilities</li>
        <li class="admin-nav-item">
          <a href="/admin/test" class="admin-nav-link">
            <span class="nav-icon">üß™</span>
            <span>Test</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/api-endpoints" class="admin-nav-link">
            <span class="nav-icon">üîå</span>
            <span>API Endpoints</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="/admin/audit-logs" class="admin-nav-link">
            <span class="nav-icon">üìã</span>
            <span>Audit Logs</span>
          </a>
        </li>
      </ul>
    </nav>

    <div class="manual-entry-container">
      <!-- Alert Messages -->
      <div id="alert-container"></div>

      <!-- Manual Entry Form -->
      <form id="manual-entry-form" class="admin-card">
        <!-- Customer Information -->
        <div class="form-section">
          <h2 class="section-title">Customer Information</h2>

          <div class="admin-form-group">
            <label for="customer-first-name" class="admin-form-label">
              First Name <span style="color: var(--color-error);">*</span>
            </label>
            <input
              type="text"
              id="customer-first-name"
              name="customerFirstName"
              class="admin-form-input"
              required
              placeholder="John"
            />
          </div>

          <div class="admin-form-group">
            <label for="customer-last-name" class="admin-form-label">
              Last Name <span style="color: var(--color-error);">*</span>
            </label>
            <input
              type="text"
              id="customer-last-name"
              name="customerLastName"
              class="admin-form-input"
              required
              placeholder="Doe"
            />
          </div>

          <div class="admin-form-group">
            <label for="customer-email" class="admin-form-label">
              Email Address <span style="color: var(--color-error);">*</span>
            </label>
            <input
              type="email"
              id="customer-email"
              name="customerEmail"
              class="admin-form-input"
              required
              placeholder="john@example.com"
            />
          </div>

          <div class="admin-form-group">
            <label for="customer-phone" class="admin-form-label">
              Phone Number (Optional)
            </label>
            <input
              type="tel"
              id="customer-phone"
              name="customerPhone"
              class="admin-form-input"
              placeholder="+1 (303) 555-0123"
            />
          </div>
        </div>

        <!-- Payment Information -->
        <div class="form-section">
          <h2 class="section-title">Payment Information</h2>

          <div class="admin-form-group">
            <label for="payment-method" class="admin-form-label">
              Payment Method <span style="color: var(--color-error);">*</span>
            </label>
            <select
              id="payment-method"
              name="paymentMethod"
              class="admin-form-select"
              required
            >
              <option value="">Select payment method...</option>
              <option value="cash">Cash</option>
              <option value="card_terminal">Card</option>
              <option value="paypal">PayPal</option>
              <option value="venmo">Venmo</option>
              <option value="comp">Comp (Free)</option>
            </select>
          </div>

          <!-- Cash Shift Info (only shown for cash payments) -->
          <div id="cash-shift-container" style="display: none;">
            <div class="cash-shift-info">
              <p><strong>Cash Shift Required</strong></p>
              <p>A cash shift must be open to process cash payments. If no shift is open, please open one from the admin dashboard.</p>
              <div id="cash-shift-select-container" style="margin-top: var(--space-sm);">
                <label for="cash-shift-id" class="admin-form-label">Active Cash Shift</label>
                <select id="cash-shift-id" name="cashShiftId" class="admin-form-select">
                  <option value="">Loading cash shifts...</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Ticket Selection & Attendee Information -->
        <div class="form-section">
          <h2 class="section-title">Ticket & Attendee Information</h2>

          <div class="admin-form-group">
            <label for="ticket-type" class="admin-form-label">
              Ticket Type <span style="color: var(--color-error);">*</span>
            </label>
            <select id="ticket-type" name="ticketType" class="admin-form-select" required>
              <option value="">Select ticket type...</option>
              <!-- Options populated dynamically -->
            </select>
          </div>

          <!-- Same as Purchaser Checkbox -->
          <div class="admin-form-group" style="background: rgba(91, 107, 181, 0.1); border: 1px solid rgba(91, 107, 181, 0.3); border-radius: var(--radius-md); padding: var(--space-md);">
            <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
              <input
                type="checkbox"
                id="same-as-purchaser"
                style="width: 20px; height: 20px; margin-right: var(--space-sm); cursor: pointer;"
              />
              <span style="font-weight: 500;">
                Attendee is the same as the purchaser
              </span>
            </label>
            <small style="color: var(--color-text-secondary); display: block; margin-top: 8px; margin-left: 28px;">
              Check this box to automatically fill attendee information with customer details
            </small>
          </div>

          <div class="admin-form-group">
            <label for="attendee-first-name" class="admin-form-label">
              Attendee First Name <span style="color: var(--color-error);">*</span>
            </label>
            <input
              type="text"
              id="attendee-first-name"
              name="attendeeFirstName"
              class="admin-form-input"
              required
              placeholder="Jane"
            />
          </div>

          <div class="admin-form-group">
            <label for="attendee-last-name" class="admin-form-label">
              Attendee Last Name <span style="color: var(--color-error);">*</span>
            </label>
            <input
              type="text"
              id="attendee-last-name"
              name="attendeeLastName"
              class="admin-form-input"
              required
              placeholder="Smith"
            />
          </div>

          <div class="admin-form-group">
            <label for="attendee-email" class="admin-form-label">
              Attendee Email Address <span style="color: var(--color-error);">*</span>
            </label>
            <input
              type="email"
              id="attendee-email"
              name="attendeeEmail"
              class="admin-form-input"
              required
              placeholder="jane@example.com"
            />
            <small style="color: var(--color-text-secondary); display: block; margin-top: 4px;">
              Attendee will receive their ticket with QR code at this email
            </small>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="summary-section">
          <h2 class="section-title">Order Summary</h2>
          <div id="order-summary">
            <div class="summary-row">
              <span>Ticket Amount:</span>
              <span id="total-amount">$0.00</span>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="admin-btn admin-btn-primary" style="width: 100%; margin-top: var(--space-lg);">
          <span>Process Purchase</span>
        </button>
      </form>
    </div>

    <!-- Admin Auth Guard -->
    <script src="/js/admin-auth-guard.js"></script>

    <!-- Manual Entry Logic -->
    <script type="module">
      import csrfService from '/js/csrf-service.js';

      // State
      let ticketTypes = [];
      let cashShifts = [];

      // HTML escaping function to prevent XSS attacks
      // CRITICAL: Use this for ALL user-provided data displayed in innerHTML
      function escapeHtml(unsafe) {
        if (unsafe == null) return "";
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', async () => {
        await loadTicketTypes();
        await loadCashShifts();
        populateTicketTypeDropdown();
        setupEventListeners();

        // Show content after initialization
        document.documentElement.style.visibility = 'visible';
        document.documentElement.style.opacity = '1';
      });

      // Load available ticket types
      async function loadTicketTypes() {
        try {
          const token = localStorage.getItem('adminToken');
          const response = await fetch('/api/admin/dashboard', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            throw new Error('Failed to load ticket types');
          }

          const data = await response.json();
          ticketTypes = data.ticketTypes || [];
        } catch (error) {
          console.error('Error loading ticket types:', error);
          showAlert('Failed to load ticket types', 'error');
        }
      }

      // Load active cash shifts
      async function loadCashShifts() {
        try {
          const token = localStorage.getItem('adminToken');
          const response = await fetch('/api/admin/cash-shifts', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            throw new Error('Failed to load cash shifts');
          }

          const data = await response.json();
          cashShifts = data.cashShifts || [];

          // Populate the cash shift dropdown
          populateCashShiftDropdown();
        } catch (error) {
          console.error('Error loading cash shifts:', error);
          cashShifts = [];
          populateCashShiftDropdown();
          showAlert('Failed to load cash shifts. Cash payments may not be available.', 'warning');
        }
      }

      // Populate cash shift dropdown with available shifts
      function populateCashShiftDropdown() {
        const select = document.getElementById('cash-shift-id');

        if (!select) {
          console.error('Cash shift select element not found');
          return;
        }

        // Clear existing options
        select.innerHTML = '';

        if (cashShifts.length === 0) {
          select.innerHTML = '<option value="">No open cash shifts available</option>';
          select.disabled = true;
          return;
        }

        // Add placeholder option
        const placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = 'Select a cash shift...';
        select.appendChild(placeholderOption);

        // Add cash shift options
        cashShifts.forEach(shift => {
          const option = document.createElement('option');
          option.value = shift.id;

          // Format the opened_at timestamp
          const openedDate = new Date(shift.opened_at);
          const formattedDate = openedDate.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });

          // Include event name if available
          let optionText = `Shift #${shift.id} - Opened ${formattedDate}`;
          if (shift.event_name) {
            optionText = `${shift.event_name} - ${optionText}`;
          }

          option.textContent = optionText;
          select.appendChild(option);
        });

        select.disabled = false;
      }

      // Populate the ticket type dropdown
      function populateTicketTypeDropdown() {
        const select = document.getElementById('ticket-type');

        if (!select) {
          console.error('Ticket type select element not found');
          return;
        }

        // Group tickets by event - include both available and test tickets
        const availableTickets = ticketTypes.filter(tt => tt.status === 'available' || tt.status === 'test');
        const ticketsByEvent = {};

        availableTickets.forEach(tt => {
          const eventName = tt.event_name || 'Unknown Event';
          if (!ticketsByEvent[eventName]) {
            ticketsByEvent[eventName] = [];
          }
          ticketsByEvent[eventName].push(tt);
        });

        // Clear existing options except placeholder
        select.innerHTML = '<option value="">Select ticket type...</option>';

        // Build optgroups for each event
        Object.keys(ticketsByEvent).sort().forEach(eventName => {
          const optgroup = document.createElement('optgroup');
          optgroup.label = eventName;

          ticketsByEvent[eventName].forEach(tt => {
            const option = document.createElement('option');
            option.value = tt.id;
            option.dataset.price = tt.price_cents;

            const maxQ = Number(tt.max_quantity || 0);
            const sold = Number(tt.sold_count || 0);
            const remainingCount = maxQ > 0 ? Math.max(0, maxQ - sold) : 0;
            const remaining = maxQ > 0 ? ` (${remainingCount} remaining)` : '';
            const testLabel = tt.status === 'test' ? ' [TEST]' : '';
            option.textContent = `${tt.name} - $${(tt.price_cents / 100).toFixed(2)}${remaining}${testLabel}`;

            optgroup.appendChild(option);
          });

          select.appendChild(optgroup);
        });
      }

      // Update order summary
      function updateSummary() {
        const select = document.getElementById('ticket-type');
        const paymentMethod = document.getElementById('payment-method').value;
        const isComp = paymentMethod === 'comp';

        let totalAmount = 0;

        if (select && select.value) {
          const selectedOption = select.options[select.selectedIndex];
          const price = parseInt(selectedOption.dataset.price) || 0;

          // If comp payment, force amount to 0
          totalAmount = isComp ? 0 : price;
        }

        document.getElementById('total-amount').textContent = `$${(totalAmount / 100).toFixed(2)}`;
      }

      // Setup event listeners
      function setupEventListeners() {
        // Payment method change
        document.getElementById('payment-method').addEventListener('change', (e) => {
          const cashContainer = document.getElementById('cash-shift-container');
          if (e.target.value === 'cash') {
            cashContainer.style.display = 'block';
          } else {
            cashContainer.style.display = 'none';
          }
          // Update summary when payment method changes (handles comp/free forcing $0.00)
          updateSummary();
        });

        // Update summary when ticket type changes
        document.getElementById('ticket-type').addEventListener('change', updateSummary);

        // "Same as Purchaser" checkbox - copy customer info to attendee fields
        document.getElementById('same-as-purchaser').addEventListener('change', (e) => {
          const attendeeFields = [
            document.getElementById('attendee-first-name'),
            document.getElementById('attendee-last-name'),
            document.getElementById('attendee-email')
          ];

          if (e.target.checked) {
            // Copy customer fields to attendee fields
            document.getElementById('attendee-first-name').value = document.getElementById('customer-first-name').value;
            document.getElementById('attendee-last-name').value = document.getElementById('customer-last-name').value;
            document.getElementById('attendee-email').value = document.getElementById('customer-email').value;

            // Make attendee fields readonly and style them
            attendeeFields.forEach(field => {
              field.readOnly = true;
              field.style.backgroundColor = 'rgba(91, 107, 181, 0.1)';
              field.style.cursor = 'not-allowed';
            });
          } else {
            // Clear attendee fields when unchecked
            document.getElementById('attendee-first-name').value = '';
            document.getElementById('attendee-last-name').value = '';
            document.getElementById('attendee-email').value = '';

            // Make attendee fields editable again and restore styling
            attendeeFields.forEach(field => {
              field.readOnly = false;
              field.style.backgroundColor = '';
              field.style.cursor = '';
            });
          }
        });

        // Also update attendee fields when customer fields change (if checkbox is checked)
        ['customer-first-name', 'customer-last-name', 'customer-email'].forEach(fieldId => {
          document.getElementById(fieldId).addEventListener('input', () => {
            if (document.getElementById('same-as-purchaser').checked) {
              // Auto-sync when checkbox is checked
              const attendeeFieldId = fieldId.replace('customer', 'attendee');
              document.getElementById(attendeeFieldId).value = document.getElementById(fieldId).value;
            }
          });
        });

        // Form submission
        document.getElementById('manual-entry-form').addEventListener('submit', handleFormSubmit);
      }

      // Handle form submission
      async function handleFormSubmit(e) {
        e.preventDefault();

        // Show loading overlay
        document.getElementById('loading-overlay').classList.add('show');

        try {
          // Gather form data
          const formData = new FormData(e.target);
          const paymentMethod = formData.get('paymentMethod');
          // CRITICAL: Trim values when extracting to reject whitespace-only inputs
          const customerFirstName = (formData.get('customerFirstName') || '').trim();
          const customerLastName = (formData.get('customerLastName') || '').trim();
          const customerName = `${customerFirstName} ${customerLastName}`.trim();
          const customerEmail = formData.get('customerEmail');
          const customerPhone = formData.get('customerPhone');
          const cashShiftId = formData.get('cashShiftId');

          // Attendee details
          // CRITICAL: Trim attendee values to reject whitespace-only inputs
          const attendeeFirstName = (formData.get('attendeeFirstName') || '').trim();
          const attendeeLastName = (formData.get('attendeeLastName') || '').trim();
          const attendeeEmail = (formData.get('attendeeEmail') || '').trim();

          // Ticket selection
          const ticketTypeId = formData.get('ticketType');

          // Validate required fields
          if (!customerFirstName || !customerLastName || !customerEmail || !paymentMethod) {
            throw new Error('Please fill in all customer information fields');
          }

          if (!attendeeFirstName || !attendeeLastName || !attendeeEmail) {
            throw new Error('Please fill in all attendee information fields');
          }

          if (!ticketTypeId) {
            throw new Error('Please select a ticket type');
          }

          // Validate cash shift for cash payments
          if (paymentMethod === 'cash' && !cashShiftId) {
            throw new Error('Please select an active cash shift for cash payments');
          }

          // Generate UUID for idempotency
          const manualEntryId = crypto.randomUUID();

          // Get CSRF token
          const token = localStorage.getItem('adminToken');
          const csrfToken = await csrfService.getCSRFToken();

          // Submit to API - single ticket with attendee details
          const response = await fetch('/api/admin/manual-ticket-entry', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`,
              'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({
              manualEntryId,
              ticketItems: [{
                ticketTypeId: ticketTypeId,
                quantity: 1,
                attendee: {
                  firstName: attendeeFirstName,
                  lastName: attendeeLastName,
                  email: attendeeEmail
                }
              }],
              paymentMethod,
              customerEmail,
              customerName,
              customerFirstName,
              customerLastName,
              customerPhone: customerPhone || null,
              cashShiftId: cashShiftId || null,
              isTest: false
            })
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || 'Failed to process ticket entry');
          }

          // Show success message
          showAlert(
            `Success! Ticket created for ${attendeeFirstName} ${attendeeLastName}.`,
            'success'
          );

          // Show email error if emails failed
          if (result.emailError) {
            showAlert(
              `‚ö†Ô∏è Ticket created successfully BUT emails failed to send!
              Error: ${result.emailError.message}
              Please manually send confirmation emails or check Vercel logs.`,
              'error'
            );
          } else {
            showAlert(
              `‚úÖ Confirmation emails sent to customer (${customerEmail}) and attendee (${attendeeEmail}).`,
              'success'
            );
          }

          // Show fraud alert if triggered
          if (result.fraudCheck?.alert) {
            showAlert(
              `Warning: Fraud alert triggered (${result.fraudCheck.recentTickets} tickets in last 15 minutes).
              Admin has been notified.`,
              'warning'
            );
          }

          // Reset form
          e.target.reset();
          updateSummary();

        } catch (error) {
          console.error('Error processing manual entry:', error);
          showAlert(error.message || 'Failed to process ticket entry', 'error');
        } finally {
          // Hide loading overlay
          document.getElementById('loading-overlay').classList.remove('show');
        }
      }

      // Show alert message
      function showAlert(message, type) {
        const container = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;

        container.appendChild(alert);

        // Auto-dismiss after 8 seconds
        setTimeout(() => {
          alert.remove();
        }, 8000);

        // Scroll to top to show alert
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // Logout
      window.logout = async function() {
        try {
          const token = localStorage.getItem('adminToken');
          await fetch('/api/admin/login', {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
        } catch (error) {
          console.error('Logout error:', error);
        } finally {
          localStorage.removeItem('adminToken');
          window.location.href = '/admin/login';
        }
      };
    </script>

    <!-- Mobile Navigation Controller -->
    <script src="/js/admin-mobile-nav.js"></script>
  </body>
</html>
