<!doctype html>
<html lang="en">
  <head>
    <!-- Inline theme detection to prevent FOUC -->
    <script>
      (function() {
        // Detect admin pages
        const path = window.location.pathname.toLowerCase();
        const isAdmin = path.includes('/admin') || path.includes('pages/admin');

        if (isAdmin) {
          // Admin pages always use dark theme
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          // Main site: check user preference
          let stored = null;
          try {
            stored = localStorage.getItem('theme-preference');
          } catch {
            // localStorage might be disabled
          }

          const preference = stored || 'system';
          let theme = preference;

          if (preference === 'system') {
            // Detect system preference
            theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
              ? 'dark'
              : 'light';
          }

          document.documentElement.setAttribute('data-theme', theme);
        }
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Tickets - A Lo Cubano Boulder Fest</title>
    <!-- Favicons -->
    <link
      rel="icon"
      type="image/png"
      href="/images/favicons/favicon-32x32.png"
    />
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/images/favicons/favicon-16x16.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/images/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/images/favicons/favicon-192x192.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="192x192"
      href="/images/favicons/favicon-192x192.png"
    />

    <!-- Critical resource preloading -->
    <script>
      // Inline critical path optimization - Event hero images with responsive variants
      (function () {
        // Check if optimized variants exist for event heroes
        const heroPath = "/images/hero/tickets.jpg";
        const isEventHero = false;

        if (isEventHero) {
          // Preload optimized variants for event heroes (WebP first, then JPEG fallback)
          const isMobile = window.innerWidth <= 768;
          const variant = isMobile ? "mobile" : "desktop";
          const baseName = "tickets";

          // Preload WebP variant
          const webpPreload = document.createElement("link");
          webpPreload.rel = "preload";
          webpPreload.as = "image";
          webpPreload.href = `/images/hero-optimized/${variant}/${baseName}.webp`;
          webpPreload.type = "image/webp";
          document.head.appendChild(webpPreload);

          // Preload AVIF variant for supported browsers
          if (typeof window !== "undefined" && "OffscreenCanvas" in window) {
            const avifPreload = document.createElement("link");
            avifPreload.rel = "preload";
            avifPreload.as = "image";
            avifPreload.href = `/images/hero-optimized/${variant}/${baseName}.avif`;
            avifPreload.type = "image/avif";
            document.head.appendChild(avifPreload);
          }

          // Fallback JPEG preload
          const jpegPreload = document.createElement("link");
          jpegPreload.rel = "preload";
          jpegPreload.as = "image";
          jpegPreload.href = `/images/hero-optimized/${variant}/${baseName}.jpg`;
          jpegPreload.type = "image/jpeg";
          document.head.appendChild(jpegPreload);
        } else {
          // Standard hero image preload for top-level pages
          const heroPreload = document.createElement("link");
          heroPreload.rel = "preload";
          heroPreload.as = "image";
          heroPreload.href = heroPath;
          document.head.appendChild(heroPreload);
        }
      })();
    </script>

    <!-- Performance optimizations -->

    <link rel="preconnect" href="https://wallet.apple.com">
    <link rel="preconnect" href="https://pay.google.com">

    
    <!-- Preconnect to Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Preload critical fonts -->
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Playfair+Display:ital,wght@0,400;0,900;1,400;1,900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Playfair+Display:ital,wght@0,400;0,900;1,400;1,900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" media="print" onload="this.media='all'">
    <noscript>
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Playfair+Display:ital,wght@0,400;0,900;1,400;1,900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap">
    </noscript>

    <!-- Theme Management - Early inclusion to prevent FOUC -->
    <script type="module" src="/js/theme-manager.js"></script>

    <!-- Time Management - Mountain Time support -->
    <script type="module" src="/js/time-manager.js"></script>

    <!-- Performance optimization system -->
    <script type="module" src="/js/qr-cache-manager.js"></script>
    <script type="module" src="/js/wallet-lazy-loader.js"></script>
    <script type="module" src="/js/performance-integration.js"></script>
    <!-- Critical CSS (render-blocking) -->
    <link rel="stylesheet" href="/css/bundle-critical.css" />

    <!-- Deferred CSS (lazy-loaded) -->
    <link rel="stylesheet" href="/css/bundle-deferred.css" media="print" onload="this.media='all'">
    <noscript>
      <link rel="stylesheet" href="/css/bundle-deferred.css">
    </noscript><style>
      .ticket-lookup {
        max-width: 600px;
        margin: 50px auto;
        padding: 30px;
        background: var(--color-background, white);
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .ticket-list {
        margin-top: 30px;
      }

      .ticket-card {
        background: var(--color-surface, #f8f9fa);
        border-left: 4px solid #667eea;
        padding: 20px;
        margin: 20px 0;
        border-radius: 5px;
      }

      .ticket-card h3 {
        margin: 0 0 10px 0;
        color: var(--color-text-primary, #333);
      }

      .ticket-details {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 10px;
        margin-top: 15px;
      }

      .ticket-details dt {
        font-weight: bold;
        color: var(--color-text-secondary, #666);
      }

      .ticket-details dd {
        margin: 0;
        color: var(--color-text-primary, #333);
      }

      .ticket-id {
        font-family: var(--font-mono, monospace);
        font-size: var(--text-xs, 0.75rem);
        color: var(--color-text-secondary);
        display: inline-block;
      }

      .status-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
      }

      .status-valid {
        background: var(--color-success-light, #d4edda);
        color: var(--color-success-dark, #155724);
      }
      .status-used {
        background: var(--color-info-light, #cce5ff);
        color: var(--color-info-dark, #004085);
      }
      .status-cancelled {
        background: var(--color-danger-light, #f8d7da);
        color: var(--color-danger-dark, #721c24);
      }
      .status-transferred {
        background: var(--color-warning-light, #fff3cd);
        color: var(--color-warning-dark, #856404);
      }

      .lookup-form {
        display: flex;
        gap: 10px;
      }

      .lookup-form input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
      }

      .lookup-form button {
        padding: 12px 30px;
        background: var(--color-primary, #667eea);
        color: var(--color-text-on-primary, white);
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }

      .lookup-form button:hover {
        background: var(--color-primary-dark, #5a67d8);
      }

      .message {
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
      }

      .message.error {
        background: var(--color-danger-light, #f8d7da);
        color: var(--color-danger-dark, #721c24);
      }

      .message.info {
        background: var(--color-info-lighter, #d1ecf1);
        color: var(--color-info-darker, #0c5460);
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: var(--color-text-secondary, #666);
      }

      .btn-small {
        display: inline-block;
        padding: 6px 12px;
        margin: 0 5px 5px 0;
        border: none;
        border-radius: 4px;
        background: var(--color-primary, #667eea);
        color: var(--color-text-on-primary, white);
        font-size: 12px;
        cursor: pointer;
        text-decoration: none;
      }

      .btn-small:hover {
        background: var(--color-primary-dark, #5a67d8);
      }

      .btn-small.btn-warning {
        background: var(--color-warning, #ed8936);
      }

      .btn-small.btn-warning:hover {
        background: var(--color-warning-dark, #dd6b20);
      }

      .btn-small.btn-danger {
        background: var(--color-danger, #e53e3e);
      }

      .btn-small.btn-danger:hover {
        background: var(--color-danger-dark, #c53030);
      }

      .ticket-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 10px;
        max-width: 600px;
        width: 90%;
        position: relative;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
      }

      .close:hover {
        color: #000;
      }

      .qr-code-display {
        text-align: center;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 20px 0;
      }

      .qr-code-data {
        word-break: break-all;
        font-family: monospace;
        font-size: 10px;
        margin-top: 10px;
        color: var(--color-text-secondary, #666);
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: var(--color-text-primary, #333);
      }

      .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      .btn-primary {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body class="typographic">
    <header class="header">
      <div class="container">
        <div class="grid">
          <div class="header-left">
            <a href="/home" class="logo-link" aria-label="Go to home page">
              <img
                src="/images/logo.png"
                alt="A Lo Cubano Boulder Fest Logo"
                class="site-logo"
                data-light-src="/images/logo.png"
                data-dark-src="/images/logo-dark.png"
              />
              <div class="logo-text">
                <span class="logo-main">A LO CUBANO</span>
                <span class="logo-separator">|</span>
                <span class="logo-sub">Boulder Fest</span>
              </div>
            </a>
          </div>
          <nav class="main-nav">
            <button
              class="menu-toggle"
              aria-label="Toggle menu"
              aria-expanded="false"
              aria-controls="main-navigation"
            >
              <div class="menu-icon">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </button>
            <ul class="nav-list" id="main-navigation">
              <li>
                <a href="/home" class="nav-link" data-text="Home">Home</a>
              </li>
              <li>
                <a href="/about" class="nav-link" data-text="About">About</a>
              </li>
              <li class="nav-item has-dropdown">
                <button
                  class="nav-trigger"
                  aria-expanded="false"
                  aria-haspopup="true"
                  data-dropdown="events"
                  data-text="Events"
                >
                  Events
                  <span class="dropdown-arrow" aria-hidden="true">▼</span>
                </button>
                <ul
                  class="dropdown-menu"
                  aria-hidden="true"
                  role="menu"
                  data-dropdown-content="events"
                >
                  <li class="dropdown-category" role="group">
                    <span class="dropdown-category-title" role="presentation"
                      >Boulder Fest</span
                    >
                    <ul class="dropdown-submenu">
                      <li>
                        <a
                          href="/boulder-fest-2026"
                          class="dropdown-link"
                          role="menuitem"
                          data-event="boulder-fest-2026"
                          data-event-status="upcoming"
                          >2026 Festival</a
                        >
                      </li>
                      <li>
                        <a
                          href="/boulder-fest-2025"
                          class="dropdown-link"
                          role="menuitem"
                          data-event="boulder-fest-2025"
                          data-event-status="current"
                          >2025 Festival</a
                        >
                      </li>
                    </ul>
                  </li>
                  <li class="dropdown-category" role="group">
                    <span class="dropdown-category-title" role="presentation"
                      >Weekenders</span
                    >
                    <ul class="dropdown-submenu">
                      <li>
                        <a
                          href="/weekender-2025-11"
                          class="dropdown-link"
                          role="menuitem"
                          data-event="weekender-2025-11"
                          data-event-status="upcoming"
                          >November 2025</a
                        >
                      </li>
                    </ul>
                  </li>
                </ul>
              </li>
              <li>
                <a href="/tickets" class="nav-link" data-text="Tickets"
                  >Tickets</a
                >
              </li>
              <li>
                <a href="/donations" class="nav-link" data-text="Donate"
                  >Donate</a
                >
              </li>
              <li>
                <a href="/contact" class="nav-link" data-text="Contact"
                  >Contact</a
                >
              </li>
            </ul>
            <div class="nav-cart-item">
              <button class="nav-cart-button" aria-label="View cart" data-testid="view-cart">
                <svg class="nav-cart-icon" viewBox="0 0 24 24" width="20" height="20">
                  <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
                <span class="nav-cart-badge" style="display: none;" data-testid="cart-counter">0</span>
              </button>
            </div>
          </nav>
        </div>
      </div>
    </header>

    <main>
      <!-- Hero Splash Image -->
      <section class="gallery-hero-splash">
        <div class="hero-image-container">
          <img
            id="hero-splash-image"
            src="/images/hero/tickets.jpg"
            alt="Excited festival attendees enjoying A Lo Cubano Boulder Fest events"
            class="hero-splash-img"
            style="object-position: top center !important"
          />
        </div>
      </section>

      <section class="section-typographic">
        <div class="container">
          <div class="ticket-lookup">
      <h1>My Tickets</h1>

      <!-- Step 1: Email Input -->
      <div id="emailStep" class="verification-step">
        <p>
          Enter your email address to receive a verification code.
        </p>
        <form class="lookup-form" id="emailForm">
          <input
            type="email"
            id="emailInput"
            placeholder="Enter your email address"
            required
            aria-label="Email address"
          />
          <button type="submit" class="btn-primary">Send Code</button>
        </form>
      </div>

      <!-- Step 2: Code Verification -->
      <div id="codeStep" class="verification-step" style="display: none;">
        <p>
          <strong>Check your email!</strong> We've sent a 6-digit verification code to <span id="emailDisplay" class="highlight-email"></span>
        </p>
        <p class="code-expiry-info">
          Code expires in <span id="expiryTimer">5:00</span> minutes
        </p>
        <form class="verification-form" id="codeForm">
          <div class="form-group">
            <label for="codeInput">Verification Code</label>
            <input
              type="text"
              id="codeInput"
              placeholder="000000"
              required
              maxlength="6"
              pattern="[0-9]{6}"
              inputmode="numeric"
              autocomplete="one-time-code"
              aria-label="6-digit verification code"
            />
          </div>
          <div class="form-actions">
            <button type="submit" class="btn-primary">Verify Code</button>
            <button type="button" id="resendCodeBtn" class="btn-secondary" disabled>
              Resend Code (<span id="resendTimer">60</span>s)
            </button>
          </div>
        </form>
        <button type="button" id="changeEmailBtn" class="btn-link">Use different email</button>
      </div>

      <!-- Step 3: Authenticated View -->
      <div id="authenticatedView" style="display: none;">
        <div class="session-info">
          <p>Viewing tickets for <span id="authenticatedEmail" class="highlight-email"></span></p>
          <button type="button" id="logoutBtn" class="btn-link">Sign out</button>
        </div>
      </div>

      <div id="messageContainer"></div>
      <div id="ticketContainer"></div>
          </div>
        </div>
      </section>
    </main>

    <!-- QR Code Modal -->
    <div id="qrModal" class="modal" role="dialog" aria-labelledby="qrModalTitle" aria-modal="true">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="qrModalTitle">Ticket QR Code</h2>
          <button class="close" onclick="closeModal('qrModal')" aria-label="Close QR code modal">&times;</button>
        </div>
        <div class="qr-code-display">
          <div id="qrCodeContainer">
            <p>QR Code will appear here</p>
          </div>
          <div class="qr-code-data" id="qrCodeData"></div>
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" onclick="closeModal('qrModal')">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Transfer Modal -->
    <div id="transferModal" class="modal" role="dialog" aria-labelledby="transferModalTitle" aria-modal="true">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="transferModalTitle">Transfer Ticket</h2>
          <button class="close" onclick="closeModal('transferModal')" aria-label="Close transfer modal">
            &times;
          </button>
        </div>
        <form id="transferForm">
          <div class="form-group">
            <label for="transferEmail">New Attendee Email *</label>
            <input type="email" id="transferEmail" required aria-required="true" autocomplete="email" />
          </div>
          <div class="form-group">
            <label for="transferFirstName">First Name *</label>
            <input type="text" id="transferFirstName" required aria-required="true" autocomplete="given-name" />
          </div>
          <div class="form-group">
            <label for="transferLastName">Last Name</label>
            <input type="text" id="transferLastName" autocomplete="family-name" />
          </div>
          <div class="form-group">
            <label for="transferPhone">Phone</label>
            <input type="tel" id="transferPhone" autocomplete="tel" />
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeModal('transferModal')"
            >
              Cancel
            </button>
            <button type="submit" class="btn-primary">Transfer Ticket</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Cancel Modal -->
    <div id="cancelModal" class="modal" role="dialog" aria-labelledby="cancelModalTitle" aria-modal="true">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="cancelModalTitle">Cancel Ticket</h2>
          <button class="close" onclick="closeModal('cancelModal')" aria-label="Close cancel modal">
            &times;
          </button>
        </div>
        <p>Are you sure you want to cancel this ticket?</p>
        <div class="form-group">
          <label for="cancelReason">Cancellation Reason (optional)</label>
          <input
            type="text"
            id="cancelReason"
            placeholder="e.g., Unable to attend"
            aria-describedby="cancelReasonHint"
          />
          <span id="cancelReasonHint" class="visually-hidden">Providing a reason is optional but helps us improve our service</span>
        </div>
        <div class="modal-actions">
          <button
            type="button"
            class="btn-secondary"
            onclick="closeModal('cancelModal')"
          >
            No, Keep Ticket
          </button>
          <button type="button" class="btn-primary" onclick="confirmCancel()">
            Yes, Cancel Ticket
          </button>
        </div>
      </div>
    </div>

    <footer class="footer-typographic">
      <div class="container">
        <p class="footer-credits">
          YOUR PASS TO THE DANCE FLOOR •
          <a
            href="mailto:alocubanoboulderfest@gmail.com?subject=A Lo Cubano Boulder Fest Inquiry"
            style="color: inherit; text-decoration: underline"
            >alocubanoboulderfest@gmail.com</a
          >
        </p>
        <div class="footer-social">
          <a
            href="https://www.instagram.com/alocubano.boulderfest/"
            target="_blank"
            rel="noopener noreferrer"
            class="social-link-type"
            aria-label="Follow us on Instagram"
          >
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
              <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
              <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
            </svg>
          </a>
          <a
            href="https://chat.whatsapp.com/KadIVdb24RWKdIKGtipnLH"
            target="_blank"
            rel="noopener noreferrer"
            class="social-link-type"
            aria-label="Join us on WhatsApp"
          >
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"
              ></path>
            </svg>
          </a>
        </div>
        <div id="theme-toggle-container" class="footer-theme-toggle"></div>
      </div>
    </footer>

    <script type="module">
      import { setSafeTextContent, displayMessage, createElementWithContent, escapeHtml } from '/js/lib/dom-security.js';
      import timeManager from '/js/time-manager.js';

      // State management
      let currentEmail = '';
      let currentAccessToken = '';
      let expiryInterval = null;
      let resendInterval = null;
      let currentTickets = [];
      let editingTicketId = null;

      // Check for existing session
      const storedToken = localStorage.getItem('ticketAccessToken');
      const storedEmail = localStorage.getItem('ticketAccessEmail');
      const tokenExpiry = localStorage.getItem('ticketAccessTokenExpiry');

      if (storedToken && storedEmail && tokenExpiry) {
        const now = Date.now();
        if (now < parseInt(tokenExpiry)) {
          // Token still valid
          currentAccessToken = storedToken;
          currentEmail = storedEmail;
          showAuthenticatedView();
          loadTickets();
        } else {
          // Token expired, clear storage
          clearSession();
        }
      }

      // Email form submission
      document.getElementById("emailForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        await sendVerificationCode();
      });

      // Code form submission
      document.getElementById("codeForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        await verifyCode();
      });

      // Resend code button
      document.getElementById("resendCodeBtn").addEventListener("click", async () => {
        await sendVerificationCode(true);
      });

      // Change email button
      document.getElementById("changeEmailBtn").addEventListener("click", () => {
        resetToEmailStep();
      });

      // Logout button
      document.getElementById("logoutBtn").addEventListener("click", () => {
        clearSession();
        resetToEmailStep();
        showMessage('You have been signed out.', 'info');
      });

      // Session management
      function clearSession() {
        localStorage.removeItem('ticketAccessToken');
        localStorage.removeItem('ticketAccessEmail');
        localStorage.removeItem('ticketAccessTokenExpiry');
        currentAccessToken = '';
        currentEmail = '';
        currentTickets = [];
      }

      function saveSession(token, email, expiresIn) {
        const expiry = Date.now() + (expiresIn * 1000);
        localStorage.setItem('ticketAccessToken', token);
        localStorage.setItem('ticketAccessEmail', email);
        localStorage.setItem('ticketAccessTokenExpiry', expiry.toString());
        currentAccessToken = token;
        currentEmail = email;
      }

      // UI state management
      function showEmailStep() {
        document.getElementById('emailStep').style.display = 'block';
        document.getElementById('codeStep').style.display = 'none';
        document.getElementById('authenticatedView').style.display = 'none';
      }

      function showCodeStep() {
        document.getElementById('emailStep').style.display = 'none';
        document.getElementById('codeStep').style.display = 'block';
        document.getElementById('authenticatedView').style.display = 'none';
        document.getElementById('codeInput').focus();
      }

      function showAuthenticatedView() {
        document.getElementById('emailStep').style.display = 'none';
        document.getElementById('codeStep').style.display = 'none';
        document.getElementById('authenticatedView').style.display = 'block';
        setSafeTextContent(document.getElementById('authenticatedEmail'), currentEmail);
      }

      function resetToEmailStep() {
        showEmailStep();
        document.getElementById('emailInput').value = '';
        document.getElementById('codeInput').value = '';
        clearMessage();
        document.getElementById('ticketContainer').innerHTML = '';
        if (expiryInterval) clearInterval(expiryInterval);
        if (resendInterval) clearInterval(resendInterval);
      }

      // Verification flow
      async function sendVerificationCode(isResend = false) {
        const email = document.getElementById('emailInput').value.trim();
        if (!email) {
          showMessage('Please enter your email address.', 'error');
          return;
        }

        currentEmail = email;

        const btn = isResend ? document.getElementById('resendCodeBtn') : document.querySelector('#emailForm button[type="submit"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Sending...';

        try {
          const response = await fetch('/api/tickets/verify-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Failed to send verification code');
          }

          setSafeTextContent(document.getElementById('emailDisplay'), email);
          showCodeStep();
          startExpiryTimer(data.expiresIn || 300); // 5 minutes default
          startResendTimer();
          showMessage('Verification code sent! Check your email.', 'success');
        } catch (error) {
          console.error('Error sending verification code:', error);
          showMessage(error.message, 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }

      async function verifyCode() {
        const code = document.getElementById('codeInput').value.trim();
        if (!code || !/^\d{6}$/.test(code)) {
          showMessage('Please enter a valid 6-digit code.', 'error');
          return;
        }

        const btn = document.querySelector('#codeForm button[type="submit"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Verifying...';

        try {
          const response = await fetch('/api/tickets/verify-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: currentEmail, code })
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Invalid verification code');
          }

          // Save session
          saveSession(data.accessToken, currentEmail, data.expiresIn || 3600);

          // Clear timers
          if (expiryInterval) clearInterval(expiryInterval);
          if (resendInterval) clearInterval(resendInterval);

          // Show authenticated view and load tickets
          showAuthenticatedView();
          await loadTickets();
          showMessage('Verification successful! Loading your tickets...', 'success');

        } catch (error) {
          console.error('Error verifying code:', error);
          showMessage(error.message, 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }

      // Timer management
      function startExpiryTimer(seconds) {
        if (expiryInterval) clearInterval(expiryInterval);

        let remaining = seconds;
        const timerEl = document.getElementById('expiryTimer');

        const updateTimer = () => {
          const minutes = Math.floor(remaining / 60);
          const secs = remaining % 60;
          setSafeTextContent(timerEl, `${minutes}:${secs.toString().padStart(2, '0')}`);

          if (remaining <= 0) {
            clearInterval(expiryInterval);
            showMessage('Verification code expired. Please request a new code.', 'warning');
          }
          remaining--;
        };

        updateTimer();
        expiryInterval = setInterval(updateTimer, 1000);
      }

      function startResendTimer() {
        if (resendInterval) clearInterval(resendInterval);

        let remaining = 60;
        const btn = document.getElementById('resendCodeBtn');
        const timerEl = document.getElementById('resendTimer');
        btn.disabled = true;

        const updateTimer = () => {
          setSafeTextContent(timerEl, remaining.toString());

          if (remaining <= 0) {
            clearInterval(resendInterval);
            btn.disabled = false;
            btn.innerHTML = 'Resend Code';
          }
          remaining--;
        };

        updateTimer();
        resendInterval = setInterval(updateTimer, 1000);
      }

      // Load tickets with authentication
      async function loadTickets() {
        const ticketContainer = document.getElementById('ticketContainer');

        ticketContainer.innerHTML = '';
        const loadingElement = createElementWithContent('div', 'Loading your tickets...', {
          className: 'loading'
        });
        ticketContainer.appendChild(loadingElement);

        try {
          const response = await fetch(`/api/tickets?email=${encodeURIComponent(currentEmail)}`, {
            headers: {
              'Authorization': `Bearer ${currentAccessToken}`
            }
          });

          const data = await response.json();

          if (!response.ok) {
            if (response.status === 401) {
              // Token expired
              clearSession();
              resetToEmailStep();
              showMessage('Your session has expired. Please sign in again.', 'warning');
              return;
            }
            throw new Error(data.error || 'Failed to load tickets');
          }

          currentTickets = data.tickets || [];

          if (currentTickets.length === 0) {
            ticketContainer.innerHTML = '<p class="no-tickets">No tickets found for this email.</p>';
            return;
          }

          displayTickets(currentTickets);
        } catch (error) {
          console.error('Error loading tickets:', error);
          showMessage(error.message, 'error');
          ticketContainer.innerHTML = '';
        }
      }

      function displayTickets(tickets) {
        const ticketContainer = document.getElementById("ticketContainer");

        const ticketsHtml = tickets
          .map((ticket) => {
            // Escape all user-controlled values
            const ticketId = escapeHtml(ticket.ticket_id || '');
            const ticketType = escapeHtml(ticket.formatted_type || formatTicketType(ticket.ticket_type || ''));
            const ticketStatus = escapeHtml(ticket.status || '');
            const attendeeFirstName = escapeHtml(ticket.attendee_first_name || '');
            const attendeeLastName = escapeHtml(ticket.attendee_last_name || '');
            const attendeeEmail = escapeHtml(ticket.attendee_email || '');
            const formattedDate = escapeHtml(ticket.formatted_date || timeManager.formatDate(ticket.event_date, true) || '');
            const orderNumber = escapeHtml(ticket.order_number || 'N/A');
            const scanCount = ticket.scan_count || 0;
            const canEdit = scanCount === 0 && currentAccessToken;

            return `
                    <div class="ticket-card" id="ticket-${ticketId}" data-ticket-id="${ticketId}">
                        <div class="ticket-header">
                            <div>
                                <h3>${ticketType}</h3>
                                <span class="status-badge status-${ticketStatus}">${ticketStatus}</span>
                            </div>
                        </div>

                        <dl class="ticket-details">
                            <dt>Ticket ID:</dt>
                            <dd><span class="ticket-id">${ticketId}</span></dd>

                            <dt>Attendee Name:</dt>
                            <dd class="attendee-info">
                                <span class="attendee-display" id="display-${ticketId}">
                                    ${attendeeFirstName} ${attendeeLastName}
                                    ${canEdit ? `<button class="btn-icon" onclick="startEditingTicket('${ticketId}')" aria-label="Edit attendee information" title="Edit attendee information">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>` : ''}
                                </span>
                                <form class="attendee-edit-form" id="edit-form-${ticketId}" style="display: none;">
                                    <div class="edit-fields">
                                        <div class="form-group-inline">
                                            <label for="edit-first-${ticketId}">First Name</label>
                                            <input type="text" id="edit-first-${ticketId}" value="${attendeeFirstName}" required />
                                        </div>
                                        <div class="form-group-inline">
                                            <label for="edit-last-${ticketId}">Last Name</label>
                                            <input type="text" id="edit-last-${ticketId}" value="${attendeeLastName}" />
                                        </div>
                                        <div class="form-group-inline">
                                            <label for="edit-email-${ticketId}">Email</label>
                                            <input type="email" id="edit-email-${ticketId}" value="${attendeeEmail}" required />
                                        </div>
                                    </div>
                                    <div class="edit-actions">
                                        <button type="button" class="btn-small btn-primary" onclick="saveTicketEdit('${ticketId}')">Save</button>
                                        <button type="button" class="btn-small btn-secondary" onclick="cancelTicketEdit('${ticketId}')">Cancel</button>
                                    </div>
                                </form>
                            </dd>

                            <dt>Email:</dt>
                            <dd id="email-display-${ticketId}">${attendeeEmail}</dd>

                            <dt>Event:</dt>
                            <dd>A Lo Cubano Boulder Fest 2026</dd>

                            <dt>Date:</dt>
                            <dd>${formattedDate}</dd>

                            <dt>Order:</dt>
                            <dd>${orderNumber}</dd>
                        </dl>

                        <!-- Lazy-loaded wallet buttons -->
                        <div class="wallet-lazy-container" data-ticket-id="${ticketId}" data-lazy-wallet="true"></div>

                        ${currentAccessToken ? `
                        <div class="ticket-actions">
                            <button class="btn-small" onclick="generateQRCode('${ticketId}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="14" width="7" height="7"></rect>
                                    <rect x="3" y="14" width="7" height="7"></rect>
                                </svg>
                                QR Code
                            </button>
                            <button class="btn-small btn-warning" onclick="initiateTransfer('${ticketId}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="7" y1="17" x2="17" y2="7"></line>
                                    <polyline points="7 7 17 7 17 17"></polyline>
                                </svg>
                                Transfer
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
          })
          .join("");

        ticketContainer.innerHTML = `
                <div class="ticket-list">
                    <h2>Your Tickets (${tickets.length})</h2>
                    ${ticketsHtml}
                </div>
            `;

        // Initialize lazy-loaded wallet buttons
        requestAnimationFrame(() => {
          const walletContainers = document.querySelectorAll('.wallet-lazy-container[data-ticket-id]');
          walletContainers.forEach(container => {
            const ticketId = container.getAttribute('data-ticket-id');
            if (ticketId) {
              window.walletLazyLoader.observeWalletContainer(container, ticketId, {
                title: 'Add to Wallet',
                size: 'small',
                showBothOnDesktop: true,
                className: 'wallet-buttons-ticket-list'
              });
            }
          });

          // Preload QR codes for first few tickets
          const firstFewTickets = tickets.slice(0, 3);
          firstFewTickets.forEach(ticket => {
            if (ticket.qr_token) {
              window.qrCacheManager.preloadQRCode(ticket.qr_token);
            }
          });
        });
      }

      function formatTicketType(type) {
        const typeMap = {
          "vip-pass": "VIP Pass",
          "weekend-pass": "Weekend Pass",
          "friday-pass": "Friday Pass",
          "saturday-pass": "Saturday Pass",
          "sunday-pass": "Sunday Pass",
          "workshop-beginner": "Beginner Workshop",
          "workshop-intermediate": "Intermediate Workshop",
          "workshop-advanced": "Advanced Workshop",
          workshop: "Workshop",
          "social-dance": "Social Dance",
          "general-admission": "General Admission",
        };
        return typeMap[type] || type;
      }

      // Message helpers
      function showMessage(message, type = 'info') {
        const messageContainer = document.getElementById("messageContainer");
        displayMessage(messageContainer, escapeHtml(message), type, {
          clearPrevious: true,
          autoHide: type === 'success' || type === 'info',
          hideDelay: 5000
        });
      }

      function clearMessage() {
        document.getElementById("messageContainer").innerHTML = '';
      }

      // Inline editing functions
      window.startEditingTicket = function(ticketId) {
        editingTicketId = ticketId;
        document.getElementById(`display-${ticketId}`).style.display = 'none';
        document.getElementById(`edit-form-${ticketId}`).style.display = 'block';
        document.getElementById(`edit-first-${ticketId}`).focus();
      };

      window.cancelTicketEdit = function(ticketId) {
        document.getElementById(`display-${ticketId}`).style.display = 'inline';
        document.getElementById(`edit-form-${ticketId}`).style.display = 'none';
        editingTicketId = null;
      };

      window.saveTicketEdit = async function(ticketId) {
        const firstName = document.getElementById(`edit-first-${ticketId}`).value.trim();
        const lastName = document.getElementById(`edit-last-${ticketId}`).value.trim();
        const email = document.getElementById(`edit-email-${ticketId}`).value.trim();

        if (!firstName || !email) {
          showMessage('First name and email are required.', 'error');
          return;
        }

        const btn = document.querySelector(`#edit-form-${ticketId} .btn-primary`);
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        try {
          const response = await fetch(`/api/tickets/${encodeURIComponent(ticketId)}/attendee`, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${currentAccessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ firstName, lastName, email })
          });

          const data = await response.json();

          if (!response.ok) {
            if (response.status === 401) {
              clearSession();
              resetToEmailStep();
              showMessage('Your session has expired. Please sign in again.', 'warning');
              return;
            }
            throw new Error(data.error || 'Failed to update ticket');
          }

          // Update ticket in current list
          const ticketIndex = currentTickets.findIndex(t => t.ticket_id === ticketId);
          if (ticketIndex !== -1) {
            currentTickets[ticketIndex].attendee_first_name = data.ticket.attendee_first_name;
            currentTickets[ticketIndex].attendee_last_name = data.ticket.attendee_last_name;
            currentTickets[ticketIndex].attendee_email = data.ticket.attendee_email;
          }

          // Update display - need to preserve the edit button
          const displayEl = document.querySelector(`#display-${ticketId}`);
          const editBtn = displayEl.querySelector('.btn-icon');
          displayEl.textContent = `${data.ticket.attendee_first_name} ${data.ticket.attendee_last_name} `;
          if (editBtn) {
            displayEl.appendChild(editBtn);
          }
          setSafeTextContent(
            document.getElementById(`email-display-${ticketId}`),
            data.ticket.attendee_email
          );

          // Cancel edit mode
          cancelTicketEdit(ticketId);

          showMessage('Ticket information updated successfully! Check your email for confirmation.', 'success');

        } catch (error) {
          console.error('Error updating ticket:', error);
          showMessage(error.message, 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      };

      // Modal management
      let currentTicketId = null;

      function openModal(modalId) {
        document.getElementById(modalId).style.display = "block";
      }

      window.closeModal = function(modalId) {
        document.getElementById(modalId).style.display = "none";
        if (modalId === "transferModal") {
          document.getElementById("transferForm").reset();
        }
        if (modalId === "cancelModal") {
          document.getElementById("cancelReason").value = "";
        }
      };

      // Close modal when clicking outside
      document.addEventListener('click', function (event) {
        const modals = document.querySelectorAll(".modal");
        modals.forEach((modal) => {
          if (event.target === modal) {
            window.closeModal(modal.id);
          }
        });
      });

      // Enhanced ticket management functions
      window.generateQRCode = async function(ticketId) {
        try {
          const ticket = currentTickets.find(t => t.ticket_id === ticketId);
          if (!ticket) {
            throw new Error('Ticket not found');
          }

          // Create a container for the QR code
          const qrContainer = document.createElement('div');

          // Load QR code using cache manager with the ticket's qr_token
          if (ticket.qr_token) {
            await window.qrCacheManager.loadQRCode(ticket.qr_token, qrContainer, {
              showSkeleton: true,
              retryOnError: true
            });
          } else {
            throw new Error('QR code not available for this ticket');
          }

          // Display QR code in modal
          document.getElementById("qrCodeContainer").innerHTML = `
            <h3>Ticket ${escapeHtml(ticketId)}</h3>
            <p>Show this QR code at the event entrance</p>
            <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #ddd;">
              ${qrContainer.innerHTML}
            </div>
          `;

          openModal("qrModal");
        } catch (error) {
          showMessage('Failed to generate QR code: ' + error.message, 'error');
        }
      };

      window.initiateTransfer = function(ticketId) {
        currentTicketId = ticketId;
        openModal("transferModal");
      };

      window.confirmCancel = function() {
        const reason = document.getElementById("cancelReason").value || "Customer request";
        performTicketCancel(currentTicketId, reason);
        closeModal("cancelModal");
      };

      // Handle transfer form submission
      document
        .getElementById("transferForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const newAttendee = {
            email: document.getElementById("transferEmail").value,
            firstName: document.getElementById("transferFirstName").value,
            lastName: document.getElementById("transferLastName").value,
            phone: document.getElementById("transferPhone").value,
          };
          performTicketTransfer(currentTicketId, newAttendee);
          closeModal("transferModal");
        });

      async function performTicketTransfer(ticketId, newAttendee) {
        try {
          if (!currentEmail) {
            throw new Error("Unable to determine current user. Please refresh the page and try again.");
          }

          // First get action token
          const tokenResponse = await fetch("/api/tickets/action-token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "transfer",
              targetId: ticketId,
              email: currentEmail,
            }),
          });

          const tokenData = await tokenResponse.json();
          if (!tokenResponse.ok) throw new Error(tokenData.error);

          // Perform transfer
          const transferResponse = await fetch("/api/tickets/transfer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ticketId,
              actionToken: tokenData.actionToken,
              newAttendee,
            }),
          });

          const transferData = await transferResponse.json();
          if (!transferResponse.ok) throw new Error(transferData.error);

          showMessage("Ticket transferred successfully!", 'success');
          setTimeout(() => loadTickets(), 2000);
        } catch (error) {
          showMessage('Transfer failed: ' + error.message, 'error');
        }
      }

      function formatDate(dateStr) {
        if (!dateStr) return "May 15-17, 2026 (Mountain Time)";
        return timeManager.formatDate(dateStr, true) + " (Mountain Time)";
      }
    </script>

    <!-- Theme Management -->
    <script type="module">
      import { initializeThemeToggle } from '/js/theme-toggle.js';
      import themeManager from '/js/theme-manager.js';

      // Initialize theme system
      document.addEventListener('DOMContentLoaded', () => {
        themeManager.initializeTheme();
        initializeThemeToggle('#theme-toggle-container');
      });
    </script>

    <!-- Navigation and Gallery Scripts -->
    <script defer src="/js/navigation.js"></script>
    <script src="/js/gallery-hero.js"></script>

    <!-- Global Cart System -->
    <script type="module" src="/js/global-cart.js"></script>

    <!-- Logo Switcher -->
    <script src="/js/logo-switcher.js"></script>
  </body>
</html>
