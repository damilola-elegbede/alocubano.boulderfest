<!doctype html>
<html lang="en">
  <head>
    <!-- Inline theme detection to prevent FOUC -->
    <script>
      (function() {
        // Detect admin pages
        const path = window.location.pathname.toLowerCase();
        const isAdmin = path.includes('/admin') || path.includes('pages/admin');

        if (isAdmin) {
          // Admin pages always use dark theme
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          // Main site: check user preference
          let stored = null;
          try {
            stored = localStorage.getItem('theme-preference');
          } catch {
            // localStorage might be disabled
          }

          const preference = stored || 'system';
          let theme = preference;

          if (preference === 'system') {
            // Detect system preference
            theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
              ? 'dark'
              : 'light';
          }

          document.documentElement.setAttribute('data-theme', theme);
        }
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Successful - A Lo Cubano Boulder Fest</title>
    <meta
      name="description"
      content="Thank you for your purchase! Your payment for A Lo Cubano Boulder Fest has been successfully processed."
    />
    <!-- Favicons -->
    <link
      rel="icon"
      type="image/png"
      href="/images/favicons/favicon-32x32.png"
    />
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/images/favicons/favicon-16x16.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/images/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/images/favicons/favicon-192x192.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="192x192"
      href="/images/favicons/favicon-192x192.png"
    />

    <!-- DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//fonts.gstatic.com" />

    <!-- Performance optimizations -->
    
    <link rel="preconnect" href="https://wallet.apple.com">
    <link rel="preconnect" href="https://pay.google.com">

    <!-- Theme Management - Early inclusion to prevent FOUC -->
    <script type="module" src="/js/theme-manager.js"></script>

    <!-- Performance optimization system -->
    <script type="module" src="/js/qr-cache-manager.js"></script>
    <script type="module" src="/js/wallet-lazy-loader.js"></script>
    <script type="module" src="/js/performance-integration.js"></script>

    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/typography.css" />
    <link rel="stylesheet" href="/css/floating-cart.css" />
    <link rel="stylesheet" href="/css/floating-cart-dark.css" />
    <link rel="stylesheet" href="/css/header-cart.css" />
    <link rel="stylesheet" href="/css/checkout-loading.css" />
    <link rel="stylesheet" href="/css/mobile-overrides.css" />
    <!-- Theme styles -->
    <link rel="stylesheet" href="/css/theme-toggle.css" />

    <style>
      /* Success Page Specific Styles */
      .success-container {
        min-height: 60vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-2xl) var(--space-xl);
      }

      .success-content {
        text-align: center;
        max-width: 600px;
        margin: 0 auto;
      }

      .success-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto var(--space-2xl);
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--color-black);
        border-radius: 50%;
        animation: scaleIn 0.5s ease-out;
      }

      .success-icon svg {
        width: 50px;
        height: 50px;
        color: var(--color-white);
      }

      @keyframes scaleIn {
        from {
          transform: scale(0);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .success-title {
        font-family: var(--font-display);
        font-size: var(--font-size-4xl);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--space-xl);
        line-height: 1.2;
      }

      .success-message {
        font-family: var(--font-sans);
        font-size: var(--font-size-lg);
        line-height: 1.6;
        margin-bottom: var(--space-xl);
        color: var(--color-text-secondary);
      }

      /* Countdown timer */
      .countdown-timer {
        font-family: var(--font-code);
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wider);
        margin-bottom: var(--space-2xl);
        padding: var(--space-md) var(--space-lg);
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        display: inline-block;
        border-radius: 4px;
      }

      .countdown-seconds {
        font-weight: bold;
        color: var(--color-red);
      }


      .success-details {
        background: var(--color-surface);
        border: 2px solid var(--color-border);
        padding: var(--space-xl);
        margin: var(--space-2xl) 0;
        text-align: left;
      }

      .success-details h3 {
        font-family: var(--font-display);
        font-size: var(--font-size-xl);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--space-lg);
        color: var(--color-text-primary);
      }

      .success-details p {
        font-family: var(--font-sans);
        font-size: var(--font-size-base);
        line-height: 1.6;
        margin-bottom: var(--space-md);
        color: var(--color-text-primary);
      }

      .success-details p:last-child {
        margin-bottom: 0;
      }

      .success-actions {
        display: flex;
        gap: var(--space-lg);
        justify-content: center;
        flex-wrap: wrap;
        margin-top: var(--space-2xl);
      }

      /* Match site button styles */
      .success-btn {
        display: inline-block;
        padding: var(--space-md) var(--space-2xl);
        border: 2px solid var(--color-black);
        background: var(--color-black);
        color: var(--color-white);
        font-family: var(--font-display);
        font-size: var(--font-size-base);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wider);
        text-decoration: none;
        transition: all var(--transition-base);
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .success-btn:hover {
        background: var(--color-white);
        color: var(--color-black);
        transform: translateY(-2px);
      }

      .success-btn.secondary {
        background: var(--color-white);
        color: var(--color-black);
      }

      .success-btn.secondary:hover {
        background: var(--color-black);
        color: var(--color-white);
      }

      /* Red accent button */
      .success-btn.accent {
        background: var(--color-red);
        border-color: var(--color-red);
        color: var(--color-white);
      }

      .success-btn.accent:hover {
        background: var(--color-white);
        color: var(--color-red);
      }

      /* Registration section styling */
      .ticket-field-group {
        background: var(--color-background, #fff);
        border: 1px solid var(--color-border, #e0e0e0);
        border-radius: 8px;
        padding: var(--space-lg);
        margin-bottom: var(--space-lg);
      }

      .ticket-field-group h4 {
        color: var(--color-primary, #5b6bb5);
        margin-bottom: var(--space-md);
        font-size: var(--font-size-lg);
      }

      .form-group {
        margin-bottom: var(--space-md);
      }

      .form-group label {
        display: block;
        color: var(--color-text-primary);
        font-weight: 600;
        margin-bottom: var(--space-xs);
      }

      .form-group input {
        width: 100%;
        padding: var(--space-sm) var(--space-md);
        border: 1px solid var(--color-border, #ccc);
        border-radius: 4px;
        font-size: var(--font-size-base);
        background: var(--color-background);
        color: var(--color-text-primary);
      }

      .form-group input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(91, 107, 181, 0.1);
      }

      .form-group input[readonly] {
        background: var(--color-gray-light, #f5f5f5);
        color: var(--color-text-secondary);
      }
      /* Registration-related styles removed - handled on separate page */

      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      /* Registration button styles removed */

      .loading-state {
        display: none;
      }

      .error-state {
        display: none;
        text-align: center;
        padding: var(--space-2xl);
      }

      .error-state .error-title {
        font-family: var(--font-display);
        font-size: var(--font-size-2xl);
        color: var(--color-red);
        text-transform: uppercase;
        margin-bottom: var(--space-lg);
      }

      @media (max-width: 640px) {
        .success-container {
          padding: var(--space-xl) var(--space-lg);
        }

        .success-title {
          font-size: var(--font-size-3xl);
        }

        .success-message {
          font-size: var(--font-size-base);
        }

        .countdown-timer {
          font-size: var(--font-size-xs);
          padding: var(--space-sm) var(--space-md);
        }


        .success-actions {
          flex-direction: column;
          width: 100%;
        }

        .success-btn {
          width: 100%;
          text-align: center;
        }
      }
    </style>
  </head>
  <body class="typographic">
    <header class="header">
      <div class="container">
        <div class="grid">
          <div class="header-left">
            <a href="/home" class="logo-link" aria-label="Go to home page">
              <img
                src="/images/logo.png"
                alt="A Lo Cubano Boulder Fest Logo"
                class="site-logo"
                data-light-src="/images/logo.png"
                data-dark-src="/images/logo-dark.png"
              />
              <div class="logo-text">
                <span class="logo-main">A LO CUBANO</span>
                <span class="logo-separator">|</span>
                <span class="logo-sub">Boulder Fest</span>
              </div>
            </a>
          </div>
          <nav class="main-nav">
            <button
              class="menu-toggle"
              aria-label="Toggle menu"
              aria-expanded="false"
              aria-controls="main-navigation"
            >
              <div class="menu-icon">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </button>
            <ul class="nav-list" id="main-navigation">
              <li>
                <a href="/home" class="nav-link" data-text="Home">Home</a>
              </li>
              <li>
                <a href="/about" class="nav-link" data-text="About">About</a>
              </li>
              <li class="nav-item has-dropdown">
                <button
                  class="nav-trigger"
                  aria-expanded="false"
                  aria-haspopup="true"
                  data-dropdown="events"
                  data-text="Events"
                >
                  Events
                  <span class="dropdown-arrow" aria-hidden="true">▼</span>
                </button>
                <ul
                  class="dropdown-menu"
                  aria-hidden="true"
                  role="menu"
                  data-dropdown-content="events"
                >
                  <li class="dropdown-category" role="group">
                    <span class="dropdown-category-title" role="presentation"
                      >Boulder Fest</span
                    >
                    <ul class="dropdown-submenu">
                      <li>
                        <a
                          href="/boulder-fest-2026"
                          class="dropdown-link"
                          role="menuitem"
                          data-event="boulder-fest-2026"
                          data-event-status="upcoming"
                          >2026 Festival</a
                        >
                      </li>
                      <li>
                        <a
                          href="/boulder-fest-2025"
                          class="dropdown-link"
                          role="menuitem"
                          data-event="boulder-fest-2025"
                          data-event-status="current"
                          >2025 Festival</a
                        >
                      </li>
                    </ul>
                  </li>
                </ul>
              </li>
              <li>
                <a href="/tickets" class="nav-link" data-text="Tickets"
                  >Tickets</a
                >
              </li>
              <li>
                <a href="/donations" class="nav-link" data-text="Donate"
                  >Donate</a
                >
              </li>
              <li>
                <a href="/contact" class="nav-link" data-text="Contact"
                  >Contact</a
                >
              </li>
              <li class="nav-cart-item">
                <button class="nav-cart-button" aria-label="View cart" data-testid="view-cart">
                  <svg class="nav-cart-icon" viewBox="0 0 24 24" width="20" height="20">
                    <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                  </svg>
                  <span class="nav-cart-badge" style="display: none;" data-testid="cart-counter">0</span>
                </button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </header>

    <main>
      <!-- Loading State -->
      <div class="loading-state">
        <div
          class="checkout-loading"
          style="position: relative; background: transparent"
        >
          <div class="checkout-loading-content">
            <div class="checkout-spinner"></div>
            <div class="checkout-loading-text">Verifying Payment</div>
            <div class="checkout-loading-subtext">
              Please wait while we confirm your transaction...
            </div>
          </div>
        </div>
      </div>

      <!-- Success State -->
      <section class="success-container" style="display: none">
        <div class="success-content">
          <div class="success-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              />
            </svg>
          </div>

          <h1 class="success-title">Payment Successful!</h1>

          <p class="success-message" id="main-message">
            Thank you for your purchase! We're excited to see you at A Lo Cubano
            Boulder Fest.
          </p>

          <div class="countdown-timer" id="countdown-timer" style="display: none;">
            Redirecting to registration in <span class="countdown-seconds" id="countdown-seconds">20</span> seconds...
          </div>

          <!-- Register Now button moved here for better visibility -->
          <div style="margin-bottom: var(--space-xl); display: none;" id="register-now-container">
            <a href="#" id="register-now-btn" class="success-btn accent">Register Now</a>
          </div>

          <!-- Wallet Download Section -->
          <div id="wallet-download-section" style="display: none; margin: var(--space-2xl) 0;">
            <div class="success-details">
              <h3>Add Tickets to Your Wallet</h3>
              <p>Get quick access to your tickets by adding them to your phone's wallet app.</p>
              <div id="wallet-buttons-container" class="success-wallet-container"></div>
            </div>
          </div>


          <div class="success-details" id="order-details" style="display: none">
            <h3>Order Details</h3>
            <p><strong>Order ID:</strong> <span id="order-id"></span></p>
            <p><strong>Amount:</strong> $<span id="order-amount"></span></p>
            <p><strong>Email:</strong> <span id="order-email"></span></p>
          </div>

          <div class="success-details" id="next-steps">
            <h3>Next Steps</h3>
            <div id="steps-content">
              <p>• Check your email for order confirmation</p>
              <p>• Save your order confirmation number</p>
              <p>• Contact us if you have any questions</p>
            </div>
          </div>

          <!-- Registration will be handled on separate page -->

          <div class="success-actions">
            <a href="/home" class="success-btn">Return to Home</a>
            <a href="/tickets" class="success-btn secondary"
              >Purchase More Tickets</a
            >
          </div>
        </div>
      </section>

      <!-- Error State -->
      <section class="error-state">
        <h2 class="error-title">Unable to Verify Payment</h2>
        <p>We couldn't verify your payment status. This might be temporary.</p>
        <p>
          Please check your email for confirmation or contact us at
          <a href="mailto:alocubanoboulderfest@gmail.com"
            >alocubanoboulderfest@gmail.com</a
          >
        </p>
        <div class="success-actions">
          <a href="/home" class="success-btn">Return to Home</a>
          <a href="/tickets" class="success-btn secondary">Try Again</a>
        </div>
      </section>
    </main>

    <footer class="footer-typographic">
      <div class="container">
        <p class="footer-credits">
          MAY 15-17, 2026 •
          <a
            href="mailto:alocubanoboulderfest@gmail.com?subject=A Lo Cubano Boulder Fest Inquiry"
            style="color: inherit; text-decoration: underline"
            >alocubanoboulderfest@gmail.com</a
          >
        </p>
        <div class="footer-social">
          <a
            href="https://www.instagram.com/alocubano.boulderfest/"
            target="_blank"
            rel="noopener noreferrer"
            class="social-link-type"
            aria-label="Follow us on Instagram"
          >
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
              <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
              <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
            </svg>
          </a>
          <a
            href="https://chat.whatsapp.com/KadIVdb24RWKdIKGtipnLH"
            target="_blank"
            rel="noopener noreferrer"
            class="social-link-type"
            aria-label="Join us on WhatsApp"
          >
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"
              ></path>
            </svg>
          </a>
        </div>
        <div id="theme-toggle-container" class="footer-theme-toggle"></div>
      </div>
    </footer>

    <script>
      // Get URL parameters for both Stripe and PayPal
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get("session_id"); // Stripe
      const token = urlParams.get("token"); // PayPal
      const payerId = urlParams.get("PayerID"); // PayPal
      const testMode = urlParams.get("test_mode") === "true";

      // Elements
      const loadingState = document.querySelector(".loading-state");
      const successContainer = document.querySelector(".success-container");
      const errorState = document.querySelector(".error-state");
      const mainMessage = document.getElementById("main-message");
      const orderDetails = document.getElementById("order-details");
      const orderId = document.getElementById("order-id");
      const orderAmount = document.getElementById("order-amount");
      const orderEmail = document.getElementById("order-email");
      const nextSteps = document.getElementById("next-steps");
      const stepsContent = document.getElementById("steps-content");
      const countdownTimer = document.getElementById("countdown-timer");
      const countdownSeconds = document.getElementById("countdown-seconds");
      const registerNowBtn = document.getElementById("register-now-btn");
      const registerNowContainer = document.getElementById("register-now-container");

      // Countdown timer variables
      let countdownInterval;
      let remainingSeconds = 20;
      let registrationUrl = null;

      // Start countdown timer
      function startCountdown() {
        // Show countdown timer
        if (countdownTimer) {
          countdownTimer.style.display = 'inline-block';
        }

        countdownInterval = setInterval(() => {
          remainingSeconds--;
          if (countdownSeconds) {
            countdownSeconds.textContent = remainingSeconds;
          }

          if (remainingSeconds <= 0) {
            clearInterval(countdownInterval);
            // Use registrationUrl if available, otherwise fallback to home
            const redirectUrl = registrationUrl || '/home';
            window.location.href = redirectUrl;
          }
        }, 1000);
      }

      // Stop countdown timer
      function stopCountdown() {
        if (countdownInterval) {
          clearInterval(countdownInterval);
        }
        if (countdownTimer) {
          countdownTimer.style.display = 'none';
        }
      }

      // Handle register now button click
      function handleRegisterNow(event) {
        event.preventDefault(); // Prevent default link behavior
        if (registrationUrl) {
          stopCountdown();
          window.location.href = registrationUrl;
        }
      }

      // Detect payment method
      function detectPaymentMethod() {
        if (sessionId && sessionId.startsWith('cs_')) {
          return 'stripe';
        } else if (token && payerId) {
          return 'paypal';
        }
        return null;
      }

      // Update loading message based on payment method
      function updateLoadingMessage(paymentMethod) {
        const loadingText = document.querySelector('.checkout-loading-text');
        const loadingSubtext = document.querySelector('.checkout-loading-subtext');

        if (paymentMethod === 'paypal') {
          if (loadingText) loadingText.textContent = 'Processing PayPal Payment';
          if (loadingSubtext) loadingSubtext.textContent = 'Please wait while we capture your PayPal transaction...';
        } else if (paymentMethod === 'stripe') {
          if (loadingText) loadingText.textContent = 'Verifying Payment';
          if (loadingSubtext) loadingSubtext.textContent = 'Please wait while we confirm your transaction...';
        }
      }


      // Verify Stripe payment
      async function verifyStripePayment() {
        try {
          const response = await fetch(
            `/api/payments/checkout-success?session_id=${sessionId}`,
          );
          const data = await response.json();

          // Debug logging to see what we're receiving from the backend
          console.log('Response from checkout-success:', {
            orderNumber: data.orderNumber,
            transactionOrderNumber: data.transaction?.orderNumber,
            sessionId: data.session?.id,
            hasTickets: data.hasTickets,
            registrationToken: data.registrationToken,
            registrationUrl: data.registrationUrl
          });
          console.log('Full response data:', data);

          if (response.ok && data.success) {
            // Transform Stripe data to unified format
            const unifiedData = {
              success: true,
              paymentMethod: 'stripe',
              orderNumber: data.orderNumber,  // Pass through the clean order number
              transaction: data.transaction,    // Pass through transaction data
              session: data.session,
              hasTickets: data.hasTickets,  // CRITICAL: Pass through for registration
              registrationToken: data.registrationToken,  // CRITICAL: Pass through for registration
              registrationUrl: data.registrationUrl,  // CRITICAL: Pass through for registration
              order: {
                id: data.orderNumber || data.session.id,  // Use orderNumber if available
                totalAmount: data.session.amount,
                customerEmail: data.session.customer_email
              },
              instructions: {
                clearCart: true,
                nextSteps: [
                  'Check your email for order confirmation',
                  'Complete your festival registration (link in email)',
                  'Save your confirmation number for check-in',
                  'Join our WhatsApp group for updates'
                ]
              },
              message: 'Payment successful! Thank you for your purchase.',
              testMode: testMode
            };

            showSuccess(unifiedData);
            return true;
          } else {
            return false;
          }
        } catch (error) {
          console.error("Error verifying Stripe payment:", error);
          return false;
        }
      }

      // Capture and verify PayPal payment
      async function capturePayPalPayment() {
        try {
          // First capture the PayPal order
          const captureResponse = await fetch('/api/payments/paypal/capture-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              orderId: token
            })
          });

          const captureData = await captureResponse.json();

          if (captureResponse.ok && captureData.success) {
            // Transform PayPal data to unified format
            const unifiedData = {
              success: true,
              paymentMethod: 'paypal',
              order: {
                id: captureData.orderId,
                totalAmount: captureData.amount,
                customerEmail: captureData.payer?.email
              },
              paypal: {
                orderId: captureData.orderId,
                captureId: captureData.captureId,
                payer: captureData.payer
              },
              instructions: captureData.instructions,
              message: captureData.message,
              testMode: captureData.testMode || testMode
            };

            showSuccess(unifiedData);
            return true;
          } else {
            console.error('PayPal capture failed:', captureData);
            return false;
          }
        } catch (error) {
          console.error("Error capturing PayPal payment:", error);
          return false;
        }
      }

      // Main payment verification function
      async function verifyPayment() {
        const paymentMethod = detectPaymentMethod();

        if (!paymentMethod) {
          showError({ error: 'No payment method detected' });
          return;
        }

        // Update loading message based on payment method
        updateLoadingMessage(paymentMethod);

        let success = false;

        if (paymentMethod === 'stripe') {
          success = await verifyStripePayment();
        } else if (paymentMethod === 'paypal') {
          success = await capturePayPalPayment();
        }

        if (!success) {
          showError({ paymentMethod });
        }
      }

      function showSuccess(data) {
        loadingState.style.display = "none";
        successContainer.style.display = "flex";

        // Update main message with payment method context
        let successMessage = data.message || 'Payment successful! Thank you for your purchase.';
        if (data.paymentMethod === 'paypal') {
          successMessage = `PayPal payment successful! Thank you for your purchase. Your transaction has been completed securely through PayPal.`;
        } else if (data.paymentMethod === 'stripe') {
          successMessage = `Credit card payment successful! Thank you for your purchase. Your transaction has been processed securely.`;
        }

        if (mainMessage) {
          mainMessage.textContent = successMessage;
        }

        // Announce success to screen readers
        announceToScreenReader(`Payment completed successfully. ${successMessage}`);

        // Show order details if available
        if (data.order || data.session || data.transaction) {
          orderDetails.style.display = "block";

          // Use the proper order number if available, otherwise fall back to session ID
          console.log('Order data received:', {
            orderNumber: data.orderNumber,
            transaction: data.transaction,
            order: data.order,
            session: data.session
          });

          // ALWAYS use order number - it should always be present
          let displayId = data.orderNumber || data.transaction?.orderNumber || '';

          if (!displayId) {
            console.error('ERROR: No order number received from backend!', {
              orderNumber: data.orderNumber,
              transactionOrderNumber: data.transaction?.orderNumber,
              sessionId: data.session?.id
            });
            displayId = 'PENDING'; // Show PENDING if no order number
          } else {
            console.log('Displaying order number:', displayId);
          }

          if (orderId) {
            orderId.textContent = displayId;
          }

          // Update amount
          if (data.transaction?.totalAmount !== undefined) {
            // Convert cents to dollars if needed
            const amount = data.transaction.totalAmount > 1000
              ? data.transaction.totalAmount / 100
              : data.transaction.totalAmount;
            orderAmount.textContent = amount.toFixed(2);
          } else if (data.order?.totalAmount !== undefined) {
            orderAmount.textContent = data.order.totalAmount.toFixed(2);
          } else if (data.session?.amount !== undefined) {
            orderAmount.textContent = data.session.amount.toFixed(2);
          }

          // Update email
          if (data.transaction?.customerEmail) {
            orderEmail.textContent = data.transaction.customerEmail;
          } else if (data.order?.customerEmail) {
            orderEmail.textContent = data.order.customerEmail;
          } else if (data.session?.customer_email) {
            orderEmail.textContent = data.session.customer_email;
          }
        }

        // Check if this is a ticket purchase (multiple ways to detect)
        const isTicketPurchase = data.hasTickets ||
                                data.order?.orderType === "tickets" ||
                                hasTickets(data.order?.items) ||
                                data.registrationUrl ||
                                data.registrationToken;

        // Extract and cache QR tokens for quick access
        if (isTicketPurchase && data.qrTokens) {
          // Preload first QR code immediately for quick access
          if (data.qrTokens.length > 0) {
            window.qrCacheManager.preloadQRCode(data.qrTokens[0]);
          }
        }

        // Debug logging for ticket purchase detection
        console.log('Ticket purchase detection:', {
          isTicketPurchase,
          hasTickets: data.hasTickets,
          orderType: data.order?.orderType,
          hasTicketsInItems: hasTickets(data.order?.items),
          hasRegistrationUrl: !!data.registrationUrl,
          hasRegistrationToken: !!data.registrationToken
        });

        // Handle registration for ticket purchases
        if (isTicketPurchase) {
          // Set registration URL - use provided URL or fallback to registration page
          if (data.registrationUrl) {
            registrationUrl = data.registrationUrl;
          } else if (data.registrationToken) {
            // Use the expected query parameter format
            registrationUrl = `/register-tickets?token=${data.registrationToken}`;
          } else {
            // Fallback to basic registration page
            registrationUrl = '/register-tickets';
          }

          console.log('Using registration URL:', registrationUrl);

          // Show register now button with its container
          if (registerNowBtn && registerNowContainer) {
            registerNowBtn.href = registrationUrl;
            registerNowContainer.style.display = 'block';
            registerNowBtn.addEventListener('click', handleRegisterNow);
          }

          // Show wallet download section for ticket purchases
          showWalletDownloadSection(data);

          // Update next steps for ticket purchases
          stepsContent.textContent = "";
          const steps = [
            "• Complete your festival registration using the link below",
            "• Add your tickets to your phone's wallet app",
            "• Check your email for order confirmation",
            "• Save your confirmation number for check-in",
            "• Join our WhatsApp group for updates",
          ];
          steps.forEach((step) => {
            const p = document.createElement("p");
            p.textContent = step;
            stepsContent.appendChild(p);
          });

          // Start countdown timer - now always starts for ticket purchases
          startCountdown();
        } else if (data.instructions?.nextSteps) {
          // Handle normal next steps without immediate registration
          stepsContent.textContent = "";
          data.instructions.nextSteps.forEach((step) => {
            const p = document.createElement("p");
            p.textContent = `• ${step}`;
            stepsContent.appendChild(p);
          });
        } else {
          // Default steps for all other purchases
          stepsContent.textContent = "";
          const steps = [
            "• Check your email for order confirmation",
            "• Save your confirmation number for your records",
            "• Contact us if you have any questions",
          ];
          steps.forEach((step) => {
            const p = document.createElement("p");
            p.textContent = step;
            stepsContent.appendChild(p);
          });
        }

        // Show test mode indicator if applicable
        if (data.testMode) {
          const testModeIndicator = document.createElement("div");
          testModeIndicator.className = "test-mode-indicator";
          testModeIndicator.style.cssText = `
            background: var(--color-danger, #ff6b6b);
            color: var(--color-text-on-danger, white);
            padding: 8px 16px;
            border-radius: 4px;
            margin: 16px 0;
            font-weight: bold;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 14px;
          `;
          testModeIndicator.textContent = "🧪 TEST MODE - This was a test transaction";

          // Insert after main message
          mainMessage.parentNode.insertBefore(testModeIndicator, mainMessage.nextSibling);
        }

        // Clear the cart as instructed by the API
        if (data.instructions?.clearCart) {
          localStorage.removeItem("alocubano_cart");
          // Dispatch storage event for cross-tab sync
          window.dispatchEvent(
            new StorageEvent("storage", {
              key: "alocubano_cart",
              oldValue: localStorage.getItem("alocubano_cart"),
              newValue: null,
              url: window.location.href,
              storageArea: localStorage,
            }),
          );
          // Dispatch custom event
          window.dispatchEvent(new Event("cartCleared"));
        }

      }

      function hasTickets(items) {
        if (!items || !Array.isArray(items)) return false;
        return items.some(
          (item) =>
            item.type === "ticket" ||
            item.name?.toLowerCase().includes("ticket") ||
            item.name?.toLowerCase().includes("pass"),
        );
      }

      function showError(errorData = null) {
        loadingState.style.display = "none";
        successContainer.style.display = "none";
        errorState.style.display = "block";

        // Update error message based on payment method or error data
        const errorTitle = document.querySelector('.error-title');
        const errorStateDiv = document.querySelector('.error-state');

        let errorMessage = 'Unable to verify payment';
        if (errorData && errorData.paymentMethod) {
          if (errorData.paymentMethod === 'paypal') {
            errorMessage = 'PayPal Payment Issue';
            if (errorTitle) {
              errorTitle.textContent = errorMessage;
            }
            // Add PayPal-specific error message
            const paypalErrorMsg = document.createElement('p');
            paypalErrorMsg.textContent = 'There was an issue processing your PayPal payment. Please check your PayPal account or contact us for assistance.';
            paypalErrorMsg.setAttribute('role', 'alert');
            paypalErrorMsg.setAttribute('aria-live', 'assertive');
            errorStateDiv.insertBefore(paypalErrorMsg, errorStateDiv.querySelector('.success-actions'));
          } else if (errorData.paymentMethod === 'stripe') {
            errorMessage = 'Payment Verification Issue';
            if (errorTitle) {
              errorTitle.textContent = errorMessage;
            }
          }
        }

        // Announce error to screen readers
        announceToScreenReader(`Error: ${errorMessage}. Please contact support if you need assistance.`);

        // Focus the error section for screen readers
        if (errorTitle) {
          errorTitle.setAttribute('tabindex', '-1');
          setTimeout(() => errorTitle.focus(), 100);
        }
      }

      // Utility function to announce messages to screen readers
      function announceToScreenReader(message) {
        // Create or update ARIA live region for announcements
        let announcer = document.getElementById('sr-announcer');
        if (!announcer) {
          announcer = document.createElement('div');
          announcer.id = 'sr-announcer';
          announcer.setAttribute('aria-live', 'polite');
          announcer.setAttribute('aria-atomic', 'true');
          announcer.style.position = 'absolute';
          announcer.style.left = '-10000px';
          announcer.style.width = '1px';
          announcer.style.height = '1px';
          announcer.style.overflow = 'hidden';
          document.body.appendChild(announcer);
        }

        // Update the message
        announcer.textContent = message;
      }

      // Show wallet download section for ticket purchases
      function showWalletDownloadSection(data) {
        const walletSection = document.getElementById('wallet-download-section');
        const walletButtonsContainer = document.getElementById('wallet-buttons-container');

        if (!walletSection || !walletButtonsContainer) return;

        // Extract ticket IDs from transaction data
        const ticketIds = getTicketIdsFromTransactionData(data);

        if (ticketIds.length > 0) {
          walletButtonsContainer.innerHTML = '';

          // Create lazy-loaded wallet containers for each ticket
          ticketIds.forEach((ticketId, index) => {
            const walletContainer = document.createElement('div');
            walletContainer.className = 'wallet-lazy-container success-wallet-item';
            walletContainer.style.marginBottom = 'var(--space-md)';

            // Initialize lazy loading for this ticket
            window.walletLazyLoader.observeWalletContainer(walletContainer, ticketId, {
              title: ticketIds.length > 1 ? `Ticket ${index + 1}` : 'Your Ticket',
              size: 'default',
              showBothOnDesktop: true,
              className: 'wallet-buttons-success-page'
            });

            walletButtonsContainer.appendChild(walletContainer);
          });

          // Show the section
          walletSection.style.display = 'block';

          // Preload QR codes for these tickets
          if (data.qrTokens && Array.isArray(data.qrTokens)) {
            data.qrTokens.forEach(token => {
              window.qrCacheManager.preloadQRCode(token);
            });
          }
        }
      }

      // Extract ticket IDs from various transaction data formats
      function getTicketIdsFromTransactionData(data) {
        const ticketIds = [];

        // Try to get ticket IDs from different possible locations in the response
        if (data.ticketIds && Array.isArray(data.ticketIds)) {
          ticketIds.push(...data.ticketIds);
        } else if (data.tickets && Array.isArray(data.tickets)) {
          data.tickets.forEach(ticket => {
            if (ticket.id) ticketIds.push(ticket.id);
            else if (ticket.ticketId) ticketIds.push(ticket.ticketId);
            else if (ticket.ticket_id) ticketIds.push(ticket.ticket_id);
          });
        } else if (data.transaction && data.transaction.tickets) {
          data.transaction.tickets.forEach(ticket => {
            if (ticket.id) ticketIds.push(ticket.id);
            else if (ticket.ticketId) ticketIds.push(ticket.ticketId);
            else if (ticket.ticket_id) ticketIds.push(ticket.ticket_id);
          });
        }

        // If no specific ticket IDs found, generate placeholder IDs for the order
        if (ticketIds.length === 0 && data.orderNumber) {
          // This is a fallback - in practice, the backend should provide actual ticket IDs
          console.warn('No specific ticket IDs found, using order-based placeholder');
          // For now, we'll create a placeholder - ideally the backend would provide ticket IDs
          ticketIds.push(`${data.orderNumber}-001`);
        }

        return ticketIds.filter(id => id); // Remove any undefined/null values
      }

      // Start verification when page loads
      verifyPayment();

      // populateRegistrationForm function removed - registration handled on separate page

      // Registration form submission handling removed - handled on separate page
    </script>

    <script src="/js/navigation.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/typography.js"></script>
    <!-- Wallet buttons loaded lazily via wallet-lazy-loader -->

    <!-- Cart system not needed on success page - cart is cleared after payment -->
    
    <!-- PayPal SDK (conditionally loaded) -->
    <script id="paypal-sdk-script">
      // Conditionally load PayPal SDK if PayPal payment is detected
      (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const isPayPalPayment = urlParams.get("token") && urlParams.get("PayerID");

        if (isPayPalPayment) {
          // Determine environment
          const isTestMode = urlParams.get("test_mode") === "true" ||
                           window.location.hostname === "localhost" ||
                           window.location.hostname.includes("vercel.app");

          // Get client ID based on environment
          const clientId = isTestMode ?
            'demo' : // This should be replaced with actual sandbox client ID for testing
            'production-client-id'; // This should be replaced with actual production client ID

          // Only load SDK if needed for enhanced PayPal integration features
          // For basic capture, we don't need the SDK as we're using server-side capture
          console.log('PayPal payment detected, test mode:', isTestMode);
        }
      })();
    </script>

    <!-- Theme Management -->
    <script type="module">
      import { initializeThemeToggle } from '/js/theme-toggle.js';
      import themeManager from '/js/theme-manager.js';

      // Initialize theme system
      document.addEventListener('DOMContentLoaded', () => {
        themeManager.initializeTheme();
        initializeThemeToggle('#theme-toggle-container');
      });
    </script>
    <script src="/js/logo-switcher.js"></script>
  </body>
</html>
