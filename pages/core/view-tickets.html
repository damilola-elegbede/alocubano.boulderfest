<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Inline theme detection to prevent FOUC -->
    <script>
      (function() {
        // Detect admin pages
        const path = window.location.pathname.toLowerCase();
        const isAdmin = path.includes('/admin') || path.includes('pages/admin');

        if (isAdmin) {
          // Admin pages always use dark theme
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          // Main site: check user preference
          let stored = null;
          try {
            stored = localStorage.getItem('theme-preference');
          } catch {
            // localStorage might be disabled
          }

          const preference = stored || 'system';
          let theme = preference;

          if (preference === 'system') {
            // Detect system preference
            theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
              ? 'dark'
              : 'light';
          }

          document.documentElement.setAttribute('data-theme', theme);
        }
      })();
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Tickets - A Lo Cubano Boulder Fest</title>
    <meta
      name="description"
      content="View your registered tickets for A Lo Cubano Boulder Fest 2026"
    />
    <link rel="icon" type="image/png" href="/images/favicon.png" />

    <!-- Core Styles -->
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/typography.css" />
    <link rel="stylesheet" href="/css/header.css" />
    <link rel="stylesheet" href="/css/footer.css" />
    <link rel="stylesheet" href="/css/forms.css" />
    <link rel="stylesheet" href="/css/register.css" />
    <link rel="stylesheet" href="/css/theme-toggle.css" />

    <style>
      .view-tickets-container {
        max-width: 960px;
        margin: 0 auto;
        padding: var(--space-2xl) var(--space-lg);
      }

      .tickets-header {
        text-align: center;
        margin-bottom: var(--space-2xl);
        padding-bottom: var(--space-xl);
        border-bottom: 2px solid var(--color-border);
      }

      .tickets-header h1 {
        font-family: var(--font-display);
        font-size: var(--text-4xl);
        color: var(--color-primary);
        margin-bottom: var(--space-md);
      }

      .event-info {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: var(--space-lg);
        margin-top: var(--space-lg);
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
      }

      .event-info span {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
      }

      .ticket-card {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: 12px;
        padding: var(--space-xl);
        margin-bottom: var(--space-xl);
        position: relative;
        overflow: hidden;
      }

      .ticket-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--color-success);
      }

      .ticket-header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-lg);
      }

      .ticket-type {
        font-family: var(--font-display);
        font-size: var(--text-2xl);
        color: var(--color-text-primary);
      }

      .ticket-id {
        font-family: var(--font-mono);
        font-size: var(--text-xs);
        color: var(--color-text-secondary);
        margin-top: var(--space-xs);
      }

      .ticket-status-badge {
        padding: var(--space-xs) var(--space-md);
        border-radius: 20px;
        font-family: var(--font-mono);
        font-size: var(--text-xs);
        font-weight: 600;
        text-transform: uppercase;
        background: var(--color-success-light);
        color: var(--color-success-700);
        border: 1px solid var(--color-success);
      }

      .attendee-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-lg);
        margin-bottom: var(--space-xl);
      }

      .info-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
      }

      .info-label {
        font-family: var(--font-mono);
        font-size: var(--text-xs);
        color: var(--color-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .info-value {
        font-family: var(--font-body);
        font-size: var(--text-base);
        color: var(--color-text-primary);
        font-weight: 500;
      }

      .wallet-section {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-md);
        padding-top: var(--space-lg);
        border-top: 1px solid var(--color-border);
      }

      .wallet-button {
        flex: 1;
        min-width: 200px;
        padding: var(--space-md) var(--space-lg);
        border-radius: 8px;
        text-align: center;
        text-decoration: none;
        font-family: var(--font-body);
        font-size: var(--text-sm);
        font-weight: 600;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
      }

      .wallet-button.apple {
        background: #000;
        color: #fff;
        border: 1px solid #000;
      }

      .wallet-button.apple:hover {
        background: #333;
        border-color: #333;
      }

      .wallet-button.google {
        background: #4285f4;
        color: #fff;
        border: 1px solid #4285f4;
      }

      .wallet-button.google:hover {
        background: #357ae8;
        border-color: #357ae8;
      }

      .loading-state {
        text-align: center;
        padding: var(--space-3xl);
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--color-border-light);
        border-top: 4px solid var(--color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto var(--space-md);
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .error-state {
        background: var(--color-error-light);
        border: 1px solid var(--color-error);
        border-radius: 8px;
        padding: var(--space-xl);
        text-align: center;
        color: var(--color-error);
        margin: var(--space-2xl) 0;
      }

      .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-md);
        justify-content: center;
        margin-top: var(--space-2xl);
        padding-top: var(--space-xl);
        border-top: 2px solid var(--color-border);
      }

      .button-type {
        padding: var(--space-md) var(--space-xl);
        border-radius: 8px;
        font-family: var(--font-body);
        font-size: var(--text-base);
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
        border: 2px solid transparent;
      }

      .button-type-primary {
        background: var(--color-primary);
        color: var(--color-white);
      }

      .button-type-primary:hover {
        background: var(--color-primary-dark);
        transform: translateY(-2px);
      }

      .button-type-secondary {
        background: transparent;
        color: var(--color-primary);
        border-color: var(--color-primary);
      }

      .button-type-secondary:hover {
        background: var(--color-primary);
        color: var(--color-white);
      }

      /* Dark mode adjustments */
      [data-theme="dark"] .ticket-card {
        background: var(--color-surface-dark);
        border-color: var(--color-border-dark);
      }

      [data-theme="dark"] .ticket-status-badge {
        background: var(--color-success-dark);
        color: var(--color-white);
        border-color: var(--color-success);
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .view-tickets-container {
          padding: var(--space-lg) var(--space-md);
        }

        .tickets-header h1 {
          font-size: var(--text-3xl);
        }

        .event-info {
          flex-direction: column;
          align-items: center;
        }

        .ticket-header-row {
          flex-direction: column;
          gap: var(--space-md);
        }

        .wallet-section {
          flex-direction: column;
        }

        .wallet-button {
          min-width: 100%;
        }
      }
    </style>

    <!-- Theme Manager -->
    <script src="/js/theme-manager.js"></script>
    <script type="module">
      import timeManager from '/js/time-manager.js';
      window.timeManager = timeManager; // Make available globally for the main script
    </script>
  </head>
  <body>
    <!-- Main Header -->
    <header class="main-header">
      <div class="container">
        <div class="header-content-type">
          <a href="/" class="logo">
            <img
              src="/images/logo.png"
              alt="A Lo Cubano Boulder Fest"
              width="120"
              height="60"
            />
          </a>
          <nav class="main-nav" id="main-nav">
            <ul>
              <li><a href="/">Home</a></li>
              <li><a href="/about">About</a></li>
              <li><a href="/artists">Artists</a></li>
              <li><a href="/schedule">Schedule</a></li>
              <li><a href="/tickets">Tickets</a></li>
              <li><a href="/gallery">Gallery</a></li>
            </ul>
          </nav>
          <button class="mobile-menu-toggle" id="mobile-menu-toggle">
            <span></span>
            <span></span>
            <span></span>
          </button>
          <a href="/tickets" class="header-cta-type">Get Tickets</a>
        </div>
      </div>
    </header>

    <main>
      <div class="view-tickets-container">
        <!-- Loading State -->
        <div id="loading-state" class="loading-state">
          <div class="spinner"></div>
          <p>Loading your tickets...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="error-state" style="display: none;">
          <h2>Unable to Load Tickets</h2>
          <p id="error-message"></p>
          <button id="retry-button" class="button-type button-type-primary">Try Again</button>
        </div>

        <!-- Tickets Display -->
        <div id="tickets-content" style="display: none;">
          <div class="tickets-header">
            <h1>Your Tickets</h1>
            <p>All tickets for A Lo Cubano Boulder Fest 2026</p>
            <div class="event-info">
              <span>📅 May 15-17, 2026 (Mountain Time)</span>
              <span>📍 Avalon Ballroom, Boulder, CO</span>
              <span>🎟️ <span id="total-tickets">0</span> Tickets</span>
            </div>
          </div>

          <div id="tickets-list">
            <!-- Tickets will be dynamically inserted here -->
          </div>

          <div class="action-buttons">
            <a href="/" class="button-type button-type-primary">Return to Home</a>
            <a href="/tickets" class="button-type button-type-secondary">Purchase More Tickets</a>
          </div>
        </div>
      </div>
    </main>

    <footer class="footer-typographic">
      <div class="container">
        <p class="footer-credits">
          MAY 15-17, 2026 (MT) •
          <a
            href="mailto:alocubanoboulderfest@gmail.com?subject=A Lo Cubano Boulder Fest Inquiry"
            style="color: inherit; text-decoration: underline"
            >alocubanoboulderfest@gmail.com</a
          >
        </p>
        <div class="footer-social">
          <a
            href="https://www.instagram.com/alocubano.boulderfest/"
            target="_blank"
            rel="noopener noreferrer"
            class="social-link-type"
            aria-label="Follow us on Instagram"
          >
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
              <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
              <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
            </svg>
          </a>
          <a
            href="https://chat.whatsapp.com/KadIVdb24RWKdIKGtipnLH"
            target="_blank"
            rel="noopener noreferrer"
            class="social-link-type"
            aria-label="Join us on WhatsApp"
          >
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M21 11.5a8.5 8.5 0 1 1-17 0 8.5 8.5 0 0 1 17 0z"
              ></path>
              <path
                d="M12.5 11.5c0 1.66-1.34 3-3 3-.83 0-1.58-.34-2.12-.88L3 21l2.37-4.38C4.83 15.58 4.5 14.33 4.5 13c0-3.31 2.69-6 6-6s6 2.69 6 6c0 1.66-.67 3.16-1.76 4.24l.76 1.26"
              ></path>
            </svg>
          </a>
        </div>
        <div id="theme-toggle-container" class="footer-theme-toggle"></div>
      </div>
    </footer>

    <!-- Mobile Menu Script -->
    <script src="/js/mobile-menu.js"></script>

    <!-- Theme Toggle -->
    <script type="module">
      import { initializeThemeToggle } from '/js/theme-toggle.js';
      document.addEventListener('DOMContentLoaded', () => {
        initializeThemeToggle('#theme-toggle-container');
      });
    </script>

    <script>
      class TicketViewer {
        constructor() {
          this.token = this.getTokenFromURL();
          this.tickets = [];
          this.init();
        }

        getTokenFromURL() {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get('token');
        }

        async init() {
          if (!this.token) {
            this.showError('No ticket access token provided. Please use the link from your email.');
            return;
          }

          try {
            await this.loadTickets();
            this.renderTickets();
          } catch (error) {
            console.error('Failed to load tickets:', error);
            this.showError(error.message || 'Failed to load tickets. Please try again.');
          }
        }

        async loadTickets() {
          console.log('[VIEW] Loading tickets with token:', this.token?.substring(0, 20) + '...');

          const response = await fetch(`/api/registration?token=${this.token}`);

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error('[VIEW] API error:', response.status, errorData);

            if (response.status === 401) {
              throw new Error('Invalid or expired token. Please check your email for the correct link.');
            } else if (response.status === 404) {
              throw new Error('No tickets found for this link.');
            } else {
              throw new Error(errorData.error || `Failed to load tickets (Error ${response.status})`);
            }
          }

          const data = await response.json();
          this.tickets = data.tickets || [];
          this.purchaserEmail = data.purchaserEmail;
          this.transactionId = data.transactionId;

          console.log('[VIEW] Loaded tickets:', this.tickets.map(t => ({
            id: t.ticketId,
            status: t.status,
            attendee: t.attendee ? `${t.attendee.firstName} ${t.attendee.lastName}` : 'Not registered'
          })));
        }

        renderTickets() {
          // Hide loading, show content
          document.getElementById('loading-state').style.display = 'none';
          document.getElementById('tickets-content').style.display = 'block';

          // Update ticket count
          document.getElementById('total-tickets').textContent = this.tickets.length;

          // Render each ticket
          const ticketsList = document.getElementById('tickets-list');
          ticketsList.innerHTML = '';

          this.tickets.forEach(ticket => {
            const ticketCard = this.createTicketCard(ticket);
            ticketsList.appendChild(ticketCard);
          });
        }

        createTicketCard(ticket) {
          const card = document.createElement('div');
          card.className = 'ticket-card';

          // Clean up ticket type display
          let displayType = ticket.ticketType || 'Festival Pass';
          if (displayType.startsWith('TEST-')) {
            displayType = displayType.substring(5);
          }
          displayType = displayType.charAt(0).toUpperCase() + displayType.slice(1).replace(/_/g, ' ');

          // Format registration date in Mountain Time
          let registrationDate = 'Not registered';
          if (ticket.registeredAt) {
            registrationDate = window.timeManager.formatDateTime(ticket.registeredAt, true) + ' (Mountain Time)';
          }

          // Determine status display
          const statusBadge = ticket.status === 'completed' ?
            '<span class="ticket-status-badge">✓ Registered</span>' :
            ticket.status === 'expired' ?
            '<span class="ticket-status-badge" style="background: var(--color-error-light); color: var(--color-error); border-color: var(--color-error);">Expired</span>' :
            '<span class="ticket-status-badge" style="background: var(--color-warning-light); color: var(--color-warning-700); border-color: var(--color-warning);">Pending Registration</span>';

          card.innerHTML = `
            <div class="ticket-header-row">
              <div>
                <div class="ticket-type">${displayType}</div>
                <div class="ticket-id">Ticket ID: ${ticket.ticketId}</div>
              </div>
              ${statusBadge}
            </div>

            ${ticket.attendee ? `
              <div class="attendee-info">
                <div class="info-group">
                  <span class="info-label">Attendee Name</span>
                  <span class="info-value">${ticket.attendee.firstName} ${ticket.attendee.lastName}</span>
                </div>
                <div class="info-group">
                  <span class="info-label">Email</span>
                  <span class="info-value">${ticket.attendee.email}</span>
                </div>
                <div class="info-group">
                  <span class="info-label">Registered</span>
                  <span class="info-value">${registrationDate}</span>
                </div>
              </div>

              <div class="wallet-section">
                <a href="/api/tickets/apple-wallet/${ticket.ticketId}"
                   class="wallet-button apple">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                  </svg>
                  Add to Apple Wallet
                </a>
                <a href="/api/tickets/google-wallet/${ticket.ticketId}"
                   class="wallet-button google">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                  </svg>
                  Add to Google Pay
                </a>
              </div>
            ` : `
              <div class="attendee-info">
                <p style="color: var(--color-text-secondary); font-style: italic;">
                  This ticket has not been registered yet.
                  ${ticket.status === 'pending' ? `<br><a href="/register-tickets?token=${this.token}" style="color: var(--color-primary);">Click here to complete registration</a>` : ''}
                </p>
              </div>
            `}
          `;

          return card;
        }

        showError(message) {
          document.getElementById('loading-state').style.display = 'none';
          document.getElementById('tickets-content').style.display = 'none';
          document.getElementById('error-message').textContent = message;
          document.getElementById('error-state').style.display = 'block';
        }
      }

      // Initialize when DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        new TicketViewer();

        // Add retry button handler
        const retryBtn = document.getElementById('retry-button');
        if (retryBtn) {
          retryBtn.addEventListener('click', () => window.location.reload());
        }
      });
    </script>
  </body>
</html>