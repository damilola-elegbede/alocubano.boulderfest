<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Successful - A Lo Cubano Boulder Fest</title>
    <meta
      name="description"
      content="Thank you for your purchase! Your tickets for A Lo Cubano Boulder Fest have been confirmed."
    />

    <!-- Favicons -->
    <link
      rel="icon"
      type="image/png"
      href="/images/favicons/favicon-32x32.png"
    />
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />

    <!-- DNS prefetch for external resources -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//fonts.gstatic.com" />

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/base.css" />
    <!-- Theme styles -->
    <link rel="stylesheet" href="/css/theme-toggle.css" />
    <style>
      body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
          135deg,
          var(--color-blue) 0%,
          var(--color-red) 100%
        );
        padding: var(--space-xl);
        margin: 0;
        font-family: var(--font-sans);
        text-align: center;
      }

      .success-container {
        max-width: 700px;
        background: var(--color-white);
        border-radius: 12px;
        padding: var(--space-xl);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        animation: slideInUp 0.6s ease-out;
      }

      .logo-container {
        width: 150px;
        height: 56px;
        margin: 0 auto var(--space-lg);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .logo-container img {
        width: auto;
        height: 56px;
        object-fit: contain;
      }

      .success-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto var(--space-lg);
        background: var(--color-green, #10b981);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: scaleIn 0.5s ease-out 0.3s both;
      }

      .success-icon::after {
        content: "✓";
        color: white;
        font-size: 2.5rem;
        font-weight: bold;
      }

      .success-title {
        font-size: var(--font-size-3xl);
        font-weight: 700;
        color: var(--color-black);
        margin-bottom: var(--space-md);
        font-family: var(--font-display);
      }

      .success-message {
        font-size: var(--font-size-lg);
        color: var(--color-black);
        margin-bottom: var(--space-lg);
        line-height: 1.6;
        opacity: 0.8;
      }

      .order-details {
        background: #f8f9fa;
        border-radius: 8px;
        padding: var(--space-lg);
        margin: var(--space-lg) 0;
        text-align: left;
      }

      .order-details h3 {
        margin-top: 0;
        color: var(--color-black);
        font-size: var(--font-size-lg);
        margin-bottom: var(--space-md);
      }

      .order-info {
        display: grid;
        gap: var(--space-sm);
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-xs) 0;
        border-bottom: 1px solid #e9ecef;
      }

      .info-row:last-child {
        border-bottom: none;
        font-weight: 600;
        font-size: var(--font-size-lg);
      }

      .order-items {
        margin-top: var(--space-md);
      }

      .item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-xs) 0;
        font-size: var(--font-size-sm);
      }

      .next-steps {
        background: #e3f2fd;
        border-radius: 8px;
        padding: var(--space-lg);
        margin: var(--space-lg) 0;
        text-align: left;
      }

      .next-steps h3 {
        margin-top: 0;
        color: var(--color-blue);
        font-size: var(--font-size-lg);
        margin-bottom: var(--space-md);
      }

      .next-steps ul {
        margin: 0;
        padding-left: var(--space-lg);
      }

      .next-steps li {
        margin-bottom: var(--space-sm);
        line-height: 1.6;
      }

      .action-buttons {
        display: flex;
        gap: var(--space-md);
        justify-content: center;
        flex-wrap: wrap;
        margin-top: var(--space-xl);
      }

      .btn {
        display: inline-block;
        padding: var(--space-md) var(--space-lg);
        background-color: var(--color-blue);
        color: var(--color-white);
        text-decoration: none;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
      }

      .btn:hover {
        background-color: var(--color-red);
        transform: translateY(-2px);
      }

      .btn-secondary {
        background-color: transparent;
        color: var(--color-black);
        border: 2px solid var(--color-black);
      }

      .btn-secondary:hover {
        background-color: var(--color-black);
        color: var(--color-white);
      }

      .loading-state {
        text-align: center;
        padding: var(--space-xl);
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--color-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto var(--space-md);
      }

      .error-state {
        background: #fff5f5;
        border: 1px solid #feb2b2;
        border-radius: 8px;
        padding: var(--space-lg);
        color: #c53030;
        margin: var(--space-lg) 0;
      }

      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes scaleIn {
        from {
          opacity: 0;
          transform: scale(0.5);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 600px) {
        .success-container {
          margin: var(--space-md);
          padding: var(--space-lg);
        }

        .action-buttons {
          flex-direction: column;
          align-items: center;
        }

        .btn {
          width: 200px;
          text-align: center;
        }

        .info-row {
          flex-direction: column;
          align-items: flex-start;
          gap: var(--space-xs);
        }
      }
    </style>
  </head>
  <body>
    <div class="success-container">
      <div class="logo-container">
        <img src="/images/logo.png" alt="A Lo Cubano Boulder Fest Logo" />
      </div>

      <!-- Loading state shown while processing -->
      <div id="loading-state" class="loading-state">
        <div class="spinner"></div>
        <div class="success-message">
          Processing your payment confirmation...
        </div>
      </div>

      <!-- Success state shown after verification -->
      <div id="success-state" style="display: none">
        <div class="success-icon"></div>
        <div class="success-title">¡Éxito! Payment Successful</div>
        <div class="success-message">
          Thank you for your purchase! Your order has been confirmed and you
          should receive an email confirmation shortly.
        </div>

        <div id="order-details" class="order-details" style="display: none">
          <h3>Order Details</h3>
          <div class="order-info">
            <div class="info-row">
              <span>Order ID:</span>
              <span id="order-id">-</span>
            </div>
            <div class="info-row">
              <span>Customer:</span>
              <span id="customer-name">-</span>
            </div>
            <div class="info-row">
              <span>Email:</span>
              <span id="customer-email">-</span>
            </div>
            <div class="info-row">
              <span>Order Type:</span>
              <span id="order-type">-</span>
            </div>
            <div class="info-row">
              <span>Total Amount:</span>
              <span id="total-amount">-</span>
            </div>
          </div>
          <div id="order-items" class="order-items"></div>
        </div>

        <div class="next-steps">
          <h3>What happens next?</h3>
          <ul>
            <li>Check your email for order confirmation and tickets</li>
            <li>Save your order confirmation number for your records</li>
            <li>
              Follow us on Instagram
              <a
                href="https://www.instagram.com/alocubano.boulderfest/"
                target="_blank"
                >@alocubano.boulderfest</a
              >
              for updates
            </li>
            <li>
              Contact us at
              <a href="mailto:alocubanoboulderfest@gmail.com"
                >alocubanoboulderfest@gmail.com</a
              >
              if you have questions
            </li>
          </ul>
        </div>

        <div class="action-buttons">
          <a href="/" class="btn">Return Home</a>
          <a href="/about" class="btn-secondary">About Festival</a>
          <a href="/schedule" class="btn-secondary">View Schedule</a>
        </div>
      </div>

      <!-- Error state if something goes wrong -->
      <div id="error-state" style="display: none">
        <div class="success-title">Payment Confirmed</div>
        <div class="success-message">
          Your payment was successful, but we encountered an issue retrieving
          your order details.
        </div>

        <div class="error-state">
          <strong>Don't worry!</strong> Your payment went through successfully.
          You should receive an email confirmation shortly. If you don't receive
          it within a few minutes, please contact us.
        </div>

        <div class="action-buttons">
          <a href="mailto:alocubanoboulderfest@gmail.com" class="btn"
            >Contact Support</a
          >
          <a href="/" class="btn-secondary">Return Home</a>
        </div>
      </div>
    </div>

    <script>
      // Clear cart from localStorage since payment was successful
      function clearCart() {
        try {
          localStorage.removeItem("cart");
          localStorage.removeItem("cartTotal");
          localStorage.removeItem("cartCount");
          console.log("Cart cleared after successful payment");

          // Trigger cart update event if cart manager exists
          if (
            window.cartManager &&
            typeof window.cartManager.clearCart === "function"
          ) {
            window.cartManager.clearCart();
          }

          // Trigger storage event for other tabs/windows
          window.dispatchEvent(
            new StorageEvent("storage", {
              key: "cart",
              oldValue: null,
              newValue: null,
              url: window.location.href,
            }),
          );
        } catch (error) {
          console.error("Error clearing cart:", error);
        }
      }

      // Get session ID from URL parameters
      function getSessionId() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("session_id");
      }

      // Format currency
      function formatCurrency(amount) {
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
        }).format(amount);
      }

      // Display order information
      function displayOrderInfo(orderData) {
        if (orderData.order) {
          document.getElementById("order-id").textContent = orderData.order.id;
          document.getElementById("customer-name").textContent =
            orderData.order.customerName;
          document.getElementById("customer-email").textContent =
            orderData.order.customerEmail;
          document.getElementById("order-type").textContent =
            orderData.order.orderType === "tickets" ? "Tickets" : "Donation";
          document.getElementById("total-amount").textContent = formatCurrency(
            orderData.order.totalAmount,
          );

          // Display order items if available
          if (orderData.order.items && orderData.order.items.length > 0) {
            const itemsContainer = document.getElementById("order-items");
            itemsContainer.innerHTML =
              '<h4 style="margin-top: var(--space-md); margin-bottom: var(--space-sm);">Items:</h4>';

            orderData.order.items.forEach((item) => {
              const itemDiv = document.createElement("div");
              itemDiv.className = "item";
              itemDiv.innerHTML = `
              <span>${item.name} (x${item.quantity})</span>
              <span>${formatCurrency(item.price * item.quantity)}</span>
            `;
              itemsContainer.appendChild(itemDiv);
            });
          }

          document.getElementById("order-details").style.display = "block";
        } else if (orderData.session) {
          // Fallback to session data if order details aren't available
          document.getElementById("customer-email").textContent =
            orderData.session.customerEmail || "N/A";
          document.getElementById("total-amount").textContent = formatCurrency(
            orderData.session.amountTotal,
          );
          document.getElementById("order-details").style.display = "block";
        }
      }

      // Process the checkout success
      async function processCheckoutSuccess() {
        const sessionId = getSessionId();

        if (!sessionId) {
          console.error("No session ID found in URL");
          document.getElementById("loading-state").style.display = "none";
          document.getElementById("error-state").style.display = "block";
          return;
        }

        try {
          // Verify the payment with our backend
          const response = await fetch(
            `/api/payments/checkout-success?session_id=${sessionId}`,
          );
          const data = await response.json();

          if (response.ok && data.success) {
            console.log("Payment verification successful:", data);

            // Clear the cart since payment was successful
            if (data.instructions?.clearCart) {
              clearCart();
            }

            // Display success state
            document.getElementById("loading-state").style.display = "none";
            document.getElementById("success-state").style.display = "block";

            // Display order information
            displayOrderInfo(data);

            // Auto-redirect if specified
            if (data.instructions?.redirectDelay) {
              setTimeout(() => {
                if (data.instructions.redirectUrl) {
                  window.location.href = data.instructions.redirectUrl;
                }
              }, data.instructions.redirectDelay);
            }
          } else {
            console.error("Payment verification failed:", data);
            document.getElementById("loading-state").style.display = "none";
            document.getElementById("error-state").style.display = "block";

            // Still clear cart if payment was successful according to Stripe
            if (data.session?.paymentStatus === "paid") {
              clearCart();
            }
          }
        } catch (error) {
          console.error("Error verifying payment:", error);
          document.getElementById("loading-state").style.display = "none";
          document.getElementById("error-state").style.display = "block";

          // Assume payment was successful and clear cart
          clearCart();
        }
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", () => {
        console.log("Checkout success page loaded");
        console.log("Session ID:", getSessionId());

        // Process the checkout success
        processCheckoutSuccess();
      });

      // Debug logging
      console.log("=== CHECKOUT SUCCESS PAGE DEBUG ===");
      console.log("Page loaded at:", new Date().toISOString());
      console.log("Current URL:", window.location.href);
      console.log("Session ID:", getSessionId());
    </script>
    
    <!-- Theme Management -->
    <script type="module">
      import { initializeThemeToggle } from '/js/theme-toggle.js';
      import themeManager from '/js/theme-manager.js';
      
      // Initialize theme system
      document.addEventListener('DOMContentLoaded', () => {
        themeManager.initializeTheme();
        // Note: checkout-success doesn't have standard header, so we handle theme without toggle UI
      });
    </script>
  </body>
</html>
