<!doctype html>
<html lang="en">
  <head>
    <!-- Inline theme detection to prevent FOUC -->
    <script>
      (function() {
        // Detect admin pages
        const path = window.location.pathname.toLowerCase();
        const isAdmin = path.includes('/admin') || path.includes('pages/admin');

        if (isAdmin) {
          // Admin pages always use dark theme
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          // Main site: check user preference
          let stored = null;
          try {
            stored = localStorage.getItem('theme-preference');
          } catch {
            // localStorage might be disabled
          }

          const preference = stored || 'system';
          let theme = preference;

          if (preference === 'system') {
            // Detect system preference
            theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
              ? 'dark'
              : 'light';
          }

          document.documentElement.setAttribute('data-theme', theme);
        }
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Ticket - A Lo Cubano Boulder Fest</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />

    <!-- Performance optimizations -->
    
    <link rel="preconnect" href="https://wallet.apple.com">
    <link rel="preconnect" href="https://pay.google.com">

    <!-- Theme Management - Early inclusion to prevent FOUC -->
    <script type="module" src="/js/theme-manager.js"></script>

    <!-- Performance optimization system -->
    <script type="module" src="/js/qr-cache-manager.js"></script>
    <script type="module" src="/js/wallet-lazy-loader.js"></script>
    <script type="module" src="/js/performance-integration.js"></script>

    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/typography.css" />
    <link rel="stylesheet" href="/css/floating-cart.css" />
    <link rel="stylesheet" href="/css/floating-cart-dark.css" />
    <link rel="stylesheet" href="/css/header-cart.css" />
    <link rel="stylesheet" href="/css/theme-toggle.css" />
    <style>
      body {
        background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .ticket-container {
        max-width: 400px;
        margin: 20px auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .ticket-header {
        background: linear-gradient(135deg, #ce1126, #002868);
        color: white;
        padding: 30px 20px;
        text-align: center;
        position: relative;
      }

      .ticket-header h1 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
      }

      .ticket-header p {
        margin: 10px 0 0;
        opacity: 0.9;
      }

      .ticket-body {
        padding: 20px;
      }

      .qr-code-container {
        text-align: center;
        padding: 30px 20px;
        background: #f8f9fa;
        margin: 0 -20px 20px;
        position: relative;
      }

      .qr-code-container img {
        width: 250px;
        height: 250px;
        padding: 10px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .qr-loading {
        width: 250px;
        height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f0f0f0;
        border-radius: 8px;
        margin: 0 auto;
      }

      .qr-error {
        width: 250px;
        height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #ffeaea;
        border: 2px dashed #d32f2f;
        border-radius: 8px;
        margin: 0 auto;
        color: #d32f2f;
        font-size: 14px;
        text-align: center;
        padding: 20px;
        box-sizing: border-box;
      }

      @media (max-width: 480px) {
        .qr-code-container img,
        .qr-loading,
        .qr-error {
          width: 220px;
          height: 220px;
        }
      }

      .qr-instructions {
        margin-top: 15px;
        font-size: 14px;
        color: #666;
      }

      .ticket-details {
        margin: 20px 0;
      }

      .ticket-details dt {
        font-weight: 600;
        color: #ce1126;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 15px;
      }

      .ticket-details dd {
        margin: 5px 0;
        font-size: 16px;
        color: #333;
      }

      .wallet-section {
        margin: 30px 0 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-left: -20px;
        margin-right: -20px;
      }

      .wallet-section h3 {
        font-size: 16px;
        margin: 0 0 15px;
        text-align: center;
        color: #333;
      }

      .wallet-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .wallet-button {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s;
        font-size: 15px;
      }

      .wallet-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .wallet-button.apple {
        background: #000;
        color: white;
      }

      .wallet-button.google {
        background: #4285f4;
        color: white;
      }

      .action-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin: 20px 0;
      }

      .action-button {
        padding: 12px 8px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        text-align: center;
        font-size: 13px;
        transition: all 0.2s;
      }

      .action-button:hover {
        background: #f8f9fa;
        border-color: #ce1126;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        text-align: center;
        padding: 40px;
        color: #d32f2f;
      }

      /* Dark mode styles */
      [data-theme="dark"] body {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        color: #ffffff;
      }

      [data-theme="dark"] .ticket-container {
        background: #2d2d2d;
        color: #ffffff;
      }

      [data-theme="dark"] .ticket-body {
        background: #2d2d2d;
      }

      [data-theme="dark"] .qr-code-container {
        background: #3a3a3a;
      }

      [data-theme="dark"] .qr-loading {
        background: #4a4a4a;
        color: #ffffff;
      }

      [data-theme="dark"] .qr-error {
        background: #4a2525;
        border-color: #d32f2f;
        color: #ff6b6b;
      }

      [data-theme="dark"] .ticket-details dt {
        color: #ff4757;
      }

      [data-theme="dark"] .ticket-details dd {
        color: #ffffff;
      }

      [data-theme="dark"] .wallet-section {
        background: #3a3a3a;
      }

      [data-theme="dark"] .wallet-section h3 {
        color: #ffffff;
      }

      [data-theme="dark"] .action-button {
        background: #3a3a3a;
        color: #ffffff;
        border-color: #555;
      }

      [data-theme="dark"] .action-button:hover {
        background: #4a4a4a;
        border-color: #ce1126;
      }


      @media print {
        body {
          background: white !important;
          color: black !important;
        }

        .wallet-section,
        .action-buttons {
          display: none;
        }

        .ticket-container {
          box-shadow: none;
          border: 2px solid #000;
          max-width: 100%;
          background: white !important;
          color: black !important;
        }

        .qr-code-container {
          background: white !important;
        }

        .ticket-details dt {
          color: #ce1126 !important;
        }

        .ticket-details dd {
          color: #333 !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="ticket-container">
      <div class="loading" id="loading-state">Loading your ticket...</div>

      <div class="error" id="error-state" style="display: none">
        Error loading ticket. Please check your link and try again.
      </div>

      <div id="ticket-content" style="display: none">
        <div class="ticket-header">
          <h1>A Lo Cubano Boulder Fest</h1>
          <p>May 15-17, 2026 • Boulder, CO</p>
        </div>

        <div class="ticket-body">
          <div class="qr-code-container" id="qr-container">
            <!-- QR code will be loaded by cache manager -->
          </div>

          <dl class="ticket-details" data-testid="ticket-details">
            <dt>Ticket ID</dt>
            <dd id="ticket-id" data-testid="ticket-id">—</dd>

            <dt>Ticket Type</dt>
            <dd id="ticket-type" data-testid="ticket-type">
              <div style="display: flex; flex-direction: column; gap: 4px;">
                <span id="ticket-type-name">—</span>
                <div id="ticket-color-indicator" style="display: none; align-items: center; gap: 8px; margin-top: 4px;">
                  <span class="ticket-color-circle"
                        style="display: inline-block; width: 14px; height: 14px;
                               border-radius: 50%;"></span>
                  <span id="ticket-color-name" style="font-size: 0.85em; opacity: 0.7;"></span>
                </div>
              </div>
            </dd>

            <dt>Attendee Name</dt>
            <dd id="attendee-name" data-testid="customer-name">—</dd>

            <dt>Event Dates</dt>
            <dd>May 15-17, 2026</dd>

            <dt>Venue</dt>
            <dd>Avalon Ballroom<br />1320 Pearl Street, Boulder, CO</dd>
          </dl>

          <div class="wallet-section" data-testid="wallet-options">
            <h3>Add to Phone Wallet</h3>
            <div id="wallet-buttons-lazy-container" class="wallet-lazy-container"></div>
          </div>

          <div class="action-buttons">
            <button class="action-button" id="print-button">
              🖨️ Print
            </button>
            <button class="action-button" id="download-button">
              💾 Save
            </button>
            <button class="action-button" id="share-button">
              📤 Share
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Get token from URL hash (fragment) for security
      function getTokenFromURL() {
        // Check hash first (preferred for security)
        if (window.location.hash) {
          return window.location.hash.substring(1); // Remove the #
        }
        // Fallback to query params for backward compatibility
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("token");
      }

      const token = getTokenFromURL();

      async function loadTicket() {
        if (!token) {
          showError("No ticket token provided");
          return;
        }

        try {
          // Verify token and get ticket details using POST
          const response = await fetch("/api/tickets/validate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              token,
              validateOnly: true, // Don't increment scan count
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Invalid ticket");
          }

          const data = await response.json();

          // Update UI with ticket details
          document.getElementById("ticket-id").textContent = data.ticket_id || data.ticket.id;
          document.getElementById("ticket-type-name").textContent = data.ticket_type || data.ticket.type;

          // Update color indicator if color data is available
          if (data.color_rgb && data.color_name) {
            const colorIndicator = document.getElementById("ticket-color-indicator");
            const colorCircle = colorIndicator.querySelector(".ticket-color-circle");
            const colorName = document.getElementById("ticket-color-name");

            colorCircle.style.background = data.color_rgb;
            colorName.textContent = data.color_name;
            colorIndicator.style.display = "flex";
          }

          document.getElementById("attendee-name").textContent =
            data.attendee_first_name && data.attendee_last_name
              ? `${data.attendee_first_name} ${data.attendee_last_name}`
              : data.ticket?.attendeeName || "—";

          // Create wallet buttons immediately
          const ticketId = data.ticket.id;
          createWalletButtons(ticketId);

          // Load QR code with caching
          await loadQRCode(token);

          // Preload QR codes for other tickets if this is part of a batch
          if (data.ticket.batchTokens && data.ticket.batchTokens.length > 0) {
            data.ticket.batchTokens.forEach(batchToken => {
              if (batchToken !== token) {
                window.qrCacheManager.preloadQRCode(batchToken);
              }
            });
          }

          // Show ticket content
          document.getElementById("loading-state").style.display = "none";
          document.getElementById("ticket-content").style.display = "block";
        } catch (error) {
          console.error("Error loading ticket:", error);
          showError(error.message);
        }
      }

      function showError(message = "Unable to load ticket") {
        document.getElementById("loading-state").style.display = "none";
        const errorState = document.getElementById("error-state");
        errorState.style.display = "block";
        // Update error message safely using textContent (XSS-safe)
        errorState.textContent = message;
      }

      async function loadQRCode(token) {
        try {
          const container = document.getElementById('qr-container');
          if (!container) {
            throw new Error('QR container not found');
          }

          // Use the optimized QR cache manager
          await window.qrCacheManager.loadQRCode(token, container, {
            showSkeleton: true,
            retryOnError: true,
            onProgress: (progress) => {
              console.log('QR load progress:', progress);
            }
          });

        } catch (error) {
          console.error('Error loading QR code:', error);
          // Error handling is done by the cache manager
        }
      }

      async function downloadQRCode() {
        const qrImgEl = document.getElementById("qr-code");
        const ticketId = document.getElementById("ticket-id").textContent || "ticket";

        if (!qrImgEl.src) {
          alert("QR code not loaded yet. Please wait and try again.");
          return;
        }

        try {
          // Create a canvas to ensure we get a clean PNG
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");

          // Wait for image to be ready
          const img = new Image();
          img.crossOrigin = "anonymous"; // Enable CORS for the image

          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
            img.src = qrImgEl.src;
          });

          // Set canvas size to match QR code
          canvas.width = img.naturalWidth || 300;
          canvas.height = img.naturalHeight || 300;

          // Draw the image on canvas with white background
          ctx.fillStyle = "white";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);

          // Convert to blob and download
          canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.download = `ticket-qr-${ticketId}.png`;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          }, "image/png");

        } catch (error) {
          console.error("Error downloading QR code:", error);
          // Fallback: try direct download of the image
          try {
            const link = document.createElement("a");
            link.download = `ticket-qr-${ticketId}.png`;
            link.href = qrImgEl.src;
            link.target = "_blank";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } catch (fallbackError) {
            alert("Unable to download QR code. Please try right-clicking the QR code and selecting 'Save Image As'.");
          }
        }
      }

      function printTicket() {
        window.print();
      }

      async function downloadTicket() {
        // Convert ticket to image
        const ticketElement = document.getElementById("ticket-content");
        const ticketId = document.getElementById("ticket-id").textContent;

        if (window.html2canvas) {
          const canvas = await html2canvas(ticketElement);
          const link = document.createElement("a");
          link.download = `ticket-${ticketId}.png`;
          link.href = canvas.toDataURL();
          link.click();
        } else {
          // Fallback: download QR code only
          const qrImg = document.getElementById("qr-code");
          const link = document.createElement("a");
          link.download = `ticket-qr-${ticketId}.png`;
          link.href = qrImg.src;
          link.click();
        }
      }

      function createWalletButtons(ticketId) {
        const container = document.getElementById('wallet-buttons-lazy-container');
        if (container) {
          // Use lazy loader for optimal performance
          window.walletLazyLoader.observeWalletContainer(container, ticketId, {
            title: 'Add to Phone Wallet',
            size: 'default',
            showBothOnDesktop: true,
            className: 'wallet-buttons-my-ticket'
          });
        }
      }

      function shareTicket() {
        const shareData = {
          title: "My A Lo Cubano Boulder Fest Ticket",
          text: `Ticket for A Lo Cubano Boulder Fest 2026!`,
          url: window.location.href,
        };

        if (navigator.share && navigator.canShare(shareData)) {
          navigator.share(shareData);
        } else {
          // Fallback: copy to clipboard
          navigator.clipboard.writeText(window.location.href);
          alert("Ticket link copied to clipboard!");
        }
      }

      // Load ticket on page load
      loadTicket();
    </script>

    <!-- Theme Toggle -->
    <script type="module">
      import { initializeThemeToggle } from '/js/theme-toggle.js';
      document.addEventListener('DOMContentLoaded', () => {
        // Add floating theme toggle for special page
        const toggleContainer = document.createElement('div');
        toggleContainer.id = 'theme-toggle-container';
        toggleContainer.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1000;';
        document.body.appendChild(toggleContainer);
        initializeThemeToggle('#theme-toggle-container');
      });

      // Attach event listeners to action buttons (CSP compliance)
      document.getElementById('print-button')?.addEventListener('click', printTicket);
      document.getElementById('download-button')?.addEventListener('click', downloadTicket);
      document.getElementById('share-button')?.addEventListener('click', shareTicket);
    </script>

    <!-- Optional: Include html2canvas for better download functionality -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
      integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </body>
</html>
