# Security Secrets Configuration

Complete guide to security secrets, strength requirements, and validation for A Lo Cubano Boulder Fest.

## Overview

The application uses multiple security secrets for authentication, authorization, and data protection. Each secret has specific strength requirements and usage patterns.

## Secret Strength Requirements

### JWT Signing Secrets

**Required For**:

- Admin authentication (`ADMIN_SECRET`)
- Registration tokens (`REGISTRATION_SECRET`)
- Wallet passes (`WALLET_AUTH_SECRET`)

**Minimum Requirements**:

- **Length**: Minimum 32 characters
- **Complexity**: Mix of uppercase, lowercase, numbers, and symbols
- **Entropy**: Cryptographically random generation required
- **Format**: Base64 or hex-encoded string

**Generation**:

```bash
# Using OpenSSL (recommended)
openssl rand -base64 32

# Using Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"

# Using Python
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
```

**Example Output**:

```text
dGhpc2lzYXNlY3VyZTMyY2hhcmFjdGVyc3RyaW5n
```

**Validation**:

```javascript
// Minimum length check
if (secret.length < 32) {
  throw new Error('JWT secret must be at least 32 characters');
}

// Entropy check (optional but recommended)
const entropy = calculateEntropy(secret);
if (entropy < 4.0) {
  console.warn('Secret has low entropy - consider regenerating');
}

function calculateEntropy(str) {
  const freq = {};
  for (const char of str) {
    freq[char] = (freq[char] || 0) + 1;
  }
  return Object.values(freq).reduce((entropy, count) => {
    const p = count / str.length;
    return entropy - p * Math.log2(p);
  }, 0);
}
```

### Webhook Secrets

**Required For**:

- Brevo webhooks (`BREVO_WEBHOOK_SECRET`)
- Stripe webhooks (`STRIPE_WEBHOOK_SECRET`)
- Cron job authentication (`CRON_SECRET`)

**Minimum Requirements**:

- **Length**: Minimum 32 characters
- **Complexity**: Alphanumeric recommended
- **Format**: String (provider-specific)

**Generation**:

```bash
# Brevo: Use your Brevo dashboard webhook configuration
# Stripe: Automatically generated when creating webhook endpoint
# Cron: Auto-generated by Vercel or manual generation

# Manual generation for CRON_SECRET
openssl rand -hex 32
```

**Validation**:

```javascript
// Example webhook validation (Stripe)
const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);

function validateWebhook(req) {
  const signature = req.headers['stripe-signature'];
  const secret = process.env.STRIPE_WEBHOOK_SECRET;

  if (!secret || secret.length < 32) {
    throw new Error('Invalid webhook secret configuration');
  }

  try {
    const event = stripe.webhooks.constructEvent(
      req.body,
      signature,
      secret
    );
    return event;
  } catch (err) {
    throw new Error(`Webhook validation failed: ${err.message}`);
  }
}
```

### Password Hashes

**Required For**:

- Admin authentication (`ADMIN_PASSWORD`)

**Minimum Requirements**:

- **Algorithm**: bcrypt with work factor 10+
- **Format**: bcrypt hash string (60 characters)
- **Source**: Never store plain text passwords

**Generation**:

```bash
# Using Node.js bcrypt
npm install bcrypt

node -e "
const bcrypt = require('bcrypt');
const saltRounds = 10;
bcrypt.hash('your-password', saltRounds, (err, hash) => {
  console.log('Bcrypt hash:', hash);
});
"
```

**Example Output**:

```text
$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy
```

**Validation**:

```javascript
import bcrypt from 'bcrypt';

async function validatePassword(plaintext, hash) {
  // Verify hash format
  if (!hash || !hash.startsWith('$2b$') || hash.length !== 60) {
    throw new Error('Invalid bcrypt hash format');
  }

  // Compare password
  const match = await bcrypt.compare(plaintext, hash);
  return match;
}
```

### API Keys

**Required For**:

- Brevo API (`BREVO_API_KEY`)
- Stripe API (`STRIPE_PUBLISHABLE_KEY`, `STRIPE_SECRET_KEY`)
- Google Drive API (`GOOGLE_DRIVE_API_KEY`)
- Internal APIs (`INTERNAL_API_KEY`)

**Minimum Requirements**:

- **Length**: Provider-specific (typically 32+ characters)
- **Complexity**: Provider-generated
- **Format**: Provider-specific format

**Generation**:

- **Brevo**: Generated in Brevo dashboard → API Keys
- **Stripe**: Generated in Stripe dashboard → Developers → API keys
- **Google Drive**: Generated in Google Cloud Console → APIs & Services
- **Internal API**: Manual generation for custom endpoints

```bash
# Generate internal API key
openssl rand -hex 32
```

**Validation**:

```javascript
// Internal API key validation
function validateInternalApiKey(provided) {
  const expected = process.env.INTERNAL_API_KEY;

  if (!expected || expected.length < 32) {
    throw new Error('Internal API key not configured');
  }

  // Constant-time comparison to prevent timing attacks
  const providedBuffer = Buffer.from(provided || '');
  const expectedBuffer = Buffer.from(expected);

  if (providedBuffer.length !== expectedBuffer.length) {
    return false;
  }

  return crypto.timingSafeEqual(providedBuffer, expectedBuffer);
}
```

## Secret Storage Best Practices

### Never Commit Secrets

**Bad**:

```javascript
// ❌ NEVER DO THIS
const ADMIN_SECRET = "hardcoded-secret-value";
```

**Good**:

```javascript
// ✅ Always use environment variables
const ADMIN_SECRET = process.env.ADMIN_SECRET;

if (!ADMIN_SECRET || ADMIN_SECRET.length < 32) {
  throw new Error('ADMIN_SECRET not configured or too weak');
}
```

### Use Environment-Specific Secrets

**Development**:

```bash
# .env.local (gitignored)
ADMIN_SECRET=dev-secret-min-32-chars-long
STRIPE_SECRET_KEY=sk_test_...
```

**Production**:

```bash
# Configured in Vercel Dashboard
ADMIN_SECRET=<strong-production-secret-64-chars>
STRIPE_SECRET_KEY=sk_live_...
```

### Rotate Secrets Regularly

**Recommended Schedule**:

- **JWT secrets**: Every 90 days
- **API keys**: Every 180 days or on suspected compromise
- **Admin passwords**: Every 90 days
- **Webhook secrets**: On provider notification or suspected compromise

**Rotation Process**:

1. **Generate new secret**:

   ```bash
   openssl rand -base64 32
   ```

2. **Update in Vercel Dashboard**:

   ```text
   Settings → Environment Variables → Edit ADMIN_SECRET
   ```

3. **Deploy with new secret**:

   ```bash
   vercel --prod
   ```

4. **Verify functionality**:

   ```bash
   npm run test:e2e -- tests/e2e/flows/admin-auth.test.js
   ```

5. **Invalidate old tokens** (if applicable)

## Secret Validation Examples

### JWT Secret Validation

```javascript
/**
 * Validate JWT secret strength
 * @param {string} secret - JWT signing secret
 * @throws {Error} If secret doesn't meet requirements
 */
function validateJwtSecret(secret) {
  if (!secret) {
    throw new Error('JWT secret is required');
  }

  if (secret.length < 32) {
    throw new Error(
      `JWT secret must be at least 32 characters (current: ${secret.length})`
    );
  }

  // Check for common weak patterns
  const weakPatterns = [
    /^(.)\1+$/, // All same character
    /^(0123456789|abcdefghij)+$/, // Sequential patterns
    /^(password|secret|admin)/i // Common words
  ];

  for (const pattern of weakPatterns) {
    if (pattern.test(secret)) {
      throw new Error('JWT secret contains weak pattern');
    }
  }

  // Calculate entropy
  const entropy = calculateEntropy(secret);
  if (entropy < 4.0) {
    console.warn(
      `JWT secret has low entropy (${entropy.toFixed(2)}) - ` +
      `consider using cryptographically random generation`
    );
  }
}

// Usage in application startup
validateJwtSecret(process.env.ADMIN_SECRET);
validateJwtSecret(process.env.REGISTRATION_SECRET);
validateJwtSecret(process.env.WALLET_AUTH_SECRET);
```

### API Key Validation

```javascript
/**
 * Validate API key format and presence
 * @param {string} apiKey - API key to validate
 * @param {string} keyName - Name of the key (for error messages)
 * @param {number} minLength - Minimum required length
 */
function validateApiKey(apiKey, keyName, minLength = 32) {
  if (!apiKey) {
    throw new Error(`${keyName} is required but not configured`);
  }

  if (apiKey.length < minLength) {
    throw new Error(
      `${keyName} must be at least ${minLength} characters ` +
      `(current: ${apiKey.length})`
    );
  }

  // Validate it's not a placeholder
  const placeholderPatterns = [
    /^(your|my|test)/i,
    /^(xxx|000|123)/,
    /<.*>/,
    /\[.*\]/
  ];

  for (const pattern of placeholderPatterns) {
    if (pattern.test(apiKey)) {
      throw new Error(
        `${keyName} appears to be a placeholder value - ` +
        `please configure a real API key`
      );
    }
  }
}

// Usage
validateApiKey(process.env.BREVO_API_KEY, 'BREVO_API_KEY', 40);
validateApiKey(process.env.STRIPE_SECRET_KEY, 'STRIPE_SECRET_KEY', 32);
validateApiKey(process.env.INTERNAL_API_KEY, 'INTERNAL_API_KEY', 32);
```

### Password Hash Validation

```javascript
/**
 * Validate bcrypt hash format
 * @param {string} hash - Bcrypt hash to validate
 * @throws {Error} If hash format is invalid
 */
function validateBcryptHash(hash) {
  if (!hash) {
    throw new Error('Password hash is required');
  }

  // Bcrypt format: $2a$10$... or $2b$10$... (60 chars total)
  const bcryptRegex = /^\$2[aby]\$\d{2}\$[./A-Za-z0-9]{53}$/;

  if (!bcryptRegex.test(hash)) {
    throw new Error(
      'Invalid bcrypt hash format - must be bcrypt hashed password'
    );
  }

  // Extract work factor
  const workFactor = parseInt(hash.split('$')[2], 10);

  if (workFactor < 10) {
    console.warn(
      `Bcrypt work factor (${workFactor}) is below recommended minimum (10)`
    );
  }

  if (workFactor > 14) {
    console.warn(
      `Bcrypt work factor (${workFactor}) may cause performance issues`
    );
  }
}

// Usage
validateBcryptHash(process.env.ADMIN_PASSWORD);
```

## Environment-Specific Configuration

### Development Secrets

**Purpose**: Testing and local development

**Characteristics**:

- Can use weaker secrets (but still minimum 32 chars)
- Test API keys from providers
- Can be shared in team (via secure channel)

**Example** (`.env.local`):

```bash
# Development secrets (gitignored)
ADMIN_SECRET="dev-admin-secret-min-32-chars-required-for-validation"
REGISTRATION_SECRET="dev-registration-secret-must-be-32-chars-long"
STRIPE_SECRET_KEY="sk_test_51..."
BREVO_API_KEY="xkeysib-..."
```

### Production Secrets

**Purpose**: Live production environment

**Characteristics**:

- Must use strong cryptographically random secrets
- Live API keys from providers
- Never shared or committed
- Rotated regularly

**Configuration** (Vercel Dashboard):

```bash
# Production secrets (configured in Vercel)
ADMIN_SECRET="<64-char-base64-encoded-random-string>"
REGISTRATION_SECRET="<64-char-base64-encoded-random-string>"
STRIPE_SECRET_KEY="sk_live_51..."
BREVO_API_KEY="xkeysib-<live-key>..."
```

### CI/CD Secrets

**Purpose**: GitHub Actions testing

**Characteristics**:

- Can use test API keys
- Separate from production
- Configured in GitHub Secrets

**Configuration** (GitHub Settings → Secrets):

```bash
# CI/CD secrets (GitHub Secrets)
TURSO_DATABASE_URL="libsql://test-db..."
TURSO_AUTH_TOKEN="<test-auth-token>"
TEST_ADMIN_PASSWORD="test-password-for-e2e-tests"
```

## Security Recommendations

### 1. Secret Complexity

**Minimum Requirements**:

| Secret Type | Min Length | Complexity | Generation Method |
|-------------|------------|------------|-------------------|
| JWT Signing | 32 chars | High | `openssl rand -base64 32` |
| API Keys | Provider | Provider | Provider dashboard |
| Passwords | 12 chars | Medium | Password manager |
| Webhook | 32 chars | Medium | Provider or `openssl rand -hex 32` |
| Internal | 32 chars | High | `openssl rand -base64 32` |

### 2. Secret Rotation

**When to Rotate**:

- Scheduled rotation (90-180 days)
- After team member departure
- Suspected compromise
- Provider security notification
- After security audit

**How to Rotate**:

1. Generate new secret with same or stronger requirements
2. Update in secret store (Vercel Dashboard)
3. Deploy application with new secret
4. Verify functionality with tests
5. Monitor for errors
6. Deactivate old secret after grace period

### 3. Access Control

**Principle of Least Privilege**:

- Only grant access to necessary secrets
- Use environment-specific secrets
- Separate development, staging, and production
- Audit secret access regularly

**Who Should Have Access**:

| Secret Type | Development Team | DevOps | Admin Panel Users |
|-------------|-----------------|--------|-------------------|
| JWT Secrets | View | Full | None |
| API Keys | Test keys | Full | None |
| Admin Password | None | Reset only | Own password |
| Database | Test DB | Full | None |

### 4. Monitoring and Alerts

**Set up monitoring for**:

- Failed authentication attempts
- Invalid secret usage
- Secret expiration warnings
- Unusual access patterns

**Example Alerts**:

```javascript
// Alert on repeated auth failures
let failedAttempts = 0;

function monitorAuthFailures(error) {
  if (error.message.includes('Invalid secret')) {
    failedAttempts++;

    if (failedAttempts > 5) {
      // Alert security team
      console.error('⚠️ SECURITY ALERT: Multiple auth failures detected');
      // Send notification to security team
    }
  }
}
```

## Troubleshooting

### Problem: "JWT secret must be at least 32 characters"

**Cause**: Secret is too short

**Solution**:

```bash
# Generate new secret
openssl rand -base64 32

# Update in Vercel Dashboard
# Settings → Environment Variables → ADMIN_SECRET
```

### Problem: "Invalid bcrypt hash format"

**Cause**: Plain text password instead of bcrypt hash

**Solution**:

```bash
# Generate bcrypt hash
node -e "
const bcrypt = require('bcrypt');
bcrypt.hash('your-password', 10, (err, hash) => {
  console.log(hash);
});
"

# Update ADMIN_PASSWORD with the hash
```

### Problem: Webhook validation failing

**Cause**: Incorrect webhook secret

**Solution**:

1. **Check provider dashboard** for correct secret
2. **Update in Vercel** with exact value from provider
3. **Ensure no extra whitespace** in secret value
4. **Verify webhook endpoint** is configured correctly

### Problem: Secret appears in logs

**Cause**: Logging full configuration or error messages

**Solution**:

```javascript
// ❌ BAD: Logs secret
console.log('Config:', process.env);

// ✅ GOOD: Redact secrets
console.log('Config:', {
  ...process.env,
  ADMIN_SECRET: '[REDACTED]',
  STRIPE_SECRET_KEY: '[REDACTED]'
});

// ❌ BAD: Error includes secret
throw new Error(`Invalid secret: ${secret}`);

// ✅ GOOD: Generic error message
throw new Error('Invalid secret provided');
```

## Related Documentation

- [Security Policy](../SECURITY.md)
- [Environment Variables](../CLAUDE.md#environment-variables)
- [Deployment Guide](./DEPLOYMENT.md)
- [Admin Panel Guide](./ADMIN_GUIDE.md)