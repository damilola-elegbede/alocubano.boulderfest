#!/bin/sh
#
# Pre-commit hook for A Lo Cubano Boulder Fest
# Runs linting and unit tests before allowing commits
#

set -e

echo "üöÄ Running pre-commit checks..."

# Check if we're in the right directory
if [ ! -f package.json ]; then
    echo "‚ùå Error: Not in project root directory"
    exit 1
fi

# Stage 1: Package drift detection
echo "üìä Stage 1: Checking for package drift..."
if node scripts/detect-package-drift.js; then
    echo "‚úÖ No package drift detected"
else
    echo "‚ùå Package drift detected - please synchronize package.json and package-lock.json"
    echo "üí° Quick fix: rm -rf node_modules package-lock.json && npm install"
    exit 1
fi

# Stage 2: Linting
echo "üìù Stage 2: Running linter..."
if npm run lint; then
    echo "‚úÖ Linting passed"
else
    echo "‚ùå Linting failed - please fix errors before committing"
    exit 1
fi

# Stage 3: Tests disabled for now (running in CI/CD)
# Tests can be re-enabled by uncommenting below
# echo "üß™ Stage 3: Running tests..."
# if npm test; then
#     echo "‚úÖ Tests passed"
# else
#     echo "‚ùå Tests failed - please fix tests before committing"
#     exit 1
# fi

# Stage 4: Check for sensitive data (basic check)
echo "üîí Stage 4: Checking for sensitive data..."
# Look for actual API keys and secrets with specific patterns
SENSITIVE_FILES=$(git diff --cached --name-only | grep -v -E "(package*.json|jest*.js|README.md|\.md$|\.githooks|\.github|install-hooks\.sh|\.template$|test|mock|config|example)" | xargs grep -l -E "(sk_live_[a-zA-Z0-9]{99}|pk_live_[a-zA-Z0-9]{99}|SG\.[a-zA-Z0-9]{22}\.[a-zA-Z0-9]{43})" 2>/dev/null || true)
if [ -n "$SENSITIVE_FILES" ]; then
    echo "‚ö†Ô∏è  WARNING: Actual sensitive data found in staged files"
    echo "Files: $SENSITIVE_FILES"
    echo "Please review your changes and remove any secrets or API keys"
    exit 1
fi

# Stage 5: Check for PII exposure in code
echo "üîê Stage 5: Checking for PII exposure..."
if node scripts/check-pii-exposure.js --staged; then
    echo "‚úÖ No PII exposure detected"
else
    PII_EXIT_CODE=$?
    if [ $PII_EXIT_CODE -eq 1 ]; then
        # Blocking violations found
        echo "‚ùå PII exposure detected - please fix before committing"
        exit 1
    elif [ $PII_EXIT_CODE -eq 2 ]; then
        # Warnings only - allow commit but notify
        echo "‚ö†Ô∏è  PII warnings detected - please review"
        echo "‚úÖ Commit allowed to proceed"
    else
        echo "‚ùå PII scan failed (exit code $PII_EXIT_CODE) - aborting commit"
        echo "   Run: node scripts/check-pii-exposure.js --staged --json for details"
        exit 1
    fi
fi

echo "‚úÖ All pre-commit checks passed!"
echo "üí° Your commit is ready to proceed"