---
name: ğŸ­ E2E Tests - Preview Deployments

# Modern E2E testing workflow using Vercel Preview Deployments
# - Triggers ONLY on successful Vercel deployments to prevent duplicate runs
# - Real production environment testing with serverless functions  
# - No local server management or port conflicts
# - Improved reliability and faster execution
# - Single run per deployment with deployment_status trigger

on:
  # Only trigger when Vercel deployments succeed - prevents duplicate runs
  deployment_status:
    # Trigger when Vercel deployments succeed
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'standard'
        type: choice
        options:
          - 'standard'      # Basic flows (6 tests)
          - 'advanced'      # All flows (12 tests)
          - 'performance'   # Performance-focused tests
          - 'accessibility' # Mobile experience tests
          - 'security'      # Admin and security tests
      browsers:
        description: 'Browser matrix to test'
        required: false
        default: 'standard'
        type: choice
        options:
          - 'standard'      # Chromium + Firefox
          - 'extended'      # + Safari (WebKit)
          - 'mobile'        # + Mobile browsers
          - 'chromium-only' # Chromium only (fastest)
      preview_url:
        description: 'Specific preview URL to test (optional)'
        required: false
        type: string

# Prevent multiple E2E runs for the same deployment
concurrency:
  group: e2e-preview-${{ github.event.deployment.sha || github.sha }}-${{ github.workflow }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  deployments: read

env:
  NODE_VERSION: "20"
  NODE_ENV: test
  CI: true
  NODE_OPTIONS: '--max-old-space-size=3072'
  PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/.playwright-browsers

jobs:
  # Extract preview URL - simplified since deployment is already complete
  get-preview-url:
    name: ğŸ” Extract Preview URL
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'deployment_status' &&
       github.event.deployment_status.state == 'success' &&
       github.event.deployment.environment == 'Preview') ||
      (github.event_name == 'workflow_dispatch')
    outputs:
      preview-url: ${{ steps.extract-url.outputs.preview-url }}
    steps:
      - name: ğŸ” Extract Preview URL
        id: extract-url
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.preview_url }}" ]; then
            # Manual trigger with specific URL
            echo "preview-url=${{ inputs.preview_url }}" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Using manually provided URL: ${{ inputs.preview_url }}"
          elif [ "${{ github.event_name }}" = "deployment_status" ]; then
            # Triggered by deployment_status event - deployment is already complete
            DEPLOYMENT_URL="${{ github.event.deployment_status.target_url }}"
            echo "preview-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Using deployment status URL: $DEPLOYMENT_URL"
          else
            echo "âŒ Unexpected event type: ${{ github.event_name }}"
            exit 1
          fi

      - name: ğŸ“‹ URL Extraction Summary
        run: |
          echo "ğŸ¯ Preview URL Extraction Results:"
          echo "  Event: ${{ github.event_name }}"
          echo "  URL: ${{ steps.extract-url.outputs.preview-url }}"
          echo "  Deployment State: ${{ github.event.deployment_status.state || 'N/A' }}"
          echo "  Environment: ${{ github.event.deployment.environment || 'N/A' }}"


  # Build test matrix (runs in parallel with URL extraction)
  build-test-matrix:
    name: ğŸ“‹ Build Test Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      test-pattern: ${{ steps.matrix.outputs.test-pattern }}
      browsers-json: ${{ steps.matrix.outputs.browsers-json }}
      test-suite: ${{ steps.matrix.outputs.test-suite }}
    steps:
      - name: ğŸ§® Build Test Matrix
        id: matrix
        run: |
          # Set defaults with proper fallback
          TEST_SUITE="${{ inputs.test_suite }}"
          BROWSERS="${{ inputs.browsers }}"
          
          # Apply defaults if empty or null
          if [ -z "$TEST_SUITE" ] || [ "$TEST_SUITE" = "null" ]; then
            TEST_SUITE="standard"
          fi
          
          if [ -z "$BROWSERS" ] || [ "$BROWSERS" = "null" ]; then
            BROWSERS="standard"
          fi
          
          echo "ğŸ”§ Input Processing:"
          echo "  Test Suite: $TEST_SUITE (from: '${{ inputs.test_suite }}')"
          echo "  Browsers: $BROWSERS (from: '${{ inputs.browsers }}')"
          
          # Build browser matrix with validation
          BROWSER_LIST=""
          case "$BROWSERS" in
            "standard")
              BROWSER_LIST="chromium firefox"
              ;;
            "extended")
              BROWSER_LIST="chromium firefox webkit"
              ;;
            "mobile")
              # Mobile browsers use device emulation in Playwright projects
              BROWSER_LIST="chromium firefox mobile-chrome mobile-safari"
              ;;
            "chromium-only")
              BROWSER_LIST="chromium"
              ;;
            *)
              echo "âš ï¸ Unknown browser selection: $BROWSERS, defaulting to standard"
              BROWSER_LIST="chromium firefox"
              ;;
          esac
          
          # Convert to JSON array
          BROWSER_JSON_ARRAY=""
          for browser in $BROWSER_LIST; do
            if [ -z "$BROWSER_JSON_ARRAY" ]; then
              BROWSER_JSON_ARRAY="\"$browser\""
            else
              BROWSER_JSON_ARRAY="$BROWSER_JSON_ARRAY, \"$browser\""
            fi
          done
          
          BROWSER_MATRIX="{\"browser\": [$BROWSER_JSON_ARRAY]}"
          
          # Determine test pattern for file filtering
          TEST_PATTERN=""
          case "$TEST_SUITE" in
            "standard")
              TEST_PATTERN="basic-navigation|cart-functionality|newsletter-simple|admin-auth|gallery-basic|registration-flow"
              ;;
            "advanced")
              TEST_PATTERN="" # Run all tests - no filter
              ;;
            "performance")
              TEST_PATTERN="gallery-browsing|user-engagement"
              ;;
            "accessibility")
              TEST_PATTERN="mobile-registration-experience"
              ;;
            "security")
              TEST_PATTERN="admin-auth|admin-dashboard|ticket-validation"
              ;;
            *)
              echo "âš ï¸ Unknown test suite: $TEST_SUITE, defaulting to standard"
              TEST_PATTERN="basic-navigation|cart-functionality|newsletter-simple|admin-auth|gallery-basic|registration-flow"
              ;;
          esac
          
          # Validate JSON structure
          if ! echo "$BROWSER_MATRIX" | jq . > /dev/null 2>&1; then
            echo "âŒ Invalid JSON generated for browser matrix: $BROWSER_MATRIX"
            exit 1
          fi
          
          # Output results
          echo "matrix=$BROWSER_MATRIX" >> $GITHUB_OUTPUT
          echo "test-pattern=$TEST_PATTERN" >> $GITHUB_OUTPUT
          echo "browsers-json=[$BROWSER_JSON_ARRAY]" >> $GITHUB_OUTPUT
          echo "test-suite=$TEST_SUITE" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ Test Matrix Configuration:"
          echo "  Browser Matrix JSON: $BROWSER_MATRIX"
          echo "  Browser List: $BROWSER_LIST"
          echo "  Test Pattern: $TEST_PATTERN"
          echo "  Test Suite: $TEST_SUITE"
          
          # Validate matrix will work
          BROWSER_COUNT=$(echo "$BROWSER_MATRIX" | jq '.browser | length')
          echo "  Browser Count: $BROWSER_COUNT"
          
          if [ "$BROWSER_COUNT" -eq 0 ]; then
            echo "âŒ No browsers in matrix!"
            exit 1
          fi

  # Main E2E testing job - simplified since deployment is already complete
  e2e-tests:
    name: ğŸ­ E2E Tests (${{ matrix.browser }})
    runs-on: ubuntu-latest
    needs: [get-preview-url, build-test-matrix]
    # Only run if URL extraction succeeded
    if: needs.get-preview-url.result == 'success'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.build-test-matrix.outputs.matrix) }}
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¯ Set Target URL
        id: target-url
        run: |
          TARGET_URL="${{ needs.get-preview-url.outputs.preview-url }}"
          
          # Validate we have a URL
          if [ -z "$TARGET_URL" ] || [ "$TARGET_URL" = "null" ]; then
            echo "âŒ No valid preview URL available"
            exit 1
          fi
          
          echo "target-url=$TARGET_URL" >> $GITHUB_OUTPUT
          echo "PLAYWRIGHT_BASE_URL=$TARGET_URL" >> $GITHUB_ENV
          echo "PREVIEW_URL=$TARGET_URL" >> $GITHUB_ENV
          echo "â„¹ï¸ Using preview URL: $TARGET_URL"

      - name: ğŸ“‹ Test Configuration
        run: |
          echo "ğŸ¯ E2E Test Configuration:"
          echo "  Target URL: ${{ steps.target-url.outputs.target-url }}"
          echo "  Browser: ${{ matrix.browser }}"
          echo "  Test Suite: ${{ needs.build-test-matrix.outputs.test-suite }}"
          echo "  Test Pattern: ${{ needs.build-test-matrix.outputs.test-pattern }}"
          echo "  NODE_OPTIONS: $NODE_OPTIONS"
          echo "  Event Type: ${{ github.event_name }}"
          echo "  Deployment State: ${{ github.event.deployment_status.state || 'N/A' }}"

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed"

      - name: ğŸ§© Cache Playwright Browsers
        uses: actions/cache@v4
        with:
          path: .playwright-browsers
          key: ${{ runner.os }}-pw-${{ matrix.browser }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-pw-${{ matrix.browser }}-
            ${{ runner.os }}-pw-

      - name: ğŸ­ Install Playwright Browsers
        run: |
          # Map browsers to actual Playwright browser names
          BROWSER="${{ matrix.browser }}"
          case "$BROWSER" in
            mobile-chrome) 
              INSTALL_BROWSER="chromium"
              echo "ğŸ“± Mobile Chrome will use Chromium with mobile device emulation"
              ;;
            mobile-safari) 
              INSTALL_BROWSER="webkit"
              echo "ğŸ“± Mobile Safari will use WebKit with mobile device emulation"
              ;;
            chromium|firefox|webkit)
              INSTALL_BROWSER="$BROWSER"
              echo "ğŸ–¥ï¸ Desktop browser: $INSTALL_BROWSER"
              ;;
            *)
              echo "âŒ Unknown browser type: $BROWSER"
              exit 1
              ;;
          esac

          # Always install browsers to ensure tests can run
          echo "ğŸ”„ Installing Playwright browser: $INSTALL_BROWSER..."
          npx playwright install --with-deps "$INSTALL_BROWSER"
          echo "âœ… Browser installed: $INSTALL_BROWSER"

      - name: ğŸ­ Run E2E Tests
        run: |
          # Determine the correct Playwright project name for the browser
          PROJECT_NAME="${{ matrix.browser }}"
          
          # Base test command
          TEST_COMMAND="npm run test:e2e -- --project $PROJECT_NAME"
          
          # Add test pattern filter if specified
          TEST_PATTERN="${{ needs.build-test-matrix.outputs.test-pattern }}"
          if [ -n "$TEST_PATTERN" ] && [ "$TEST_PATTERN" != "" ]; then
            # Use file path filtering instead of grep for more reliable filtering
            echo "ğŸ¯ Applying test pattern filter: $TEST_PATTERN"
            
            # Create a temporary file list based on pattern
            TEMP_FILE_LIST=$(mktemp)
            find tests/e2e/flows -name "*.test.js" | grep -E "($TEST_PATTERN)" > "$TEMP_FILE_LIST" || true
            
            if [ -s "$TEMP_FILE_LIST" ]; then
              TEST_FILES=$(cat "$TEMP_FILE_LIST" | tr '\n' ' ')
              TEST_COMMAND="npm run test:e2e -- --project $PROJECT_NAME -- $TEST_FILES"
              echo "ğŸ“ Test files to run: $TEST_FILES"
            else
              echo "âš ï¸ No test files match pattern '$TEST_PATTERN', running all tests"
            fi
            
            rm -f "$TEMP_FILE_LIST"
          else
            echo "ğŸ¯ Running all E2E tests (no pattern filter)"
          fi

          echo "ğŸš€ Executing: $TEST_COMMAND"
          echo "ğŸŒ Target URL: ${{ env.PREVIEW_URL }}"
          echo "ğŸ¦Š Browser Project: $PROJECT_NAME"
          
          # Run tests with better error handling
          if ! eval $TEST_COMMAND; then
            echo "âŒ E2E tests failed for ${{ matrix.browser }}"
            echo "ğŸ“Š Collecting debug information..."
            
            # List available test files for debugging
            echo "Available test files:"
            find tests/e2e/flows -name "*.test.js" | head -10
            
            # Show Playwright project configuration
            echo "Playwright projects:"
            npx playwright show-report --list 2>/dev/null || echo "No report available"
            
            exit 1
          fi
        env:
          PLAYWRIGHT_BASE_URL: ${{ env.PREVIEW_URL }}

      - name: ğŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-${{ matrix.browser }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

      - name: ğŸ“‹ Test Summary
        if: always()
        run: |
          echo "ğŸ“Š E2E Test Summary (${{ matrix.browser }}):"
          echo "  Target URL: ${{ env.PREVIEW_URL }}"
          echo "  Test Status: ${{ job.status }}"
          echo "  Browser: ${{ matrix.browser }}"
          echo "  Test Suite: ${{ needs.build-test-matrix.outputs.test-suite }}"
          
          # Browser-specific debugging information
          case "${{ matrix.browser }}" in
            firefox)
              echo "ğŸ¦Š Firefox-specific debug information:"
              echo "  Firefox timeout: 20s actions, 45s navigation"
              echo "  User Agent: Playwright-E2E-Tests-Preview-Firefox"
              ;;
            webkit)
              echo "ğŸ§­ Safari/WebKit debug information:"
              echo "  WebKit project with Safari engine"
              ;;
            mobile-*)
              echo "ğŸ“± Mobile browser debug information:"
              echo "  Using device emulation for mobile testing"
              ;;
          esac
          
          # Check if there were any browser-specific timeouts
          if [ -d "test-results" ]; then
            echo "  Timeout errors:"
            find test-results -name "*.txt" -exec grep -l "timeout\|TimeoutError" {} \; 2>/dev/null || echo "    No timeout errors found"
          fi
          
          if [ -f "playwright-report/index.html" ]; then
            echo "  Report: Available in artifacts"
            
            # Count test results for summary
            TOTAL_TESTS=$(find test-results -name "*.zip" 2>/dev/null | wc -l || echo "0")
            echo "  Test artifacts: $TOTAL_TESTS"
          fi

  # Collect and report results
  e2e-results:
    name: ğŸ“Š E2E Results Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests, build-test-matrix]
    if: always()
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“Š Collect Test Results
        id: collect
        uses: ./.github/actions/collect-test-results
        with:
          test-type: "e2e"
          test-results-path: "test-results-summary.json"

      - name: ğŸ“„ Read Summary JSON
        id: read-results
        run: |
          echo "json=$(jq -c . test-results-summary.json 2>/dev/null || echo '{}')" >> "$GITHUB_OUTPUT"

      - name: ğŸ’¬ Post Results to PR
        if: github.event_name == 'deployment_status' && github.event.deployment.environment == 'Preview'
        uses: ./.github/actions/post-test-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          commit-sha: ${{ github.sha }}
          workflow-run-id: ${{ github.run_id }}
          e2e-test-results: ${{ steps.read-results.outputs.json }}

      - name: ğŸ“‹ Final Summary
        run: |
          echo "ğŸ¯ E2E Test Suite Complete"
          echo "  Suite: ${{ needs.build-test-matrix.outputs.test-suite }}"
          echo "  Browsers: ${{ needs.build-test-matrix.outputs.browsers-json }}"
          echo "  Pattern: ${{ needs.build-test-matrix.outputs.test-pattern }}"
          echo "  Status: ${{ needs.e2e-tests.result }}"

          if [ "${{ needs.e2e-tests.result }}" = "success" ]; then
            echo "âœ… All E2E tests passed!"
          else
            echo "âŒ Some E2E tests failed - check individual job results"
            exit 1
          fi