name: "🔗 Integration Tests"

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: integration-tests-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  NODE_ENV: test
  CI: true
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  test:
    name: "🔗 Integration Tests (Node ${{ matrix.node-version }})"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      fail-fast: false
      matrix:
        node-version: ['20.x', '22.x']

    env:
      DATABASE_URL: "file:./data/test-integration.db"
      INTEGRATION_TEST_MODE: "true"
      VERCEL: ""
      # Admin authentication - CRITICAL for integration tests
      TEST_ADMIN_PASSWORD: ${{ secrets.TEST_ADMIN_PASSWORD || 'test-admin-password-123' }}
      # Do NOT set ADMIN_PASSWORD in test environments - use TEST_ADMIN_PASSWORD instead
      ADMIN_SECRET: ${{ secrets.TEST_ADMIN_SECRET || 'test_admin_secret_minimum_32_characters_for_jwt_signing' }}
      # Test environment variables for integration tests
      STRIPE_SECRET_KEY: ${{ secrets.TEST_STRIPE_SECRET_KEY || 'sk_test_dummy_integration_key' }}
      STRIPE_PUBLISHABLE_KEY: ${{ secrets.TEST_STRIPE_PUBLISHABLE_KEY || 'pk_test_dummy_integration_key' }}
      BREVO_API_KEY: ${{ secrets.TEST_BREVO_API_KEY || 'test_brevo_integration_key' }}
      BREVO_NEWSLETTER_LIST_ID: "1"
      BREVO_WEBHOOK_SECRET: ${{ secrets.TEST_BREVO_WEBHOOK_SECRET || 'test_webhook_secret' }}
      INTERNAL_API_KEY: ${{ secrets.TEST_INTERNAL_API_KEY || 'test-internal-api-key-32-chars-min' }}
      WALLET_AUTH_SECRET: ${{ secrets.TEST_WALLET_AUTH_SECRET || 'test_wallet_auth_secret_minimum_32_chars' }}
      APPLE_PASS_KEY: ${{ secrets.TEST_APPLE_PASS_KEY || 'dGVzdF9hcHBsZV9wYXNzX2tleQ==' }}
      # Integration test timeouts
      VITEST_TEST_TIMEOUT: 60000
      VITEST_HOOK_TIMEOUT: 45000
      VITEST_SETUP_TIMEOUT: 20000
      VITEST_CLEANUP_TIMEOUT: 10000
      VITEST_REQUEST_TIMEOUT: 45000

    steps:
      - name: "📥 Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "🔧 Setup Node.js ${{ matrix.node-version }}"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: "📦 Install Dependencies"
        env:
          NGROK_SKIP_DOWNLOAD: true
          npm_config_build_from_source: true
          PYTHON: python3
        run: |
          echo "📦 Installing dependencies..."

          # Install with npm ci for reproducibility
          npm ci --prefer-offline --no-audit --no-fund

          # Workaround for npm optional dependencies bug #4828
          if [ "$RUNNER_OS" = "Linux" ]; then
            echo "🔧 Checking for platform-specific binaries..."

            # Install Rollup Linux binary if missing
            if [ ! -d "node_modules/@rollup/rollup-linux-x64-gnu" ]; then
              echo "⚠️  Rollup Linux binary missing (npm bug #4828)"
              echo "🔧 Installing @rollup/rollup-linux-x64-gnu..."
              npm install @rollup/rollup-linux-x64-gnu@4.50.0 --no-save --no-audit
            fi

            # Install LibSQL Linux binary if missing
            if [ ! -d "node_modules/@libsql/linux-x64-gnu" ]; then
              echo "⚠️  LibSQL Linux binary missing (npm bug #4828)"
              echo "🔧 Installing @libsql/linux-x64-gnu..."
              npm install @libsql/linux-x64-gnu --no-save --no-audit || true
            fi

            # Rebuild native modules
            echo "🔄 Rebuilding native modules..."
            npm rebuild
          fi

          echo "✅ Dependencies installed and verified"

      - name: "🗃️ Setup SQLite Database"
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🗃️ Setting up Integration Test Database"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          # Create data directory if it doesn't exist
          mkdir -p data

          # Remove any existing integration test database
          rm -f data/test-integration.db

          # Run database migrations first
          echo "🔄 Running database migrations..."
          NODE_ENV=test node scripts/migrate.js

          # Verify database creation
          if [ -f "data/test-integration.db" ]; then
            echo "✅ Integration test database created successfully"
            echo "📊 Database size: $(du -h data/test-integration.db | cut -f1)"
          else
            echo "❌ Failed to create integration test database"
            exit 1
          fi

      - name: "🔗 Run Integration Tests"
        id: test
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🔗 Running Integration Test Suite"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🎯 Timeout: 5 minutes total (stage limit)"
          echo "🗃️ Database: SQLite with real file storage"
          echo "🌐 APIs: Limited external service integration"
          echo "🧪 Expected: ~30-50 integration tests"
          echo "⚙️  Environment: Test credentials configured"
          echo "⏱️  Individual Test Timeout: 60 seconds"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          # Record start time
          start_time=$(date +%s%3N)

          # Run integration tests with increased timeout (280 seconds, 20 seconds buffer)
          timeout 280s npm run test:integration 2>&1 | tee integration-test-output.log
          test_exit_code=${PIPESTATUS[0]}

          # Record end time
          end_time=$(date +%s%3N)
          duration=$((end_time - start_time))

          # Extract test counts - Fix: Calculate total_tests correctly
          passing_tests=$(grep -E "Tests.*passed" integration-test-output.log | sed -E "s/.*Tests[[:space:]]+([0-9]+)[[:space:]]+passed.*/\1/" | head -1 || echo "0")
          failing_tests=$(grep -E "Tests.*failed" integration-test-output.log | sed -E "s/.*Tests[[:space:]]+([0-9]+)[[:space:]]+failed.*/\1/" | head -1 || echo "0")
          total_tests=$((passing_tests + failing_tests))

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📊 Integration Test Results"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ Tests Passed: $passing_tests"
          echo "❌ Tests Failed: $failing_tests"
          echo "📈 Total Tests: $total_tests"
          echo "⏱️  Duration: ${duration}ms"
          echo "🗃️ Database: File-based SQLite"

          # Timeout evaluation
          if [ "$duration" -lt 300000 ]; then
            echo "🏆 EXCELLENT: Integration tests completed within 5-minute limit!"
          else
            echo "⚠️  WARNING: Integration tests exceeded 5-minute timeout limit"
          fi

          exit $test_exit_code

      - name: "🧹 Database Cleanup"
        if: always()
        run: |
          echo "🧹 Cleaning up integration test database..."
          rm -f data/test-integration.db
          echo "✅ Integration test database cleanup completed"

      - name: "📤 Upload Test Results"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-node-${{ matrix.node-version }}
          path: integration-test-output.log
          retention-days: 7

      - name: "📊 Report to PR"
        if: github.event_name == 'pull_request' && always()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('integration-test-output.log', 'utf8');
            const nodeVersion = '${{ matrix.node-version }}';
            const status = '${{ job.status }}';

            const statusIcon = status === 'success' ? '✅' : '❌';
            const statusText = status === 'success' ? 'PASSED' : 'FAILED';

            const comment = `## ${statusIcon} Integration Tests ${statusText} (Node ${nodeVersion})

            <details>
            <summary>View Test Output</summary>

            \`\`\`
            ${output.slice(-3000)}
            \`\`\`

            </details>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes(`Integration Tests`) &&
              comment.body.includes(`Node ${nodeVersion}`)
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }