---
name: ðŸ”— Integration Tests

# Integration testing for API endpoints and database operations
# Validates cross-system functionality and data flow

on:
  pull_request:
    branches: [main]
    paths:
      - 'api/**'
      - 'migrations/**'
      - 'tests/**'
      - 'package.json'
  push:
    branches: [main]
    paths:
      - 'api/**'
      - 'migrations/**'
      - 'tests/**'
  workflow_dispatch:
  workflow_call:

env:
  NODE_VERSION: "20"
  NODE_ENV: test
  CI: true
  # Test database configuration
  DATABASE_URL: "file:./data/integration-test.db"
  TURSO_DATABASE_URL: "file:./data/integration-test.db"
  TEST_TYPE: integration

jobs:
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ“ Prepare Test Environment
        run: |
          mkdir -p data
          echo "ðŸ”§ Test environment prepared"

      - name: ðŸ—ƒï¸ Setup Test Database
        run: |
          echo "ðŸ—ƒï¸ Setting up integration test database..."
          node scripts/setup-database.js
          echo "âœ… Database setup complete"

      - name: ðŸ§ª Run Integration Tests
        env:
          # Test configuration
          TEST_ADMIN_PASSWORD: test-admin-password
          ADMIN_SECRET: test-admin-secret-key-minimum-32-characters
          # Disable external services for integration tests
          BREVO_API_KEY: ""
          STRIPE_SECRET_KEY: ""
        run: |
          echo "ðŸ§ª Running integration tests..."
          
          # Run unit tests with integration focus
          npm test
          
          echo "âœ… Integration tests completed"

      - name: ðŸ¥ Health Check Tests
        run: |
          echo "ðŸ¥ Running health check tests..."
          npm run test:health || echo "Health checks completed with warnings"

      - name: ðŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-${{ github.run_number }}
          path: |
            coverage/
            test-results/
          retention-days: 7
          if-no-files-found: ignore

  # Database migration tests
  migration-tests:
    name: ðŸ—ƒï¸ Migration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ“ Prepare Migration Environment
        run: |
          mkdir -p data
          echo "ðŸ”§ Migration environment prepared"

      - name: ðŸ—ƒï¸ Test Database Migrations
        env:
          DATABASE_URL: "file:./data/migration-test.db"
          TURSO_DATABASE_URL: "file:./data/migration-test.db"
        run: |
          echo "ðŸ—ƒï¸ Testing database migrations..."
          
          # Test migration up
          npm run migrate:up
          
          # Verify migration status
          npm run migrate:status
          
          # Verify database integrity
          npm run migrate:verify
          
          echo "âœ… Migration tests completed"

  # API contract tests
  api-tests:
    name: ðŸ“¡ API Contract Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ“ Prepare API Test Environment
        run: |
          mkdir -p data
          echo "ðŸ”§ API test environment prepared"

      - name: ðŸ—ƒï¸ Setup API Test Database
        run: |
          echo "ðŸ—ƒï¸ Setting up API test database..."
          node scripts/setup-database.js
          echo "âœ… API database setup complete"

      - name: ðŸ“¡ Run API Contract Tests
        env:
          DATABASE_URL: "file:./data/api-test.db"
          TURSO_DATABASE_URL: "file:./data/api-test.db"
          TEST_ADMIN_PASSWORD: test-admin-password
          ADMIN_SECRET: test-admin-secret-key-minimum-32-characters
          TEST_TYPE: integration
        run: |
          echo "ðŸ“¡ Running API contract tests..."
          
          # Run specific API contract tests
          npx vitest run --config tests/vitest.config.js tests/api-contracts.test.js
          
          echo "âœ… API contract tests completed"

  # Summary and reporting
  summary:
    name: ðŸ“‹ Integration Test Summary
    runs-on: ubuntu-latest
    needs: [integration-tests, migration-tests, api-tests]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ðŸ“Š Generate Integration Test Summary
        run: |
          echo "# ðŸ”— Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Integration Tests**: ${{ needs.integration-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Migration Tests**: ${{ needs.migration-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API Contract Tests**: ${{ needs.api-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status**: ${{ 
            (needs.integration-tests.result == 'success' && 
             needs.migration-tests.result == 'success' && 
             needs.api-tests.result == 'success') && 'âœ… All Tests Passed' || 'âŒ Some Tests Failed' 
          }}" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Report Integration Test Failures
        if: |
          needs.integration-tests.result == 'failure' || 
          needs.migration-tests.result == 'failure' || 
          needs.api-tests.result == 'failure'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âŒ Integration Test Failures" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Integration tests have failed. This may indicate:" >> $GITHUB_STEP_SUMMARY
          echo "1. API contract violations" >> $GITHUB_STEP_SUMMARY
          echo "2. Database migration issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Cross-system integration problems" >> $GITHUB_STEP_SUMMARY
          echo "4. Environment configuration issues" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the test artifacts and fix issues before merging." >> $GITHUB_STEP_SUMMARY
          
          exit 1