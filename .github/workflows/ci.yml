name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install
    
    - name: Run linting
      run: npm run lint
    
  build-test:
    runs-on: ubuntu-latest
    needs: [lint]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check file structure
      run: |
        # Verify all required files exist
        test -f pages/typographic/home.html
        test -f pages/typographic/about.html
        test -f pages/typographic/artists.html
        test -f pages/typographic/schedule.html
        test -f pages/typographic/gallery.html
        test -f pages/typographic/tickets.html
        test -f pages/typographic/donations.html
        test -f css/typography-simplified.css
        test -f vercel.json
        test -f README.md
    
    - name: Test static server
      run: |
        python3 -m http.server 8000 &
        SERVER_PID=$!
        sleep 5
        
        # Test if server is running
        curl -f http://localhost:8000/pages/typographic/home.html || exit 1
        
        # Test all pages
        for page in about artists schedule gallery tickets donations; do
          curl -f http://localhost:8000/pages/typographic/$page.html || exit 1
        done
        
        # Test CSS loading
        curl -f http://localhost:8000/css/typography-simplified.css || exit 1
        
        kill $SERVER_PID
    
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check security headers configuration
      run: |
        # Check if security headers are configured in vercel.json
        if ! grep -q "X-Content-Type-Options" vercel.json; then
          echo "Security headers not found in vercel.json"
          exit 1
        fi
        echo "✓ Security headers configured"
    
    - name: Scan for sensitive data
      run: |
        # Check for potential secrets or API keys (excluding test files and expected strings)
        if grep -r -E "(api[_-]?key|password|secret|token)" \
           --include="*.js" --include="*.html" --include="*.css" \
           --exclude-dir=node_modules \
           --exclude-dir=.git \
           --exclude="package*.json" \
           --exclude="jest*.js" \
           .; then
          echo "⚠️  Potential sensitive data found - please review"
          exit 1
        fi
        echo "✓ No sensitive data detected"
    
    - name: Validate required configuration files
      run: |
        # Check that essential config files exist and are valid
        test -f vercel.json || { echo "vercel.json missing"; exit 1; }
        test -f package.json || { echo "package.json missing"; exit 1; }
        
        # Basic JSON syntax check
        python3 -m json.tool vercel.json > /dev/null || { echo "vercel.json has invalid JSON"; exit 1; }
        python3 -m json.tool package.json > /dev/null || { echo "package.json has invalid JSON"; exit 1; }
        
        echo "✓ Configuration files validated"
    
  deploy-preview:
    runs-on: ubuntu-latest
    needs: [lint, build-test, security-scan]
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to Vercel Preview
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        github-comment: true