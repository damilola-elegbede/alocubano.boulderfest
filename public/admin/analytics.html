<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics Dashboard - A Lo Cubano Boulder Fest Admin</title>

    <!-- Cuban Salsa Admin Theme -->
    <link rel="stylesheet" href="/css/admin-unified.css" />
    <link rel="stylesheet" href="/css/admin-mobile.css" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Admin Event Selector -->
    <script type="module" src="/js/admin-event-selector.js"></script>

    <style>
      /* Cuban Salsa Analytics Theme Overrides */
      :root {
        --analytics-primary: var(--admin-primary);
        --analytics-secondary: var(--admin-secondary);
        --analytics-success: var(--admin-success);
        --analytics-warning: var(--admin-warning);
        --analytics-danger: var(--admin-danger);
        --analytics-info: var(--admin-info);
      }

      body {
        font-family: var(--admin-font-body);
        background: var(--admin-bg-light);
        min-height: 100vh;
        padding: var(--admin-space-xl);
        color: var(--color-gray-800);
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Cuban-inspired Chart Colors */
      :root {
        --chart-color-1: var(--admin-primary);
        --chart-color-2: var(--admin-secondary);
        --chart-color-3: #f6ad55;
        --chart-color-4: var(--admin-success);
        --chart-color-5: #4299e1;
        --chart-color-6: #ed8936;
      }

      /* Responsive Adjustments */
      @media (max-width: 768px) {
        body {
          padding: var(--admin-space-md);
        }
        
        .header {
          flex-direction: column;
          align-items: stretch;
        }

        .controls-bar {
          flex-direction: column;
          align-items: stretch;
        }

        .time-range-controls,
        .export-controls {
          justify-content: center;
          gap: var(--admin-space-sm);
        }

        .metrics-grid {
          grid-template-columns: 1fr;
        }

        .two-column-charts {
          grid-template-columns: 1fr;
        }
      }

      /* Loading Animation with Cuban Flair */
      .admin-salsa-loading {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 3px solid rgba(204, 41, 54, 0.1);
        border-top: 3px solid var(--admin-primary);
        border-radius: 50%;
        animation: salsaSpin 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) infinite;
        margin-right: var(--admin-space-md);
      }

      @keyframes salsaSpin {
        0% { transform: rotate(0deg); }
        25% { transform: rotate(90deg) scale(1.05); }
        50% { transform: rotate(180deg); }
        75% { transform: rotate(270deg) scale(1.05); }
        100% { transform: rotate(360deg); }
      }

      /* Cuban Dance Animation for Interactive Elements */
      @keyframes cubanDance {
        0%, 100% { transform: translateX(0) rotate(0deg); }
        25% { transform: translateX(2px) rotate(1deg); }
        50% { transform: translateX(-2px) rotate(-1deg); }
        75% { transform: translateX(1px) rotate(0.5deg); }
      }

      /* Utility Classes */
      .text-right {
        text-align: right;
      }

      .font-mono {
        font-family: var(--admin-font-mono);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="admin-card admin-cuban-gradient admin-fade-in">
        <div class="admin-card-header">
          <div>
            <a
              href="index.html"
              class="admin-btn admin-btn-secondary admin-btn-sm"
              style="margin-right: var(--admin-space-sm)"
            >
              üéØ Portal
            </a>
            <a href="dashboard.html" class="admin-btn admin-btn-secondary admin-btn-sm">
              üìã Dashboard
            </a>
            <h1 style="font-family: var(--admin-font-display); color: var(--color-white); font-size: var(--font-size-2xl); margin-top: var(--admin-space-md); margin-bottom: 0;">üìä Analytics Dashboard</h1>
          </div>
          <div style="color: rgba(255, 255, 255, 0.8); font-size: var(--font-size-sm)">
            <div id="last-updated" class="admin-text-muted" style="margin-bottom: var(--admin-space-xs)">
              Last updated: <span id="update-time">--</span>
            </div>
            <div id="current-filters" class="admin-text-muted" style="font-size: var(--font-size-xs);">
              Event: <span id="current-event">All Events</span> ‚Ä¢ Time Range: <span id="current-time-range">30 Days</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Event Selector -->
      <div id="event-selector-container"></div>

      <!-- Controls Bar -->
      <div class="admin-card admin-conga-item">
        <div class="admin-card-body">
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--admin-space-lg);">
            <div class="time-range-controls" style="display: flex; gap: var(--admin-space-sm);">
              <button class="admin-btn admin-btn-outline time-range-btn" data-days="7">7 Days</button>
              <button class="admin-btn admin-btn-primary time-range-btn active" data-days="30">30 Days</button>
              <button class="admin-btn admin-btn-outline time-range-btn" data-days="90">90 Days</button>
              <button class="admin-btn admin-btn-outline time-range-btn" data-days="all">All Time</button>
            </div>
            <div class="export-controls" style="display: flex; gap: var(--admin-space-sm);">
              <button class="admin-btn admin-btn-success export-btn" onclick="exportJSON()">
                üì• Export JSON
              </button>
              <button class="admin-btn admin-btn-info export-btn" onclick="exportCSV()">
                üì• Export CSV
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Metrics Grid -->
      <div class="admin-widgets" id="metrics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--admin-space-xl); margin-bottom: var(--admin-space-3xl);">
        <div class="admin-widget-stat admin-conga-item">
          <div class="admin-widget-stat-label">Total Tickets Sold</div>
          <div class="admin-widget-stat-value" id="total-tickets">--</div>
          <div class="admin-widget-stat-change" id="tickets-change">--</div>
        </div>
        <div class="admin-widget-stat admin-conga-item">
          <div class="admin-widget-stat-label">Gross Revenue</div>
          <div class="admin-widget-stat-value" id="gross-revenue">--</div>
          <div class="admin-widget-stat-change" id="revenue-change">--</div>
        </div>
        <div class="admin-widget-stat admin-conga-item">
          <div class="admin-widget-stat-label">Unique Customers</div>
          <div class="admin-widget-stat-value" id="unique-customers">--</div>
          <div class="admin-widget-stat-change" id="customers-change">--</div>
        </div>
        <div class="admin-widget-stat admin-conga-item">
          <div class="admin-widget-stat-label">Check-in Rate</div>
          <div class="admin-widget-stat-value" id="checkin-rate">--</div>
          <div class="admin-widget-stat-change" id="checkin-change">--</div>
        </div>
        <div class="admin-widget-stat admin-conga-item">
          <div class="admin-widget-stat-label">Conversion Rate</div>
          <div class="admin-widget-stat-value" id="conversion-rate">--</div>
          <div class="admin-widget-stat-change" id="conversion-change">--</div>
        </div>
        <div class="admin-widget-stat admin-conga-item">
          <div class="admin-widget-stat-label">Top Ticket Type</div>
          <div class="admin-widget-stat-value" id="top-ticket" style="font-size: var(--font-size-xl);">
            --
          </div>
          <div class="admin-widget-stat-change" id="top-ticket-count">--</div>
        </div>
        <div class="admin-widget-stat admin-conga-item">
          <div class="admin-widget-stat-label">Wallet Adoption</div>
          <div class="admin-widget-stat-value" id="wallet-adoption">--</div>
          <div class="admin-widget-stat-change" id="wallet-change">--</div>
        </div>
        <div class="admin-widget-stat admin-conga-item">
          <div class="admin-widget-stat-label">Digital Revenue Share</div>
          <div class="admin-widget-stat-value" id="digital-share">--</div>
          <div class="admin-widget-stat-change" id="digital-change">--</div>
        </div>
      </div>

      <!-- Charts Section -->
      <div style="display: grid; grid-template-columns: 1fr; gap: var(--admin-space-xl); margin-bottom: var(--admin-space-xl);">
        <!-- Sales Trend Chart -->
        <div class="admin-card admin-fade-in">
          <div class="admin-card-header">
            <h2 class="admin-card-title">Sales Trend</h2>
          </div>
          <div class="admin-card-body">
            <div style="position: relative; height: 300px;">
              <canvas id="sales-trend-chart"></canvas>
            </div>
          </div>
        </div>

        <!-- Two Column Charts -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--admin-space-xl);">
          <!-- Revenue Breakdown -->
          <div class="admin-card admin-fade-in admin-salsa-rhythm">
            <div class="admin-card-header">
              <h2 class="admin-card-title">Revenue by Ticket Type</h2>
            </div>
            <div class="admin-card-body">
              <div style="position: relative; height: 300px;">
                <canvas id="revenue-breakdown-chart"></canvas>
              </div>
            </div>
          </div>

          <!-- Hourly Sales Pattern -->
          <div class="admin-card admin-fade-in admin-salsa-rhythm">
            <div class="admin-card-header">
              <h2 class="admin-card-title">Sales by Hour of Day</h2>
            </div>
            <div class="admin-card-body">
              <div style="position: relative; height: 300px;">
                <canvas id="hourly-sales-chart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Check-in and Wallet Charts -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--admin-space-xl);">
          <!-- Check-in Rate by Type -->
          <div class="admin-card admin-fade-in admin-salsa-rhythm">
            <div class="admin-card-header">
              <h2 class="admin-card-title">Check-in Rate by Ticket Type</h2>
            </div>
            <div class="admin-card-body">
              <div style="position: relative; height: 300px;">
                <canvas id="checkin-by-type-chart"></canvas>
              </div>
            </div>
          </div>

          <!-- Wallet Adoption Trend -->
          <div class="admin-card admin-fade-in admin-salsa-rhythm">
            <div class="admin-card-header">
              <h2 class="admin-card-title">Apple Wallet Adoption Trend</h2>
            </div>
            <div class="admin-card-body">
              <div style="position: relative; height: 300px;">
                <canvas id="wallet-trend-chart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Customers Table -->
      <div class="admin-table-container admin-fade-in">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Top Customers</h2>
        </div>
        <table class="admin-table">
          <thead>
            <tr>
              <th>Customer</th>
              <th>Email</th>
              <th>Tickets</th>
              <th>Total Spent</th>
              <th>Last Purchase</th>
            </tr>
          </thead>
          <tbody id="top-customers-tbody">
            <tr>
              <td colspan="5" style="text-align: center; padding: var(--admin-space-2xl);">
                <div class="admin-salsa-loading"></div>
                <span style="color: var(--admin-text-secondary);">Loading customer data...</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Recommendations -->
      <div class="admin-card admin-fade-in">
        <div class="admin-card-header">
          <h2 class="admin-card-title">Insights & Recommendations</h2>
        </div>
        <div class="admin-card-body">
          <div id="recommendations-list">
            <div style="text-align: center; padding: var(--admin-space-2xl);">
              <div class="admin-salsa-loading"></div>
              <span style="color: var(--admin-text-secondary);">Analyzing data...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // Import event selector functionality
      import { initializeEventSelector } from '/js/admin-event-selector.js';
      
      // Global variables
      let analyticsData = null;
      let currentTimeRange = 30;
      let currentEventId = 'all';
      let eventSelector = null;
      let charts = {};
      let refreshInterval = null;

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        initializeEventSelectorComponent();
        initializeTimeRangeButtons();
        loadAnalytics();
        // Auto-refresh every 5 minutes
        refreshInterval = setInterval(loadAnalytics, 5 * 60 * 1000);
      });
      
      // Initialize event selector
      function initializeEventSelectorComponent() {
        const container = document.getElementById('event-selector-container');
        if (!container) {
          console.warn('Event selector container not found');
          return;
        }
        
        // Initialize the event selector
        eventSelector = initializeEventSelector(container);
        
        if (eventSelector) {
          // Get initial selection
          const selection = eventSelector.getSelectedEvent();
          currentEventId = selection.id;
          
          // Update initial displays
          updateCurrentEventDisplay(selection.event?.name || 'All Events');
          updateCurrentTimeRangeDisplay(currentTimeRange);
          
          // Listen for event changes
          document.addEventListener('eventSelectorChange', handleEventChange);
        }
      }
      
      // Handle event selector change
      function handleEventChange(event) {
        const { eventId, event: eventData } = event.detail;
        currentEventId = eventId;
        
        console.log('Analytics event changed to:', eventId);
        
        // Update filter display
        updateCurrentEventDisplay(eventData?.name || 'All Events');
        
        // Reload analytics data with new event filter
        loadAnalytics();
      }
      
      // Update current event display in header
      function updateCurrentEventDisplay(eventName) {
        const eventDisplay = document.getElementById('current-event');
        if (eventDisplay) {
          eventDisplay.textContent = eventName;
        }
      }
      
      // Update current time range display in header
      function updateCurrentTimeRangeDisplay(timeRange) {
        const timeDisplay = document.getElementById('current-time-range');
        if (timeDisplay) {
          const displayText = timeRange === 'all' ? 'All Time' : `${timeRange} Days`;
          timeDisplay.textContent = displayText;
        }
      }

      // Clean up on page unload
      window.addEventListener("beforeunload", () => {
        // Clear interval to prevent memory leaks
        if (refreshInterval) {
          clearInterval(refreshInterval);
          refreshInterval = null;
        }

        // Destroy all charts
        Object.values(charts).forEach((chart) => {
          if (chart && typeof chart.destroy === "function") {
            chart.destroy();
          }
        });
        charts = {};
        
        // Cleanup event selector
        if (eventSelector) {
          eventSelector.destroy();
        }
      });

      // Initialize time range buttons
      function initializeTimeRangeButtons() {
        const buttons = document.querySelectorAll(".time-range-btn");
        buttons.forEach((btn) => {
          btn.addEventListener("click", () => {
            // Update active state - replace Cuban button classes
            buttons.forEach((b) => {
              b.classList.remove("active", "admin-btn-primary");
              b.classList.add("admin-btn-outline");
            });
            btn.classList.remove("admin-btn-outline");
            btn.classList.add("active", "admin-btn-primary");

            // Add Cuban dance animation
            btn.style.animation = "cubanDance 0.6s ease-in-out";
            setTimeout(() => {
              btn.style.animation = "";
            }, 600);

            // Update time range and reload
            const days = btn.dataset.days;
            currentTimeRange = days === "all" ? "all" : parseInt(days);
            
            // Update time range display
            updateCurrentTimeRangeDisplay(currentTimeRange);
            
            loadAnalytics();
          });
        });
      }

      // Load analytics data
      async function loadAnalytics() {
        try {
          // Build query parameters
          const queryParams = new URLSearchParams();
          
          // Add days parameter if not "all"
          if (currentTimeRange !== "all") {
            queryParams.set('days', currentTimeRange);
          }
          
          // Add eventId parameter
          if (currentEventId && currentEventId !== 'all') {
            queryParams.set('eventId', currentEventId);
          }
          
          const queryString = queryParams.toString();
          const url = `/api/admin/analytics${queryString ? '?' + queryString : ''}`;

          console.log('Loading analytics:', { url, eventId: currentEventId, days: currentTimeRange });

          const response = await fetch(url);
          if (!response.ok) throw new Error("Failed to load analytics");

          analyticsData = await response.json();

          // Update all components
          updateMetrics();
          updateCharts();
          updateTopCustomers();
          updateRecommendations();
          updateLastUpdated();
        } catch (error) {
          console.error("Error loading analytics:", error);
          showError("Failed to load analytics data");
        }
      }

      // Update metrics cards
      function updateMetrics() {
        if (!analyticsData) return;

        const { metrics, comparison } = analyticsData;

        // Total Tickets - use textContent for safe display
        document.getElementById("total-tickets").textContent =
          metrics.totalTickets.toLocaleString();
        updateChange("tickets-change", comparison.tickets);

        // Gross Revenue - use textContent for safe display
        document.getElementById("gross-revenue").textContent =
          `$${metrics.grossRevenue.toLocaleString()}`;
        updateChange("revenue-change", comparison.revenue);

        // Unique Customers - use textContent for safe display
        document.getElementById("unique-customers").textContent =
          metrics.uniqueCustomers.toLocaleString();
        updateChange("customers-change", comparison.customers);

        // Check-in Rate - use textContent for safe display
        document.getElementById("checkin-rate").textContent =
          `${metrics.checkinRate.toFixed(1)}%`;
        updateChange("checkin-change", comparison.checkinRate);

        // Conversion Rate - use textContent for safe display
        document.getElementById("conversion-rate").textContent =
          `${metrics.conversionRate.toFixed(1)}%`;
        updateChange("conversion-change", comparison.conversionRate);

        // Top Ticket Type - use textContent for safe display
        if (metrics.topTicketType) {
          document.getElementById("top-ticket").textContent =
            metrics.topTicketType.name;
          document.getElementById("top-ticket-count").textContent =
            `${metrics.topTicketType.count} sold`;
        }

        // Wallet Adoption - use textContent for safe display
        document.getElementById("wallet-adoption").textContent =
          `${metrics.walletAdoption.toFixed(1)}%`;
        updateChange("wallet-change", comparison.walletAdoption);

        // Digital Revenue Share - use textContent for safe display
        document.getElementById("digital-share").textContent =
          `${metrics.digitalShare.toFixed(1)}%`;
        updateChange("digital-change", comparison.digitalShare);
      }

      // Update change indicator
      function updateChange(elementId, change) {
        const element = document.getElementById(elementId);
        if (!element || change === undefined) return;

        const isPositive = change >= 0;
        // Remove old positive/negative classes before adding new one
        element.classList.remove("positive", "negative");
        element.classList.add(isPositive ? "positive" : "negative");
        // Use textContent for safe display
        element.textContent = `${isPositive ? "‚Üë" : "‚Üì"} ${Math.abs(change).toFixed(1)}%`;
      }

      // Update charts
      function updateCharts() {
        if (!analyticsData) return;

        // Sales Trend Chart
        updateSalesTrendChart();

        // Revenue Breakdown Chart
        updateRevenueBreakdownChart();

        // Hourly Sales Chart
        updateHourlySalesChart();

        // Check-in by Type Chart
        updateCheckinByTypeChart();

        // Wallet Trend Chart
        updateWalletTrendChart();
      }

      // Sales Trend Chart
      function updateSalesTrendChart() {
        const canvas = document.getElementById("sales-trend-chart");
        if (!canvas) return; // Guard against missing element

        const ctx = canvas.getContext("2d");
        const { salesTrend } = analyticsData;

        if (!salesTrend) return; // Guard against missing data

        // Destroy existing chart if it exists
        if (charts.salesTrend) {
          charts.salesTrend.destroy();
          charts.salesTrend = null; // Clear reference
        }

        charts.salesTrend = new Chart(ctx, {
          type: "line",
          data: {
            labels: salesTrend.dates,
            datasets: [
              {
                label: "Daily Sales",
                data: salesTrend.daily,
                borderColor: "var(--admin-primary)",
                backgroundColor: "rgba(204, 41, 54, 0.1)",
                tension: 0.4,
                borderWidth: 3,
              },
              {
                label: "Cumulative",
                data: salesTrend.cumulative,
                borderColor: "var(--admin-secondary)",
                backgroundColor: "rgba(91, 107, 181, 0.1)",
                tension: 0.4,
                yAxisID: "y1",
                borderWidth: 3,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            scales: {
              y: {
                type: "linear",
                display: true,
                position: "left",
                title: {
                  display: true,
                  text: "Daily Sales",
                },
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",
                title: {
                  display: true,
                  text: "Cumulative Sales",
                },
                grid: {
                  drawOnChartArea: false,
                },
              },
            },
          },
        });
      }

      // Revenue Breakdown Chart
      function updateRevenueBreakdownChart() {
        const canvas = document.getElementById("revenue-breakdown-chart");
        if (!canvas) return; // Guard against missing element

        const ctx = canvas.getContext("2d");
        const { revenueByType } = analyticsData;

        if (!revenueByType) return; // Guard against missing data

        if (charts.revenueBreakdown) {
          charts.revenueBreakdown.destroy();
          charts.revenueBreakdown = null; // Clear reference
        }

        charts.revenueBreakdown = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: revenueByType.labels,
            datasets: [
              {
                data: revenueByType.values,
                backgroundColor: [
                  "#CC2936", // Cuban red
                  "#5B6BB5", // Cuban blue
                  "#f6ad55", // Sunset orange
                  "#28a745", // Success green
                  "#4299e1", // Sky blue
                  "#ed8936", // Warm orange
                  "#764ba2", // Purple accent
                  "#48bb78", // Caribbean green
                ],
                borderWidth: 2,
                borderColor: "#ffffff",
                hoverOffset: 8,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const value = context.parsed;
                    const total = context.dataset.data.reduce(
                      (a, b) => a + b,
                      0,
                    );
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${context.label}: $${value.toLocaleString()} (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
      }

      // Hourly Sales Chart
      function updateHourlySalesChart() {
        const canvas = document.getElementById("hourly-sales-chart");
        if (!canvas) return; // Guard against missing element

        const ctx = canvas.getContext("2d");
        const { hourlySales } = analyticsData;

        if (!hourlySales) return; // Guard against missing data

        if (charts.hourlySales) {
          charts.hourlySales.destroy();
          charts.hourlySales = null; // Clear reference
        }

        charts.hourlySales = new Chart(ctx, {
          type: "bar",
          data: {
            labels: hourlySales.hours,
            datasets: [
              {
                label: "Sales",
                data: hourlySales.sales,
                backgroundColor: "rgba(204, 41, 54, 0.8)",
                borderColor: "#CC2936",
                borderWidth: 2,
                hoverBackgroundColor: "rgba(204, 41, 54, 1)",
                borderRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Number of Sales",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "Hour of Day",
                },
              },
            },
          },
        });
      }

      // Check-in by Type Chart
      function updateCheckinByTypeChart() {
        const canvas = document.getElementById("checkin-by-type-chart");
        if (!canvas) return; // Guard against missing element

        const ctx = canvas.getContext("2d");
        const { checkinByType } = analyticsData;

        if (!checkinByType) return; // Guard against missing data

        if (charts.checkinByType) {
          charts.checkinByType.destroy();
          charts.checkinByType = null; // Clear reference
        }

        charts.checkinByType = new Chart(ctx, {
          type: "bar",
          data: {
            labels: checkinByType.types,
            datasets: [
              {
                label: "Check-in Rate (%)",
                data: checkinByType.rates,
                backgroundColor: "rgba(40, 167, 69, 0.8)",
                borderColor: "#28a745",
                borderWidth: 2,
                hoverBackgroundColor: "rgba(40, 167, 69, 1)",
                borderRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: "Check-in Rate (%)",
                },
              },
            },
          },
        });
      }

      // Wallet Trend Chart
      function updateWalletTrendChart() {
        const canvas = document.getElementById("wallet-trend-chart");
        if (!canvas) return; // Guard against missing element

        const ctx = canvas.getContext("2d");
        const { walletTrend } = analyticsData;

        if (!walletTrend) return; // Guard against missing data

        if (charts.walletTrend) {
          charts.walletTrend.destroy();
          charts.walletTrend = null; // Clear reference
        }

        charts.walletTrend = new Chart(ctx, {
          type: "line",
          data: {
            labels: walletTrend.dates,
            datasets: [
              {
                label: "Wallet Adoption (%)",
                data: walletTrend.adoption,
                borderColor: "#5B6BB5",
                backgroundColor: "rgba(91, 107, 181, 0.1)",
                tension: 0.4,
                borderWidth: 3,
                pointBackgroundColor: "#5B6BB5",
                pointBorderColor: "#ffffff",
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 8,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: "Adoption Rate (%)",
                },
              },
            },
          },
        });
      }

      // Update top customers table
      function updateTopCustomers() {
        if (!analyticsData || !analyticsData.topCustomers) return;

        const tbody = document.getElementById("top-customers-tbody");
        const customers = analyticsData.topCustomers;

        if (customers.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #718096;">
                            No customer data available
                        </td>
                    </tr>
                `;
          return;
        }

        tbody.innerHTML = customers
          .map(
            (customer) => `
                <tr>
                    <td>${escapeHtml(customer.name)}</td>
                    <td>${escapeHtml(customer.email)}</td>
                    <td>${escapeHtml(String(customer.ticketCount))}</td>
                    <td>${escapeHtml("$" + customer.totalSpent.toLocaleString())}</td>
                    <td>${escapeHtml(formatDate(customer.lastPurchase))}</td>
                </tr>
            `,
          )
          .join("");
      }

      // Update recommendations
      function updateRecommendations() {
        if (!analyticsData || !analyticsData.recommendations) return;

        const container = document.getElementById("recommendations-list");
        const recommendations = analyticsData.recommendations;

        if (recommendations.length === 0) {
          container.innerHTML = `
                    <div class="admin-card" style="padding: var(--admin-space-lg); margin-bottom: var(--admin-space-md); border-left: 4px solid var(--admin-info);">
                        <div style="display: flex; align-items: flex-start; gap: var(--admin-space-md);">
                            <div style="font-size: 20px;">‚ÑπÔ∏è</div>
                            <div>
                                <div style="font-weight: 600; color: var(--color-gray-800); margin-bottom: var(--admin-space-xs);">No recommendations</div>
                                <div style="font-size: var(--font-size-sm); color: var(--color-gray-600);">
                                    All metrics are performing well. Keep up the great work! üéâ
                                </div>
                            </div>
                        </div>
                    </div>
                `;
          return;
        }

        container.innerHTML = recommendations
          .map((rec, index) => {
            const badgeClass =
              rec.type === "success"
                ? "admin-badge-success"
                : rec.type === "warning"
                  ? "admin-badge-warning"
                  : "admin-badge-info";
            const borderColor =
              rec.type === "success"
                ? "var(--admin-success)"
                : rec.type === "warning"
                  ? "var(--admin-warning)"
                  : "var(--admin-info)";
            const icon =
              rec.type === "success"
                ? "‚úÖ"
                : rec.type === "warning"
                  ? "‚ö†Ô∏è"
                  : "‚ÑπÔ∏è";

            return `
                    <div class="admin-card admin-conga-item" style="padding: var(--admin-space-lg); margin-bottom: var(--admin-space-md); border-left: 4px solid ${borderColor}; animation-delay: ${index * 0.1}s;">
                        <div style="display: flex; align-items: flex-start; gap: var(--admin-space-md);">
                            <div style="font-size: 20px;">${icon}</div>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: var(--admin-space-md); margin-bottom: var(--admin-space-sm);">
                                    <h3 style="font-weight: 600; color: var(--color-gray-800); margin: 0; font-size: var(--font-size-base);">${escapeHtml(rec.title)}</h3>
                                    <span class="admin-badge ${badgeClass}">${rec.type.toUpperCase()}</span>
                                </div>
                                <p style="font-size: var(--font-size-sm); color: var(--color-gray-600); margin: 0; line-height: var(--line-height-relaxed);">${escapeHtml(rec.message)}</p>
                            </div>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // Export functions
      async function exportJSON() {
        if (!analyticsData) {
          alert("No data to export");
          return;
        }

        const dataStr = JSON.stringify(analyticsData, null, 2);
        const dataUri =
          "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);

        const eventSuffix = currentEventId !== 'all' ? `_${currentEventId}` : '';
        const timeSuffix = currentTimeRange !== 'all' ? `_${currentTimeRange}d` : '_all';
        const exportFileDefaultName = `analytics${eventSuffix}${timeSuffix}_${getDateString()}.json`;

        const linkElement = document.createElement("a");
        linkElement.setAttribute("href", dataUri);
        linkElement.setAttribute("download", exportFileDefaultName);
        linkElement.click();
      }

      async function exportCSV() {
        if (!analyticsData) {
          alert("No data to export");
          return;
        }

        // Create CSV content
        const csv = [];

        // Add metrics
        csv.push("Metrics Report");
        csv.push("Metric,Value");
        csv.push(`Total Tickets,${analyticsData.metrics.totalTickets}`);
        csv.push(`Gross Revenue,$${analyticsData.metrics.grossRevenue}`);
        csv.push(`Unique Customers,${analyticsData.metrics.uniqueCustomers}`);
        csv.push(`Check-in Rate,${analyticsData.metrics.checkinRate}%`);
        csv.push(`Conversion Rate,${analyticsData.metrics.conversionRate}%`);
        csv.push(`Wallet Adoption,${analyticsData.metrics.walletAdoption}%`);
        csv.push(
          `Digital Revenue Share,${analyticsData.metrics.digitalShare}%`,
        );
        csv.push("");

        // Add top customers
        csv.push("Top Customers");
        csv.push("Name,Email,Tickets,Total Spent,Last Purchase");
        analyticsData.topCustomers.forEach((customer) => {
          csv.push(
            `"${customer.name}","${customer.email}",${customer.ticketCount},$${customer.totalSpent},"${customer.lastPurchase}"`,
          );
        });

        const csvContent = csv.join("\n");
        const dataUri =
          "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);

        const eventSuffix = currentEventId !== 'all' ? `_${currentEventId}` : '';
        const timeSuffix = currentTimeRange !== 'all' ? `_${currentTimeRange}d` : '_all';
        const exportFileDefaultName = `analytics${eventSuffix}${timeSuffix}_${getDateString()}.csv`;

        const linkElement = document.createElement("a");
        linkElement.setAttribute("href", dataUri);
        linkElement.setAttribute("download", exportFileDefaultName);
        linkElement.click();
      }

      // Utility functions
      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      }

      function getDateString() {
        const now = new Date();
        return now.toISOString().split("T")[0];
      }

      function updateLastUpdated() {
        const now = new Date();
        document.getElementById("update-time").textContent =
          now.toLocaleTimeString("en-US", {
            hour: "2-digit",
            minute: "2-digit",
          });
      }

      function showError(message) {
        console.error(message);
        // You could show a toast notification here
      }
    </script>
  </body>
</html>
