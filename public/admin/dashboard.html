<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - A Lo Cubano Boulder Fest</title>
    <meta
      name="description"
      content="Admin dashboard for A Lo Cubano Boulder Fest - Manage registrations, track attendance, and monitor festival operations"
    />

    <!-- Favicons -->
    <link
      rel="icon"
      type="image/png"
      href="/images/favicons/favicon-32x32.png"
    />
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/images/favicons/favicon-16x16.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/images/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/images/favicons/favicon-192x192.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="192x192"
      href="/images/favicons/favicon-192x192.png"
    />

    <!-- Main Site Stylesheets -->
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/typography.css" />
    
    <!-- Cuban Salsa Theme Admin Stylesheets -->
    <link rel="stylesheet" href="/css/admin-unified.css" />
    <link rel="stylesheet" href="/css/admin-mobile.css" />

    <style>
      /* Admin-specific styling using main site design system */
      .admin-header {
        background: var(--color-black);
        color: var(--color-white);
        padding: var(--space-lg) 0;
        border-bottom: 2px solid var(--color-red);
        margin-bottom: var(--space-xl);
      }

      .admin-header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: var(--space-md);
      }

      .admin-branding {
        display: flex;
        align-items: center;
        gap: var(--space-lg);
      }

      .admin-logo {
        height: 50px;
        width: auto;
      }

      .admin-title-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
      }

      .admin-title {
        font-family: var(--font-display);
        font-size: var(--font-size-2xl);
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
        margin: 0;
        color: var(--color-white);
      }

      .admin-subtitle {
        font-family: var(--font-code);
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wider);
        color: var(--color-red);
        margin: 0;
      }

      .admin-header-actions {
        display: flex;
        gap: var(--space-sm);
        align-items: center;
        flex-wrap: wrap;
      }

      .admin-btn {
        display: inline-flex;
        align-items: center;
        gap: var(--space-xs);
        padding: var(--space-sm) var(--space-lg);
        font-family: var(--font-code);
        font-size: var(--font-size-xs);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
        border: 2px solid transparent;
        transition: all var(--transition-base);
        cursor: pointer;
        text-decoration: none;
        min-height: 44px;
        border-radius: var(--radius-md);
      }

      .admin-btn-portal {
        background: var(--color-blue);
        color: var(--color-white);
        border-color: var(--color-blue);
      }

      .admin-btn-portal:hover {
        background: transparent;
        color: var(--color-blue);
        transform: translateY(-2px);
      }

      .admin-btn-analytics {
        background: transparent;
        color: var(--color-white);
        border-color: var(--color-white);
      }

      .admin-btn-analytics:hover {
        background: var(--color-white);
        color: var(--color-black);
        transform: translateY(-2px);
      }

      .admin-btn-sync {
        background: var(--color-red);
        color: var(--color-white);
        border-color: var(--color-red);
      }

      .admin-btn-sync:hover:not(:disabled) {
        background: transparent;
        color: var(--color-red);
        transform: translateY(-2px);
      }

      .admin-btn-sync:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .admin-btn-logout {
        background: transparent;
        color: var(--color-white);
        border-color: var(--color-red);
      }

      .admin-btn-logout:hover {
        background: var(--color-red);
        color: var(--color-white);
        transform: translateY(-2px);
      }

      /* Dashboard Content */
      .dashboard-container {
        background: var(--color-white);
        min-height: calc(100vh - 200px);
      }

      .dashboard-stats {
        margin-bottom: var(--space-3xl);
      }

      .stats-header {
        text-align: center;
        margin-bottom: var(--space-2xl);
      }

      .stats-title {
        font-family: var(--font-display);
        font-size: var(--font-size-4xl);
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
        color: var(--color-black);
        margin: 0 0 var(--space-sm) 0;
      }

      .stats-subtitle {
        font-family: var(--font-code);
        font-size: var(--font-size-sm);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wider);
        color: var(--color-gray-600);
        margin: 0;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: var(--space-xl);
        margin-bottom: var(--space-3xl);
      }

      .stat-card {
        background: var(--color-white);
        border: 2px solid var(--color-gray-200);
        border-radius: var(--radius-lg);
        padding: var(--space-xl);
        transition: all var(--transition-base);
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--color-blue), var(--color-red));
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--color-blue);
      }

      .stat-card-header {
        font-family: var(--font-code);
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wider);
        color: var(--color-gray-600);
        margin-bottom: var(--space-md);
        font-weight: 600;
      }

      .stat-number {
        font-family: var(--font-display);
        font-size: var(--font-size-4xl);
        font-weight: 900;
        color: var(--color-black);
        margin-bottom: var(--space-xs);
        line-height: var(--line-height-none);
      }

      .stat-label {
        font-family: var(--font-code);
        font-size: var(--font-size-xs);
        color: var(--color-gray-500);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
      }

      /* Special styling for wallet stats */
      .stat-card.wallet-apple::before {
        background: var(--color-black);
      }

      .stat-card.wallet-google::before {
        background: var(--color-blue);
      }

      /* Admin Section */
      .admin-section {
        background: var(--color-white);
        border: 2px solid var(--color-gray-200);
        border-radius: var(--radius-lg);
        padding: var(--space-2xl);
        margin-bottom: var(--space-3xl);
        transition: all var(--transition-base);
      }

      .admin-section:hover {
        border-color: var(--color-blue);
        box-shadow: var(--shadow-md);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-xl);
        padding-bottom: var(--space-lg);
        border-bottom: 2px solid var(--color-gray-200);
      }

      .section-title {
        font-family: var(--font-display);
        font-size: var(--font-size-3xl);
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
        color: var(--color-black);
        margin: 0;
      }

      /* Search Interface */
      .search-interface {
        background: var(--color-gray-100);
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-xl);
        border: 1px solid var(--color-gray-200);
      }

      .search-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr auto auto;
        gap: var(--space-md);
        align-items: end;
      }

      .search-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
      }

      .search-label {
        font-family: var(--font-code);
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wider);
        color: var(--color-gray-700);
        font-weight: 600;
      }

      .search-input,
      .search-select {
        padding: var(--space-sm) var(--space-md);
        border: 2px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        font-family: var(--font-sans);
        font-size: var(--font-size-sm);
        background: var(--color-white);
        transition: border-color var(--transition-base);
        min-height: 44px;
      }

      .search-input:focus,
      .search-select:focus {
        outline: none;
        border-color: var(--color-blue);
        box-shadow: 0 0 0 3px rgba(91, 107, 181, 0.1);
      }

      .search-btn {
        padding: var(--space-sm) var(--space-lg);
        background: var(--color-blue);
        color: var(--color-white);
        border: 2px solid var(--color-blue);
        border-radius: var(--radius-md);
        font-family: var(--font-code);
        font-size: var(--font-size-xs);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
        cursor: pointer;
        transition: all var(--transition-base);
        min-height: 44px;
      }

      .search-btn:hover {
        background: transparent;
        color: var(--color-blue);
        transform: translateY(-2px);
      }

      .export-btn {
        background: var(--color-red);
        border-color: var(--color-red);
      }

      .export-btn:hover {
        background: transparent;
        color: var(--color-red);
      }

      /* Data Table */
      .table-container {
        background: var(--color-white);
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th {
        background: var(--color-gray-100);
        padding: var(--space-md) var(--space-lg);
        text-align: left;
        font-family: var(--font-code);
        font-size: var(--font-size-xs);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wider);
        color: var(--color-gray-700);
        border-bottom: 2px solid var(--color-gray-200);
      }

      .data-table td {
        padding: var(--space-md) var(--space-lg);
        border-bottom: 1px solid var(--color-gray-200);
        font-family: var(--font-sans);
        font-size: var(--font-size-sm);
        color: var(--color-black);
      }

      .data-table tr:hover {
        background: var(--color-gray-50);
      }

      .ticket-id {
        font-family: var(--font-code);
        font-size: var(--font-size-xs);
        background: var(--color-gray-100);
        color: var(--color-black);
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-sm);
        font-weight: 600;
      }

      .status-badge {
        display: inline-block;
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--radius-full);
        font-family: var(--font-code);
        font-size: var(--font-size-xs);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
        line-height: 1;
      }

      .status-valid {
        background: rgba(0, 128, 0, 0.1);
        color: #006400;
        border: 1px solid rgba(0, 128, 0, 0.3);
      }

      .status-checked-in {
        background: rgba(91, 107, 181, 0.1);
        color: var(--color-blue);
        border: 1px solid rgba(91, 107, 181, 0.3);
      }

      .status-cancelled {
        background: rgba(204, 41, 54, 0.1);
        color: var(--color-red);
        border: 1px solid rgba(204, 41, 54, 0.3);
      }

      .action-btn {
        padding: var(--space-xs) var(--space-md);
        font-family: var(--font-code);
        font-size: var(--font-size-xs);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
        border: 2px solid transparent;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all var(--transition-base);
        min-height: 36px;
      }

      .checkin-btn {
        background: rgba(0, 128, 0, 0.1);
        color: #006400;
        border-color: rgba(0, 128, 0, 0.3);
      }

      .checkin-btn:hover:not(:disabled) {
        background: #006400;
        color: var(--color-white);
        transform: translateY(-1px);
      }

      .checkin-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* Pagination */
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: var(--space-md);
        margin-top: var(--space-xl);
        padding: var(--space-lg);
        background: var(--color-gray-50);
        border-radius: var(--radius-md);
      }

      .pagination-btn {
        padding: var(--space-sm) var(--space-lg);
        font-family: var(--font-code);
        font-size: var(--font-size-xs);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wide);
        border: 2px solid var(--color-gray-300);
        background: var(--color-white);
        color: var(--color-gray-700);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all var(--transition-base);
        min-height: 44px;
      }

      .pagination-btn:hover:not(:disabled) {
        background: var(--color-blue);
        color: var(--color-white);
        border-color: var(--color-blue);
        transform: translateY(-2px);
      }

      .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .page-info {
        font-family: var(--font-code);
        font-size: var(--font-size-sm);
        color: var(--color-gray-600);
        padding: var(--space-sm) var(--space-lg);
      }

      /* Loading and Error States */
      .loading-state,
      .error-state {
        text-align: center;
        padding: var(--space-3xl);
        font-family: var(--font-code);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wider);
      }

      .loading-state {
        color: var(--color-gray-600);
        font-size: var(--font-size-sm);
      }

      .error-state {
        background: rgba(204, 41, 54, 0.1);
        color: var(--color-red);
        border: 2px solid rgba(204, 41, 54, 0.3);
        border-radius: var(--radius-md);
        font-size: var(--font-size-base);
        font-weight: 600;
      }

      /* Authentication States */
      body:not([data-auth-status="authenticated"]) .dashboard-container {
        display: none;
      }

      body:not([data-auth-status="authenticated"]) .admin-header {
        display: none;
      }

      body[data-auth-status="checking"] {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: var(--color-white);
      }

      body[data-auth-status="checking"]::after {
        content: "CHECKING AUTHENTICATION...";
        font-family: var(--font-code);
        font-size: var(--font-size-lg);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wider);
        color: var(--color-gray-600);
        animation: pulse 2s ease-in-out infinite;
      }

      body[data-auth-status="unauthenticated"]::after,
      body[data-auth-status="failed"]::after {
        content: "REDIRECTING TO LOGIN...";
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: var(--font-code);
        font-size: var(--font-size-lg);
        text-transform: uppercase;
        letter-spacing: var(--letter-spacing-wider);
        color: var(--color-red);
        z-index: 9999;
        animation: pulse 2s ease-in-out infinite;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .admin-header-content {
          flex-direction: column;
          align-items: stretch;
          text-align: center;
        }

        .admin-branding {
          justify-content: center;
          margin-bottom: var(--space-md);
        }

        .admin-header-actions {
          justify-content: center;
          flex-wrap: wrap;
        }

        .stats-grid {
          grid-template-columns: 1fr;
          gap: var(--space-lg);
        }

        .search-grid {
          grid-template-columns: 1fr;
          gap: var(--space-md);
        }

        .table-container {
          overflow-x: auto;
        }

        .data-table {
          min-width: 600px;
        }

        .data-table th,
        .data-table td {
          padding: var(--space-sm);
          font-size: var(--font-size-xs);
        }

        .pagination {
          flex-wrap: wrap;
          gap: var(--space-sm);
        }

        .pagination-btn {
          padding: var(--space-sm);
          font-size: 10px;
        }
      }

      /* Dark mode support for admin interface */
      @media (prefers-color-scheme: dark) {
        .admin-section,
        .stat-card,
        .table-container {
          background: var(--color-gray-900);
          border-color: var(--color-gray-700);
          color: var(--color-white);
        }

        .data-table th {
          background: var(--color-gray-800);
          color: var(--color-gray-300);
        }

        .data-table td {
          color: var(--color-white);
        }

        .search-interface {
          background: var(--color-gray-800);
          border-color: var(--color-gray-700);
        }
      }

      /* Animation keyframes */
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body class="typographic admin-portal admin-fade-in">
    <!-- Admin Header with Branding -->
    <header class="admin-header admin-cuban-gradient">
      <div class="container">
        <div class="admin-header-content">
          <div class="admin-branding">
            <img
              src="/images/logo.png"
              alt="A Lo Cubano Boulder Fest Logo"
              class="admin-logo"
            />
            <div class="admin-title-group">
              <h1 class="admin-title">Admin Dashboard</h1>
              <p class="admin-subtitle">Festival Management System</p>
            </div>
          </div>
          <nav class="admin-header-actions" aria-label="Admin navigation">
            <a
              href="/admin"
              class="admin-btn admin-btn-secondary admin-dance"
              aria-label="Go to admin portal"
            >
              ðŸŽ¯ Portal
            </a>
            <a
              href="/admin/analytics"
              class="admin-btn admin-btn-outline admin-partner-swap"
              aria-label="View analytics"
            >
              ðŸ“ˆ Analytics
            </a>
            <button
              class="admin-btn admin-btn-primary admin-shake-hover"
              onclick="syncToSheets()"
              aria-label="Sync data to Google Sheets"
            >
              ðŸ“Š Sync to Sheets
            </button>
            <button
              class="admin-btn admin-btn-danger admin-heartbeat"
              onclick="logout()"
              aria-label="Logout from admin dashboard"
            >
              Logout
            </button>
          </nav>
        </div>
      </div>
    </header>

    <!-- Main Dashboard Content -->
    <main class="dashboard-container admin-cha-cha-slide">
      <div class="container">
        <!-- Dashboard Statistics -->
        <section class="dashboard-stats">
          <div class="stats-header">
            <h2 class="stats-title admin-text-primary">Festival Overview</h2>
            <p class="stats-subtitle">Real-time registration and attendance data</p>
          </div>
          
          <div class="stats-grid admin-rumba-wave" id="statsGrid" data-testid="dashboard-stats">
            <div class="loading-state">Loading statistics...</div>
          </div>
        </section>

        <!-- Registrations Management -->
        <section class="admin-card admin-glow-hover" id="registrations">
          <!-- Additional anchor for transactions (points to same section) -->
          <span id="transactions"></span>
          
          <div class="section-header">
            <h2 class="section-title">Registrations</h2>
          </div>

          <!-- Search and Filter Interface -->
          <div class="search-interface">
            <div class="search-grid">
              <div class="search-group">
                <label for="searchInput" class="search-label">Search Query</label>
                <input
                  type="text"
                  id="searchInput"
                  class="search-input"
                  placeholder="Search by name, email, or ticket ID..."
                  onkeypress="if(event.key==='Enter') searchRegistrations()"
                  data-testid="search-registrations"
                />
              </div>
              
              <div class="search-group">
                <label for="statusFilter" class="search-label">Status Filter</label>
                <select
                  id="statusFilter"
                  class="search-select"
                  onchange="searchRegistrations()"
                  data-testid="ticket-type-filter"
                >
                  <option value="">All Status</option>
                  <option value="valid">Valid</option>
                  <option value="cancelled">Cancelled</option>
                  <option value="transferred">Transferred</option>
                </select>
              </div>
              
              <div class="search-group">
                <label for="checkinFilter" class="search-label">Check-in Filter</label>
                <select 
                  id="checkinFilter" 
                  class="search-select"
                  onchange="searchRegistrations()"
                >
                  <option value="">All Tickets</option>
                  <option value="false">Not Checked In</option>
                  <option value="true">Checked In</option>
                </select>
              </div>

              <button 
                class="admin-btn admin-btn-secondary admin-dance" 
                onclick="searchRegistrations()" 
                data-testid="search-button"
                aria-label="Execute search"
              >
                Search
              </button>

              <button 
                class="admin-btn admin-btn-primary admin-partner-swap" 
                onclick="exportToCSV()"
                aria-label="Export results to CSV"
              >
                Export CSV
              </button>
            </div>
          </div>

          <!-- Data Table Container -->
          <div class="admin-table-container">
            <div id="registrationsTable" data-testid="registrations-table">
              <div class="loading-state">Loading registrations...</div>
            </div>
          </div>

          <!-- Pagination Controls -->
          <div class="pagination" id="pagination"></div>
        </section>
      </div>
    </main>

    <script>
      // Security improvements:
      // 1. All user-provided data is escaped using escapeHtml() to prevent XSS attacks
      // 2. CSRF tokens are fetched and included in all state-changing requests
      // 3. Error messages are safely displayed using textContent or escapeHtml()

      let currentPage = 0;
      const pageSize = 50;
      let authToken = null;
      let csrfToken = null;

      // HTML escaping function to prevent XSS attacks
      // CRITICAL: Use this for ALL user-provided data displayed in innerHTML
      function escapeHtml(unsafe) {
        if (unsafe == null) return "";
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Fetch CSRF token
      async function fetchCSRFToken() {
        try {
          const response = await fetch("/api/admin/csrf-token");
          if (response.ok) {
            const data = await response.json();
            csrfToken = data.csrfToken;
            // Refresh token before it expires (50 minutes)
            setTimeout(fetchCSRFToken, 50 * 60 * 1000);
          }
        } catch (error) {
          console.warn("Failed to fetch CSRF token:", error);
          // Continue without CSRF token for backward compatibility
        }
      }

      // Check authentication on load
      async function checkAuth() {
        // Add auth check status indicator immediately
        document.body.setAttribute('data-auth-status', 'checking');
        
        try {
          // Try to use existing session - use a faster endpoint for auth check
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout
          
          const response = await fetch("/api/admin/dashboard", {
            signal: controller.signal,
            headers: {
              'Cache-Control': 'no-cache'
            }
          });
          
          clearTimeout(timeoutId);

          if (!response.ok) {
            // Not authenticated, redirect to login immediately
            document.body.setAttribute('data-auth-status', 'unauthenticated');
            // Use replace to prevent back button issues
            window.location.replace("/admin/login");
            return false;
          }

          // Fetch CSRF token after successful auth check
          await fetchCSRFToken();
          document.body.setAttribute('data-auth-status', 'authenticated');

          return true;
        } catch (error) {
          console.error("Auth check failed:", error);
          document.body.setAttribute('data-auth-status', 'failed');
          // Use replace to prevent back button issues
          window.location.replace("/admin/login");
          return false;
        }
      }

      // Load dashboard data
      async function loadDashboard() {
        // Ensure auth status is set immediately
        if (!document.body.getAttribute('data-auth-status')) {
          document.body.setAttribute('data-auth-status', 'checking');
        }
        
        if (!(await checkAuth())) return;

        try {
          const response = await fetch("/api/admin/dashboard");
          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          displayStats(data.stats);
          await loadRegistrations();
        } catch (error) {
          console.error("Failed to load dashboard:", error);
          document.getElementById("statsGrid").innerHTML = `
                    <div class="error-state">Failed to load dashboard: ${escapeHtml(error.message)}</div>
                `;
        }
      }

      // Display statistics
      function displayStats(stats) {
        const statsGrid = document.getElementById("statsGrid");

        statsGrid.innerHTML = `
                <div class="admin-card admin-widget-stat admin-conga-item">
                    <div class="stat-card-header">Total Tickets</div>
                    <div class="stat-number admin-text-primary">${stats.total_tickets || 0}</div>
                </div>
                <div class="admin-card admin-widget-stat admin-conga-item">
                    <div class="stat-card-header">Checked In</div>
                    <div class="stat-number admin-text-primary">${stats.checked_in || 0}</div>
                    <div class="stat-label">${Math.round((stats.checked_in / stats.total_tickets) * 100) || 0}% completion</div>
                </div>
                <div class="admin-card admin-widget-stat admin-conga-item">
                    <div class="stat-card-header">Total Revenue</div>
                    <div class="stat-number admin-text-primary">$${(stats.total_revenue || 0).toFixed(2)}</div>
                </div>
                <div class="admin-card admin-widget-stat admin-conga-item">
                    <div class="stat-card-header">Total Orders</div>
                    <div class="stat-number admin-text-primary">${stats.total_orders || 0}</div>
                </div>
                <div class="admin-card admin-widget-stat admin-conga-item">
                    <div class="stat-card-header">Workshop Tickets</div>
                    <div class="stat-number admin-text-primary">${stats.workshop_tickets || 0}</div>
                </div>
                <div class="admin-card admin-widget-stat admin-conga-item">
                    <div class="stat-card-header">VIP Tickets</div>
                    <div class="stat-number admin-text-primary">${stats.vip_tickets || 0}</div>
                </div>
                <!-- Wallet Statistics -->
                <div class="admin-card admin-widget-stat admin-conga-item wallet-apple">
                    <div class="stat-card-header">Apple Wallet</div>
                    <div class="stat-number admin-text-primary">${stats.apple_wallet_users || 0}</div>
                    <div class="stat-label">${stats.total_tickets ? Math.round((stats.apple_wallet_users / stats.total_tickets) * 100) : 0}% adoption</div>
                </div>
                <div class="admin-card admin-widget-stat admin-conga-item wallet-google">
                    <div class="stat-card-header">Google Wallet</div>
                    <div class="stat-number admin-text-primary">${stats.google_wallet_users || 0}</div>
                    <div class="stat-label">${stats.total_tickets ? Math.round((stats.google_wallet_users / stats.total_tickets) * 100) : 0}% adoption</div>
                </div>
                <div class="admin-card admin-widget-stat admin-conga-item">
                    <div class="stat-card-header">QR Generated</div>
                    <div class="stat-number admin-text-primary">${stats.qr_generated || 0}</div>
                    <div class="stat-label">${stats.total_tickets ? Math.round((stats.qr_generated / stats.total_tickets) * 100) : 0}% ready</div>
                </div>
            `;
      }

      // Load registrations
      async function loadRegistrations(page = 0) {
        currentPage = page;
        const offset = page * pageSize;

        const search = document.getElementById("searchInput").value;
        const status = document.getElementById("statusFilter").value;
        const checkedIn = document.getElementById("checkinFilter").value;

        const params = new URLSearchParams({
          limit: pageSize,
          offset: offset,
          ...(search && { search }),
          ...(status && { status }),
          ...(checkedIn && { checkedIn }),
        });

        try {
          const response = await fetch(`/api/admin/registrations?${params}`);
          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          displayRegistrations(data.registrations);
          displayPagination(data.total, page);
        } catch (error) {
          console.error("Failed to load registrations:", error);
          document.getElementById("registrationsTable").innerHTML = `
                    <div class="error-state">Failed to load registrations: ${escapeHtml(error.message)}</div>
                `;
        }
      }

      // Display registrations table
      function displayRegistrations(registrations) {
        if (registrations.length === 0) {
          document.getElementById("registrationsTable").innerHTML = `
                    <div class="loading-state">
                        No registrations found
                    </div>
                `;
          return;
        }

        const tableHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Order</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${registrations
                          .map(
                            (reg) => `
                            <tr>
                                <td><span class="ticket-id admin-badge admin-badge-secondary">${escapeHtml(reg.ticket_id)}</span></td>
                                <td>${escapeHtml(reg.attendee_first_name)} ${escapeHtml(reg.attendee_last_name)}</td>
                                <td>${escapeHtml(reg.attendee_email)}</td>
                                <td>${escapeHtml(formatTicketType(reg.ticket_type))}</td>
                                <td>
                                    <span class="admin-badge admin-badge-${reg.checked_in_at ? "success" : escapeHtml(reg.status === 'valid' ? 'primary' : 'danger')}">
                                        ${reg.checked_in_at ? "Checked In" : escapeHtml(reg.status)}
                                    </span>
                                </td>
                                <td>${escapeHtml(reg.order_number)}</td>
                                <td>
                                    ${
                                      reg.checked_in_at
                                        ? `<button class="admin-btn admin-btn-sm admin-btn-warning admin-shake-hover" data-action="undo" data-ticket-id="${escapeHtml(reg.ticket_id)}" data-testid="checkin-reg_${escapeHtml(reg.ticket_id)}">Undo</button>`
                                        : `<button class="admin-btn admin-btn-sm admin-btn-success admin-dance" data-action="checkin" data-ticket-id="${escapeHtml(reg.ticket_id)}" data-testid="checkin-reg_${escapeHtml(reg.ticket_id)}">Check In</button>`
                                    }
                                </td>
                            </tr>
                        `,
                          )
                          .join("")}
                    </tbody>
                </table>
            `;

        document.getElementById("registrationsTable").innerHTML = tableHTML;
      }

      // Display pagination
      function displayPagination(total, currentPage) {
        const totalPages = Math.ceil(total / pageSize);
        const pagination = document.getElementById("pagination");

        if (totalPages <= 1) {
          pagination.innerHTML = "";
          return;
        }

        pagination.innerHTML = `
                <button class="admin-btn admin-btn-outline" onclick="loadRegistrations(0)" ${currentPage === 0 ? "disabled" : ""}>
                    First
                </button>
                <button class="admin-btn admin-btn-outline" onclick="loadRegistrations(${currentPage - 1})" ${currentPage === 0 ? "disabled" : ""}>
                    Previous
                </button>
                <span class="page-info admin-badge admin-badge-info">
                    Page ${currentPage + 1} of ${totalPages}
                </span>
                <button class="admin-btn admin-btn-outline" onclick="loadRegistrations(${currentPage + 1})" ${currentPage >= totalPages - 1 ? "disabled" : ""}>
                    Next
                </button>
                <button class="admin-btn admin-btn-outline" onclick="loadRegistrations(${totalPages - 1})" ${currentPage >= totalPages - 1 ? "disabled" : ""}>
                    Last
                </button>
            `;
      }

      // Search registrations
      function searchRegistrations() {
        loadRegistrations(0);
      }

      // Check in ticket
      async function checkinTicket(ticketId) {
        if (!confirm(`Check in ticket ${ticketId}?`)) return;

        try {
          const headers = { "Content-Type": "application/json" };
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const response = await fetch(
            `/api/admin/registrations?ticketId=${encodeURIComponent(ticketId)}`,
            {
              method: "PUT",
              headers: headers,
              body: JSON.stringify({ action: "checkin" }),
            },
          );

          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          await loadRegistrations(currentPage);
        } catch (error) {
          alert(`Failed to check in: ${escapeHtml(error.message)}`);
        }
      }

      // Undo check in
      async function undoCheckin(ticketId) {
        if (!confirm(`Undo check-in for ticket ${ticketId}?`)) return;

        try {
          const headers = { "Content-Type": "application/json" };
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          const response = await fetch(
            `/api/admin/registrations?ticketId=${encodeURIComponent(ticketId)}`,
            {
              method: "PUT",
              headers: headers,
              body: JSON.stringify({ action: "undo_checkin" }),
            },
          );

          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          await loadRegistrations(currentPage);
        } catch (error) {
          alert(`Failed to undo check-in: ${escapeHtml(error.message)}`);
        }
      }

      // Export to CSV
      async function exportToCSV() {
        const search = document.getElementById("searchInput").value;
        const status = document.getElementById("statusFilter").value;
        const checkedIn = document.getElementById("checkinFilter").value;

        const params = new URLSearchParams({
          limit: 10000, // Export all
          offset: 0,
          ...(search && { search }),
          ...(status && { status }),
          ...(checkedIn && { checkedIn }),
        });

        try {
          const response = await fetch(`/api/admin/registrations?${params}`);
          const data = await response.json();

          if (!response.ok) throw new Error(data.error);

          // Convert to CSV
          const csv = convertToCSV(data.registrations);

          // Download
          const blob = new Blob([csv], { type: "text/csv" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `registrations-${new Date().toISOString().split("T")[0]}.csv`;
          a.click();
        } catch (error) {
          alert(`Export failed: ${escapeHtml(error.message)}`);
        }
      }

      // Convert to CSV
      function convertToCSV(data) {
        if (data.length === 0) return "";

        const headers = [
          "Ticket ID",
          "First Name",
          "Last Name",
          "Email",
          "Ticket Type",
          "Status",
          "Checked In",
          "Order Number",
        ];

        // Note: No HTML escaping needed for CSV export data
        // CSV format handles special characters differently
        const rows = data.map((row) => [
          row.ticket_id,
          row.attendee_first_name,
          row.attendee_last_name,
          row.attendee_email,
          row.ticket_type,
          row.status,
          row.checked_in_at ? "Yes" : "No",
          row.order_number,
        ]);

        return [
          headers.join(","),
          ...rows.map((row) =>
            row
              .map((cell) => `"${String(cell || "").replace(/"/g, '""')}"`)
              .join(","),
          ),
        ].join("\n");
      }

      // Format ticket type
      function formatTicketType(type) {
        const typeMap = {
          "vip-pass": "VIP Pass",
          "weekend-pass": "Weekend Pass",
          "friday-pass": "Friday",
          "saturday-pass": "Saturday",
          "sunday-pass": "Sunday",
          workshop: "Workshop",
          "general-admission": "General",
        };
        return typeMap[type] || type;
      }

      // Logout
      async function logout() {
        try {
          const headers = {};
          // Add CSRF token if available
          if (csrfToken) {
            headers["X-CSRF-Token"] = csrfToken;
          }

          await fetch("/api/admin/login", {
            method: "DELETE",
            headers: headers,
          });
          window.location.href = "/admin/login";
        } catch (error) {
          console.error("Logout failed:", error);
          window.location.href = "/admin/login";
        }
      }

      // Sync to Google Sheets
      async function syncToSheets() {
        const btn = event.target;
        const originalText = btn.textContent;

        btn.disabled = true;
        btn.textContent = "Syncing...";

        try {
          const response = await fetch("/api/sheets/sync", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (response.ok) {
            if (data.sheetUrl) {
              alert(
                `âœ… Sync completed!\n\nView your data at:\n${data.sheetUrl}`,
              );
            } else {
              alert(`âœ… Sync completed at ${data.timestamp}`);
            }
          } else {
            alert(`âŒ Sync failed: ${data.message || data.error}`);
          }
        } catch (error) {
          alert(`âŒ Sync failed: ${error.message}`);
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }

      // Add event delegation for check-in buttons
      document
        .getElementById("registrationsTable")
        .addEventListener("click", function (event) {
          if (event.target.matches(".checkin-btn[data-action]")) {
            const action = event.target.getAttribute("data-action");
            const ticketId = event.target.getAttribute("data-ticket-id");

            if (action === "checkin") {
              checkinTicket(ticketId);
            } else if (action === "undo") {
              undoCheckin(ticketId);
            }
          }
        });

      // Initialize dashboard immediately
      document.body.setAttribute('data-auth-status', 'checking');
      loadDashboard();

      // Refresh data every 30 seconds
      setInterval(() => {
        loadDashboard();
      }, 30000);
    </script>
  </body>
</html>
