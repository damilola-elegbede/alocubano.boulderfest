<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🔐 Configuración de Seguridad MFA - A Lo Cubano Boulder Fest</title>
    <link rel="stylesheet" href="/css/admin-unified.css">
    <link rel="stylesheet" href="/css/admin-mobile.css">
  </head>
  <body>
    <div class="admin-header admin-cuban-gradient">
      <h1>🛡️ Configuración de Seguridad MFA</h1>
      <div class="header-actions">
        <a href="dashboard.html" class="admin-btn admin-btn-secondary"
          >🏠 Panel Principal</a
        >
      </div>
    </div>

    <div class="container admin-fade-in">
      <!-- MFA Status Section -->
      <div class="admin-card admin-fade-in">
        <h2 class="admin-section-title">🔐 Estado de Autenticación Multi-Factor</h2>
        <div id="mfaStatusContainer">
          <div class="loading admin-pulse">
            <div class="spinner"></div>
            <span>🔄 Cargando estado MFA...</span>
          </div>
        </div>
      </div>

      <!-- MFA Setup Section -->
      <div class="admin-card admin-fade-in">
        <h2 class="admin-section-title">⚙️ Configurar Autenticación Multi-Factor</h2>
        <div id="setupContainer" class="admin-form">
          <!-- Content will be dynamically loaded -->
        </div>
      </div>

      <!-- Recovery Options Section -->
      <div class="admin-card admin-fade-in">
        <h2 class="admin-section-title">🔑 Opciones de Recuperación</h2>
        <div id="recoveryContainer" class="admin-form">
          <div class="admin-alert admin-alert-warning">
            <strong>🚨 Importante:</strong> Guarda tus códigos de respaldo en un lugar seguro.
            Son la única forma de recuperar el acceso si pierdes tu dispositivo autenticador.
          </div>
          <!-- Content will be dynamically loaded -->
        </div>
      </div>
    </div>

    <script>
      let mfaStatus = null;
      let setupData = null;

      // Initialize page
      async function init() {
        await checkAuth();
        await loadMfaStatus();
      }

      // Check authentication
      async function checkAuth() {
        try {
          const response = await fetch("/api/admin/dashboard");
          if (!response.ok) {
            window.location.href = "login.html";
            return false;
          }
          return true;
        } catch (error) {
          console.error("Auth check failed:", error);
          window.location.href = "login.html";
          return false;
        }
      }

      // Load MFA status
      async function loadMfaStatus() {
        try {
          const response = await fetch("/api/admin/mfa-setup");
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          mfaStatus = await response.json();
          displayMfaStatus();
          displaySetupOptions();
          displayRecoveryOptions();
        } catch (error) {
          console.error("Failed to load MFA status:", error);
          displayError(
            "mfaStatusContainer",
            `Failed to load MFA status: ${error.message}`,
          );
        }
      }

      // Display MFA status
      function displayMfaStatus() {
        const container = document.getElementById("mfaStatusContainer");
        const isEnabled = mfaStatus.isEnabled;
        const statusClass = isEnabled ? "success" : "danger";
        const statusIcon = isEnabled ? "🛡️" : "⚠️";
        const statusTitle = isEnabled ? "🔐 MFA Activado" : "🚨 MFA Desactivado";
        const statusDesc = isEnabled
          ? `✨ Activado el ${new Date(mfaStatus.enabledAt).toLocaleDateString()}`
          : "🔓 Tu cuenta no está protegida con autenticación multi-factor";

        container.innerHTML = `
          <div class="admin-alert admin-alert-${statusClass} admin-pulse">
            <div class="status-icon">${statusIcon}</div>
            <div class="status-text">
              <div class="status-title">${statusTitle}</div>
              <div class="status-description">${statusDesc}</div>
            </div>
          </div>
          ${
            isEnabled
              ? `
            <div class="admin-stats-grid admin-fade-in">
              <div class="admin-stat-item">
                <div class="admin-stat-value">${mfaStatus.backupCodesCount}</div>
                <div class="admin-stat-label">🔑 Códigos de Respaldo</div>
              </div>
              <div class="admin-stat-item">
                <div class="admin-stat-value">${mfaStatus.recentAttempts.successful}</div>
                <div class="admin-stat-label">✅ Intentos Exitosos (24h)</div>
              </div>
              <div class="admin-stat-item">
                <div class="admin-stat-value">${mfaStatus.recentAttempts.total}</div>
                <div class="admin-stat-label">📊 Total Intentos (24h)</div>
              </div>
              <div class="admin-stat-item">
                <div class="admin-stat-value">${mfaStatus.deviceName || "Desconocido"}</div>
                <div class="admin-stat-label">📱 Dispositivo Autenticador</div>
              </div>
            </div>
          `
              : ""
          }
        `;
      }

      // Display setup options
      function displaySetupOptions() {
        const container = document.getElementById("setupContainer");

        if (mfaStatus.isEnabled) {
          container.innerHTML = `
            <div class="admin-alert admin-alert-success admin-fade-in">
              <strong>🛡️ MFA ya está activado</strong><br>
              ✨ Tu cuenta está protegida con autenticación multi-factor.
            </div>
            <div class="admin-form-actions">
              <button class="admin-btn admin-btn-warning" onclick="generateBackupCodes()">🔄 Generar Nuevos Códigos</button>
              <button class="admin-btn admin-btn-danger" onclick="confirmDisableMfa()">🚫 Desactivar MFA</button>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="admin-alert admin-alert-warning admin-shake">
              <strong>⚠️ Tu cuenta no está protegida</strong><br>
              🔐 Activa la autenticación multi-factor para asegurar tu cuenta de admin.
            </div>
            <div class="admin-form-actions">
              <button class="admin-btn admin-btn-success admin-pulse" onclick="startMfaSetup()">🛡️ Activar MFA</button>
            </div>
          `;
        }
      }

      // Display recovery options
      function displayRecoveryOptions() {
        const container = document.getElementById("recoveryContainer");

        if (!mfaStatus.isEnabled) {
          container.innerHTML = `
            <div class="admin-alert admin-alert-warning">
              🔐 MFA debe estar activado antes que las opciones de recuperación estén disponibles.
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="admin-stats-grid admin-fade-in">
            <div class="admin-stat-item">
              <div class="admin-stat-value">${mfaStatus.backupCodesCount}</div>
              <div class="admin-stat-label">🔑 Códigos de Respaldo Disponibles</div>
            </div>
          </div>
          <div class="admin-form-actions">
            <button class="admin-btn admin-btn-warning" onclick="generateBackupCodes()">🔄 Generar Nuevos Códigos</button>
            <button class="admin-btn admin-btn-danger" onclick="showRecoveryOptions()">🆘 Opciones de Recuperación</button>
          </div>
        `;
      }

      // Start MFA setup process
      async function startMfaSetup() {
        const container = document.getElementById("setupContainer");
        container.innerHTML = `
          <div class="loading admin-pulse">
            <div class="spinner"></div>
            <span>🔐 Generando secreto TOTP...</span>
          </div>
        `;

        try {
          const response = await fetch(
            "/api/admin/mfa-setup?action=generate-secret",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ deviceName: "Admin Authenticator" }),
            },
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          setupData = await response.json();
          displaySetupFlow();
        } catch (error) {
          console.error("Failed to generate MFA secret:", error);
          displayError(
            "setupContainer",
            `Failed to generate MFA secret: ${error.message}`,
          );
        }
      }

      // Display setup flow
      function displaySetupFlow() {
        const container = document.getElementById("setupContainer");
        container.innerHTML = `
          <div class="setup-flow active admin-fade-in">
            <div class="admin-setup-step admin-card">
              <div class="admin-step-header">
                <div class="admin-step-number admin-cuban-gradient">1</div>
                <h3>📱 Instalar App Autenticadora</h3>
              </div>
              <p>💾 Instala una app autenticadora en tu teléfono:</p>
              <ul style="margin: 10px 0 0 20px;">
                <li><strong>🔵 Google Authenticator</strong> (iOS/Android)</li>
                <li><strong>🟠 Authy</strong> (iOS/Android/Desktop)</li>
                <li><strong>🔷 Microsoft Authenticator</strong> (iOS/Android)</li>
                <li><strong>🟡 1Password</strong> (Característica Premium)</li>
              </ul>
            </div>

            <div class="admin-setup-step admin-card admin-fade-in">
              <div class="admin-step-header">
                <div class="admin-step-number admin-cuban-gradient">2</div>
                <h3>📷 Escanear Código QR</h3>
              </div>
              <p>🔍 Abre tu app autenticadora y escanea este código QR:</p>
              <div class="admin-qr-container">
                <img src="${setupData.qrCodeUrl}" alt="MFA QR Code" class="admin-qr-code admin-pulse">
              </div>
              <p><strong>❓ ¿No puedes escanear?</strong> Ingresa esta clave manualmente:</p>
              <div class="admin-manual-entry">${setupData.manualEntryKey}</div>
            </div>

            <div class="admin-setup-step admin-card admin-fade-in">
              <div class="admin-step-header">
                <div class="admin-step-number admin-cuban-gradient">3</div>
                <h3>✅ Verificar Configuración</h3>
              </div>
              <p>🔢 Ingresa el código de 6 dígitos de tu app autenticadora:</p>
              <div class="admin-form-group">
                <input type="text" 
                       id="verificationCode" 
                       class="admin-input"
                       placeholder="000000" 
                       maxlength="6" 
                       pattern="[0-9]{6}"
                       autocomplete="off">
                <button class="admin-btn admin-btn-success admin-pulse" onclick="verifyMfaSetup()">🛡️ Verificar y Activar</button>
              </div>
              <div id="verificationResult"></div>
            </div>
          </div>
        `;

        // Auto-focus on verification input
        setTimeout(() => {
          document.getElementById("verificationCode").focus();
        }, 100);
      }

      // Verify MFA setup
      async function verifyMfaSetup() {
        const codeInput = document.getElementById("verificationCode");
        const code = codeInput.value.trim();
        const resultDiv = document.getElementById("verificationResult");

        if (!/^\d{6}$/.test(code)) {
          resultDiv.innerHTML = `
            <div class="admin-alert admin-alert-danger admin-shake">
              🚨 Por favor ingresa un código válido de 6 dígitos de tu app autenticadora.
            </div>
          `;
          return;
        }

        resultDiv.innerHTML = `
          <div class="loading admin-pulse">
            <div class="spinner"></div>
            <span>🔍 Verificando código...</span>
          </div>
        `;

        try {
          const response = await fetch(
            "/api/admin/mfa-setup?action=verify-setup",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                token: code,
                deviceName: "Admin Authenticator",
              }),
            },
          );

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error);
          }

          // Success! Show backup codes
          displayBackupCodes(result.backupCodes);

          // Reload status after successful setup
          setTimeout(() => {
            loadMfaStatus();
          }, 2000);
        } catch (error) {
          console.error("MFA verification failed:", error);
          resultDiv.innerHTML = `
            <div class="admin-alert admin-alert-danger admin-shake">
              <strong>❌ Verificación falló:</strong> ${error.message}
            </div>
          `;
        }
      }

      // Display backup codes
      function displayBackupCodes(codes) {
        const container = document.getElementById("setupContainer");
        container.innerHTML = `
          <div class="admin-alert admin-alert-success admin-fade-in">
            <strong>🎉 ¡MFA Activado Exitosamente!</strong><br>
            🛡️ Tu cuenta ahora está protegida con autenticación multi-factor.
          </div>
          
          <div class="admin-setup-step admin-card admin-fade-in">
            <div class="admin-step-header">
              <div class="admin-step-number admin-cuban-gradient">4</div>
              <h3>💾 Guardar Códigos de Respaldo</h3>
            </div>
            <div class="admin-alert admin-alert-warning">
              <strong>🚨 Importante:</strong> Guarda estos códigos de respaldo en un lugar seguro. 
              Son la única forma de recuperar el acceso si pierdes tu dispositivo autenticador.
              Cada código solo se puede usar una vez.
            </div>
            <div class="admin-backup-codes admin-fade-in">
              ${codes.map((code) => `<div class="admin-backup-code">${code}</div>`).join("")}
            </div>
            <div class="admin-form-actions">
              <button class="admin-btn admin-btn-primary admin-pulse" onclick="downloadBackupCodes(${JSON.stringify(codes).replace(/"/g, "&quot;")})">📥 Descargar Códigos</button>
              <button class="admin-btn admin-btn-success" onclick="loadMfaStatus()">✅ Continuar</button>
            </div>
          </div>
        `;
      }

      // Generate new backup codes
      async function generateBackupCodes() {
        if (
          !confirm("This will invalidate all existing backup codes. Continue?")
        ) {
          return;
        }

        try {
          const response = await fetch(
            "/api/admin/mfa-setup?action=generate-backup-codes",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            },
          );

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error);
          }

          displayBackupCodes(result.backupCodes);
        } catch (error) {
          console.error("Failed to generate backup codes:", error);
          alert(`Failed to generate backup codes: ${error.message}`);
        }
      }

      // Confirm disable MFA
      function confirmDisableMfa() {
        const code = prompt(
          "Enter your current TOTP code or backup code to disable MFA:",
        );
        if (!code) return;

        disableMfa(code);
      }

      // Disable MFA
      async function disableMfa(confirmationCode) {
        try {
          const response = await fetch("/api/admin/mfa-setup?action=disable", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ confirmationCode }),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error);
          }

          alert("MFA has been disabled successfully.");
          loadMfaStatus();
        } catch (error) {
          console.error("Failed to disable MFA:", error);
          alert(`Failed to disable MFA: ${error.message}`);
        }
      }

      // Download backup codes
      function downloadBackupCodes(codes) {
        const content = `A Lo Cubano Boulder Fest - Códigos de Respaldo MFA Admin
Generado: ${new Date().toLocaleString()}

🚨 IMPORTANTE: Guarda estos códigos de forma segura. Cada uno solo se puede usar una vez.

${codes.map((code, i) => `${i + 1}. ${code}`).join("\n")}

Instrucciones:
🔑 Usa estos códigos si pierdes acceso a tu app autenticadora
✅ Ingresa cualquier código no usado cuando se solicite MFA
🔄 Genera nuevos códigos después de usar varios de ellos
🛡️ Mantén estos códigos en un lugar seguro y privado
`;

        const blob = new Blob([content], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `mfa-backup-codes-${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Show recovery options
      function showRecoveryOptions() {
        if (
          confirm(
            "Open recovery options? This should only be used if you have lost access to your authenticator device.",
          )
        ) {
          window.open("mfa-recovery.html", "_blank");
        }
      }

      // Display error
      function displayError(containerId, message) {
        const container = document.getElementById(containerId);
        container.innerHTML = `
          <div class="admin-alert admin-alert-danger admin-shake">
            <strong>🚨 Error:</strong> ${escapeHtml(message)}
          </div>
        `;
      }

      // HTML escaping function
      function escapeHtml(unsafe) {
        if (unsafe == null) return "";
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
