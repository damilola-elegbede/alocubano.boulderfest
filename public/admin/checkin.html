<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#cc2936" />
    <title>Check-in Scanner - A Lo Cubano</title>
    <link rel="manifest" href="/public/manifest.json" />
    <link rel="apple-touch-icon" href="/public/images/icons/icon-192x192.png" />
    <link rel="stylesheet" href="/css/admin-unified.css" />
    <link rel="stylesheet" href="/css/admin-mobile.css" />
    <style>
      /* Minimal override styles for scanner-specific functionality */
      body {
        height: 100vh;
        overflow: hidden;
        position: relative;
      }

      .scanner-container {
        height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
      }

      .scanner-viewport {
        flex: 1;
        position: relative;
        background: #000;
        overflow: hidden;
      }

      #reader {
        width: 100%;
        height: 100%;
      }

      .scanner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .scan-region {
        width: 250px;
        height: 250px;
        border: 3px solid var(--admin-primary);
        border-radius: 20px;
        position: relative;
        animation: cubanPulse 2s infinite;
      }

      @keyframes cubanPulse {
        0% {
          border-color: var(--admin-primary);
          box-shadow: 0 0 0 0 rgba(204, 41, 54, 0.4);
        }
        50% {
          border-color: var(--admin-secondary);
          box-shadow: 0 0 0 15px rgba(91, 107, 181, 0.2);
        }
        100% {
          border-color: var(--admin-primary);
          box-shadow: 0 0 0 0 rgba(204, 41, 54, 0.4);
        }
      }

      .scan-corners {
        position: absolute;
        width: 30px;
        height: 30px;
        border: 4px solid #fff;
      }

      .scan-corners.tl {
        top: -2px;
        left: -2px;
        border-right: none;
        border-bottom: none;
        border-top-left-radius: 10px;
      }

      .scan-corners.tr {
        top: -2px;
        right: -2px;
        border-left: none;
        border-bottom: none;
        border-top-right-radius: 10px;
      }

      .scan-corners.bl {
        bottom: -2px;
        left: -2px;
        border-right: none;
        border-top: none;
        border-bottom-left-radius: 10px;
      }

      .scan-corners.br {
        bottom: -2px;
        right: -2px;
        border-left: none;
        border-top: none;
        border-bottom-right-radius: 10px;
      }

      .controls {
        background: var(--admin-bg-dark);
        padding: 20px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
      }

      .control-btn {
        background: var(--admin-primary);
        color: white;
        border: none;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      }

      .control-btn:hover {
        transform: scale(1.1) rotate(5deg);
        box-shadow: 0 5px 15px rgba(204, 41, 54, 0.4);
      }

      .control-btn:active {
        transform: scale(0.95);
      }

      .control-btn.torch {
        background: var(--admin-warning);
      }

      .control-btn.manual {
        background: var(--admin-secondary);
      }

      .stats-bar {
        background: rgba(0, 0, 0, 0.8);
        padding: 10px 20px;
        display: flex;
        justify-content: space-around;
        font-size: 14px;
      }

      .stat-item {
        text-align: center;
      }

      .stat-value {
        font-size: 20px;
        font-weight: bold;
        color: var(--admin-primary);
      }

      .stat-label {
        color: #95a5a6;
        font-size: 11px;
        text-transform: uppercase;
        margin-top: 2px;
      }

      /* Override result modal with Cuban celebration animations */
      .result-content.success {
        background: var(--admin-cuban-gradient);
        animation: cubanCelebration 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      }

      @keyframes cubanCelebration {
        0% { transform: translateY(50px) scale(0.8) rotate(-5deg); opacity: 0; }
        50% { transform: translateY(-10px) scale(1.05) rotate(2deg); opacity: 0.9; }
        100% { transform: translateY(0) scale(1) rotate(0deg); opacity: 1; }
      }

      .result-content.error {
        background: linear-gradient(135deg, var(--admin-danger), #f45c43);
      }

      /* Manual input styling overrides */
      .manual-input {
        position: fixed;
        bottom: -100%;
        left: 0;
        right: 0;
        transition: bottom 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        z-index: 500;
        border-radius: 20px 20px 0 0;
        margin: 0 10px;
        max-width: calc(100% - 20px);
      }

      .manual-input.show {
        bottom: 0;
      }

      .manual-input-buttons {
        display: flex;
        gap: var(--admin-space-md);
        margin-top: var(--admin-space-lg);
      }

      .manual-input-buttons .admin-btn {
        flex: 1;
      }

      /* Hide HTML5 QR Code default UI elements */
      #reader__dashboard_section_csr,
      #reader__dashboard_section_fsr {
        display: none !important;
      }

      #reader__scan_region {
        border: none !important;
      }

      #reader video {
        object-fit: cover !important;
      }
    </style>
  </head>
  <body class="admin-portal">
    <div class="admin-header admin-cuban-gradient">
      <div class="admin-header-left">
        <h1 class="admin-header-title" data-testid="scanner-title">
          üé´ Check-in Scanner
        </h1>
        <span class="admin-header-subtitle">A Lo Cubano Boulder Fest</span>
      </div>
      <div class="admin-header-right">
        <button class="admin-btn admin-btn-outline" onclick="showMenu()">
          ‚ò∞ Dashboard
        </button>
      </div>
    </div>

    <div class="offline-indicator" id="offlineIndicator">
      üìµ Offline - Check-ins will sync when connected
    </div>

    <div class="scanner-container admin-fade-in" data-testid="scanner-container">
      <div class="stats-bar admin-table">
        <div class="stat-item">
          <div class="stat-value" id="todayCount">0</div>
          <div class="stat-label">Today</div>
        </div>
        <div class="stat-item">
          <div
            class="stat-value"
            id="sessionCount"
            data-testid="checkin-counter"
          >
            0
          </div>
          <div class="stat-label">Session</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="queueCount">0</div>
          <div class="stat-label">Queued</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="walletCount">0</div>
          <div class="stat-label">Wallet</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalCount">0</div>
          <div class="stat-label">Total</div>
        </div>
      </div>

      <div class="scanner-viewport admin-rumba-wave">
        <div id="reader" data-testid="camera-scanner"></div>
        <div class="scanner-overlay">
          <div class="scan-region">
            <div class="scan-corners tl"></div>
            <div class="scan-corners tr"></div>
            <div class="scan-corners bl"></div>
            <div class="scan-corners br"></div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="control-btn torch admin-dance" onclick="toggleTorch()" id="torchBtn">
          üî¶
        </button>
        <button
          class="control-btn manual admin-dance"
          onclick="showManualInput()"
          data-testid="manual-input-toggle"
        >
          ‚å®Ô∏è
        </button>
        <button class="control-btn admin-dance" onclick="location.reload()">üîÑ</button>
      </div>
    </div>

    <div class="result-modal" id="resultModal">
      <div class="result-content admin-card admin-cha-cha-slide" id="resultContent">
        <div class="result-icon" id="resultIcon"></div>
        <div
          class="result-title"
          id="resultTitle"
          data-testid="validation-result"
        ></div>
        <div
          class="result-details"
          id="resultDetails"
          data-testid="ticket-info"
        ></div>
        <button class="result-btn admin-btn admin-btn-outline" onclick="closeResult()">
          Continue Scanning
        </button>
      </div>
    </div>

    <div class="manual-input admin-card" id="manualInput">
      <div class="admin-card-header">
        <h3 class="admin-card-title">Manual Ticket Entry</h3>
      </div>
      <div class="admin-card-body">
        <input
          type="text"
          id="manualTicketId"
          class="admin-form-input"
          placeholder="Enter ticket ID..."
          autocomplete="off"
          data-testid="qr-manual-input"
        />
        <div class="manual-input-buttons">
          <button
            class="admin-btn admin-btn-primary"
            onclick="submitManualTicket()"
            data-testid="validate-ticket"
          >
            Check In
          </button>
          <button class="admin-btn admin-btn-secondary" onclick="hideManualInput()">Cancel</button>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
      let scanner = null;
      let sessionCount = 0;
      let isScanning = false;
      let torchOn = false;

      // Statistics
      const stats = {
        today: 0,
        session: 0,
        queued: 0,
        wallet: 0,
        total: 0,
      };

      // Initialize scanner
      async function initScanner() {
        try {
          scanner = new Html5Qrcode("reader");

          const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            experimentalFeatures: {
              useBarCodeDetectorIfSupported: true,
            },
          };

          await scanner.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanError,
          );

          isScanning = true;
        } catch (error) {
          console.error("Failed to start scanner:", error);
          alert("Camera access denied or not available");
        }
      }

      // Handle successful scan
      async function onScanSuccess(decodedText) {
        if (!isScanning) return;

        // Prevent multiple scans
        isScanning = false;

        // Haptic feedback
        if (navigator.vibrate) {
          navigator.vibrate(200);
        }

        // Validate QR code
        await validateTicket(decodedText);

        // Resume scanning after delay
        setTimeout(() => {
          isScanning = true;
        }, 2000);
      }

      // Handle scan errors (ignore)
      function onScanError(error) {
        // Ignore scan errors
      }

      // Validate ticket (QR code or JWT wallet token)
      async function validateTicket(token) {
        try {
          // Detect wallet tokens (JWT format)
          const isWalletToken = token.includes(".") && token.length > 100;

          const response = await fetch("/api/tickets/validate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              token: token,
              validatedBy: "mobile-scanner",
              location: "entrance",
              wallet_source: isWalletToken ? "jwt" : null,
              qr_access_method: isWalletToken ? "wallet" : "qr_code",
            }),
          });

          const data = await response.json();

          if (data.offline) {
            // Offline check-in
            stats.queued++;
            updateStats();
            showResult(
              "queued",
              "Queued for Sync",
              `Check-in saved offline (${stats.queued} in queue)`,
            );
          } else if (data.valid) {
            // Success
            stats.session++;
            stats.today++;
            if (data.ticket && data.ticket.wallet_source) stats.wallet++;
            updateStats();

            // Show wallet badge if from wallet
            const walletBadge =
              data.ticket && data.ticket.wallet_source ? "üì± " : "üé´ ";
            const accessMethod =
              data.ticket && data.ticket.qr_access_method === "wallet"
                ? " (Wallet)"
                : "";

            if (data.ticket) {
              showResult(
                "success",
                `${walletBadge}Valid Ticket!`,
                `${data.ticket.attendeeName}\n${data.ticket.type}${accessMethod}\nScan ${data.ticket.scanCount}/${data.ticket.maxScans}`,
              );
            } else {
              showResult("success", "Valid Ticket!", "Check-in successful");
            }
          } else {
            // Error
            showResult(
              "error",
              "Invalid Ticket",
              data.error || "This ticket cannot be validated",
            );
          }
        } catch (error) {
          console.error("Validation error:", error);

          // Queue for offline sync
          stats.queued++;
          updateStats();
          showResult(
            "queued",
            "Queued for Sync",
            "No connection - check-in saved",
          );
        }
      }

      // Show result modal with Cuban celebration effects
      function showResult(type, title, details) {
        const modal = document.getElementById("resultModal");
        const content = document.getElementById("resultContent");
        const icon = document.getElementById("resultIcon");
        const titleEl = document.getElementById("resultTitle");
        const detailsEl = document.getElementById("resultDetails");

        // Set content
        if (type === "success") {
          content.className = "result-content success admin-card admin-cha-cha-slide admin-fireworks";
          icon.textContent = "üéâ";
          content.setAttribute("data-testid", "checkin-success");
          
          // Trigger Cuban celebration animation
          setTimeout(() => {
            content.classList.add("admin-heartbeat");
          }, 300);
        } else if (type === "error") {
          content.className = "result-content error admin-card admin-cha-cha-slide";
          icon.textContent = "‚ùå";
          content.setAttribute("data-testid", "validation-error");
        } else if (type === "queued") {
          content.className = "result-content admin-card admin-cha-cha-slide";
          icon.textContent = "üì•";
          content.setAttribute("data-testid", "network-error");
        }

        titleEl.textContent = title;
        detailsEl.textContent = details;

        // Show modal with Cuban flair
        modal.classList.add("show");

        // Add music note animations for success
        if (type === "success") {
          createMusicNotes();
        }

        // Auto-close after 3 seconds
        setTimeout(() => {
          closeResult();
        }, 3000);
      }

      // Create Cuban music note animation for celebrations
      function createMusicNotes() {
        const notes = ['üéµ', 'üé∂', '‚ô™', '‚ô´'];
        const modal = document.getElementById("resultModal");
        
        for (let i = 0; i < 3; i++) {
          setTimeout(() => {
            const note = document.createElement('div');
            note.className = 'admin-music-note';
            note.textContent = notes[Math.floor(Math.random() * notes.length)];
            note.style.left = Math.random() * 80 + 10 + '%';
            note.style.animationDelay = Math.random() * 0.5 + 's';
            modal.appendChild(note);
            
            // Remove note after animation
            setTimeout(() => {
              if (note.parentNode) {
                note.parentNode.removeChild(note);
              }
            }, 3000);
          }, i * 200);
        }
      }

      // Close result modal and clean up Cuban animation classes
      function closeResult() {
        const modal = document.getElementById("resultModal");
        const content = document.getElementById("resultContent");
        
        modal.classList.remove("show");
        
        // Clean up animation classes
        content.classList.remove("admin-heartbeat", "admin-fireworks", "admin-cha-cha-slide");
        
        // Remove any floating music notes
        const notes = modal.querySelectorAll('.admin-music-note');
        notes.forEach(note => {
          if (note.parentNode) {
            note.parentNode.removeChild(note);
          }
        });
      }

      // Toggle torch/flashlight
      async function toggleTorch() {
        if (!scanner) return;

        try {
          const track = scanner.getRunningTrackCameraCapabilities();

          if (track && track.torchFeature) {
            torchOn = !torchOn;
            await track.applyTorch(torchOn);

            document.getElementById("torchBtn").style.background = torchOn
              ? "#f1c40f"
              : "#f39c12";
          } else {
            alert("Torch not available on this device");
          }
        } catch (error) {
          console.error("Torch error:", error);
          alert("Torch control not supported");
        }
      }

      // Show manual input
      function showManualInput() {
        document.getElementById("manualInput").classList.add("show");
        document.getElementById("manualTicketId").focus();
      }

      // Hide manual input
      function hideManualInput() {
        document.getElementById("manualInput").classList.remove("show");
        document.getElementById("manualTicketId").value = "";
      }

      // Submit manual ticket
      async function submitManualTicket() {
        const ticketId = document.getElementById("manualTicketId").value.trim();

        if (!ticketId) {
          alert("Please enter a ticket ID");
          return;
        }

        hideManualInput();

        // For manual entry, we need to look up the ticket first
        try {
          const response = await fetch(
            `/api/tickets?ticket_id=${encodeURIComponent(ticketId)}`,
          );
          const data = await response.json();

          if (data.ticket && data.ticket.qr_token) {
            await validateTicket(data.ticket.qr_token);
          } else {
            showResult("error", "Not Found", "Ticket ID not found");
          }
        } catch (error) {
          showResult("error", "Error", "Failed to lookup ticket");
        }
      }

      // Update statistics display
      function updateStats() {
        document.getElementById("todayCount").textContent = stats.today;
        document.getElementById("sessionCount").textContent = stats.session;
        document.getElementById("queueCount").textContent = stats.queued;
        document.getElementById("walletCount").textContent = stats.wallet;
        document.getElementById("totalCount").textContent = stats.total;
      }

      // Load statistics
      async function loadStats() {
        try {
          const response = await fetch("/api/admin/dashboard");
          const data = await response.json();

          if (data.stats) {
            stats.today = data.stats.today_sales || 0;
            stats.total = data.stats.checked_in || 0;
            stats.wallet = data.stats.wallet_checkins || 0;
            updateStats();
          }
        } catch (error) {
          console.error("Failed to load stats:", error);
        }
      }

      // Check online status
      function updateOnlineStatus() {
        const indicator = document.getElementById("offlineIndicator");

        if (navigator.onLine) {
          indicator.classList.remove("show");

          // Trigger sync if we have queued items
          if (stats.queued > 0 && "serviceWorker" in navigator) {
            navigator.serviceWorker.ready.then((registration) => {
              return registration.sync.register("sync-checkins");
            });
          }
        } else {
          indicator.classList.add("show");
        }
      }

      // Show menu (placeholder)
      function showMenu() {
        if (confirm("Return to dashboard?")) {
          window.location.href = "/admin/dashboard";
        }
      }

      // Check authentication (mobile sessions last 72 hours)
      async function checkAuth() {
        try {
          // First check if we have a mobile session
          const response = await fetch("/api/admin/dashboard");
          if (!response.ok) {
            // Show mobile login screen instead of redirecting
            showMobileLogin();
            return false;
          }
          return true;
        } catch (error) {
          showMobileLogin();
          return false;
        }
      }

      // Show mobile login UI
      function showMobileLogin() {
        document.body.innerHTML = `
                <div style="
                    height: 100vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                ">
                    <div style="
                        background: white;
                        padding: 40px;
                        border-radius: 20px;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                        max-width: 90%;
                        width: 350px;
                    ">
                        <h2 style="color: #2c3e50; margin-bottom: 10px; text-align: center;">
                            üé´ Check-in Staff Login
                        </h2>
                        <p style="color: #7f8c8d; text-align: center; margin-bottom: 30px; font-size: 14px;">
                            Session lasts 72 hours
                        </p>
                        <form id="mobileLoginForm" onsubmit="handleMobileLogin(event)">
                            <input 
                                type="password" 
                                id="staffPassword"
                                placeholder="Enter staff password"
                                required
                                style="
                                    width: 100%;
                                    padding: 15px;
                                    border: 1px solid #ddd;
                                    border-radius: 10px;
                                    font-size: 16px;
                                    margin-bottom: 20px;
                                "
                            >
                            <button type="submit" style="
                                width: 100%;
                                padding: 15px;
                                background: #667eea;
                                color: white;
                                border: none;
                                border-radius: 10px;
                                font-size: 18px;
                                font-weight: 600;
                                cursor: pointer;
                            ">
                                Login to Scanner
                            </button>
                            <div id="loginError" style="
                                color: #e74c3c;
                                text-align: center;
                                margin-top: 15px;
                                display: none;
                            "></div>
                        </form>
                    </div>
                </div>
            `;

        // Focus password field
        setTimeout(() => {
          document.getElementById("staffPassword").focus();
        }, 100);
      }

      // Handle mobile login
      async function handleMobileLogin(event) {
        event.preventDefault();

        const password = document.getElementById("staffPassword").value;
        const errorDiv = document.getElementById("loginError");

        try {
          // Get CSRF token first
          const csrfResponse = await fetch("/api/admin/csrf-token");
          const csrfData = await csrfResponse.json();

          // Attempt login with mobile endpoint
          const response = await fetch("/api/admin/mobile-login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": csrfData.token,
            },
            body: JSON.stringify({
              password: password,
              csrfToken: csrfData.token,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            // Login successful, reload page
            location.reload();
          } else {
            errorDiv.textContent = data.error || "Invalid password";
            errorDiv.style.display = "block";
            document.getElementById("staffPassword").value = "";
            document.getElementById("staffPassword").focus();
          }
        } catch (error) {
          errorDiv.textContent = "Connection error. Please try again.";
          errorDiv.style.display = "block";
        }
      }

      // Initialize app
      async function init() {
        // Check authentication
        if (!(await checkAuth())) return;

        // Register service worker
        if ("serviceWorker" in navigator) {
          try {
            await navigator.serviceWorker.register("/js/sw.js");
            console.log("Service worker registered");
          } catch (error) {
            console.error("Service worker registration failed:", error);
          }
        }

        // Initialize scanner
        await initScanner();

        // Load statistics
        await loadStats();

        // Monitor online status
        updateOnlineStatus();
        window.addEventListener("online", updateOnlineStatus);
        window.addEventListener("offline", updateOnlineStatus);

        // Refresh stats periodically
        setInterval(loadStats, 30000);
      }

      // Start app
      init();
    </script>
  </body>
</html>
