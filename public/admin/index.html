<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Portal - A Lo Cubano Boulder Fest</title>
    <style>
      body {
        background: linear-gradient(135deg, #d2691e, #ff6347);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .loading-container {
        text-align: center;
        color: white;
        padding: 40px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .loading-text {
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 10px;
      }

      .loading-subtext {
        font-size: 14px;
        opacity: 0.8;
        font-style: italic;
      }

      .error-message {
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.3);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        display: none;
      }

      .error-message.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <div class="loading-text">ðŸŽº Authenticating...</div>
      <div class="loading-subtext">Checking admin credentials - Â¡Un momento!</div>
      <div id="errorMessage" class="error-message">
        Authentication failed. Redirecting to login...
      </div>
    </div>

    <script>
      // Enhanced authentication check with proper token validation
      async function checkAuthentication() {
        try {
          // Check for various auth tokens in different storage locations
          const adminToken = localStorage.getItem('adminToken') || 
                           sessionStorage.getItem('adminToken') ||
                           getCookieValue('admin_session');

          // If no token found, redirect to login immediately
          if (!adminToken) {
            console.log('No authentication token found, redirecting to login');
            window.location.replace('login.html');
            return;
          }

          // Validate token with the server
          const response = await fetch('/api/admin/dashboard', {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${adminToken}`,
              'Content-Type': 'application/json'
            },
            credentials: 'include' // Include cookies for session-based auth
          });

          if (response.ok) {
            // Token is valid, redirect to dashboard
            console.log('Authentication successful, redirecting to dashboard');
            window.location.replace('dashboard.html');
          } else if (response.status === 401 || response.status === 403) {
            // Token is invalid or expired, clear it and redirect to login
            console.log('Authentication token invalid/expired, redirecting to login');
            clearAuthTokens();
            showErrorAndRedirect('Authentication expired. Please login again.');
          } else {
            // Other server error, try login page
            console.log('Server error during auth check, redirecting to login');
            showErrorAndRedirect('Server error. Please try logging in again.');
          }
        } catch (error) {
          console.error('Auth check failed:', error);
          // Network error or other issue, redirect to login
          showErrorAndRedirect('Connection error. Please try logging in again.');
        }
      }

      // Get cookie value by name
      function getCookieValue(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) {
          return parts.pop().split(';').shift();
        }
        return null;
      }

      // Clear all authentication tokens
      function clearAuthTokens() {
        localStorage.removeItem('adminToken');
        sessionStorage.removeItem('adminToken');
        // Clear session cookie
        document.cookie = 'admin_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=' + window.location.hostname;
      }

      // Show error message and redirect after delay
      function showErrorAndRedirect(message) {
        const errorElement = document.getElementById('errorMessage');
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.classList.add('show');
        }
        
        // Redirect after 2 seconds to show the error message
        setTimeout(() => {
          window.location.replace('login.html');
        }, 2000);
      }

      // Alternative authentication check using cookie-based session
      async function checkSessionAuth() {
        try {
          const response = await fetch('/api/admin/dashboard', {
            method: 'GET',
            credentials: 'include' // This will include httpOnly cookies
          });

          if (response.ok) {
            console.log('Session authentication successful, redirecting to dashboard');
            window.location.replace('dashboard.html');
          } else {
            console.log('No valid session, redirecting to login');
            window.location.replace('login.html');
          }
        } catch (error) {
          console.error('Session auth check failed:', error);
          window.location.replace('login.html');
        }
      }

      // Initialize authentication check immediately
      // Try both token-based and session-based auth
      Promise.race([
        checkAuthentication(),
        checkSessionAuth()
      ]).catch(() => {
        // If both fail, redirect to login
        window.location.replace('login.html');
      });

      // Fallback redirect in case JavaScript takes too long
      setTimeout(() => {
        console.log('Fallback redirect triggered');
        if (window.location.pathname.includes('index.html')) {
          window.location.replace('login.html');
        }
      }, 5000); // 5 second timeout
    </script>
  </body>
</html>
