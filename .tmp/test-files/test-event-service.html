<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Service Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        pre {
            background: #000;
            padding: 10px;
            border: 1px solid #0f0;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Event Service Test</h1>

    <button onclick="testEventsService()">Test Event Service</button>
    <button onclick="testCartManager()">Test Cart Manager</button>
    <button onclick="clearCart()">Clear Cart</button>

    <pre id="output">Ready to test...</pre>

    <script type="module">
        import eventsService from '/js/lib/events-service.js';
        import { getCartManager } from '/js/lib/cart-manager.js';

        async function testEventsService() {
            const output = document.getElementById('output');
            try {
                output.textContent = 'Initializing events service...\n';

                await eventsService.ensureInitialized();
                output.textContent += 'Service initialized!\n\n';

                // Test getting all events
                const events = await eventsService.getAllEvents();
                output.textContent += `Found ${events.length} events:\n`;

                events.forEach(event => {
                    output.textContent += `\n- Event ID ${event.id}: ${event.name}\n`;
                    output.textContent += `  Slug: ${event.slug}\n`;
                    output.textContent += `  Display: ${event.displayName || event.name}\n`;
                    output.textContent += `  Type: ${event.type}\n`;
                });

                // Test specific lookups
                output.textContent += '\n\nTesting specific lookups:\n';

                // Test integer ID lookup
                const event1 = await eventsService.getEventById(1);
                output.textContent += `\nEvent ID 1: ${event1 ? event1.name : 'Not found'}\n`;

                // Test negative ID for test events
                const testEvent = await eventsService.getEventById(-1);
                output.textContent += `Event ID -1 (test): ${testEvent ? testEvent.name : 'Not found'}\n`;

                // Test slug lookup
                const slugEvent = await eventsService.getEventBySlug('boulderfest-2026');
                output.textContent += `Event by slug 'boulderfest-2026': ${slugEvent ? slugEvent.name : 'Not found'}\n`;

                // Test cache stats
                const stats = eventsService.getCacheStats();
                output.textContent += `\nCache stats: ${JSON.stringify(stats, null, 2)}\n`;

            } catch (error) {
                output.textContent += `\nError: ${error.message}\n${error.stack}`;
            }
        }

        async function testCartManager() {
            const output = document.getElementById('output');
            try {
                output.textContent = 'Testing cart manager with integer event IDs...\n';

                const cartManager = getCartManager();
                await cartManager.initialize();

                // Add a test ticket with integer event ID
                await cartManager.addTicket({
                    ticketType: 'TEST-integration',
                    price: 100,
                    name: '[TEST] Integration Test Ticket',
                    eventId: -1, // Integer ID for test festival
                    eventDate: '2028-02-29',
                    venue: 'Test Venue',
                    quantity: 1
                });

                output.textContent += '\nAdded test ticket with event ID -1\n';

                const state = cartManager.getState();
                output.textContent += `\nCart state: ${JSON.stringify(state, null, 2)}\n`;

            } catch (error) {
                output.textContent += `\nError: ${error.message}\n${error.stack}`;
            }
        }

        async function clearCart() {
            const output = document.getElementById('output');
            try {
                const cartManager = getCartManager();
                await cartManager.initialize();
                await cartManager.clear();
                output.textContent = 'Cart cleared successfully!';
            } catch (error) {
                output.textContent = `Error clearing cart: ${error.message}`;
            }
        }

        // Make functions available globally
        window.testEventsService = testEventsService;
        window.testCartManager = testCartManager;
        window.clearCart = clearCart;
    </script>
</body>
</html>