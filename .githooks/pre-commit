#!/bin/sh
#
# Pre-commit hook for A Lo Cubano Boulder Fest
# Runs linting and unit tests before allowing commits
#

set -e

echo "üöÄ Running pre-commit checks..."

# Check if we're in the right directory
if [ ! -f package.json ]; then
    echo "‚ùå Error: Not in project root directory"
    exit 1
fi

# Stage 1: Linting
echo "üìù Stage 1: Running linter..."
if npm run lint; then
    echo "‚úÖ Linting passed"
else
    echo "‚ùå Linting failed - please fix errors before committing"
    exit 1
fi

# Stage 2: Unit tests (without strict coverage for commits)
echo "üß™ Stage 2: Running unit tests..."
if npm run test:unit -- --passWithNoTests --coverage=false; then
    echo "‚úÖ Unit tests passed"
else
    echo "‚ùå Unit tests failed - please fix tests before committing"
    exit 1
fi

# Stage 3: Check for sensitive data (basic check)
echo "üîí Stage 3: Checking for sensitive data..."
SENSITIVE_FILES=$(git diff --cached --name-only | grep -v -E "(package*.json|jest*.js|README.md|\.md$|\.githooks|\.github|install-hooks\.sh)" | xargs grep -l -i -E "(api[_-]?key|password|secret[^a]|token)" 2>/dev/null || true)
if [ -n "$SENSITIVE_FILES" ]; then
    echo "‚ö†Ô∏è  WARNING: Potential sensitive data found in staged files"
    echo "Files: $SENSITIVE_FILES"
    echo "Please review your changes and remove any secrets or API keys"
    exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
echo "üí° Your commit is ready to proceed"