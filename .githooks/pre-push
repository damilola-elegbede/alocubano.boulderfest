#!/bin/sh
#
# Pre-push hook for A Lo Cubano Boulder Fest
# Runs comprehensive test suite before allowing pushes
#

set -e

protected_branch='main'
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')
remote="$1"
url="$2"

echo "🚀 Running pre-push validation for branch: $current_branch"

# Check if we're in the right directory
if [ ! -f package.json ]; then
    echo "❌ Error: Not in project root directory"
    exit 1
fi

# Enhanced checks for main branch
if [ "$current_branch" = "$protected_branch" ]; then
    echo "⚡ Enhanced validation for protected branch: $protected_branch"
fi

# Stage 1: Quick lint check (in case pre-commit was bypassed)
echo "📝 Stage 1: Quick lint verification..."
if npm run lint; then
    echo "✅ Linting verified"
else
    echo "❌ Linting failed - cannot push"
    exit 1
fi

# Stage 2: Unit tests with coverage
echo "🧪 Stage 2: Running unit tests with coverage..."
if npm run test:unit; then
    echo "✅ Unit tests passed"
else
    echo "❌ Unit tests failed - cannot push"
    exit 1
fi

# Stage 3: Link validation tests
echo "🔗 Stage 3: Running link validation..."
if npm run test:links; then
    echo "✅ Link validation passed"
else
    echo "⚠️  Link validation had warnings, but continuing..."
fi

# Stage 4: Python-based comprehensive link validation
echo "🐍 Stage 4: Running comprehensive Python link validation..."
if python3 run_link_tests.py; then
    echo "✅ Comprehensive link validation passed"
else
    echo "❌ Comprehensive link validation failed - cannot push"
    exit 1
fi

# Stage 5: Build verification (if applicable)
echo "🏗️  Stage 5: Verifying project structure..."
if [ -f vercel.json ]; then
    # Validate JSON files
    if python3 -m json.tool vercel.json > /dev/null 2>&1; then
        echo "✅ vercel.json is valid"
    else
        echo "❌ vercel.json has invalid JSON - cannot push"
        exit 1
    fi
fi

if python3 -m json.tool package.json > /dev/null 2>&1; then
    echo "✅ package.json is valid"
else
    echo "❌ package.json has invalid JSON - cannot push"
    exit 1
fi

# Stage 6: Security check for main branch
if [ "$current_branch" = "$protected_branch" ]; then
    echo "🔒 Stage 6: Enhanced security scan for main branch..."
    if find . -name "*.js" -o -name "*.html" -o -name "*.css" | \
       grep -v node_modules | \
       xargs grep -l -i -E "(api[_-]?key|password|secret|token)" 2>/dev/null | \
       grep -v -E "(package*.json|jest*.js|README.md|\.md$)" || false; then
        echo "❌ Sensitive data detected in main branch push - cannot push"
        exit 1
    fi
    echo "✅ Security scan passed"
fi

echo ""
echo "🎉 All pre-push checks passed!"
echo "📊 Push summary:"
echo "   • Linting: ✅"
echo "   • Unit tests: ✅"
echo "   • Link validation: ✅"
echo "   • Python validation: ✅"
echo "   • Structure check: ✅"
if [ "$current_branch" = "$protected_branch" ]; then
    echo "   • Security scan: ✅"
fi
echo ""
echo "🚢 Your push is ready to proceed!"